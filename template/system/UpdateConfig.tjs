// UpdateConfig.tjs - Config.tjs ����p�����߂̃X�N���v�g
// Copyright (C)2001-2009, W.Dee and contributors  ��ρE�z�z�͎��R�ł�

// Config.~new �t�@�C���͐V���� Config.tjs �t�@�C���B
// Config.tjs �t�@�C�����̃o�[�W�������� KAG �̃o�[�W�������
// ��v���Ȃ��ꍇ�ɂ��̃X�N���v�g�t�@�C�����Ă΂��B

if(Storages.isExistentStorage("Config.~new"))
{
	// Config.~new �t�@�C����������

	// Config.tjs ��ǂݍ���
	var settings = %[]; // �ݒ�����i�[���鎫���z��
	var oldconfig = [].load("Config.tjs"); //Config.tjs ��ǂݍ���
	var pattern = /^;\s*(.*?)\s*=(.*)$/; // �ݒ�s��F�����邽�߂̐��K�\���p�^�[��
	var pattern_adds = /^\/\/\[start-(.*?)-additionals\]$/;
	for(var i = 0; i < oldconfig.count; i++)
	{
		var matched = pattern.match(oldconfig[i]);
		if(matched.count) settings[matched[1]] = matched[2];
		matched = pattern_adds.match(oldconfig[i]);
		if(matched.count)
		{
			var end_mark = "//[end-" + matched[1] + "-additionals]";
			i++;
			var content = '';
			while(oldconfig[i] != end_mark && i < oldconfig.count)
			{
				content += oldconfig[i] + "\n";
				i++;
			}
			settings["additional" + matched[1]] = content;
		}
	}

	// �o�[�W�������̏�������
	settings['global.config_version'] = " \"" + kagVersion + "\"; // ���̍s�������Ȃ��ł�������";

	// Config.~new �̓ǂݍ��݂Ɛݒ�̈�p��
	var newconfig = [].load("Config.~new"); // Config.~new ��ǂݍ���
	var lines = '';
	for(var i = 0; i < newconfig.count; i++)
	{
		var matched = pattern.match(newconfig[i]);
		var matched_adds = pattern_adds.match(newconfig[i]);
		if(matched.count)
		{
			var setting_name = matched[1];
			var setting = settings[setting_name];
			if(setting !== void)
				lines += ";" + setting_name + " =" + setting + "\n";
			else
				lines += newconfig[i] + "\n";
		}
		else if(matched_adds.count)
		{
			var setting_name = "additional" + matched_adds[1];
			var end_mark = "//[end-" + matched_adds[1] + "-additionals]";
			var setting = settings[setting_name];
			if(setting !== void)
			{
				lines += "//[start-" + matched_adds[1] + "-additionals]\n" +
					setting + end_mark + "\n";
				i++;
				while(newconfig[i] != end_mark && i < newconfig.count) i++;
			}
			else
			{
				lines += newconfig[i] + "\n";
			}
		}
		else
		{
			lines += newconfig[i] + "\n";
		}
	}

	// Pad �̕\��
	global.configPad = new Pad();
	global.configPad.text = lines;
	global.configPad.color = 0;
	global.configPad.title = "Config.tjs";
	global.configPad.fileName = Storages.getLocalName(Storages.getPlacedPath("Config.tjs"));
	global.configPad.visible = true;

	// �ʒm
	System.inform("�ݒ���e���Â� Config.tjs �����p���܂����B\n"
		"�gConfig.tjs�h�E�B���h�E��ɕ\������Ă�����e�ł悯��΁A���E�B���h�E���\n"
		"�E�N���b�N�����āu�ۑ��v��I�����AConfig.tjs ��ۑ����Ă��������B\n"
		"Config.~new �t�@�C���͍폜���Ă��܂��܂���B");

	// �V���� config �̓ǂݍ��ݒ���
	Scripts.exec(lines);
}
