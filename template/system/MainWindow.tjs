//;# MainWindow.tjs - KAG ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Eï¿½Bï¿½ï¿½ï¿½hï¿½E
//;# Copyright (C)2001-2009, W.Dee and contributors  ï¿½ï¿½ÏEï¿½zï¿½zï¿½Íï¿½ï¿½Rï¿½Å‚ï¿½
//;<<'END_OF_TJS_SCRIPT';

// ï¿½ï¿½ï¿½ÌƒXï¿½Nï¿½ï¿½ï¿½vï¿½gï¿½Í—Lï¿½ï¿½ï¿½ perl5 ï¿½Xï¿½Nï¿½ï¿½ï¿½vï¿½gï¿½Å‚ï¿½ï¿½ï¿½ï¿½ï¿½

var SKIP_NONE = 0;
var SKIP_CLICK = 1;
var SKIP_PAGE  = 2;
var SKIP_STOP  = 3;
var SKIP_FAST  = 4;
var SKIP_LABEL = 5;
var SKIP_CANCEL = 6;
var SKIP_FORCE  = 7;

class KAGWindow extends Window
{
	// KAG ï¿½ÌƒEï¿½Bï¿½ï¿½ï¿½hï¿½E ï¿½Nï¿½ï¿½ï¿½X
	// KAG ï¿½Ì“ï¿½ï¿½ï¿½Ìƒï¿½ï¿½Cï¿½ï¿½ï¿½È•ï¿½ï¿½ï¿½ï¿½Í‚ï¿½ï¿½ï¿½ï¿½É‹Lï¿½qï¿½ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½

	// ï¿½È‰ï¿½ï¿½Ì‚ï¿½ï¿½ï¿½ï¿½A/*C*/ ï¿½Ì‚Â‚ï¿½ï¿½Ïï¿½ï¿½ÍAï¿½ï¿½ï¿½[ï¿½ï¿½ perl ï¿½Xï¿½Nï¿½ï¿½ï¿½vï¿½gï¿½É‚ï¿½ï¿½ï¿½ï¿½
	// ï¿½ï¿½ï¿½ï¿½ï¿½Iï¿½Éxï¿½ÉƒRï¿½sï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½Rï¿½[ï¿½hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ïï¿½

	var scWidth = 640; // ï¿½ï¿½Ê‰ï¿½ï¿½ï¿½
	var scHeight = 480; // ï¿½ï¿½Êcï¿½ï¿½

	var aboutWidth = 320; // ï¿½uï¿½ï¿½ï¿½Ìƒ\ï¿½tï¿½gï¿½É‚Â‚ï¿½ï¿½Ävï¿½Eï¿½Bï¿½ï¿½ï¿½hï¿½Eï¿½Ì‰ï¿½ï¿½ï¿½
	var aboutHeight = 200; // ï¿½ï¿½ï¿½cï¿½ï¿½
	var aboutStorage = "about.ks";

    var defaultName   = "ï¿½ï¿½ï¿½O"; // ï¿½Wï¿½ï¿½ï¿½ï¿½    ï¿½ï¿½ï¿½[ï¿½ï¿½ï¿½hï¿½gï¿½ï¿½ï¿½ï¿½ï¿½{ï¿½Cï¿½Xï¿½Ø‚ï¿½Ö‚ï¿½ï¿½É—ï¿½ï¿½p
    var defaultFamily = "ï¿½cï¿½ï¿½"; // ï¿½Wï¿½ï¿½ï¿½cï¿½ï¿½  ï¿½ï¿½ï¿½[ï¿½ï¿½ï¿½hï¿½gï¿½ï¿½ï¿½ï¿½ï¿½{ï¿½Cï¿½Xï¿½Ø‚ï¿½Ö‚ï¿½ï¿½É—ï¿½ï¿½p
    
	var isFirstProcess = true; // ï¿½ï¿½ÔÅï¿½ï¿½ï¿½ process ï¿½ÌŒÄ‚Ñoï¿½ï¿½ï¿½ï¿½ï¿½Ç‚ï¿½ï¿½ï¿½

	var freeSaveDataMode = false; // ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½jï¿½ï¿½ï¿½[ï¿½oï¿½[ï¿½È‚Ç‚ÅŠÇ—ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ÉAï¿½Â•Ê‚Ìƒtï¿½@ï¿½Cï¿½ï¿½ï¿½Æ‚ï¿½ï¿½ÄŠÇ—ï¿½ï¿½ï¿½ï¿½ï¿½
	var saveThumbnail = false; // ï¿½Tï¿½ï¿½ï¿½lï¿½Cï¿½ï¿½ï¿½ï¿½Û‘ï¿½ï¿½ï¿½ï¿½é‚©ï¿½Ç‚ï¿½ï¿½ï¿½
	var thumbnailWidth = 133; // ï¿½Tï¿½ï¿½ï¿½lï¿½Cï¿½ï¿½ï¿½Ì‰ï¿½ï¿½ï¿½
	var thumbnailDepth = 8; // ï¿½Tï¿½ï¿½ï¿½lï¿½Cï¿½ï¿½ï¿½ï¿½BMPï¿½ï¿½ï¿½[ï¿½hï¿½B8ï¿½ï¿½24
		// ï¿½Tï¿½ï¿½ï¿½lï¿½Cï¿½ï¿½ï¿½ï¿½ ï¿½tï¿½ï¿½ï¿½Jï¿½ï¿½ï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ÑƒTï¿½Cï¿½Yï¿½tï¿½ï¿½ï¿½[ï¿½ï¿½ï¿½Ìƒpï¿½bï¿½`ï¿½ï¿½
		// ï¿½ï¿½ñ‚ï¿½ï¿½ç‚¢ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ü‚ï¿½ï¿½ï¿½ï¿½B
		// ï¿½ï¿½ï¿½Ìï¿½ï¿½ï¿½Ø‚ï¿½Ä‚ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½ã‚°ï¿½Ü‚ï¿½ï¿½B

	var snapshotLayer = void; // ï¿½æ‘œï¿½ÌƒXï¿½iï¿½bï¿½vï¿½Vï¿½ï¿½ï¿½bï¿½gï¿½ï¿½ï¿½êï¿½Iï¿½É•Û‘ï¿½ï¿½ï¿½ï¿½éƒŒï¿½Cï¿½ï¿½
	var snapshotLockCount = 0; // ï¿½ï¿½ï¿½bï¿½Nï¿½Jï¿½Eï¿½ï¿½ï¿½g

	var lastSaveDataNameGlobal = ""; // ï¿½ÅŒï¿½É•Û‘ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½tï¿½ï¿½ï¿½[ï¿½Zï¿½[ï¿½uï¿½ï¿½ï¿½[ï¿½hï¿½Å‚Ìƒtï¿½@ï¿½Cï¿½ï¿½ï¿½ï¿½
	/*C*/var lastSaveDataName = ""; // ï¿½ÅŒï¿½É•Û‘ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½tï¿½ï¿½ï¿½[ï¿½Zï¿½[ï¿½uï¿½ï¿½ï¿½[ï¿½hï¿½Å‚Ìƒtï¿½@ï¿½Cï¿½ï¿½ï¿½ï¿½

	var saveDataLocation = System.dataPath; // ï¿½Zï¿½[ï¿½uï¿½fï¿½[ï¿½^ï¿½Û‘ï¿½ï¿½êŠ

	var saveDataID = "00000000-0000-0000-0000-000000000000"; // ï¿½Zï¿½[ï¿½uï¿½fï¿½[ï¿½^ï¿½ï¿½ ID

	var readOnlyMode = false; // ï¿½Ç‚İï¿½ï¿½İï¿½pï¿½ï¿½ï¿½[ï¿½h(ï¿½fï¿½[ï¿½^ï¿½ï¿½ï¿½fï¿½Bï¿½Xï¿½Nï¿½Éï¿½ï¿½ï¿½ï¿½È‚ï¿½)
	var dataName = "data"; // ï¿½Zï¿½[ï¿½uï¿½fï¿½[ï¿½^ï¿½ï¿½
	var saveDataMode = ""; // ï¿½fï¿½[ï¿½^ï¿½Û‘ï¿½ï¿½ï¿½ï¿½[ï¿½h( "c" ï¿½ÅˆÃï¿½ï¿½ï¿½ )

    var recordHistoryOfStore = 0; // ï¿½Ê‰ß—ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Lï¿½^ï¿½ï¿½ï¿½é‚©ï¿½Ç‚ï¿½ï¿½ï¿½
		// 0 = ï¿½ï¿½ï¿½ï¿½ï¿½Iï¿½É‚Í‹Lï¿½^ï¿½ï¿½ï¿½È‚ï¿½
        // 1 = ï¿½Û‘ï¿½ï¿½Â”\ï¿½Èƒï¿½ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		// 2 = ï¿½Iï¿½ï¿½ï¿½ï¿½ ( @s ï¿½^ï¿½O ) ï¿½ï¿½ï¿½ï¿½
		// 3 = ï¿½Iï¿½ï¿½ï¿½ï¿½ ( @select / @mselect ï¿½^ï¿½O ) ï¿½ï¿½ï¿½ï¿½
    
	var maxHistoryOfStore = 1; // ï¿½Ê‰ß‹Lï¿½^ï¿½ÌÅ‘å”
	var historyOfStore = []; // ï¿½Ê‰ß—ï¿½ï¿½ï¿½ï¿½fï¿½[ï¿½^
	var nextRecordHistory = false;
		// ï¿½ï¿½ï¿½Ì•Û‘ï¿½ï¿½Â”\ï¿½Èƒï¿½ï¿½xï¿½ï¿½ï¿½Ê‰ßï¿½ï¿½ÉŒï¿½ï¿½İ‚Ìï¿½ï¿½ï¿½Û‘ï¿½ï¿½ï¿½ï¿½é‚©ï¿½Ç‚ï¿½ï¿½ï¿½
    
	var stablePosibility = false;
		// ï¿½xï¿½ï¿½Û‘ï¿½ï¿½Â”\ï¿½Èƒï¿½ï¿½xï¿½ï¿½ï¿½Ô‚ï¿½ stable ï¿½É‚È‚ï¿½Â”\ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½é‚©ï¿½Ç‚ï¿½ï¿½ï¿½

	var fullScreened = false; // ï¿½ï¿½ï¿½İƒtï¿½ï¿½ï¿½Xï¿½Nï¿½ï¿½ï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½Ç‚ï¿½ï¿½ï¿½

	var isMain = true; // ï¿½ï¿½ï¿½ê‚ªï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Eï¿½Bï¿½ï¿½ï¿½hï¿½Eï¿½ï¿½ï¿½Ç‚ï¿½ï¿½ï¿½

	var askOnClose = true; // ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ÉIï¿½ï¿½ï¿½ï¿½ï¿½é‚©ï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½Uï¿½É•ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ç‚ï¿½ï¿½ï¿½

	var helpFile = ""; // ï¿½uï¿½wï¿½ï¿½ï¿½v > ï¿½Úï¿½ï¿½vï¿½ÅŠJï¿½ï¿½ï¿½tï¿½@ï¿½Cï¿½ï¿½

	var quakeTimer; // quake ï¿½pï¿½Ìƒ^ï¿½Cï¿½}
	var defaultQuakeTimeInChUnit = false;
    var quakeMessageLayer = false; // ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ quakeï¿½ÎÛ‚É‚ï¿½ï¿½é‚©
    /*C*/var quaking = false; // ï¿½hï¿½ï¿½Ä‚ï¿½ï¿½é‚©
	/*C*/var quakeEndTick = 0; // ï¿½hï¿½ï¿½ï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ tick
	/*C*/var quakeHorzMax = 0; // ï¿½ï¿½ï¿½Uï¿½ï¿½
	/*C*/var quakeVertMax = 0; // ï¿½cï¿½Uï¿½ï¿½
	/*C*/var quakePhase = 0;

	var chDefaultAntialiased; // ï¿½ï¿½ï¿½ï¿½ï¿½ÉƒAï¿½ï¿½ï¿½`ï¿½Gï¿½Cï¿½ï¿½ï¿½Aï¿½Xï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½é‚©ï¿½Ç‚ï¿½ï¿½ï¿½
	var chDefaultFace; // ï¿½ï¿½ï¿½ï¿½ï¿½Ìƒfï¿½tï¿½Hï¿½ï¿½ï¿½gï¿½Ìƒtï¿½Hï¿½ï¿½ï¿½g
    var initialMessageLayerVisible = true;

    var historyLayer; // ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½
    /*C*/var historyWriteEnabled = true; // ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½É•ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½oï¿½Í‚ï¿½ï¿½é‚©
	/*C*/var historyEnabled = true; // ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½Â”\ï¿½ï¿½
    var historyShowing = false; // ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
	var lastHistoryHiddenTick = 0; // ï¿½ÅŒï¿½É—ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½É‚È‚ï¿½ï¿½ï¿½ï¿½Æ‚ï¿½ï¿½ï¿½ tick

    var selectPrevSkipMode;
    var selectPrevAutoMode;
    
    var _selectLayer;           // ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½
    var selectShowing = false; // ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½

    property selectLayer {
        getter() {
            if (_selectLayer === void) {
                // ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ìì¬
                _selectLayer = new SelectLayer(this, fore.base);
                _selectLayer.name = "ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½";
                add(_selectLayer);
            }
            return _selectLayer;
        }
    }
    
    var _mapSelectLayer;           // ï¿½}ï¿½bï¿½vï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½
    var mapSelectShowing = false; // ï¿½}ï¿½bï¿½vï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½

    property mapSelectLayer {
        getter() {
            if (_mapSelectLayer === void) {
                // ï¿½}ï¿½bï¿½vï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ìì¬
                _mapSelectLayer = new MapSelectLayer(this, fore.base);
                _mapSelectLayer.name = "ï¿½}ï¿½bï¿½vï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½";
                add(_mapSelectLayer);
            }
            return _mapSelectLayer;
        }
    }
    
    var _transLayer; // ï¿½ï¿½ÊØ‚ï¿½Ö‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½pï¿½ï¿½ï¿½Cï¿½ï¿½
    var transShowing = false; // ï¿½ï¿½ÊØ‚ï¿½Ö‚ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½

    property transLayer {
        getter() {
            if (_transLayer === void) {
                _transLayer = new TransLayer(this);
                add(_transLayer);
            }
            return _transLayer;
        }
    }
    
	/*C*/var numCharacterLayers = 0; // ï¿½Oï¿½iï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ìï¿½
	/*C*/var numMessageLayers = 1; // ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ìï¿½

    /*C*/var messageFadeTime = 500; // ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ì•\ï¿½ï¿½ON/OFF ï¿½Ìï¿½ï¿½ï¿½

    var sysbase;  // ï¿½xï¿½[ï¿½Xï¿½ï¿½ï¿½Cï¿½ï¿½
    var _debugwin; // ï¿½fï¿½oï¿½bï¿½Oï¿½\ï¿½ï¿½ï¿½pï¿½ï¿½ï¿½Cï¿½ï¿½

	property debugwin {
		getter() {
			if (_debugwin === void) {
				// ï¿½fï¿½oï¿½bï¿½Oï¿½\ï¿½ï¿½ï¿½p
				_debugwin = new Layer(this, primaryLayer);
				_debugwin.name = "ï¿½fï¿½oï¿½bï¿½Oï¿½ï¿½ñƒŒƒCï¿½ï¿½";
				_debugwin.setSize(scWidth, 50);
				if (typeof global.debugwintop !== "undefined" && global.debugwintop) {
					_debugwin.setPos(0, 0);
				} else {
					_debugwin.setPos(0, scHeight - _debugwin.height);
				}
				_debugwin.visible = false;
				_debugwin.hitThreshold = 256;
            }
            return _debugwin;
        }
    }
    
    var fore = %[]; // ï¿½\ï¿½ï¿½ï¿½Cï¿½ï¿½
	var back = %[]; // ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½

	var scPositionX = %[]; // ï¿½ï¿½ï¿½ï¿½ï¿½Gï¿½Ì’ï¿½ï¿½Sï¿½ï¿½ï¿½W(X)

	var tempLayer = void; // ï¿½êï¿½Iï¿½Èƒï¿½ï¿½Cï¿½ï¿½

	var lineBreak; // ï¿½sï¿½Ò‚ï¿½ï¿½pï¿½Aï¿½jï¿½ï¿½ï¿½[ï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½
	var pageBreak; // ï¿½yï¿½[ï¿½Wï¿½Ò‚ï¿½ï¿½pï¿½Oï¿½ï¿½ï¿½tï¿½ÌƒAï¿½jï¿½ï¿½ï¿½[ï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½
	var clickWaiting = false; // ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Ò‚ï¿½ï¿½ï¿½ï¿½Ç‚ï¿½ï¿½ï¿½

	var mainConductor; // ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ÌƒRï¿½ï¿½ï¿½_ï¿½Nï¿½^
	var extraConductor; // ï¿½\ï¿½ï¿½ÌƒRï¿½ï¿½ï¿½_ï¿½Nï¿½^
	var conductor; // ï¿½ï¿½ï¿½İ‚ÌƒRï¿½ï¿½ï¿½_ï¿½Nï¿½^
	var usingExtraConductor = false; // ï¿½\ï¿½ï¿½ÌƒRï¿½ï¿½ï¿½_ï¿½Nï¿½^ï¿½ï¿½ï¿½gï¿½pï¿½ï¿½ï¿½ï¿½ï¿½Ç‚ï¿½ï¿½ï¿½
	var onExtraConductorReturn; // extraConductor ï¿½ï¿½ï¿½ï¿½Êï¿½ÌƒRï¿½ï¿½ï¿½_ï¿½Nï¿½^ï¿½É–ß‚ï¿½Æ‚ï¿½ï¿½É‚ï¿½ÔŠÖï¿½

	var tagHandlers; // ï¿½^ï¿½Oï¿½Ìƒnï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Qï¿½ï¿½ï¿½ï¿½ï¿½zï¿½ï¿½

	var saveMacros = true; // ï¿½}ï¿½Nï¿½ï¿½ï¿½ï¿½xï¿½É•Û‘ï¿½ï¿½ï¿½ï¿½é‚©ï¿½Ç‚ï¿½ï¿½ï¿½

	var current; // ï¿½ï¿½ï¿½İ‘ï¿½ï¿½ì’†ï¿½Ìƒï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½
	/*C*/var currentNum; // ï¿½ï¿½ï¿½İ‘ï¿½ï¿½ì’†ï¿½Ìƒï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ôï¿½
	/*C*/var currentPage; // ï¿½ï¿½ï¿½İ‘ï¿½ï¿½ì’†ï¿½Ìƒï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ìƒyï¿½[ï¿½W(ï¿½\0/ï¿½ï¿½1)
	/*C*/var currentWithBack = false; // ï¿½ï¿½ï¿½ï¿½Ê‚É‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½`ï¿½æ‚·ï¿½é‚©ï¿½Ç‚ï¿½ï¿½ï¿½
    var currentVoiceScript; // ï¿½ï¿½ï¿½İ—Lï¿½ï¿½Èƒ{ï¿½Cï¿½X
    
	var bgm; // BGM ï¿½Iï¿½uï¿½Wï¿½Fï¿½Nï¿½g

    var numSEBuffers = 1; // ï¿½ï¿½Ê‰ï¿½ï¿½oï¿½bï¿½tï¿½@ï¿½Ìï¿½
	var se = []; // ï¿½ï¿½Ê‰ï¿½ï¿½oï¿½bï¿½tï¿½@ï¿½Iï¿½uï¿½Wï¿½Fï¿½Nï¿½g

    // ï¿½Vï¿½Xï¿½eï¿½ï¿½ï¿½ï¿½ï¿½gï¿½ï¿½ï¿½ï¿½SEï¿½ï¿½Ô‚ï¿½ï¿½iï¿½ï¿½ï¿½[ï¿½hï¿½ï¿½ï¿½É”jï¿½ó‚³‚ï¿½È‚ï¿½)
    property sysse {
        getter() {
            return se[numSEBuffers];
        }
    }
    
	var numMovies = 1; // ï¿½ï¿½ï¿½[ï¿½rï¿½[ï¿½Iï¿½uï¿½Wï¿½Fï¿½Nï¿½gï¿½ï¿½
//	var movie; // ï¿½ï¿½ï¿½[ï¿½rï¿½[ï¿½Iï¿½uï¿½Wï¿½Fï¿½Nï¿½g
	var movies = []; // ï¿½ï¿½ï¿½[ï¿½rï¿½[ï¿½Iï¿½uï¿½Wï¿½Fï¿½Nï¿½g

    function isMoviePlaying() {
        for (var i=0;i<numMovies;i++) {
            if (movies[i].canWaitStop) {
                return true;
            }
        }
        return false;
    }

    // ï¿½ï¿½ï¿½Ìƒeï¿½Lï¿½Xï¿½gï¿½\ï¿½ï¿½ï¿½Ì‘Oï¿½É‘Sï¿½{ï¿½Cï¿½Xï¿½ï¿½ï¿½Jï¿½bï¿½g
    /*C*/var voicecut = false;
    // ï¿½{ï¿½Cï¿½Xï¿½ï¿½ï¿½Jï¿½bï¿½gï¿½Ìƒ^ï¿½Cï¿½~ï¿½ï¿½ï¿½Oï¿½Íƒyï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
    /*C*/var voicecutpage = false;
    // ï¿½{ï¿½Cï¿½Xï¿½Äï¿½ï¿½ï¿½ï¿½ï¿½ bgm ï¿½ï¿½ï¿½_ï¿½Eï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
    /*C*/var bgmdown = false;
    
	var transCount; // ï¿½ï¿½ï¿½İiï¿½sï¿½ï¿½ï¿½Ìƒgï¿½ï¿½ï¿½ï¿½ï¿½Wï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Ìï¿½
	var moveCount; // ï¿½ï¿½ï¿½İiï¿½sï¿½ï¿½ï¿½Ìï¿½ï¿½ï¿½ï¿½Ú“ï¿½ï¿½Ìï¿½
    
	var chSpeeds = %[
		fast: 10, // ï¿½uï¿½ï¿½ï¿½ï¿½ï¿½vï¿½ï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½Xï¿½sï¿½[ï¿½h
		normal: 30, // ï¿½uï¿½ï¿½ï¿½Êvï¿½ï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½Xï¿½sï¿½[ï¿½h
		slow: 50, // ï¿½uï¿½xï¿½ï¿½ï¿½vï¿½ï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½Xï¿½sï¿½[ï¿½h
		];

	var userChSpeed = 30; // ï¿½ï¿½ï¿½[ï¿½Uï¿½Ì‘Iï¿½ñ‚¾•ï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½Xï¿½sï¿½[ï¿½h
	var userCh2ndSpeed = -1; // ï¿½ï¿½ï¿½[ï¿½Uï¿½Ì‘Iï¿½ï¿½ ï¿½ï¿½Ç•ï¿½ï¿½ï¿½ï¿½Ì•ï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½Xï¿½sï¿½[ï¿½h
	var chNonStopToPageBreak = false; // ï¿½yï¿½[ï¿½Wï¿½ï¿½ï¿½Ü‚Åˆï¿½Cï¿½É“Ç‚İiï¿½Ş‚ï¿½ ( l ï¿½^ï¿½Oï¿½ğ–³ï¿½ï¿½ï¿½ï¿½é‚© )
	var ch2ndNonStopToPageBreak = false; // ï¿½ï¿½Ç‚Ì•ï¿½ï¿½ï¿½ï¿½Åƒyï¿½[ï¿½Wï¿½ï¿½ï¿½Ü‚Åˆï¿½Cï¿½É“Ç‚İiï¿½Ş‚ï¿½
	/*C*/var chUserMode = true; // ï¿½ï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½ï¿½ï¿½xï¿½ÍŒï¿½ï¿½İƒï¿½ï¿½[ï¿½Uï¿½Ì‘Iï¿½ñ‚¾‚ï¿½ï¿½Ì‚ï¿½
	/*C*/var chSpeed = 30; // ï¿½ï¿½ï¿½İ‚Ì•ï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½Xï¿½sï¿½[ï¿½h
	/*C*/var actualChSpeed = chSpeed; // ï¿½ï¿½ï¿½Û‚Ì•ï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½Xï¿½sï¿½[ï¿½h

	/*C*/var beforeNoWaitActualChSpeed; // nowait ï¿½É“ï¿½ï¿½Oï¿½ï¿½ actualChSpeed
	/*C*/var beforeNoWaitChUserMode; // nowait ï¿½É“ï¿½ï¿½Oï¿½ï¿½ chUserMode

	/*C*/var clickSkipEnabled = true; // ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½Lï¿½ï¿½
	/*C*/var nextSkipEnabled = true; // ï¿½ï¿½ï¿½Ì‘Iï¿½ï¿½ï¿½ï¿½(/ï¿½ï¿½ï¿½ï¿½)ï¿½Ü‚Åiï¿½Ş‚ï¿½ï¿½Lï¿½ï¿½

    /*C*/var allskip   = false; // 0:ï¿½ï¿½Ç‚Ì‚İƒXï¿½Lï¿½bï¿½v 1:ï¿½Sï¿½ÄƒXï¿½Lï¿½bï¿½v
    /*C*/var afterauto = false; // ï¿½Iï¿½ï¿½ï¿½ï¿½Iï¿½[ï¿½g   1:ï¿½pï¿½ï¿½ 0:ï¿½ï¿½ï¿½ï¿½
    /*C*/var afterskip = false; // ï¿½Iï¿½ï¿½ï¿½ï¿½Xï¿½Lï¿½bï¿½v 1:ï¿½pï¿½ï¿½ 0:ï¿½ï¿½ï¿½ï¿½
    /*C*/var nosewhenskip = false; // 1:ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½ï¿½SEï¿½ï¿½ï¿½È‚ç‚³ï¿½È‚ï¿½

	var skipNoDispStartTime;
	var _skipNoDisp; // ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½É•\ï¿½ï¿½ï¿½ï¿½ï¿½È‚ï¿½
	var skipNoDispWin;

	property skipNoDisp {
		getter() {
			return _skipNoDisp;
		}
		setter(v) {
			_skipNoDisp = v;
			if (current !== void && currentNum == 0) {
				if(currentWithBack) current.comp.clear(elm.all);
				current.clear(true);
				if (v) {
					if (skipNoDispWin === void) {
						skipNoDispWin = new Layer(this, primaryLayer);
						skipNoDispWin.name = "ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ñƒŒƒCï¿½ï¿½";
						skipNoDispWin.setSize(scWidth, 30);
						skipNoDispWin.setPos(0, scHeight - 30);
						skipNoDispWin.hitThreshold = 256;
					}
					dm("ï¿½ï¿½ï¿½Ì‘Iï¿½ï¿½ï¿½ï¿½ï¿½Ü‚Å”ï¿½\ï¿½ï¿½ï¿½Xï¿½Lï¿½bï¿½vï¿½Jï¿½n");
					if (kag.historyWriteEnabled) {
						kag.historyLayer.clearAction();
						kag.historyLayer.reline();
					}
					skipNoDispStartTime = System.getTickCount();
				} else {
					if (skipNoDispWin !== void) {
						invalidate skipNoDispWin;
						skipNoDispWin = void;
					}
					dm("ï¿½Xï¿½Lï¿½bï¿½vï¿½É‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½:" + (System.getTickCount() - skipNoDispStartTime) + "(ms)");
				}
			}
		}
	}
	
    var _skipMode = SKIP_NONE; // ï¿½Xï¿½Lï¿½bï¿½vï¿½Ìƒï¿½ï¿½[ï¿½h
	// SKIP_NONE ï¿½Xï¿½Lï¿½bï¿½vï¿½È‚ï¿½, SKIP_CLICK ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Ò‚ï¿½ï¿½Lï¿½ï¿½ï¿½Ü‚ï¿½, SKIP_PAGE ï¿½ï¿½yï¿½[ï¿½Wï¿½Ò‚ï¿½ï¿½Lï¿½ï¿½ï¿½Ü‚ï¿½
	// SKIP_STOP ï¿½ï¿½ï¿½Ì’ï¿½~ï¿½Ü‚ï¿½ SKIP_FAST ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ SKIP_LABEL ï¿½ï¿½ï¿½Ìƒï¿½ï¿½xï¿½ï¿½ï¿½Ü‚Å‹ï¿½ï¿½ï¿½ï¿½Xï¿½Lï¿½bï¿½v
	// SKIP_CANCEL ï¿½ï¿½ï¿½ÌƒXï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½ï¿½ï¿½Ü‚Å‹ï¿½ï¿½ï¿½ï¿½Xï¿½Lï¿½bï¿½v
	// SKIP_FORCE ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½p
	property skipMode {
		getter() {
			return _skipMode;
		}
		setter(v) {
			_skipMode = v;
			if (v == SKIP_NONE && skipNoDisp) {
				skipNoDisp = false;
				if (typeof this.syncHandler != "undefined") {
					this.syncHandler();
				}
				// ï¿½vï¿½ï¿½ï¿½Oï¿½Cï¿½ï¿½ï¿½ÉƒVï¿½ï¿½ï¿½Nï¿½ï¿½ï¿½wï¿½ï¿½
				forEachEventHook('onSync',
								 function(handler, f) { handler(); } incontextof this);
			}
		}
	}
	
    // beginskip ï¿½ï¿½ï¿½ÌƒXï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½[ï¿½h
    var prevSkipMode;
    
    var autoMode = false; // ï¿½ï¿½ï¿½ï¿½ï¿½Ç‚İ‚ï¿½ï¿½ï¿½ï¿½İƒï¿½ï¿½[ï¿½hï¿½ï¿½ï¿½Ç‚ï¿½ï¿½ï¿½

    var autoModePageWait = 350; // ï¿½ï¿½ï¿½ï¿½ï¿½Ç‚İ‚ï¿½ï¿½ï¿½ï¿½İƒï¿½ï¿½[ï¿½hï¿½ï¿½ï¿½Ì‰ï¿½yï¿½[ï¿½Wï¿½ï¿½ï¿½ÌƒEï¿½Fï¿½Cï¿½g
	var autoModeLineWait = 50; // ï¿½ï¿½ï¿½ï¿½ï¿½Ç‚İ‚ï¿½ï¿½ï¿½ï¿½İƒï¿½ï¿½[ï¿½hï¿½ï¿½ï¿½Ìsï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Ò‚ï¿½ï¿½ï¿½ï¿½ÌƒEï¿½Fï¿½Cï¿½g
		// ï¿½ï¿½Ì“ï¿½Â‚ÍAï¿½mï¿½[ï¿½Eï¿½Fï¿½Cï¿½gï¿½É‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ê‡ï¿½ï¿½ 0 ï¿½Å‚Í‚È‚ï¿½ï¿½ï¿½ -4 ï¿½ï¿½ï¿½wï¿½è‚·ï¿½é‚±ï¿½ï¿½

    // ï¿½ï¿½ï¿½Zï¿½ï¿½ï¿½ï¿½ï¿½pï¿½î€ï¿½ï¿½ï¿½ï¿½
    var autoModeAddWait;
    /**
     * ï¿½ï¿½ï¿½ï¿½ï¿½Ò‚ï¿½ï¿½É’Ç‰ï¿½ï¿½ï¿½ï¿½Ô‚ï¿½ï¿½ï¿½ï¿½Zï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½iï¿½{ï¿½Cï¿½Xï¿½pï¿½j
     * @param time ï¿½ï¿½ï¿½Zï¿½ï¿½ï¿½ï¿½
     */
    function addAutoWait(time=void) {
        if (time !== void) {
            autoModeAddWait = System.getTickCount() + time;
        } else {
            autoModeAddWait = void;
        }
    }

    /**
     * ï¿½ï¿½ï¿½ï¿½ï¿½Ò‚ï¿½ï¿½ï¿½ï¿½Ô‚ÌŒvï¿½Zï¿½ï¿½ï¿½sï¿½ï¿½
     */
    function calcAutoModePageWait() {
        if (autoModeAddWait !== void) {
            var waittime = autoModeAddWait - System.getTickCount();
			if (waittime > 0) {
				waittime += autoModeLineWait*2; // 2ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½ğ‘«‚ï¿½
				return autoModePageWait > waittime ? autoModePageWait : waittime; // ï¿½å‚«ï¿½ï¿½ï¿½Ù‚ï¿½ï¿½ï¿½Ô‚ï¿½
            }
        }
        return autoModePageWait;
    }

    /**
     * ï¿½ï¿½ï¿½ï¿½ï¿½Ò‚ï¿½ï¿½ï¿½ï¿½Ô‚ÌŒvï¿½Zï¿½ï¿½ï¿½sï¿½ï¿½
     */
    function calcAutoModeLineWait() {
        if (autoModeAddWait !== void) {
            var waittime = autoModeAddWait - System.getTickCount();
            if (waittime > 0) {
                return autoModeLineWait > waittime ? autoModeLineWait : waittime; // ï¿½å‚«ï¿½ï¿½ï¿½Ù‚ï¿½ï¿½ï¿½Ô‚ï¿½
            }
        }
        return autoModeLineWait;
    }

    
	var skipKeyRepressed = false; // return ï¿½ï¿½ï¿½é‚¢ï¿½ï¿½ space ï¿½Lï¿½[ ( f ï¿½Lï¿½[ï¿½È‚Ç‚Å‚Í‚È‚ï¿½ )
								// ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ true ï¿½É‚È‚ï¿½ ( ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ false

	var autoModePageWaits = %[
		fast: 400,  // ï¿½ï¿½ï¿½ï¿½ï¿½Ç‚İ‚ï¿½ï¿½ï¿½ï¿½İƒï¿½ï¿½[ï¿½hï¿½Ì‰ï¿½yï¿½[ï¿½Wï¿½ï¿½ ï¿½Eï¿½Fï¿½Cï¿½gï¿½uï¿½Zï¿½ï¿½ï¿½v
		faster: 700,  // ï¿½ï¿½ï¿½ï¿½ï¿½Ç‚İ‚ï¿½ï¿½ï¿½ï¿½İƒï¿½ï¿½[ï¿½hï¿½Ì‰ï¿½yï¿½[ï¿½Wï¿½ï¿½ ï¿½Eï¿½Fï¿½Cï¿½gï¿½uï¿½ï¿½ï¿½Zï¿½ï¿½ï¿½v
		medium: 1000,  // ï¿½ï¿½ï¿½ï¿½ï¿½Ç‚İ‚ï¿½ï¿½ï¿½ï¿½İƒï¿½ï¿½[ï¿½hï¿½Ì‰ï¿½yï¿½[ï¿½Wï¿½ï¿½ ï¿½Eï¿½Fï¿½Cï¿½gï¿½uï¿½ï¿½ï¿½Êv
		slower: 1300, // ï¿½ï¿½ï¿½ï¿½ï¿½Ç‚İ‚ï¿½ï¿½ï¿½ï¿½İƒï¿½ï¿½[ï¿½hï¿½Ì‰ï¿½yï¿½[ï¿½Wï¿½ï¿½ ï¿½Eï¿½Fï¿½Cï¿½gï¿½uï¿½ï¿½ï¿½xï¿½ï¿½ï¿½v
		slow: 2000, // ï¿½ï¿½ï¿½ï¿½ï¿½Ç‚İ‚ï¿½ï¿½ï¿½ï¿½İƒï¿½ï¿½[ï¿½hï¿½Ì‰ï¿½yï¿½[ï¿½Wï¿½ï¿½ ï¿½Eï¿½Fï¿½Cï¿½gï¿½uï¿½xï¿½ï¿½ï¿½v
		];

	var autoModeLineWaits = %[
		fast: 180,  // ï¿½ï¿½ï¿½ï¿½ï¿½Ç‚İ‚ï¿½ï¿½ï¿½ï¿½İƒï¿½ï¿½[ï¿½hï¿½Ìsï¿½ï¿½ ï¿½Eï¿½Fï¿½Cï¿½gï¿½uï¿½Zï¿½ï¿½ï¿½v
		faster: 240,  // ï¿½ï¿½ï¿½ï¿½ï¿½Ç‚İ‚ï¿½ï¿½ï¿½ï¿½İƒï¿½ï¿½[ï¿½hï¿½Ìsï¿½ï¿½ ï¿½Eï¿½Fï¿½Cï¿½gï¿½uï¿½ï¿½ï¿½Zï¿½ï¿½ï¿½v
		medium: 300,  // ï¿½ï¿½ï¿½ï¿½ï¿½Ç‚İ‚ï¿½ï¿½ï¿½ï¿½İƒï¿½ï¿½[ï¿½hï¿½Ìsï¿½ï¿½ ï¿½Eï¿½Fï¿½Cï¿½gï¿½uï¿½ï¿½ï¿½Êv
		slower: 360, // ï¿½ï¿½ï¿½ï¿½ï¿½Ç‚İ‚ï¿½ï¿½ï¿½ï¿½İƒï¿½ï¿½[ï¿½hï¿½Ìsï¿½ï¿½ ï¿½Eï¿½Fï¿½Cï¿½gï¿½uï¿½ï¿½ï¿½xï¿½ï¿½ï¿½v
		slow: 500, // ï¿½ï¿½ï¿½ï¿½ï¿½Ç‚İ‚ï¿½ï¿½ï¿½ï¿½İƒï¿½ï¿½[ï¿½hï¿½Ìsï¿½ï¿½ ï¿½Eï¿½Fï¿½Cï¿½gï¿½uï¿½xï¿½ï¿½ï¿½v
		];

	/*C*/var canCancelSkipByClick = true; // ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½É‚ï¿½ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½Ô‚ÌƒLï¿½ï¿½ï¿½ï¿½ï¿½Zï¿½ï¿½ï¿½ï¿½ï¿½Å‚ï¿½ï¿½é‚©

	/*C*/var autoWCEnabled = false; // ï¿½ï¿½ï¿½ï¿½ï¿½Eï¿½Fï¿½Cï¿½gï¿½ï¿½ï¿½Lï¿½ï¿½Ç‚ï¿½ï¿½ï¿½
	/*C*/var autoWCChars = ""; // ï¿½ï¿½ï¿½ï¿½ï¿½Eï¿½Fï¿½Cï¿½gï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½é•¶ï¿½ï¿½
	var autoWCWaits = []; // ï¿½ï¿½ï¿½ï¿½ï¿½Eï¿½Fï¿½Cï¿½gï¿½ÌƒEï¿½Fï¿½Cï¿½g

	var timeOrigin; // resetWait ï¿½Åİ’è‚³ï¿½ê‚½ï¿½ï¿½ï¿½ÔŒï¿½ï¿½_
	var lastWaitTime; // wait mode=until ï¿½Åï¿½ï¿½Û‚É‘Ò‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½

	var stableHandlers = []; // ï¿½Vï¿½Xï¿½eï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½(ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Ò‚ï¿½/ï¿½ï¿½~)ï¿½ï¿½ï¿½ï¿½ï¿½Æ‚ï¿½ï¿½ÉŒÄ‚Î‚ï¿½ï¿½
	var runHandlers = []; // ï¿½Vï¿½Xï¿½eï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½nï¿½ß‚ï¿½ï¿½Æ‚ï¿½ï¿½ÉŒÄ‚Î‚ï¿½ï¿½
	var inStable = true; // ï¿½ï¿½ï¿½è‚µï¿½Ä‚ï¿½ï¿½ï¿½Æ‚ï¿½(ï¿½ï¿½ï¿½sï¿½ï¿½ï¿½Å‚È‚ï¿½ï¿½Æ‚ï¿½) true
	var inSleep = false; // s ï¿½^ï¿½Oï¿½Å’ï¿½~ï¿½ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½Æ‚ï¿½ true

	var updateBeforeCh = 0; // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½`ï¿½æ‚·ï¿½ï¿½Oï¿½É‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê•`ï¿½ï¿½É“ï¿½é‚©ï¿½Ç‚ï¿½ï¿½ï¿½ï¿½ÌƒJï¿½Eï¿½ï¿½ï¿½g

	var messageLayerHiding = false; // ï¿½ï¿½ï¿½[ï¿½Uï¿½É‚ï¿½èƒï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½Bï¿½ï¿½ï¿½ï¿½Ä‚ï¿½ï¿½é‚©

	/*C*/var rightClickEnabled = true; // ï¿½Eï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½ï¿½ï¿½Lï¿½ï¿½
	/*C*/var rightClickCall = false; // ï¿½Eï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Å“ï¿½ï¿½ï¿½Ìƒï¿½ï¿½[ï¿½`ï¿½ï¿½ï¿½ï¿½ï¿½Ä‚Ô‚ï¿½
	/*C*/var rightClickJump = false; // ï¿½Eï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½ï¿½ï¿½Å“ï¿½ï¿½ï¿½Ìƒï¿½ï¿½xï¿½ï¿½ï¿½ÉƒWï¿½ï¿½ï¿½ï¿½ï¿½vï¿½ï¿½ï¿½é‚©
	/*C*/var rightClickTarget = ""; // ï¿½Eï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Å‚ÌŒÄ‚Ñoï¿½ï¿½ï¿½ï¿½
	/*C*/var rightClickStorage = ""; // ï¿½Eï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Å‚ÌŒÄ‚Ñoï¿½ï¿½ï¿½ï¿½
	/*C*/var rightClickName = "default"; // ï¿½Eï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Ìƒï¿½ï¿½jï¿½ï¿½ï¿½[ï¿½\ï¿½ï¿½ï¿½ï¿½
	/*C*/var rightClickCurrentMenuName = ""; // ï¿½Eï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Ìƒï¿½ï¿½jï¿½ï¿½ï¿½[ï¿½ÉŒï¿½ï¿½İİ’è‚³ï¿½ï¿½Ä‚ï¿½ï¿½é–¼ï¿½O
	var rightClickDefaultName = ""; // ï¿½Eï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Ìƒfï¿½tï¿½Hï¿½ï¿½ï¿½gï¿½Ìƒï¿½ï¿½jï¿½ï¿½ï¿½[ï¿½\ï¿½ï¿½ï¿½ï¿½

	/*C*/var lastClickGlyphVisible; // extraConductor ï¿½ï¿½ï¿½gï¿½pï¿½ï¿½ï¿½é’¼ï¿½Oï¿½ÉƒNï¿½ï¿½ï¿½bï¿½Nï¿½Ò‚ï¿½ï¿½Lï¿½ï¿½ï¿½ï¿½ï¿½Âï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ç‚ï¿½ï¿½ï¿½
	var lastClickGlyphMessagePage;
		// extraConductor ï¿½ï¿½ï¿½gï¿½pï¿½ï¿½ï¿½é’¼ï¿½Oï¿½ÌƒNï¿½ï¿½ï¿½bï¿½Nï¿½Ò‚ï¿½ï¿½Lï¿½ï¿½ï¿½Ì•\ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ä‚ï¿½ï¿½éƒï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ìƒyï¿½[ï¿½W
	var lastClickGlyphMessageNum; // ï¿½V ï¿½Ôï¿½
	var lastClickGlyphWhich; // ï¿½V "page" ï¿½ï¿½ "line" ï¿½ï¿½
	var inSleepBeforeExtraConductor; // extraConductor ï¿½ï¿½ï¿½gï¿½pï¿½ï¿½ï¿½é’¼ï¿½Oï¿½ï¿½ inSleep ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½

	// ï¿½Êï¿½Ìƒ}ï¿½Eï¿½Xï¿½Jï¿½[ï¿½\ï¿½ï¿½
	/*C*/var cursorDefault = crArrow;  // ï¿½Êï¿½Ìƒ}ï¿½Eï¿½Xï¿½Jï¿½[ï¿½\ï¿½ï¿½
	/*C*/var cursorPointed = crHandPoint;  // ï¿½{ï¿½^ï¿½ï¿½ï¿½Aï¿½ï¿½ï¿½ï¿½ï¿½Nï¿½ï¿½ï¿½ï¿½ï¿½|ï¿½Cï¿½ï¿½ï¿½gï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ìƒ}ï¿½Eï¿½Xï¿½Jï¿½[ï¿½\ï¿½ï¿½
	/*C*/var cursorWaitingClick = crArrow;  // ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Ò‚ï¿½ï¿½Ìƒ}ï¿½Eï¿½Xï¿½Jï¿½[ï¿½\ï¿½ï¿½
	/*C*/var cursorDraggable = crSizeAll; // ï¿½hï¿½ï¿½ï¿½bï¿½Oï¿½Â”\ï¿½ÈêŠï¿½pï¿½Ìƒ}ï¿½Eï¿½Xï¿½Jï¿½[ï¿½\ï¿½ï¿½

	/*C*/var startAnchorEnabled = false; // ï¿½uï¿½Åï¿½ï¿½É–ß‚ï¿½vï¿½ï¿½ï¿½gï¿½pï¿½Â”\ï¿½ï¿½ï¿½Ç‚ï¿½ï¿½ï¿½

	/*C*/var storeEnabled = true; // ï¿½ï¿½ï¿½[ï¿½Uï¿½ï¿½ï¿½uï¿½xï¿½ï¿½ï¿½Í‚ï¿½ï¿½Şvï¿½ï¿½ï¿½jï¿½ï¿½ï¿½[ï¿½ÉƒAï¿½Nï¿½Zï¿½Xï¿½Â”\ï¿½ï¿½ï¿½Ç‚ï¿½ï¿½ï¿½
	/*C*/var restoreEnabled = true; // ï¿½ï¿½ï¿½[ï¿½Uï¿½ï¿½ï¿½uï¿½xï¿½ï¿½ï¿½ï¿½ï¿½Ç‚ï¿½vï¿½ï¿½ï¿½jï¿½ï¿½ï¿½[ï¿½ÉƒAï¿½Nï¿½Zï¿½Xï¿½Â”\ï¿½ï¿½ï¿½Ç‚ï¿½ï¿½ï¿½
	var storeLabelPassed = false; // ï¿½Û‘ï¿½ï¿½Â”\ï¿½Èƒï¿½ï¿½xï¿½ï¿½ï¿½ï¿½Ê‰ß‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ç‚ï¿½ï¿½ï¿½
    /*C*/var currentStorage = ""; // ï¿½ï¿½ï¿½İ‚Ìƒï¿½ï¿½xï¿½ï¿½
    /*C*/var currentLabel = ""; // ï¿½ï¿½ï¿½İ‚Ìƒï¿½ï¿½xï¿½ï¿½
	/*C*/var currentPageName = ""; // ï¿½ï¿½ï¿½İ‚Ìƒyï¿½[ï¿½Wï¿½ï¿½

	var currentRecordName = ""; // ï¿½ï¿½ï¿½İ‚Ì‹Lï¿½^ï¿½ï¿½ ( trail_ï¿½Xï¿½gï¿½ï¿½ï¿½[ï¿½W_ï¿½ï¿½ï¿½xï¿½ï¿½ )
	var autoRecordPageShowing = false; // ï¿½ï¿½ï¿½xï¿½ï¿½ï¿½Ê‰ß‹Lï¿½^ï¿½ï¿½ï¿½ï¿½ï¿½é‚©

	var numBookMarks = 10; // ï¿½ï¿½ï¿½jï¿½ï¿½ï¿½[ï¿½É—pï¿½Ó‚ï¿½ï¿½ï¿½xï¿½ÌƒTï¿½uï¿½ï¿½ï¿½jï¿½ï¿½ï¿½[ï¿½ï¿½ï¿½Ú‚Ìï¿½
	var showBookMarkDate = false; // ï¿½ï¿½ï¿½jï¿½ï¿½ï¿½[ï¿½Éxï¿½ï¿½ï¿½Í‚ï¿½ï¿½ñ‚¾“ï¿½tï¿½ï¿½ï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½ï¿½ï¿½é‚©

    var bookMarkDateSecond = false; // ï¿½ï¿½tï¿½É•bï¿½Ü‚Å‚Ó‚ï¿½ï¿½ß‚é‚©

    // ï¿½vï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½
    var playTime;
    var playStartTime;

    function clearPlayTime(initTime = 0) {
        playTime = initTime;
        playStartTime = (new Date()).getTime();
    }
    
	var bookMarkNames = []; // ï¿½ï¿½ï¿½jï¿½ï¿½ï¿½[ï¿½Éİ’è‚³ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½xï¿½Ì–ï¿½ï¿½O
	var bookMarkDates = []; // ï¿½xï¿½Ì“ï¿½t
    var bookMarkProtectedStates = []; // ï¿½xï¿½ï¿½ï¿½ÛŒì‚³ï¿½ï¿½Ä‚ï¿½ï¿½é‚©ï¿½Ìï¿½ï¿½
    var bookMarkStorages  = []; // ï¿½xï¿½ÌƒVï¿½iï¿½ï¿½ï¿½Iï¿½ï¿½
    var bookMarkPlayTimes = [];  // ï¿½xï¿½Ìƒvï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½
    var bookMarkInfos = [];     // ï¿½xï¿½Ì’Ç‰ï¿½ï¿½ï¿½ï¿½

	var showFixedPitchOnlyInFontSelector = false; // ï¿½tï¿½Hï¿½ï¿½ï¿½gï¿½Iï¿½ï¿½ï¿½ÅŒÅ’ï¿½sï¿½bï¿½gï¿½tï¿½Hï¿½ï¿½ï¿½gï¿½Ì‚İ‚ï¿½\ï¿½ï¿½ï¿½ï¿½ï¿½é‚©

	var flags = %[]; // ï¿½tï¿½ï¿½ï¿½O(ï¿½ï¿½ï¿½[ï¿½U)
	var pflags = %[]; // ï¿½uï¿½Û‘ï¿½ï¿½Â”\ï¿½Èƒï¿½ï¿½xï¿½ï¿½ï¿½vï¿½ï¿½Ê‰ß‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½_ï¿½Å‚Ìƒtï¿½ï¿½ï¿½O(ï¿½ï¿½ï¿½[ï¿½U)
	var pcflags = %[]; // ï¿½V (ï¿½Rï¿½A)
	var sflags = %[]; // ï¿½Vï¿½Xï¿½eï¿½ï¿½ï¿½Ïï¿½ï¿½Ìˆï¿½(ï¿½ï¿½ï¿½[ï¿½U)
	var scflags = %[]; // ï¿½Vï¿½Xï¿½eï¿½ï¿½ï¿½Ïï¿½ï¿½Ìˆï¿½(ï¿½Rï¿½A)
	var tflags = %[]; // ï¿½êï¿½tï¿½ï¿½ï¿½O

	var tempBookMarks = []; // ï¿½êï¿½Iï¿½É•Û‘ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½x

	var clickCount = 0; // ï¿½ï¿½ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Jï¿½Eï¿½ï¿½ï¿½g
	var lastMouseDownX; // ï¿½ÅŒï¿½ÉƒNï¿½ï¿½ï¿½bï¿½Nï¿½ï¿½ï¿½ê‚½ X ï¿½ï¿½ï¿½W
	var lastMouseDownY; // ï¿½ÅŒï¿½ÉƒNï¿½ï¿½ï¿½bï¿½Nï¿½ï¿½ï¿½ê‚½ Y ï¿½ï¿½ï¿½W

	var mouseKeyEnabledCount = 0; // ï¿½}ï¿½Eï¿½Xï¿½Lï¿½[ï¿½ï¿½ï¿½Lï¿½ï¿½Ç‚ï¿½ï¿½ï¿½

	var kagPlugins = []; // KAG ï¿½vï¿½ï¿½ï¿½Oï¿½Cï¿½ï¿½

	var keyDownHook = []; // ï¿½Lï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ê‚½ï¿½Æ‚ï¿½ï¿½ÉŒÄ‚Ñoï¿½ï¿½ï¿½ï¿½é•¨
	var leftClickHook = []; // ï¿½Eï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½ï¿½ï¿½ê‚½ï¿½Æ‚ï¿½ï¿½ÉŒÄ‚Ñoï¿½ï¿½ï¿½ï¿½é•¨
	var rightClickHook = []; // ï¿½ï¿½ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½ï¿½ï¿½ê‚½ï¿½Æ‚ï¿½ï¿½ÉŒÄ‚Ñoï¿½ï¿½ï¿½ï¿½é•¨

	var padKeyMap; // ï¿½pï¿½bï¿½hï¿½{ï¿½^ï¿½ï¿½ -> ï¿½nï¿½ï¿½ï¿½hï¿½ï¿½(ï¿½Lï¿½[ï¿½Rï¿½[ï¿½h)ï¿½Bï¿½Rï¿½ï¿½ï¿½Xï¿½gï¿½ï¿½ï¿½Nï¿½^ï¿½ï¿½ï¿½Åİ’ï¿½
	var padKeyMapReverse; // ï¿½Lï¿½[ï¿½Rï¿½[ï¿½h -> ï¿½pï¿½bï¿½hï¿½{ï¿½^ï¿½ï¿½ï¿½Bï¿½Rï¿½ï¿½ï¿½Xï¿½gï¿½ï¿½ï¿½Nï¿½^ï¿½ï¿½ï¿½Åİ’ï¿½


	var holdPeriodEventQueue = [];	// ï¿½Û—ï¿½ï¿½É‚ï¿½ï¿½ê‚½ï¿½ï¿½ï¿½[ï¿½rï¿½[ï¿½Ìƒsï¿½ï¿½ï¿½Iï¿½hï¿½Cï¿½xï¿½ï¿½ï¿½gï¿½Lï¿½ï¿½ï¿½[
	var isLeavePeriodEvent = false;	// ï¿½ï¿½ï¿½[ï¿½rï¿½[ï¿½Ìƒsï¿½ï¿½ï¿½Iï¿½hï¿½Cï¿½xï¿½ï¿½ï¿½gï¿½ï¿½Û—ï¿½ï¿½É‚ï¿½ï¿½é‚©ï¿½Ç‚ï¿½ï¿½ï¿½
	var isWaitPeriodEvent = false;	// ï¿½ï¿½ï¿½[ï¿½rï¿½[ï¿½Ìƒsï¿½ï¿½ï¿½Iï¿½hï¿½Cï¿½xï¿½ï¿½ï¿½gï¿½Ò‚ï¿½ï¿½ï¿½Ô‚ï¿½ï¿½Ç‚ï¿½ï¿½ï¿½
	var waitedPeriodEventStorageName = void;	// ï¿½sï¿½ï¿½ï¿½Iï¿½hï¿½Cï¿½xï¿½ï¿½ï¿½gï¿½Ò‚ï¿½ï¿½ï¿½ï¿½Rï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Xï¿½gï¿½ï¿½ï¿½[ï¿½Wï¿½ï¿½

    // ------------------------------------------------------ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½ï¿½

    var autoLabelMode; // true:ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½h
    var autoLabelType; // 0:ï¿½ÔÚƒï¿½ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½h 1:ï¿½sï¿½Ôï¿½ï¿½wï¿½èƒï¿½[ï¿½h
    var autoLabelCount;  // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½xï¿½ï¿½ï¿½Jï¿½Eï¿½ï¿½ï¿½^
	var autoLabelCurrentRecordName; // ï¿½ï¿½ï¿½ï¿½ï¿½Û‘ï¿½ï¿½pï¿½Lï¿½^ï¿½ï¿½

	// ï¿½fï¿½oï¿½bï¿½Oï¿½pï¿½@ï¿½\
	var autoLabelSaveMode; // ï¿½ï¿½ï¿½xï¿½ï¿½ï¿½Åï¿½ï¿½ï¿½ï¿½Iï¿½ÉƒZï¿½[ï¿½uï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½sï¿½ï¿½ï¿½éƒ‚ï¿½[ï¿½h

    // ------------------------------------------------------ ï¿½ï¿½zï¿½Äï¿½ï¿½ï¿½ï¿½ï¿½

    var recollectionBookmark = 5000; 
    var recollectionEndLabel; // ï¿½ï¿½zï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½xï¿½ï¿½
    var recollectionStorage;  // ï¿½ï¿½zï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½Ì‘Jï¿½Úï¿½Xï¿½gï¿½ï¿½ï¿½[ï¿½W
    var recollectionTarget;   // ï¿½ï¿½zï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½Ì‘Jï¿½Úï¿½^ï¿½[ï¿½Qï¿½bï¿½g

    /**
     * ï¿½ï¿½zï¿½ï¿½ï¿½ï¿½ï¿½Ç‚ï¿½ï¿½ï¿½
     */
    property isRecollection {
        getter() {
            return recollectionEndLabel !== void;
        }
    }
    
    /**
     * ï¿½ï¿½zï¿½ï¿½ï¿½[ï¿½hï¿½ï¿½ï¿½sï¿½ï¿½ï¿½Jï¿½nï¿½ï¿½ï¿½ï¿½
     */
    function startRecollection(elm) {
        if (elm.no !== void) {
            var num = (int)elm.no;
            // ï¿½ï¿½ï¿½[ï¿½hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ isRecollection ï¿½ï¿½Lï¿½ï¿½É‚ï¿½ï¿½é‚½ï¿½ß‚Æ‚è‚ ï¿½ï¿½ï¿½ï¿½ï¿½İ’ï¿½
            recollectionEndLabel = true;
            if (loadBookMark(recollectionBookmark + num)) {
                // ï¿½ï¿½ï¿½[ï¿½hï¿½ï¿½ï¿½ï¿½ï¿½Åï¿½ï¿½ï¿½ï¿½ï¿½Ä‚ï¿½Ì‚Å‚ï¿½ï¿½ï¿½ï¿½ï¿½xï¿½İ’ï¿½
                recollectionEndLabel = "*kaisouEnd" + num;
                recollectionStorage  = elm.doneStorage;
                recollectionTarget   = elm.doneTarget;
            } else {
                process(elm.doneStorage, elm.doneTarget);
            }
        } else if (elm.storage !== void || elm.target !== void) {
            process(elm.storage, elm.target);
            recollectionEndLabel = "*kaisouEndStorage";
            recollectionStorage  = elm.doneStorage;
            recollectionTarget   = elm.doneTarget;
        }
    }

    /**
     * ï¿½ï¿½zï¿½ï¿½ï¿½[ï¿½hï¿½ï¿½ï¿½sï¿½ï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
     */
    function endRecollection() {
        // ï¿½ï¿½zï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
        if (isRecollection) {
            var ret = -1;
            if (recollectionStorage != '' || recollectionTarget != '') {
                // ï¿½ï¿½ï¿½sï¿½ï¿½oï¿½^ï¿½Aï¿½hï¿½ï¿½ï¿½Xï¿½ÉˆÚ‚ï¿½
                if (recollectionStorage != '') {
                    conductor.loadScenario(recollectionStorage);
                }
                if (recollectionTarget != '') {
                    conductor.goToLabel(recollectionTarget);
                }
                inSleep = false;
                notifyRun();
                if (conductor.status != conductor.mRun) conductor.run();
                ret = 0;
            } else {
                // ï¿½ï¿½ï¿½sï¿½ï¿½~
                stablePosibility = true;
                cancelSkip();
                isSleep = true;
                notifyStable();
            }
            stopRecollection();
            return ret;
        }
        return 0;
    }
    
    function stopRecollection() {
        recollectionEndLabel = void;
        recollectionStorage = void;
        recollectionTarget  = void;
    }
    
	//------------------------------------------------------ ï¿½_ï¿½Cï¿½Aï¿½ï¿½ï¿½Oï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ --

    var currentDialog;
    
    function handleOpenDialog() {
        if (currentDialog !== void) {
            stopAllTransitions();
            cancelSkip();
            currentDialog.parent   = primaryLayer;
            currentDialog.absolute = 9000000;
            currentDialog.visible = true;
            currentDialog.setMode();
            currentDialog.focus();
            currentDialog.onOpen();
        }
        setMenuAccessibleAll();
    }

    function handleCloseDialog() {
        if (this isvalid) {
            if (currentDialog !== void) {
                currentDialog.visible = false;
                currentDialog.removeMode();
                invalidate currentDialog;
                currentDialog = void;
            }
            if (this isvalid) {
                kag.setMenuAccessibleAll();
            }
        }
    }

    /**
     * ï¿½_ï¿½Cï¿½Aï¿½ï¿½ï¿½Oï¿½ï¿½ï¿½Jï¿½ï¿½
     */
    function openDialog(dialog, trans) {
        if (currentDialog !== void &&
            currentDialog !== dialog) {
            invalidate currentDialog;
        }

        mainConductor.interrupted = true;
        extraConductor.interrupted = true;
        setMenuAccessibleAll();

        currentDialog = dialog;
        global.openDialogTrigger = new AsyncTrigger(handleOpenDialog, '');
        global.openDialogTrigger.cached = true;
        global.openDialogTrigger.trigger();
    }

    function closeDialog(dialog=void) {
        if (currentDialog !== void && (dialog === void || currentDialog === dialog)) {
            if (mainConductor.interrupted) {
                mainConductor.interrupted  = false;
            }
            if (extraConductor.interrupted) {
                extraConductor.interrupted = false;
            }
            setMenuAccessibleAll();
            
            if (currentDialog !== void) {
                global.closeDialogTrigger = new AsyncTrigger(handleCloseDialog, '');
                global.closeDialogTrigger.cached = true;
                global.closeDialogTrigger.trigger();
            }
        } else if (dialog !== void) {
            dialog.visible = false;
        }
    }

    //------------------------------------------------------ ï¿½ï¿½ï¿½ï¿½^ï¿½Cï¿½} --

    /**
     * ï¿½ï¿½ÊXï¿½Vï¿½ï¿½ï¿½ï¿½
     */
	function onFlipTimerInterval(now) {
		var work = false;
		
		// ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Xï¿½V
		updateAction(now);
		work = true if actionCount > 0;
		
		updateLayerMovies();
		work = true if movieLayers.count > 0;
		
		// ï¿½ï¿½ÊØ‚ï¿½Ö‚ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Xï¿½V
		if (_transLayer !== void) {
			_transLayer.update(now);
			work = true if _transLayer.working;
		}

		if (!work) {
			flipStop();
		}
	}

	function flipStart() {
		flipStop();
		System.addContinuousHandler(onFlipTimerInterval);
	}

	function flipStop() {
		System.removeContinuousHandler(onFlipTimerInterval);
	}
	
	//------------------------------------------------------ ï¿½Rï¿½ï¿½ï¿½Xï¿½gï¿½ï¿½ï¿½Nï¿½^ --

	function KAGWindow(ismain = true, width = 0, height = 0, invisible = false)
	{
		// ï¿½Rï¿½ï¿½ï¿½Xï¿½gï¿½ï¿½ï¿½Nï¿½^
		// ï¿½ï¿½ : ismain : ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Eï¿½Bï¿½ï¿½ï¿½hï¿½Eï¿½Æ‚ï¿½ï¿½Äì¬ï¿½ï¿½ï¿½ï¿½ï¿½Ì‚ï¿½ï¿½Ç‚ï¿½ï¿½ï¿½
		super.Window(); // ï¿½eï¿½Nï¿½ï¿½ï¿½Xï¿½ÌƒRï¿½ï¿½ï¿½Xï¿½gï¿½ï¿½ï¿½Nï¿½^ï¿½ï¿½ï¿½Ä‚ï¿½

		// ï¿½Rï¿½ï¿½ï¿½tï¿½Bï¿½Mï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½Vï¿½ï¿½ï¿½ï¿½
		isMain = ismain;
		if(ismain)
		{
			(KAGWindow_config incontextof this)();
			(KAGWindow_config_override incontextof this)()
				if typeof global.KAGWindow_config_override != "undefined";
		}

		// savedataid ï¿½Ìã‘ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		if (typeof global.ENV_GameId != "undefined") {
			saveDataID = global.ENV_GameId;
		}
		
		userChSpeed = chSpeed = actualChSpeed = chSpeeds.normal;
		autoModePageWait = autoModePageWaits.medium;
		autoModeLineWait = autoModeLineWaits.medium;

		askOnClose = false if !ismain;

		// saveDataLocation ï¿½ï¿½ï¿½tï¿½ï¿½ï¿½pï¿½Xï¿½Å‚È‚ï¿½ï¿½æ‚¤ï¿½È‚ï¿½ï¿½ System.exePath ï¿½ï¿½
		// ï¿½tï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		if(saveDataLocation.indexOf(":") == -1)
			saveDataLocation = System.exePath + saveDataLocation;

        // ï¿½Zï¿½[ï¿½uï¿½Â”\ï¿½ï¿½ï¿½Ç‚ï¿½ï¿½ï¿½ï¿½ÌŠmï¿½F
        checkSave();
        
		// ï¿½ï¿½ï¿½Oï¿½Ìoï¿½Íï¿½ï¿½ saveDataLocation ï¿½É‚ï¿½ï¿½ï¿½
		if(ismain) Debug.logLocation = saveDataLocation;
        
		// ï¿½ï¿½ï¿½jï¿½ï¿½ï¿½[ï¿½Aï¿½Cï¿½eï¿½ï¿½ï¿½Ìì¬
		if(ismain) (KAGWindow_createMenus incontextof this)();
		if(typeof this.rightClickMenuItem != "undefined")
			rightClickDefaultName = rightClickCurrentMenuName = rightClickMenuItem.caption;

		if(typeof this.autoModeMediumMenuItem != "undefined")
			autoModeMediumMenuItem.checked = true;
		if(typeof this.windowedMenuItem != "undefined")
			windowedMenuItem.checked = true;
		if(typeof this.chNormalMenuItem != "undefined")
			chNormalMenuItem.checked = true;
		if(typeof this.ch2ndNoChangeMenuItem != "undefined")
			ch2ndNoChangeMenuItem.checked = true;

		if(ismain) (Menu_visible_config incontextof this)();

		createBookMarkSubMenus();

		// ï¿½Eï¿½Bï¿½ï¿½ï¿½hï¿½Eï¿½Oï¿½ï¿½ï¿½Ì’ï¿½ï¿½ï¿½
		if(ismain)
		{
			borderStyle = bsSingle;
			innerSunken = true;
		}
		else
		{
			borderStyle = bsDialog;
			innerSunken = false;
		}
		showScrollBars = false;
		if(ismain) caption = System.title;

		// ï¿½Vï¿½Xï¿½eï¿½ï¿½ï¿½^ï¿½Cï¿½gï¿½ï¿½ï¿½ï¿½ï¿½Lï¿½ï¿½ï¿½vï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Æ“ï¿½ï¿½ï¿½ï¿½ï¿½
		//if(ismain) System.title = caption;

		// ï¿½Eï¿½Bï¿½ï¿½ï¿½hï¿½Eï¿½Tï¿½Cï¿½Yï¿½Ì’ï¿½ï¿½ï¿½
		if(width != 0 && height != 0)
		{
			// ï¿½^ï¿½ï¿½ï¿½ï¿½ê‚½ï¿½Tï¿½Cï¿½Yï¿½ï¿½Kï¿½p
			scWidth = width;
			scHeight = height;
		}

		// quake ï¿½pï¿½^ï¿½Cï¿½}ï¿½Ìì¬
		quakeTimer = new Timer(onQuakeTimerInterval, '');
		add(quakeTimer);
		quakeTimer.interval = 50;

        // ï¿½xï¿½[ï¿½Xï¿½É‚È‚éƒŒï¿½Cï¿½ï¿½
        sysbase = new Layer(this, null);
        sysbase.setSize(scWidth, scHeight);
        sysbase.hasImage = false;
        add(sysbase);

        // ï¿½wï¿½iï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ìì¬
		fore.messages = [];
		back.messages = [];
		fore.layers = [];
		back.layers = [];
        fore.base = new BaseLayer(this, sysbase, "ï¿½\-ï¿½wï¿½i");
        add(fore.base);
        fore.base.setImageSize(scWidth, scHeight);
        fore.base.setSizeToImageSize();
        fore.base.visible = true;
        back.base = new BaseLayer(this, sysbase, "ï¿½ï¿½-ï¿½wï¿½i");
        add(back.base);
        back.base.setImageSize(scWidth, scHeight);
		back.base.setSizeToImageSize();

        fore.base.setCompLayer(back.base);
		back.base.setCompLayer(fore.base);
		fore.base.freeImage();
		back.base.freeImage();

		fore.base.setDefaultCursor(cursorDefault);
		back.base.setDefaultCursor(cursorDefault);

        // ï¿½ï¿½ï¿½äƒŒï¿½Cï¿½ï¿½ ï¿½wï¿½iï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ìï¿½
        fore.stage = new StageLayer(this, fore.base, "ï¿½\-ï¿½ï¿½ï¿½ï¿½", "stage");
        add(fore.stage);
        fore.stage.setImageSize(scWidth, scHeight);
        fore.stage.setSizeToImageSize();
        fore.stage.absolute = 100;
        back.stage = new StageLayer(this, back.base, "ï¿½ï¿½-ï¿½ï¿½ï¿½ï¿½", "stage");
        add(back.stage);
        back.stage.setImageSize(scWidth, scHeight);
        back.stage.setSizeToImageSize();
        back.stage.absolute = 100;
        fore.stage.setCompLayer(back.stage);
		back.stage.setCompLayer(fore.stage);
		fore.stage.freeImage();
		back.stage.freeImage();
        
        // ï¿½Cï¿½xï¿½ï¿½ï¿½gï¿½ï¿½ï¿½Cï¿½ï¿½ ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ì‰ï¿½
        fore.event = new StageLayer(this, fore.base, "ï¿½\-ï¿½Cï¿½xï¿½ï¿½ï¿½g", "event");
        add(fore.event);
        fore.event.setImageSize(scWidth, scHeight);
        fore.event.setSizeToImageSize();
        fore.event.absolute = 6 * 100000 - 100;
        back.event = new StageLayer(this, back.base, "ï¿½ï¿½-ï¿½Cï¿½xï¿½ï¿½ï¿½g", "event");
        add(back.event);
        back.event.setImageSize(scWidth, scHeight);
        back.event.setSizeToImageSize();
        back.event.absolute = 6 * 100000 - 100;
        fore.event.setCompLayer(back.event);
		back.event.setCompLayer(fore.event);
		fore.event.freeImage();
		back.event.freeImage();
        
		// ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ìì¬
        historyLayer = new HistoryLayer(this, fore.base);
        historyLayer.name = "ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½";
		add(historyLayer);

		// ï¿½Oï¿½iï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ìì¬
		allocateCharacterLayers(numCharacterLayers);

		// ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ìì¬
		allocateMessageLayers(numMessageLayers, false);
		current = fore.messages[0];
		currentNum = 0;
		currentPage = 0;
		currentWithBack = false;
		if(initialMessageLayerVisible)
		{
			fore.messages[0].visible = true;
			back.messages[0].visible = true;
		}

		chDefaultAntialiased = fore.messages[0].defaultAntialiased;
			// ï¿½ï¿½ï¿½ï¿½ï¿½ÉƒAï¿½ï¿½ï¿½`ï¿½Gï¿½Cï¿½ï¿½ï¿½Aï¿½Xï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½é‚©ï¿½Ç‚ï¿½ï¿½ï¿½
		chDefaultFace = fore.messages[0].userFace;
			// ï¿½ï¿½ï¿½ï¿½ï¿½Ìƒfï¿½tï¿½Hï¿½ï¿½ï¿½gï¿½Ìƒtï¿½Hï¿½ï¿½ï¿½g

		if(typeof this.chAntialiasMenuItem != "undefined")
			chAntialiasMenuItem.checked = chDefaultAntialiased;

		// ï¿½sï¿½Ò‚ï¿½/ï¿½yï¿½[ï¿½Wï¿½Ò‚ï¿½ï¿½Aï¿½jï¿½ï¿½ï¿½[ï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ìì¬
		lineBreak = new ClickGlyphLayer(this, fore.base);
		add(lineBreak);
		lineBreak.name = "ï¿½sï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Ò‚ï¿½ï¿½Lï¿½ï¿½";
		pageBreak = new ClickGlyphLayer(this, fore.base);
		add(pageBreak);
		pageBreak.name = "ï¿½yï¿½[ï¿½Wï¿½ï¿½ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Ò‚ï¿½ï¿½Lï¿½ï¿½";

		// ï¿½^ï¿½Oï¿½nï¿½ï¿½ï¿½hï¿½ï¿½/ï¿½Rï¿½ï¿½ï¿½_ï¿½Nï¿½^ï¿½ï¿½ï¿½ì¬
		tagHandlers = getHandlers();
        mainConductor = new Conductor(this, tagHandlers);
		add(mainConductor);
		conductor = mainConductor;
		extraConductor = new Conductor(this, tagHandlers);
		add(extraConductor);

        // ï¿½Rï¿½ï¿½ï¿½_ï¿½Nï¿½^ï¿½Ìƒfï¿½oï¿½bï¿½Oï¿½ï¿½ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½wï¿½ï¿½
        debugLevel = _debugLevel;
        
		// BGM ï¿½Iï¿½uï¿½Wï¿½Fï¿½Nï¿½gï¿½ï¿½ï¿½ì¬
		bgm = new BGM(this);
		add(bgm);

		// ï¿½ï¿½Ê‰ï¿½ï¿½Iï¿½uï¿½Wï¿½Fï¿½Nï¿½gï¿½ï¿½ï¿½ì¬
        for(var i = 0; i < numSEBuffers+1; i++)
            add(se[i] = new SESoundBuffer(this, i));

		// ï¿½ï¿½ï¿½[ï¿½rï¿½[ï¿½Iï¿½uï¿½Wï¿½Fï¿½Nï¿½gï¿½ï¿½ï¿½ì¬
		if(ismain)
		{
			for( var i = 0; i < numMovies; i++)
				add(movies[i] = new Movie(this,i));
		}

		// ï¿½fï¿½tï¿½Hï¿½ï¿½ï¿½gï¿½Ìƒnï¿½ï¿½ï¿½hï¿½ï¿½ï¿½ï¿½Ç‰ï¿½
		stableHandlers.add(defaultStableHandler);
		runHandlers.add(defaultRunHandler);

		// ï¿½Vï¿½Xï¿½eï¿½ï¿½ï¿½Ïï¿½ï¿½Ì“Ç‚İï¿½ï¿½ï¿½
		if(ismain) loadSystemVariables();

		// ï¿½Vï¿½Xï¿½eï¿½ï¿½ï¿½Ïï¿½ï¿½ğ”½‰f
		if(ismain)
		{
			setSystemStateFromSystemVariables();
			setBookMarkMenuCaptions();
		}

		// ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ÌƒNï¿½ï¿½ï¿½A
		clearMessageLayers(false);

		// ï¿½Yï¿½[ï¿½ï¿½ï¿½ï¿½Ô•â³
		if (ismain && scflags.zoomNumer != 0 && scflags.zoomDenom != 0) {
			setZoom(scflags.zoomNumer, scflags.zoomDenom);
		} else {
			setZoom(1,1);
		}

		// ï¿½Eï¿½Bï¿½ï¿½ï¿½hï¿½Eï¿½Ê’uï¿½Ì’ï¿½ï¿½ï¿½
		if(this.width + this.left > System.desktopLeft + System.desktopWidth)
			left = ((System.desktopWidth - this.width) >>1) + System.desktopLeft;
		if(this.height + this.top > System.desktopTop + System.desktopHeight)
			top = ((System.desktopHeight - this.height) >>1) + System.desktopTop;

		// ï¿½pï¿½bï¿½hï¿½{ï¿½^ï¿½ï¿½ï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Ìì¬
		createPadKeyMap();

		// ï¿½Eï¿½Bï¿½ï¿½ï¿½hï¿½Eï¿½ï¿½\ï¿½ï¿½
		if(ismain) visible = !invisible;

		// ï¿½ï¿½ÊƒTï¿½Cï¿½Yï¿½ï¿½ï¿½Eï¿½Bï¿½ï¿½ï¿½hï¿½Eï¿½Tï¿½Cï¿½Yï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ê‡ï¿½ï¿½
		// ï¿½tï¿½ï¿½ï¿½Xï¿½Nï¿½ï¿½ï¿½[ï¿½ï¿½ï¿½É‚ï¿½ï¿½Ä‚İ‚ï¿½
		if(ismain && visible)
		{
			// ï¿½ï¿½ï¿½Tï¿½Cï¿½Y
			var w = scWidth  * zoomNumer / zoomDenom;
			var h = scHeight * zoomNumer / zoomDenom;
			if(System.screenWidth <= w && System.screenHeight <= h)
				onFullScreenMenuItemClick(this);
		}

		// ï¿½Oï¿½ï¿½Nï¿½ï¿½ï¿½ï¿½ï¿½Éƒtï¿½ï¿½ï¿½Xï¿½Nï¿½ï¿½ï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ê‡ï¿½Íƒtï¿½ï¿½ï¿½Xï¿½Nï¿½ï¿½ï¿½[ï¿½ï¿½ï¿½É‚ï¿½ï¿½Ä‚İ‚ï¿½
		if(ismain && visible)
		{
			if(scflags.fullScreen !== void && +scflags.fullScreen)
				onFullScreenMenuItemClick(this);
		}

		// ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Vï¿½Xï¿½eï¿½ï¿½ï¿½Ïï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½oï¿½ï¿½
		if(ismain) {
			// scflags.fullScreen ï¿½ï¿½ï¿½jï¿½ï¿½ï¿½Ä‚ï¿½ï¿½Ü‚ï¿½ï¿½ï¿½ï¿½ß•Û‘ï¿½
			var origfs = scflags.fullScreen;

			saveSystemVariables();

			// !visible ï¿½ï¿½ï¿½ï¿½ scflags.fullScreen ï¿½ğ•œ‹A
			scflags.fullScreen = origfs if (!visible);
		}
	}

	//------------------------------------------------------------- finalize --

	function finalize()
	{
		// finalize ï¿½ï¿½ï¿½\ï¿½bï¿½h
		stopAllActions();
		flipStop();

		if (debugControl) {
            wmrStop(this);
        }
        
        clearBgmStop();
        clearBgmLabel();
        
		// ï¿½vï¿½ï¿½ï¿½Oï¿½Cï¿½ï¿½ï¿½Ì–ï¿½ï¿½ï¿½
		for(var i = 0; i < kagPlugins.count; i++) invalidate kagPlugins[i];

		// ï¿½Oï¿½iï¿½Aï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ğ–³Œï¿½
		for(var i = 0; i< fore.layers.count; i++) invalidate fore.layers[i];
		for(var i = 0; i< back.layers.count; i++) invalidate back.layers[i];
		for(var i = 0; i< fore.messages.count; i++) invalidate fore.messages[i];
		for(var i = 0; i< back.messages.count; i++) invalidate back.messages[i];

        // ï¿½ï¿½ï¿½ï¿½Eï¿½Cï¿½xï¿½ï¿½ï¿½gï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ğ–³Œï¿½
        invalidate fore.stage;
        invalidate back.stage;
        invalidate fore.event;
        invalidate back.event;
        
		// snapshotLayer ï¿½ğ–³Œï¿½
		invalidate snapshotLayer if snapshotLayer !== void;

		// tempLayer ï¿½ğ–³Œï¿½
		invalidate tempLayer if tempLayer !== void;

		// ï¿½Xï¿½[ï¿½pï¿½[ï¿½Nï¿½ï¿½ï¿½Xï¿½ï¿½ finalize ï¿½ï¿½ï¿½Ä‚ï¿½
		super.finalize(...);
	}

	//-------------------------------------------------- onCloseQuery/close --

    function onCloseYes() {
        shutdown();
    }

	function onCloseQuery()
	{
		saveSystemVariables();
        if(!askOnClose) { super.onCloseQuery(true); return; }
        if (currentDialog === void) {
            askYesNo("ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½Ü‚ï¿½ï¿½ï¿½ï¿½H", "ï¿½mï¿½F", onCloseYes);
        }
        super.onCloseQuery(false);
    }

	function close()
	{
		// ï¿½Eï¿½Bï¿½ï¿½ï¿½hï¿½Eï¿½ï¿½Â‚ï¿½ï¿½ï¿½
		saveSystemVariables();
		super.close(...);
	}

	function shutdown()
	{
		// ï¿½Eï¿½Bï¿½ï¿½ï¿½hï¿½Eï¿½ï¿½Â‚ï¿½ï¿½é‚ªï¿½Aï¿½Iï¿½ï¿½ï¿½mï¿½Fï¿½ï¿½ï¿½sï¿½ï¿½È‚ï¿½
		// ï¿½ï¿½ï¿½Ìƒï¿½ï¿½\ï¿½bï¿½hï¿½ï¿½ï¿½ï¿½ close ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ÆAï¿½lï¿½Xï¿½ï¿½
		// ï¿½Iï¿½uï¿½Wï¿½Fï¿½Nï¿½gï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ä‚ï¿½ï¿½Ü‚ï¿½ï¿½Aï¿½ï¿½ï¿½ï¿½
		// ï¿½Öï¿½ï¿½ï¿½ï¿½ï¿½ß‚ï¿½ï¿½ï¿½ï¿½ï¿½ÅƒGï¿½ï¿½ï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½B
		// ï¿½ï¿½ï¿½Ì‚ï¿½ï¿½ßAï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ AsyncTrigger ï¿½ï¿½ï¿½î‚µï¿½ÄA
		// ï¿½Sï¿½Ä‚Ìƒï¿½ï¿½\ï¿½bï¿½hï¿½ï¿½ï¿½ï¿½Aï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æ‚ÉƒVï¿½ï¿½ï¿½bï¿½gï¿½_ï¿½Eï¿½ï¿½
		// ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½sï¿½ï¿½ï¿½B
		global.shutdownTrigger =
			new AsyncTrigger(handleShutdown, '');
		global.shutdownTrigger.cached = true;
		global.shutdownTrigger.trigger();
		if(conductor.status == conductor.mRun)
			conductor.interrupt();
			// ï¿½Rï¿½ï¿½ï¿½_ï¿½Nï¿½^ï¿½ï¿½ï¿½ï¿½ï¿½sï¿½ï¿½ï¿½Ìï¿½ï¿½ï¿½
			// ï¿½Rï¿½ï¿½ï¿½_ï¿½Nï¿½^ï¿½É’ï¿½ï¿½fï¿½ï¿½`ï¿½ï¿½ï¿½ï¿½
	}

	function handleShutdown()
	{
		// shutdown() ï¿½ï¿½ï¿½ï¿½ÌƒVï¿½ï¿½ï¿½bï¿½gï¿½_ï¿½Eï¿½ï¿½ï¿½vï¿½ï¿½ï¿½ï¿½
		// ï¿½ï¿½ï¿½Û‚Éï¿½ï¿½ï¿½ï¿½ï¿½ï¿½éƒï¿½\ï¿½bï¿½h
		var askOnClose_save = askOnClose;
		askOnClose = false;
		close();
		if(this isvalid) askOnClose = askOnClose_save;
	}

	function closeByScript(elm)
	{
		// ï¿½Eï¿½Bï¿½ï¿½ï¿½hï¿½Eï¿½ï¿½Â‚ï¿½ï¿½ï¿½
		// ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æ–Ê“|ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æ‚ï¿½ï¿½ï¿½ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½Ì‚ï¿½
		// shutdown ï¿½Æ“ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½R
		// ï¿½uï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½vï¿½ï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ÄƒEï¿½Bï¿½ï¿½ï¿½hï¿½Eï¿½ï¿½ï¿½Â‚ï¿½ï¿½È‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ê‡ï¿½ï¿½
		// 'not_closed' ï¿½gï¿½ï¿½ï¿½Kï¿½ï¿½ï¿½ï¿½ï¿½sï¿½ï¿½ï¿½ï¿½Aï¿½ï¿½ï¿½sï¿½ÍÄŠJï¿½ï¿½ï¿½ï¿½B
		var askOnClose_save = askOnClose;
		if(elm.ask !== void && !(+elm.ask)) askOnClose = false;
		global.shutdownTrigger =
			new AsyncTrigger(handleCloseByScript, '');
		global.shutdownTrigger.cached = true;
		global.shutdownTrigger.trigger();

		// closeByScript ï¿½ÍAï¿½ï¿½ï¿½Ìƒnï¿½ï¿½ï¿½hï¿½ï¿½ï¿½ï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		// ï¿½uï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½Ü‚ï¿½ï¿½ï¿½ï¿½Hï¿½vï¿½Ìƒ_ï¿½Cï¿½Aï¿½ï¿½ï¿½Oï¿½ï¿½\ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½B
		// ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ê‡ï¿½Í‚ï¿½ï¿½Ì‚Ü‚ÜIï¿½ï¿½ï¿½ï¿½ï¿½ï¿½B
		// ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½È‚ï¿½ï¿½ê‡ï¿½ï¿½ 'not_closed' ï¿½gï¿½ï¿½ï¿½Kï¿½ï¿½ï¿½ï¿½ï¿½sï¿½ï¿½ï¿½ï¿½A
		// ï¿½ï¿½ï¿½sï¿½ÍŒpï¿½ï¿½ï¿½ï¿½ï¿½ï¿½B
		conductor.wait(%[
			not_closed : askOnClose_save
			? (function
			{
				// ï¿½ï¿½ï¿½Û‚É‚ï¿½ï¿½ê‚ªï¿½Ä‚Î‚ï¿½é‚±ï¿½Æ‚Í‚È‚ï¿½ï¿½ï¿½ï¿½Aï¿½ê‰
				askOnClose = true;
			} incontextof this)
			: (function
			{
			} incontextof this)
			]);
	}

	function handleCloseByScript()
	{
		// shutdown() ï¿½ï¿½ï¿½ï¿½ÌƒVï¿½ï¿½ï¿½bï¿½gï¿½_ï¿½Eï¿½ï¿½ï¿½vï¿½ï¿½ï¿½ï¿½
		// ï¿½ï¿½ï¿½Û‚Éï¿½ï¿½ï¿½ï¿½ï¿½ï¿½éƒï¿½\ï¿½bï¿½h
		close();
		if(this isvalid) // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ê‚½ï¿½ê‡
			conductor.trigger('not_closed');
	}

	//------------------------------------------------------ ï¿½vï¿½ï¿½ï¿½Oï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ --

	function forEachEventHook(method, func, arg)
	{
		// ï¿½ï¿½ï¿½×‚Ä‚Ìƒvï¿½ï¿½ï¿½Oï¿½Cï¿½ï¿½ï¿½Iï¿½uï¿½Wï¿½Fï¿½Nï¿½gï¿½ï¿½ method ï¿½É‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		// func ï¿½ï¿½ï¿½ï¿½ï¿½sï¿½ï¿½ï¿½ï¿½
		// func ï¿½Ìˆï¿½É‚ÍŠeï¿½vï¿½fï¿½ï¿½ arg ï¿½ï¿½ï¿½nï¿½ï¿½ï¿½ï¿½ï¿½
		if(kagPlugins.count)
		{
			var array = [];
			array.assign(kagPlugins); // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Rï¿½sï¿½[ï¿½ï¿½ï¿½Aï¿½Rï¿½sï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½É‘Î‚ï¿½ï¿½Äï¿½ï¿½sï¿½ï¿½ï¿½ï¿½
			var arraycount = array.count;
			for(var i =0; i<arraycount; i++)
			{
				var obj = array[i];
				if(typeof obj[method] != "undefined")
					func(obj[method], arg);
			}
		}
	}

	function addPlugin(plugin)
	{
		// ï¿½vï¿½ï¿½ï¿½Oï¿½Cï¿½ï¿½ï¿½Iï¿½uï¿½Wï¿½Fï¿½Nï¿½gï¿½ï¿½Ç‰ï¿½
		kagPlugins.add(plugin);
	}

	function removePlugin(plugin)
	{
		// ï¿½vï¿½ï¿½ï¿½Oï¿½Cï¿½ï¿½ï¿½Iï¿½uï¿½Wï¿½Fï¿½Nï¿½gï¿½ï¿½ï¿½íœ
		kagPlugins.remove(plugin);
	}

	//---------------------------------------------------------- ï¿½tï¿½bï¿½Nï¿½ï¿½ï¿½ï¿½ --

	function callHook(array, arg1, arg2, arg3)
	{
		if(array.count)
		{
			var processed = false;
			var newarray = [];
			newarray.assign(array);
			var arraycount = newarray.count;
			for(var i  = 0; i < arraycount; i++)
			{
				var func = newarray[i];
				var ret = func(arg1, arg2, arg3);
				processed = processed || ret;
			}
			return processed;
		}
		else
		{
			return false;
		}
	}

	//------------------------------------------ ï¿½pï¿½bï¿½hï¿½ÌƒLï¿½[ï¿½}ï¿½bï¿½sï¿½ï¿½ï¿½Oï¿½ì¬ --

	function createPadKeyMap()
	{
		// ï¿½pï¿½bï¿½hï¿½ï¿½Í‚Æ‚ï¿½ï¿½ï¿½É‘Î‰ï¿½ï¿½ï¿½ï¿½é“®ï¿½ï¿½Ìƒ}ï¿½bï¿½sï¿½ï¿½ï¿½Oï¿½B
		// ï¿½Wï¿½ï¿½ï¿½Å‚Í\ï¿½ï¿½ï¿½Lï¿½[ï¿½ÍƒLï¿½[ï¿½{ï¿½[ï¿½hï¿½ÌƒJï¿½[ï¿½\ï¿½ï¿½ï¿½Lï¿½[ï¿½Éƒ}ï¿½bï¿½sï¿½ï¿½ï¿½Oï¿½A
		// ï¿½{ï¿½^ï¿½ï¿½1 ï¿½ï¿½ Returnï¿½Aï¿½{ï¿½^ï¿½ï¿½2 ï¿½ï¿½ ESCï¿½Aï¿½{ï¿½^ï¿½ï¿½3 ï¿½ï¿½ ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½Ì•\ï¿½ï¿½
		// ï¿½Éƒ}ï¿½bï¿½sï¿½ï¿½ï¿½Oï¿½ï¿½ï¿½ï¿½ï¿½B
		// ï¿½Öï¿½ï¿½ï¿½ï¿½wï¿½è‚µï¿½ï¿½ï¿½ê‡ï¿½Íƒ{ï¿½^ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æ‚ï¿½ï¿½É‚Í‚ï¿½ï¿½ÌŠÖï¿½ï¿½ï¿½ï¿½Ä‚Î‚ï¿½ï¿½B

		padKeyMap = %[
			VK_PADLEFT =>		VK_LEFT,
			VK_PADRIGHT =>		VK_RIGHT,
			VK_PADUP =>			VK_UP,
			VK_PADDOWN =>		VK_DOWN,
			VK_PAD1 =>			VK_RETURN,
			VK_PAD2 =>			VK_ESCAPE,
			VK_PAD3 =>
				function(ev) {
					showHistoryByKey(this);
				},
			];

		// padKeyMapReverse ï¿½ï¿½ï¿½ì¬
		padKeyMapReverse = %[];
		var ar = [];
		ar.assign(padKeyMap);
		for(var i = 0; i < ar.count; i += 2)
		{
			if(typeof(ar[i+1]) != "Object")
			{
				padKeyMapReverse[ar[i+1]] = ar[i];
			}
		}
	}

	function getKeyState(key)
	{
		// System.getKeyState ï¿½Öï¿½ï¿½Æ“ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Aï¿½pï¿½bï¿½hï¿½ÌƒLï¿½[ï¿½ÉŠÖ‚ï¿½ï¿½Ä‚ï¿½
		// ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ô‚ï¿½
		var sg = System.getKeyState;
		var state = sg(key);
		if(state) return true;
		var pad_key = padKeyMapReverse[key];
		if(pad_key !== void)
		{
			// ï¿½Lï¿½[ï¿½Rï¿½[ï¿½h -> ï¿½pï¿½bï¿½hï¿½ÌƒLï¿½[ï¿½Rï¿½[ï¿½hï¿½Ì•ÏŠï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Â‚ï¿½ï¿½ï¿½ï¿½ï¿½
			return sg(pad_key);
		}
		return false;
	}

	//-------------------------------------------------------------- action --

	function action(ev)
	{
        if(ev.type == 'onKeyDown' && ev.target === this)
		{
            // ï¿½pï¿½bï¿½hï¿½ï¿½Í‚É‘Î‰ï¿½ï¿½ï¿½ï¿½éˆï¿½ï¿½
			var handler = padKeyMap[ev.key];
			if(handler !== void)
			{
				// ï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Â‚ï¿½ï¿½ï¿½ï¿½ï¿½
				if(typeof(handler) == "Object")
				{
					// ï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½ÍŠÖï¿½
					(handler incontextof this)(ev);
				}
				else
				{
					// ï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½ÍƒLï¿½[ï¿½Rï¿½[ï¿½h
					postInputEvent('onKeyDown', %[key: handler]);
					postInputEvent('onKeyUp', %[key: handler]);
				}
			}
		}
	}

	//------------------------------------------------------ tempLayer ï¿½Ö˜A --

	property temporaryLayer
	{
		// ï¿½ï¿½ï¿½[ï¿½Nï¿½Gï¿½ï¿½ï¿½Aï¿½Æ‚ï¿½ï¿½Äˆêï¿½Iï¿½Égï¿½pï¿½Å‚ï¿½ï¿½éƒŒï¿½Cï¿½ï¿½ï¿½ï¿½Ô‚ï¿½
		getter()
		{
			if(tempLayer === void)
			{
				tempLayer = new KAGLayer(this, primaryLayer);
				tempLayer.name = "ï¿½êï¿½ï¿½ï¿½[ï¿½Nï¿½ï¿½ï¿½Cï¿½ï¿½";
			}
			return tempLayer;
		}
	}

	//------------------------------------------------ ï¿½ï¿½ï¿½jï¿½ï¿½ï¿½[ï¿½Aï¿½Cï¿½eï¿½ï¿½ï¿½Ö˜A --

	function onExitMenuItemClick(sender)
	{
		close();
	}

	function onRightClickMenuItemClick(sender)
	{
		onPrimaryRightClick(); // ï¿½Eï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Ì“ï¿½ï¿½ï¿½
	}

	function onShowHistoryMenuItemClick(sender)
	{
		if(historyLayer.visible) hideHistory(); else showHistory();
	}

	function onSkipToNextStopMenuItemClick(sender)
	{
        if (skipMode) cancelSkip(); else skipToStop();
        setMenuAccessibleAll();
	}


    function onAutoLabelSaveModeMenuItemClick(sender)
    {
        autoLabelSaveMode = !autoLabelSaveMode;
        if (autoLabelSaveMode) {
            canDebugControl();
        } 
        if (typeof this.autoLabelSaveModeMenuItem != "undefined") {
            autoLabelSaveModeMenuItem.checked = autoLabelSaveMode;
        }
        if (typeof this.skipToPrevLabelMenuItem != "undefined") {
            skipToPrevLabelMenuItem.enabled = autoLabelSaveMode;
        }
    }

    
	function onSkipToNextLabelMenuItemClick(sender)
	{
        if (skipMode) cancelSkip(); else skipToLabel();
        setMenuAccessibleAll();
	}

	function onSkipToPrevLabelMenuItemClick(sender)
	{
		if (autoLabelSaveMode) {
			// ï¿½Oï¿½ï¿½ï¿½cï¿½[ï¿½ï¿½ï¿½É—ï¿½ï¿½ï¿½
            var exefile = "%stools\\searchprev.exe".sprintf(
                Storages.getLocalName(System.exePath));
            var param = "\"%s\" \"%s\" %d".sprintf(
                Storages.getLocalName(System.exeName),
                Storages.getLocalName(Storages.getPlacedPath(pcflags.mainConductor.storageName)),
                pcflags.mainConductor.curLine);
            System.shellExecute(exefile, param);
        }
    }
    
	function onAutoModeMenuItemClick(sender)
	{
        if(autoMode) {
			cancelAutoMode();
        } else {
            enterAutoMode();
        }
        setMenuAccessibleAll();
    }

	function onAutoModeWaitMenuClick(sender)
	{
		sender.checked = true;
		autoModePageWait = sender.wait;
		autoModeLineWait = sender.lwait;
	}

	function onBackStartMenuItemClick(sender)
	{
		goBackHistory();
	}

	function onGoToStartMenuItemClick(sender)
	{
		goToStartWithAsk();
	}

    function onAllSkipMenuItemClick(sender)
    {
		sender.checked = true;
        allskip = sender.skip;
		saveSystemVariables();
    }
    
	function onChSpeedMenuItemClick(sender)
	{
		sender.checked = true;
		userChSpeed = sender.speed;
		setUserSpeed();
		saveSystemVariables();
	}

	function onChNonStopToPageBreakItemClick(sender)
	{
		chNonStopToPageBreak = ! chNonStopToPageBreak;
		if(typeof this.chNonStopToPageBreakItem != "undefined")
			chNonStopToPageBreakItem.checked = chNonStopToPageBreak;
			saveSystemVariables();
	}

	function onCh2ndNonStopToPageBreakItemClick(sender)
	{
		ch2ndNonStopToPageBreak = ! ch2ndNonStopToPageBreak;
		if(typeof this.ch2ndNonStopToPageBreakItem != "undefined")
			ch2ndNonStopToPageBreakItem.checked = ch2ndNonStopToPageBreak;
			saveSystemVariables();
	}

	function onCh2ndSpeedMenuItemClick(sender)
	{
		sender.checked = true;
		userCh2ndSpeed = sender.speed;
		setUserSpeed();
		saveSystemVariables();
	}

	function onChAntialiasMenuItemClick(sender)
	{
		chDefaultAntialiased = !chDefaultAntialiased;
		if(typeof this.chAntialiasMenuItem != "undefined")
			chAntialiasMenuItem.checked = chDefaultAntialiased;
		setMessageLayerUserFont();
		saveSystemVariables();
	}

	function onChChangeFontMenuItem(sender)
	{
		selectFont();
		saveSystemVariables();
	}

	function onRestoreMenuClick(sender)
	{
		if(!freeSaveDataMode) return;
		loadBookMarkFromFileWithAsk();
	}

	function onStoreMenuClick(sender)
	{
		if(!freeSaveDataMode) return;
		saveBookMarkToFileWithAsk();
	}

	function setZoom(numer, denom) {
		if (!fullScreen) {
			super.setZoom(numer, denom);
			setInnerSize(scWidth * zoomNumer / zoomDenom,
						 scHeight * zoomNumer / zoomDenom);
			top++, top--; // VCRï¿½Èƒï¿½ï¿½[ï¿½rï¿½[ï¿½ï¿½ï¿½Ç]ï¿½ï¿½ï¿½ï¿½æ‚¤ï¿½É‚ï¿½ï¿½Ü‚ï¿½ï¿½È‚ï¿½ XXX
		}
	}
	
	function onWindowedMenuItemClick(sender)
	{
		if(fullScreened)
		{
			try
			{
				fullScreen = false;
				setZoom(zoomNumer, zoomDenom);
			}
			catch(e)
			{
				Debug.notice("ï¿½Eï¿½Bï¿½ï¿½ï¿½hï¿½Eï¿½ï¿½ï¿½[ï¿½hï¿½ÉˆÚsï¿½Å‚ï¿½ï¿½Ü‚ï¿½ï¿½ï¿½Å‚ï¿½ï¿½ï¿½ : " + e.message);
			}
			fullScreened = fullScreen;
			if(fullScreened)
				fullScreenMenuItem.checked = true;
			else
				windowedMenuItem.checked = true;
		}
		saveSystemVariables();
	}

	function onFullScreenMenuItemClick(sender)
	{
		if(!fullScreened)
		{
			try
			{
				setInnerSize(scWidth, scHeight);
				fullScreen = true;
			}
			catch(e)
			{
				Debug.notice("ï¿½tï¿½ï¿½ï¿½Xï¿½Nï¿½ï¿½ï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½hï¿½ÉˆÚsï¿½Å‚ï¿½ï¿½Ü‚ï¿½ï¿½ï¿½Å‚ï¿½ï¿½ï¿½ : " + e.message);
			}
			fullScreened = fullScreen;
			if(fullScreened)
				fullScreenMenuItem.checked = true;
			else
				windowedMenuItem.checked = true;
		}
		saveSystemVariables();
	}

	function onHelpIndexMenuItemClick(sender)
	{
		// ï¿½wï¿½ï¿½ï¿½vï¿½tï¿½@ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½Jï¿½ï¿½
		System.shellExecute(Storages.getLocalName(System.exePath) + helpFile);
	}

	function onHelpAboutMenuItemClick(sender)
	{
		// ï¿½uï¿½ï¿½ï¿½Ìƒ\ï¿½tï¿½gï¿½É‚Â‚ï¿½ï¿½Ävï¿½Eï¿½Bï¿½ï¿½ï¿½hï¿½Eï¿½ï¿½\ï¿½ï¿½
		var win = this.helpAboutWindow = new global.KAGWindow(false, aboutWidth, aboutHeight);
		win.debugLevel = tkdlNone;
		win.borderStyle = bsToolWindow;
		win.setInnerSize(aboutWidth, aboutHeight);
		win.setPos(left + ((width - win.width)>>1), top + ((height - win.height)>>1));
		win.rightClickMenuItem = new KAGMenuItem(this, "RightClick", 0, win.onRightClickMenuItemClick, false); // ESCï¿½Åï¿½ï¿½ï¿½ï¿½ï¿½æ‚¤ï¿½ï¿½
		win.process(aboutStorage ,,, true); // about.ks ï¿½ï¿½ immediate ï¿½Å•\ï¿½ï¿½
		win.showModal(); // ï¿½ï¿½ï¿½[ï¿½hï¿½tï¿½ï¿½ï¿½Å•\ï¿½ï¿½
		invalidate win.rightClickMenuItem;
		invalidate win;
		delete this.helpAboutWindow;
	}

    // ï¿½Vï¿½iï¿½ï¿½ï¿½Iï¿½ï¿½ï¿½sï¿½_ï¿½Cï¿½Aï¿½ï¿½ï¿½Oï¿½Ä‚Ñoï¿½ï¿½
    function onExecDialogMenuItemClick(sender)
    {
        execDialog();
    }

    function onChDebugLogMenuItemClick(sender) {
        logMode = !logMode;
        if (typeof sender != "undefined") {
            sender.checked = logMode;
        }
        initLog();
    }

    function onOutputDebugLogMenuItemClick(sender) {
        outputLog();
    }
    
	function onReloadScenarioMenuItemClick(sender)
	{
		saveBookMark(1000, false);
		loadBookMark(1000);
	}

	function onShowConsoleMenuItemClick(sender)
	{
		Debug.console.visible = true;
	}

	function onShowContollerMenuItemClick(sender)
	{
		Debug.controller.visible = true;
	}

	function internalSetMenuAccessibleAll(menu, state)
	{
		// autoEnable ï¿½ï¿½ true ï¿½Ì‚ï¿½ï¿½×‚Ä‚Ìƒï¿½ï¿½jï¿½ï¿½ï¿½[ï¿½ï¿½ï¿½Ú‚ï¿½ accessible ï¿½É’l state ï¿½ï¿½
		// ï¿½İ’è‚·ï¿½ï¿½
		if(typeof menu.autoEnable != "undefined" && menu.autoEnable)
			menu.accessible = state;
		if(typeof menu.stopRecur == "undefined" || !menu.stopRecur)
		{
			var children = menu.children;
			for(var i = children.count -1; i >= 0; i--)
				internalSetMenuAccessibleAll(children[i], state); // ï¿½Ä‹A
		}
	}

	function canStore()
	{
		return storeEnabled && storeLabelPassed && !isRecollection;
	}

	function canRestore()
	{
		return restoreEnabled && !isRecollection;
	}

	function setMenuAccessibleAll()
	{
		// ï¿½ï¿½ï¿½jï¿½ï¿½ï¿½[ï¿½ï¿½ï¿½Ú‚Ìgï¿½pï¿½ï¿½/ï¿½sï¿½Â‚ï¿½İ’è‚·ï¿½ï¿½

		// autoEnable ï¿½ï¿½ true ï¿½Ì‚ï¿½ï¿½×‚Ä‚Ìƒï¿½ï¿½jï¿½ï¿½ï¿½[ï¿½ï¿½ï¿½Ú‚ï¿½ accessible ï¿½ï¿½
		// ï¿½lï¿½ï¿½İ’è‚·ï¿½ï¿½
        var modal = historyLayer.visible || messageLayerHiding || currentDialog || panelModal;
        var state = inStable && !modal;
        internalSetMenuAccessibleAll(menu, state);

        // ï¿½ï¿½ï¿½Ì‘ï¿½ï¿½Ìƒï¿½ï¿½jï¿½ï¿½ï¿½[ï¿½Ìgï¿½pï¿½ï¿½/ï¿½sï¿½ï¿½
        var canSkip = !modal && (inStable || skipMode) && !inSleep && nextSkipEnabled && (allskip || getCurrentRead()) && !selectShowing && !mapSelectShowing && !transShowing && !panelShowing;
        //dm("canSkip:" + canSkip);
        if(typeof this.skipToNextStopMenuItem != "undefined")
            skipToNextStopMenuItem.enabled = canSkip;

		if(typeof this.rightClickMenuItem != "undefined")
            rightClickMenuItem.enabled = inStable && !historyLayer.visible && !currentDialog;

		if(typeof this.showHistoryMenuItem != "undefined")
            showHistoryMenuItem.enabled = inStable && !messageLayerHiding && !mapSelectShowing && !transShowing && !currentDialog && !panelModal &&
				historyEnabled;

        var canAuto = !modal && (inStable || autoMode) && !inSleep && !skipMode && !selectShowing && !mapSelectShowing && !transShowing && !panelShowing;
        if(typeof this.autoModeMenuItem != "undefined")
            autoModeMenuItem.enabled = canAuto;

		if(typeof this.goBackMenuItem != "undefined")
			goBackMenuItem.enabled = state && isHistoryOfStoreAlive();

		if(typeof this.goToStartMenuItem != "undefined")
			goToStartMenuItem.enabled = state && startAnchorEnabled;

		if(typeof this.exitMenuItem != "undefined")
			exitMenuItem.enabled = !currentDialog;

		if(typeof this.storeMenu != "undefined")
		{
			var st = state && canStore();
			var children = storeMenu.children;
			if(freeSaveDataMode) storeMenu.enabled = st;
			for(var i = children.count - 1; i >= 0; i--)
			{
				var obj = children[i];
				obj.enabled = obj.orgEnabled && st;
			}
		}

		if(typeof this.restoreMenu != "undefined")
		{
			var st = state && canRestore();
			var children = restoreMenu.children;
			if(freeSaveDataMode) restoreMenu.enabled = st;
			for(var i = children.count - 1; i >= 0; i--)
			{
				var obj = children[i];
				obj.enabled = obj.orgEnabled && st;
			}
		}

        // ï¿½Sï¿½ï¿½ï¿½ï¿½
		if (this == global.Window.mainWindow && typeof global.onModeChange !== "undefined") {
			global.onModeChange(this, autoMode, skipMode, canAuto, canSkip, selectShowing || mapSelectShowing || transShowing || panelShowing, modal);
		}
    }

	//----------------------------------------------- ï¿½}ï¿½Eï¿½Xï¿½Lï¿½[ï¿½ï¿½Lï¿½ï¿½É‚ï¿½ï¿½ï¿½ --

	function enableMouseKey()
	{
		// ï¿½}ï¿½Eï¿½Xï¿½Lï¿½[ï¿½ï¿½Lï¿½ï¿½É‚ï¿½ï¿½ï¿½
		if(mouseKeyEnabledCount == 0)
		{
			useMouseKey = true;
			mouseCursorState = mcsVisible;
		}
		mouseKeyEnabledCount++; // ï¿½Qï¿½ÆƒJï¿½Eï¿½ï¿½ï¿½^ï¿½ï¿½
	}

	function disableMouseKey()
	{
		// ï¿½}ï¿½Eï¿½Xï¿½Lï¿½[ï¿½ğ–³Œï¿½É‚ï¿½ï¿½ï¿½
		mouseKeyEnabledCount --;
		if(mouseKeyEnabledCount == 0) useMouseKey = false;
	}

	//----------------------------------------------------- ï¿½Vï¿½Xï¿½eï¿½ï¿½ï¿½Ïï¿½ï¿½Ö˜A --

    /**
     * ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½İƒeï¿½Xï¿½gï¿½ï¿½ï¿½sï¿½ï¿½
     */
    function checkSave()
    {
		if(!readOnlyMode) {
			
			var appName = (typeof global.ENV_Maker != "undefined") ? global.ENV_Maker + "/" + global.ENV_GameName : System.title;
/*
			// ï¿½Zï¿½[ï¿½uï¿½êŠï¿½Ìï¿½ï¿½ï¿½ï¿½Ö‚ï¿½
			var udp = Storages.chopStorageExt(System.exeName) + ".udp";
			if(Storages.isExistentStorage(udp)) {
				var vars = [];
				vars.load(udp);
				if (vars[0] == "document") {
					if (System.personalPath != System.exePath) {
						saveDataLocation = System.personalPath + appName;
					}
				} else if (vars[0] == "application") {
					if (System.appDataPath != System.exePath) {
						saveDataLocation = System.appDataPath + appName;
					}
				}
			}
*/
			// ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½İŒï¿½ï¿½ï¿½ï¿½eï¿½Xï¿½g
			var dummy = ["test"];
			var fn = saveDataLocation + "/" + "savecheck";
			try {
				(Array.saveStruct incontextof dummy)(fn);
			} catch(e) {
				if (System.personalPath != System.exePath) {
					errorInform("savemydoc");
					saveDataLocation = System.personalPath + appName;
				} else {
					readOnlyMode = true;
					errorInform("readonly");
				}
			}

			dm("ï¿½Zï¿½[ï¿½uï¿½fï¿½[ï¿½^ï¿½Û‘ï¿½ï¿½êŠ:" + saveDataLocation );
		}
    }
    
	function loadSystemVariables()
	{
		// ï¿½Vï¿½Xï¿½eï¿½ï¿½ï¿½Ïï¿½ï¿½Ì“Ç‚İï¿½ï¿½ï¿½
		try
		{
			var fn = saveDataLocation + "/" + dataName +
				"sc.ksd";
			if(Storages.isExistentStorage(fn))
			{
				scflags = Scripts.evalStorage(fn);
				scflags = %[] if scflags === void;
			}
			else
			{
				scflags = %[];
			}

			var fn = saveDataLocation + "/" + dataName +
				"su.ksd";
			if(Storages.isExistentStorage(fn))
			{
				sflags = Scripts.evalStorage(fn);
				sflags = %[] if sflags === void;
			}
			else
			{
				sflags = %[];
			}
		}
		catch(e)
		{
			throw new Exception("ï¿½Vï¿½Xï¿½eï¿½ï¿½ï¿½Ïï¿½ï¿½fï¿½[ï¿½^ï¿½ï¿½Ç‚İï¿½ï¿½ß‚È‚ï¿½ï¿½ï¿½ï¿½A"
				"ï¿½ï¿½ï¿½é‚¢ï¿½ÍƒVï¿½Xï¿½eï¿½ï¿½ï¿½Ïï¿½ï¿½fï¿½[ï¿½^ï¿½ï¿½ï¿½ï¿½ï¿½Ä‚ï¿½ï¿½Ü‚ï¿½(" + e.message + ")");
		}
	}

	function setSystemStateFromSystemVariables()
	{
		// ï¿½Vï¿½Xï¿½eï¿½ï¿½ï¿½Ïï¿½ï¿½ÉŠï¿½Ã‚ï¿½ï¿½ÄƒVï¿½Xï¿½eï¿½ï¿½ï¿½ï¿½İ’ï¿½
		// (ï¿½tï¿½ï¿½ï¿½Xï¿½Nï¿½ï¿½ï¿½[ï¿½ï¿½ï¿½Ö˜Aï¿½ï¿½ï¿½Ì‚ï¿½ï¿½ï¿½)
		if(scflags.autoModePageWait !== void)
		{
			if(typeof this.autoModeWaitMenu !== "undefined")
			{
				var children = autoModeWaitMenu.children;
				for(var i = children.count-1; i >= 0; i--)
				{
					var item = children[i];
					if(typeof item.wait !== "undefined" && item.wait == scflags.autoModePageWait)
					{
						item.checked = true;
						break;
					}
				}
			}
		}

		if(scflags.userChSpeed !== void)
		{
			if(typeof this.chSpeedMenu !== "undefined")
			{
				var children = chSpeedMenu.children;
				for(var i = children.count-1; i >= 0; i--)
				{
					var item = children[i];
					if(typeof item.speed !== "undefined" && item.speed == scflags.userChSpeed)
					{
						item.checked = true;
						break;
					}
				}
			}
		}

		if(scflags.userCh2ndSpeed !== void)
		{
			if(typeof this.chSpeedMenu !== "undefined")
			{
				var children = ch2ndSpeedMenu.children;
				for(var i = children.count-1; i >= 0; i--)
				{
					var item = children[i];
					if(typeof item.speed !== "undefined" && item.speed == scflags.userCh2ndSpeed)
					{
						item.checked = true;
						break;
					}
				}
			}
		}

		if (scflags.allskip !== void) {
			allskip = scflags.allskip;
		}
		if (typeof this.allskipMenu !== "undefined") {
			var children = allskipMenu.children;
			for(var i = children.count-1; i >= 0; i--) {
				var item = children[i];
				if(typeof item.skip !== "undefined" && item.skip == allskip) {
					item.checked = true;
					break;
				}
			}
        }

        voicecut = scflags.voicecut if scflags.voicecut !== void;
        voicecutpage = scflags.voicecutpage if scflags.voicecutpage !== void;
        bgmdown = scflags.bgmdown if scflags.bgmdown !== void;
        
        afterauto = scflags.afterauto if scflags.afterauto !== void;
        afterskip = scflags.afterskip if scflags.afterskip !== void;
        nosewhenskip = scflags.nosewhenskip if scflags.nosewhenskip !== void;
        
		lastSaveDataNameGlobal = scflags.lastSaveDataNameGlobal if scflags.lastSaveDataNameGlobal !== void;

		bookMarkNames = scflags.bookMarkNames if scflags.bookMarkNames !== void;
		bookMarkDates = scflags.bookMarkDates if scflags.bookMarkDates !== void;
		bookMarkProtectedStates = scflags.bookMarkProtectedStates if scflags.bookMarkProtectedStates !== void;
		bookMarkStorages = scflags.bookMarkStorages if scflags.bookMarkStorages !== void;
		bookMarkPlayTimes = scflags.bookMarkPlayTimes if scflags.bookMarkPlayTimes !== void;
		bookMarkInfos = scflags.bookMarkInfos if scflags.bookMarkInfos !== void;

		autoModePageWait = scflags.autoModePageWait if scflags.autoModePageWait !== void;
		autoModeLineWait = scflags.autoModeLineWait if scflags.autoModeLineWait !== void;
		userChSpeed = scflags.userChSpeed if scflags.userChSpeed !== void;
		userCh2ndSpeed = scflags.userCh2ndSpeed if scflags.userCh2ndSpeed !== void;

		setUserSpeed();

		chNonStopToPageBreak = scflags.chNonStopToPageBreak if scflags.chNonStopToPageBreak !== void;
		if(typeof this.chNonStopToPageBreakItem != "undefined")
			chNonStopToPageBreakItem.checked = chNonStopToPageBreak;

		ch2ndNonStopToPageBreak = scflags.ch2ndNonStopToPageBreak if scflags.ch2ndNonStopToPageBreak !== void;
		if(typeof this.ch2ndNonStopToPageBreakItem != "undefined")
			ch2ndNonStopToPageBreakItem.checked = ch2ndNonStopToPageBreak;

		chDefaultAntialiased = scflags.chDefaultAntialiased if scflags.chDefaultAntialiased !== void;
		if(typeof this.chAntialiasMenuItem != "undefined")
			chAntialiasMenuItem.checked = chDefaultAntialiased;
		chDefaultFace = scflags.chDefaultFace if scflags.chDefaultFace !== void;

		setMessageLayerUserFont();

		bgm.restoreSystemState(scflags);

        for(var i = 0; i<numSEBuffers+1; i++)
		{
			se[i].restoreSystemState(scflags);
		}

        // ï¿½{ï¿½Cï¿½Xï¿½pï¿½ï¿½ï¿½xï¿½ï¿½ï¿½ï¿½pï¿½ï¿½ï¿½jï¿½ï¿½ï¿½[
        if(typeof this.voiceSpeedMenu !== "undefined") {
            var children = voiceSpeedMenu.children;
            for (var i = children.count-1; i >= 0; i--) {
                var item = children[i];
                if (typeof item.speed !== "undefined" && item.speed == voicespeed) {
                    item.checked = true;
                    break;
                }
            }
		}

        if (scflags.logMode !== void) {
            logMode = scflags.logMode;
        }
        if (typeof this.chDebugLogMenuItem != "undefined") {
            chDebugLogMenuItem.checked = logMode;
        }
        
        if (scflags.debugLevel !== void) {
            debugLevel = scflags.debugLevel;
        }
        switch (debugLevel) {
        case tkdlNone:
            if(typeof this.debugLevelNoneMenuItem != "undefined")
                debugLevelNoneMenuItem.checked = true;
            break;
        case tkdlSimple:
            if(typeof this.debugLevelSimpleMenuItem != "undefined")
                debugLevelSimpleMenuItem.checked = true;
            break;
        case tkdlVerbose:
            if(typeof this.debugLevelVerboseMenuItem != "undefined")
                debugLevelVerboseMenuItem.checked = true;
            break;
        }

        if (scflags.debugwin !== void && scflags.debugwin) {
            debugwin.visible = true;
        }
        if (typeof this.debugWinMenuItem != "undefined" && _debugwin !== void) {
            debugWinMenuItem.checked = debugwin.visible;
        }

        if (scflags.autoLabelSaveMode !== void) {
            autoLabelSaveMode = scflags.autoLabelSaveMode;
            if (autoLabelSaveMode) {
                canDebugControl();
            } 
        }
        if (typeof this.autoLabelSaveModeMenuItem != "undefined") {
            autoLabelSaveModeMenuItem.checked = autoLabelSaveMode;
        }
        if (typeof this.skipToPrevLabelMenuItem != "undefined") {
            skipToPrevLabelMenuItem.enabled = autoLabelSaveMode;
        }
    }

	function clearSystemVariables()
	{
		// ï¿½Vï¿½Xï¿½eï¿½ï¿½ï¿½Ïï¿½ï¿½ÌƒNï¿½ï¿½ï¿½A
		(Dictionary.clear incontextof sflags)();
	}

	function saveSystemVariables()
	{
		// ï¿½Vï¿½Xï¿½eï¿½ï¿½ï¿½Ïï¿½ï¿½Ì•Û‘ï¿½
		if(!isMain) return;

		// ï¿½vï¿½ï¿½ï¿½Oï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½Ä‚ï¿½
		forEachEventHook('onSaveSystemVariables',
			function(handler, f) { handler(); } incontextof this);

		// ï¿½tï¿½ï¿½ï¿½Xï¿½Nï¿½ï¿½ï¿½[ï¿½ï¿½
		scflags.fullScreen = fullScreened;
		scflags.zoomNumer = zoomNumer;
		scflags.zoomDenom = zoomDenom;

		// ï¿½ï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½ï¿½ï¿½x
		scflags.autoModePageWait = autoModePageWait;
		scflags.autoModeLineWait = autoModeLineWait;
		scflags.userChSpeed = userChSpeed;
		scflags.userCh2ndSpeed = userCh2ndSpeed;
		scflags.chDefaultAntialiased = chDefaultAntialiased;
		scflags.chDefaultFace = chDefaultFace;
		scflags.chNonStopToPageBreak = chNonStopToPageBreak;
		scflags.ch2ndNonStopToPageBreak = ch2ndNonStopToPageBreak;

		// ï¿½uï¿½bï¿½Nï¿½}ï¿½[ï¿½Nï¿½ï¿½
		scflags.bookMarkNames = bookMarkNames; // (ï¿½Rï¿½sï¿½[ï¿½Å‚Í‚È‚ï¿½ï¿½ï¿½)ï¿½Qï¿½Æ‚Å\ï¿½ï¿½
        scflags.bookMarkDates = bookMarkDates;
		scflags.bookMarkProtectedStates = bookMarkProtectedStates;
        scflags.bookMarkStorages = bookMarkStorages;
        scflags.bookMarkPlayTimes = bookMarkPlayTimes;
        scflags.bookMarkInfos = bookMarkInfos;

		scflags.lastSaveDataNameGlobal = lastSaveDataNameGlobal;

        // ï¿½{ï¿½Cï¿½Xï¿½Jï¿½bï¿½gï¿½ï¿½ï¿½ï¿½ï¿½İ’ï¿½
        scflags.voicecut = voicecut;
        scflags.voicecutpage = voicecutpage;
        scflags.bgmdown = bgmdown;
        
        // ï¿½Sï¿½ÄƒXï¿½Lï¿½bï¿½v
        scflags.allskip = allskip;
        
        scflags.afterauto = afterauto;
        scflags.afterskip = afterskip;
        scflags.nosewhenskip = nosewhenskip;

        scflags.logMode = logMode;
        scflags.debugLevel = debugLevel;
        scflags.debugwin = _debugwin !== void && debugwin.visible;
        scflags.autoLabelSaveMode = autoLabelSaveMode;
        
		// ï¿½tï¿½@ï¿½Cï¿½ï¿½ï¿½Éï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		if(!readOnlyMode)
		{
            try {
            var fn = saveDataLocation + "/" + dataName +
				"sc.ksd";
			(Dictionary.saveStruct incontextof scflags)(fn, saveDataMode);

			var fn = saveDataLocation + "/" + dataName +
				"su.ksd";
			(Dictionary.saveStruct incontextof sflags)(fn, saveDataMode);
            } catch (e) {
                readOnlyMode = true;
            }
		}
	}

	//------------------------------------------------------- ï¿½Qï¿½[ï¿½ï¿½ï¿½Ïï¿½ï¿½Ö˜A --

    /**
     * ï¿½ï¿½ï¿½ï¿½ï¿½Û‘ï¿½ï¿½ï¿½ï¿½ï¿½
     * @param f ï¿½Lï¿½^ï¿½ï¿½ loadFromLine ï¿½sï¿½Ôï¿½ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½vï¿½wï¿½ï¿½
     */
	function internalStoreFlags(f, loadFromLine)
	{
		// f ï¿½ÉŒï¿½ï¿½İ‚Ìï¿½Ô‚ï¿½ï¿½Lï¿½^ï¿½ï¿½ï¿½ï¿½

		// KAGWindow ï¿½ÉŠÖ‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		(Dictionary.clear incontextof f)(); // ï¿½Nï¿½ï¿½ï¿½A
		// ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ [start_store_vars] ï¿½ï¿½ï¿½ï¿½ [end_store_vars] ï¿½ÅˆÍ‚Ü‚ê‚½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		// ï¿½ï¿½ï¿½[ï¿½ï¿½ perl ï¿½Xï¿½Nï¿½ï¿½ï¿½vï¿½gï¿½É‚ï¿½ï¿½ï¿½Äï¿½ï¿½ï¿½ï¿½Iï¿½Éï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ì‚ÅAï¿½ï¿½ï¿½Ìƒ}ï¿½[ï¿½Nï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		// ï¿½ï¿½ï¿½Ìƒ}ï¿½[ï¿½Nï¿½ÌŠÔ‚ï¿½ÒWï¿½ï¿½ï¿½ï¿½ï¿½è‚µï¿½È‚ï¿½ï¿½ï¿½ï¿½ÆB
		// [start_store_vars]
		f.lastSaveDataName = lastSaveDataName;
		f.quaking = quaking;
		f.quakeEndTick = quakeEndTick;
		f.quakeHorzMax = quakeHorzMax;
		f.quakeVertMax = quakeVertMax;
		f.quakePhase = quakePhase;
		f.historyWriteEnabled = historyWriteEnabled;
		f.historyEnabled = historyEnabled;
		f.numCharacterLayers = numCharacterLayers;
		f.numMessageLayers = numMessageLayers;
		f.currentNum = currentNum;
		f.currentPage = currentPage;
		f.currentWithBack = currentWithBack;
		f.chUserMode = chUserMode;
		f.chSpeed = chSpeed;
		f.actualChSpeed = actualChSpeed;
		f.beforeNoWaitActualChSpeed = beforeNoWaitActualChSpeed;
		f.beforeNoWaitChUserMode = beforeNoWaitChUserMode;
		f.clickSkipEnabled = clickSkipEnabled;
		f.nextSkipEnabled = nextSkipEnabled;
		f.canCancelSkipByClick = canCancelSkipByClick;
		f.autoWCEnabled = autoWCEnabled;
		f.autoWCChars = autoWCChars;
		f.rightClickEnabled = rightClickEnabled;
		f.rightClickCall = rightClickCall;
		f.rightClickJump = rightClickJump;
		f.rightClickTarget = rightClickTarget;
		f.rightClickStorage = rightClickStorage;
		f.rightClickName = rightClickName;
		f.rightClickCurrentMenuName = rightClickCurrentMenuName;
		f.lastClickGlyphVisible = lastClickGlyphVisible;
		f.cursorDefault = cursorDefault;
		f.cursorPointed = cursorPointed;
		f.cursorWaitingClick = cursorWaitingClick;
		f.cursorDraggable = cursorDraggable;
		f.startAnchorEnabled = startAnchorEnabled;
		f.storeEnabled = storeEnabled;
		f.restoreEnabled = restoreEnabled;
        f.currentStorage  = currentStorage;
        f.currentLabel    = currentLabel;
		f.currentPageName = currentPageName;
		// [end_store_vars]

		// perl ï¿½Xï¿½Nï¿½ï¿½ï¿½vï¿½gï¿½É‚ï¿½ï¿½ï¿½Äï¿½ï¿½ï¿½ï¿½Iï¿½Éï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½È‚ï¿½ï¿½ï¿½ï¿½ÌAï¿½ï¿½ï¿½ï¿½ï¿½Â‚ï¿½ï¿½B
		// ï¿½ï¿½ï¿½ï¿½ï¿½Eï¿½Fï¿½Cï¿½g
		f.autoWCWaits = [];
		f.autoWCWaits.assign(autoWCWaits); // ï¿½ï¿½ï¿½ï¿½ï¿½Eï¿½Fï¿½Cï¿½gï¿½ÌƒEï¿½Fï¿½Cï¿½g

		// bgm
		f.bgm = bgm.store();

		// ï¿½ï¿½Ê‰ï¿½
		f.se = [];
		for(var i = 0; i<numSEBuffers; i++)
		{
			f.se[i] = se[i].store();
		}

		// ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½
		f.foreMessageLayers = [];
		f.backMessageLayers = [];
		for(var i = 0; i < numMessageLayers; i++)
		{
			f.foreMessageLayers[i] = fore.messages[i].store();
			f.backMessageLayers[i] = back.messages[i].store();
		}

		// ï¿½Oï¿½iï¿½ï¿½ï¿½Cï¿½ï¿½
		f.foreCharacterLayers = [];
		f.backCharacterLayers = [];
		for(var i = 0; i < numCharacterLayers; i++)
		{
			f.foreCharacterLayers[i] = fore.layers[i].store();
			f.backCharacterLayers[i] = back.layers[i].store();
		}

        // ï¿½ï¿½ï¿½äƒŒï¿½Cï¿½ï¿½ï¿½Eï¿½Cï¿½xï¿½ï¿½ï¿½gï¿½ï¿½ï¿½Cï¿½ï¿½
        f.foreStageLayer = fore.stage.store();
        f.backStageLayer = back.stage.store();
        f.foreEventLayer = fore.event.store();
        f.backEventLayer = back.event.store();
        
		// ï¿½wï¿½iï¿½ï¿½ï¿½Cï¿½ï¿½
		f.foreBaseLayer = fore.base.store();
		f.backBaseLayer = back.base.store();

		// ï¿½Eï¿½Bï¿½ï¿½ï¿½hï¿½Eï¿½Lï¿½ï¿½ï¿½vï¿½Vï¿½ï¿½ï¿½ï¿½
		f.caption = caption;

		// ï¿½Rï¿½ï¿½ï¿½_ï¿½Nï¿½^
		f.mainConductor = mainConductor.store();
		f.mainConductor.lineSaveMode = true if loadFromLine;
		if(!saveMacros) f.mainConductor.macros = void;
		// ï¿½}ï¿½Nï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ void ï¿½Åã‘ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æxï¿½ï¿½ï¿½Ìƒ}ï¿½Nï¿½ï¿½ï¿½ï¿½ï¿½Í–ï¿½ï¿½ï¿½É‚È‚ï¿½

		// ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½
		if(historyLayer.storeState)
		{
			f.historyData = historyLayer.save();
		}

		// ï¿½ï¿½ï¿½[ï¿½rï¿½[
		if( isMain )
		{
			f.movies = [];
			for( var i = 0; i < numMovies; i++)
				f.movies[i] = movies[i].store();
		}

        f.lineMode  = lineMode;
        f.crAfterName = crAfterName;
        f.erAfterPage = erAfterPage;
        f.noCrOnce = noCrOnce;
        f.noErOnce = noErOnce;
        f.autoIndent = autoIndent;
        f.autoLabelCount = autoLabelCount;
        f.afterPage = afterPage;
        f.emptyLine = emptyLine;
        f.prevEmptyLine = prevEmptyLine;
        
		// storeHook
		forEachEventHook('onStore',
			function(handler, f) { handler(f.flags, f.options); } incontextof this,
			%[flags:f, options:void]);
	}

	function storeFlags(loadFromLine=false)
	{
		// pcflags, pflags ï¿½É’lï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½

		// flags -> pflags
		(Dictionary.assignStruct incontextof pflags)(flags);

		internalStoreFlags(pcflags, loadFromLine);
	}

	function internalRestoreFlags(f, clear = true, elm = void)
	{
		// f ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ç‚İoï¿½ï¿½
		// clear ï¿½ï¿½ true ï¿½È‚ï¿½Îƒï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½Nï¿½ï¿½ï¿½Aï¿½ï¿½ï¿½ï¿½
		// se, bgm ï¿½ï¿½ï¿½ï¿½ï¿½ê‚¼ï¿½ï¿½ true ï¿½È‚ï¿½Î‚ï¿½ï¿½Ìï¿½ï¿½ï¿½ï¿½ï¿½ï¿½fï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		// backlay ï¿½ï¿½ true ï¿½Ìê‡ï¿½ÍAï¿½\ï¿½ï¿½Ê‚Éƒï¿½ï¿½[ï¿½hï¿½ï¿½ï¿½×‚ï¿½ï¿½ï¿½ï¿½Ì‚ğ— ‰ï¿½Ê‚Éƒï¿½ï¿½[ï¿½hï¿½ï¿½ï¿½ï¿½

		// KAGWindow ï¿½ÉŠÖ‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		// ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ [start_restore_vars] ï¿½ï¿½ï¿½ï¿½ [end_restore_vars] ï¿½ÅˆÍ‚Ü‚ê‚½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		// (ï¿½ï¿½)
		// [start_restore_vars]
		lastSaveDataName = f.lastSaveDataName if f.lastSaveDataName !== void;
		quaking = f.quaking if f.quaking !== void;
		quakeEndTick = f.quakeEndTick if f.quakeEndTick !== void;
		quakeHorzMax = f.quakeHorzMax if f.quakeHorzMax !== void;
		quakeVertMax = f.quakeVertMax if f.quakeVertMax !== void;
		quakePhase = f.quakePhase if f.quakePhase !== void;
		historyWriteEnabled = f.historyWriteEnabled if f.historyWriteEnabled !== void;
		historyEnabled = f.historyEnabled if f.historyEnabled !== void;
		numCharacterLayers = f.numCharacterLayers if f.numCharacterLayers !== void;
		numMessageLayers = f.numMessageLayers if f.numMessageLayers !== void;
		currentNum = f.currentNum if f.currentNum !== void;
		currentPage = f.currentPage if f.currentPage !== void;
		currentWithBack = f.currentWithBack if f.currentWithBack !== void;
		chUserMode = f.chUserMode if f.chUserMode !== void;
		chSpeed = f.chSpeed if f.chSpeed !== void;
		actualChSpeed = f.actualChSpeed if f.actualChSpeed !== void;
		beforeNoWaitActualChSpeed = f.beforeNoWaitActualChSpeed if f.beforeNoWaitActualChSpeed !== void;
		beforeNoWaitChUserMode = f.beforeNoWaitChUserMode if f.beforeNoWaitChUserMode !== void;
		clickSkipEnabled = f.clickSkipEnabled if f.clickSkipEnabled !== void;
		nextSkipEnabled = f.nextSkipEnabled if f.nextSkipEnabled !== void;
		canCancelSkipByClick = f.canCancelSkipByClick if f.canCancelSkipByClick !== void;
		autoWCEnabled = f.autoWCEnabled if f.autoWCEnabled !== void;
		autoWCChars = f.autoWCChars if f.autoWCChars !== void;
		rightClickEnabled = f.rightClickEnabled if f.rightClickEnabled !== void;
		rightClickCall = f.rightClickCall if f.rightClickCall !== void;
		rightClickJump = f.rightClickJump if f.rightClickJump !== void;
		rightClickTarget = f.rightClickTarget if f.rightClickTarget !== void;
		rightClickStorage = f.rightClickStorage if f.rightClickStorage !== void;
		rightClickName = f.rightClickName if f.rightClickName !== void;
		rightClickCurrentMenuName = f.rightClickCurrentMenuName if f.rightClickCurrentMenuName !== void;
		lastClickGlyphVisible = f.lastClickGlyphVisible if f.lastClickGlyphVisible !== void;
		cursorDefault = f.cursorDefault if f.cursorDefault !== void;
		cursorPointed = f.cursorPointed if f.cursorPointed !== void;
		cursorWaitingClick = f.cursorWaitingClick if f.cursorWaitingClick !== void;
		cursorDraggable = f.cursorDraggable if f.cursorDraggable !== void;
		startAnchorEnabled = f.startAnchorEnabled if f.startAnchorEnabled !== void;
		storeEnabled = f.storeEnabled if f.storeEnabled !== void;
		restoreEnabled = f.restoreEnabled if f.restoreEnabled !== void;
        currentStorage = f.currentStorage if f.currentStorage !== void;
        currentLabel = f.currentLabel if f.currentLabel !== void;
		currentPageName = f.currentPageName if f.currentPageName !== void;
		// [end_restore_vars]

		// perl ï¿½Xï¿½Nï¿½ï¿½ï¿½vï¿½gï¿½É‚ï¿½ï¿½ï¿½Äï¿½ï¿½ï¿½ï¿½Iï¿½Éï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½È‚ï¿½ï¿½ï¿½ï¿½ÌAï¿½ï¿½ï¿½ï¿½ï¿½Â‚ï¿½ï¿½B

		// ï¿½ï¿½ï¿½ï¿½ï¿½Eï¿½Fï¿½Cï¿½g
		autoWCWaits.assign(f.autoWCWaits) if f.autoWCWaits !== void;

        switch (f.lineMode) {
        case 0:
            setLineMode();
            break;
        case 1:
            setLineMode("page");
            break;
        case 2:
            setLineMode("line");
            break;
        case 3:
            setLineMode("vn");
            break;
        case 4:
            setLineMode("tex");
            break;
        case 5:
            setLineMode("free");
            break;
        }
        crAfterName = f.crAfterName;
        erAfterPage = f.erAfterPage;
        noCrOnce    = f.noCrOnce;
        noErOnce    = f.noErOnce;
        autoIndent = f.autoIndent;
        autoLabelCount = f.autoLabelCount;
        afterPage = f.afterPage;
        emptyLine = f.emptyLine;
        prevEmptyLine = f.prevEmptyLine;
        
		// ï¿½ï¿½ï¿½[ï¿½rï¿½[
		if( isMain )
		{
			for( var i = 0; i < numMovies; i++)
				movies[i].restore(f.movies[i]);
		}

		// ï¿½wï¿½iï¿½ï¿½ï¿½Cï¿½ï¿½
		var backlay = elm != void && elm.backlay != void && +elm.backlay;
		if(backlay)
		{
			back.base.restore(f.foreBaseLayer);
		}
		else
		{
			fore.base.restore(f.foreBaseLayer);
			back.base.restore(f.backBaseLayer);
		}

        if (backlay) {
            back.stage.restore(f.foreStageLayer);
            back.event.restore(f.foreEventLayer);
        } else {
            fore.stage.restore(f.foreStageLayer);
			back.stage.restore(f.backStageLayer);
            fore.event.restore(f.foreEventLayer);
			back.event.restore(f.backEventLayer);
        }
        
		// ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½
		allocateMessageLayers(numMessageLayers);
		if(backlay)
		{
			for(var i = 0; i < numMessageLayers; i++)
			{
				back.messages[i].restore(f.foreMessageLayers[i]);
			}
		}
		else
		{
			for(var i = 0; i < numMessageLayers; i++)
			{
				fore.messages[i].restore(f.foreMessageLayers[i]);
				back.messages[i].restore(f.backMessageLayers[i]);
			}
		}

		if(clear)
		{
			for(var i = 0; i < numMessageLayers; i++)
			{
				fore.messages[i].clear();
				back.messages[i].clear();
			}
			if(historyLayer.storeState)
			{
				historyLayer.load(f.historyData);
			}
			else
			{
				if(historyWriteEnabled)
				{
					if(historyLayer.everypage)
						historyLayer.repage();
					else
						historyLayer.reline(), historyLayer.reline();
				}
				historyLayer.clearAction();
			}
		}

		// ï¿½Oï¿½iï¿½ï¿½ï¿½Cï¿½ï¿½
		allocateCharacterLayers(numCharacterLayers);
		if(backlay)
		{
			for(var i = 0; i < numCharacterLayers; i++)
			{
				back.layers[i].restore(f.foreCharacterLayers[i]);
			}
		}
		else
		{
			for(var i = 0; i < numCharacterLayers; i++)
			{
                try {
                    fore.layers[i].restore(f.foreCharacterLayers[i]);
                } catch (e) {
                    dm("ï¿½æ‘œï¿½Ì“Ç‚İï¿½ï¿½İ‚Éï¿½ï¿½sï¿½ï¿½ï¿½Ü‚ï¿½ï¿½ï¿½");
                } 
                try {
                    back.layers[i].restore(f.backCharacterLayers[i]);
                } catch (e) {
                    dm("ï¿½æ‘œï¿½Ì“Ç‚İï¿½ï¿½İ‚Éï¿½ï¿½sï¿½ï¿½ï¿½Ü‚ï¿½ï¿½ï¿½");
                } 
            }
		}

		// quake ï¿½Ö˜A
		restoreQuake();

		// bgm
		if(elm === void || elm.bgm === void || +elm.bgm)
		{
			bgm.restore(f.bgm);
		}

		// ï¿½ï¿½Ê‰ï¿½
		if(elm === void || elm.se === void || +elm.se)
		{
			for(var i = 0; i<numSEBuffers; i++)
			{
				se[i].restore(f.se[i]);
			}
		}

		// ï¿½Eï¿½Bï¿½ï¿½ï¿½hï¿½Eï¿½Lï¿½ï¿½ï¿½vï¿½Vï¿½ï¿½ï¿½ï¿½
		caption = f.caption;
		//System.title = caption;

		// current ï¿½Ìİ’è‚µï¿½ï¿½ï¿½ï¿½
		current = (currentPage?back:fore).messages[currentNum];

		// ï¿½Eï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½ï¿½ï¿½jï¿½ï¿½ï¿½[ï¿½ï¿½
		if(typeof this.rightClickMenuItem != "undefined")
			rightClickMenuItem.caption = rightClickCurrentMenuName;

		// restoreHook
		forEachEventHook('onRestore',
			function(handler, f) { handler(f.flags, f.clear, f.options); } incontextof this,
			%[flags:f, clear:clear, options:elm]);

	}

	function restoreFlags()
	{
		// pcflags, pflags ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ç‚İoï¿½ï¿½

		// ï¿½ï¿½ï¿½[ï¿½hï¿½ï¿½ï¿½Aï¿½ï¿½ï¿½[ï¿½rï¿½[ï¿½Ìƒsï¿½ï¿½ï¿½Iï¿½hï¿½Cï¿½xï¿½ï¿½ï¿½gï¿½ï¿½ï¿½ï¿½ï¿½Nï¿½ï¿½ï¿½Aï¿½ï¿½ï¿½ï¿½
		purgeMoviePeriod();

		// ï¿½Xï¿½iï¿½bï¿½vï¿½Vï¿½ï¿½ï¿½bï¿½gï¿½Ì”jï¿½ï¿½
		freeSnapshot();

		// ï¿½gï¿½ï¿½ï¿½ï¿½ï¿½Wï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Aï¿½ï¿½ï¿½ï¿½ï¿½Ú“ï¿½ï¿½Ì’ï¿½~
		stopAllTransitions();
		stopAllMoves();

		// ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Ò‚ï¿½ï¿½Lï¿½ï¿½ï¿½ï¿½ï¿½Bï¿½ï¿½
		hideClickGlyphs();

		// ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Bï¿½ï¿½
		hideHistory();

        // ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Bï¿½ï¿½
        hideSelect();
		hideMapSelect();
		hideTransLayer();
		hidePanel();
        
		// ï¿½Xï¿½Lï¿½bï¿½vï¿½ÌƒLï¿½ï¿½ï¿½ï¿½ï¿½Zï¿½ï¿½
        if (skipMode < SKIP_FORCE) {
            cancelSkip();
        }

		// pflags -> flags
		(Dictionary.assignStruct incontextof flags)(pflags);

		// ï¿½xï¿½Ç—ï¿½ï¿½Ö˜A
		storeLabelPassed = true;
		nextRecordHistory = false;
		stablePosibility = false;

		// ï¿½Rï¿½ï¿½ï¿½_ï¿½Nï¿½^
		currentRecordName = "";
		autoLabelCurrentRecordName = "";
		extraConductor.clear();
		setConductorToMain();
		mainConductor.restore(pcflags.mainConductor);
		// XXX ï¿½ï¿½ï¿½Ô“ï¿½ï¿½Ö‚ï¿½
		
		// ï¿½Ç‚İï¿½ï¿½ï¿½
		internalRestoreFlags(pcflags);

		// ï¿½ï¿½ï¿½[ï¿½hï¿½ÏXï¿½ï¿½Ô‚ï¿½ï¿½ï¿½ï¿½Zï¿½bï¿½g
		if (typeof global.resetModeChanged != "undefined") {
			global.resetModeChanged();
		}
		
        // ï¿½ï¿½ï¿½jï¿½ï¿½ï¿½[ï¿½Ö˜A
		setMenuAccessibleAll();

        // ï¿½ï¿½zï¿½ï¿½ï¿½~
        stopRecollection();
        
		// ï¿½ï¿½ï¿½sï¿½Jï¿½n
		processGo();
    }

	function clearVariables()
	{
		// ï¿½Qï¿½[ï¿½ï¿½ï¿½Ïï¿½ï¿½ÌƒNï¿½ï¿½ï¿½A
		(Dictionary.clear incontextof flags)();
	}

	//--------------------------------------------------------- ï¿½Ê‰ß‹Lï¿½^ï¿½Ç—ï¿½ --

	function pushHistoryOfStore()
	{
		//dm("ï¿½Ê‰ß‹Lï¿½^ï¿½ï¿½ï¿½s");
		// ï¿½Ê‰ß‹Lï¿½^ï¿½ï¿½ï¿½sï¿½ï¿½
		// pflags, pcflags ï¿½Éï¿½ï¿½ï¿½ï¿½iï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ÉŒÄ‚Ô‚ï¿½ï¿½ï¿½

		if(nextRecordHistory)
		{
			if(stablePosibility)
			{
				// stablePosibility ï¿½ï¿½ false ï¿½Ìê‡ï¿½ÍA
				// ï¿½ï¿½ï¿½ï¿½ï¿½Ìƒï¿½ï¿½xï¿½ï¿½ï¿½Å’Ê‰ß‹Lï¿½^ï¿½ï¿½ï¿½sï¿½ï¿½ï¿½Ä‚ï¿½
				// ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Oï¿½É–ß‚é‚·ï¿½×‚ï¿½ï¿½È‚ï¿½ï¿½Ì‚Å’Ê‰ß‹Lï¿½^ï¿½ï¿½ï¿½ï¿½ï¿½È‚ï¿½

				// ï¿½ï¿½ï¿½ï¿½ï¿½zï¿½ï¿½ï¿½ï¿½ì¬
				var dic = %[];

				// user ï¿½ï¿½ core ï¿½ï¿½ï¿½Lï¿½^
				dic.user = %[];
				(Dictionary.assignStruct incontextof dic.user)(pflags);
				dic.core = %[];
				(Dictionary.assignStruct incontextof dic.core)(pcflags);

				// dic ï¿½ï¿½ historyOfStore ï¿½Ìæ“ªï¿½É‘}ï¿½ï¿½
				historyOfStore.insert(0, dic);

				// ï¿½Í‚İoï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½íœ
				if(historyOfStore.count > maxHistoryOfStore)
					historyOfStore.count = maxHistoryOfStore;
			}

			nextRecordHistory = false;
		}
	}

	function setToRecordHistory()
	{
		// ï¿½ï¿½ï¿½Ìuï¿½Û‘ï¿½ï¿½Â”\ï¿½Èƒï¿½ï¿½xï¿½ï¿½ï¿½vï¿½Ê‰ßï¿½ï¿½ï¿½
		// ï¿½Ê‰ß‹Lï¿½^ï¿½ï¿½ï¿½sï¿½ï¿½ï¿½æ‚¤ï¿½Éİ’è‚·ï¿½ï¿½
		// ( ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Aï¿½ï¿½ï¿½Ì‚Æ‚ï¿½ï¿½É‹Lï¿½^ï¿½ï¿½ï¿½ï¿½ï¿½Ì‚ÍAï¿½ï¿½ï¿½İ‚Ìï¿½ï¿½ )
        if (!isRecollection) {
            nextRecordHistory = true;
        }
	}

	function isHistoryOfStoreAlive()
	{
		// ï¿½Ê‰ß‹Lï¿½^ï¿½ï¿½ï¿½ï¿½ï¿½pï¿½Â”\ï¿½ï¿½ï¿½Ç‚ï¿½ï¿½ï¿½ï¿½ï¿½Ô‚ï¿½
		return historyOfStore.count;
	}

    function goBackYes() {
        // user ï¿½ï¿½ core ï¿½ï¿½ pflags, pcflags ï¿½É–ß‚ï¿½
        (Dictionary.assignStruct incontextof pflags)(historyOfStore[0].user);
        (Dictionary.assignStruct incontextof pcflags)(historyOfStore[0].core);
        
        // ï¿½Lï¿½^ï¿½Ìæ“ªï¿½ï¿½ï¿½íœï¿½ï¿½ï¿½ï¿½
        historyOfStore.erase(0);

		if (kag.historyWriteEnabled) {
			historyLayer.clearAction();
		}
		
		// ï¿½fï¿½[ï¿½^ï¿½ï¿½ï¿½ï¿½ï¿½ÉAï¿½xï¿½ï¿½ï¿½ï¿½ï¿½Ç‚é“®ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		restoreFlags();
	}

    function goBackHistory(ask = true)
	{
		// ï¿½Ê‰ß‹Lï¿½^ï¿½ï¿½ï¿½ï¿½ï¿½Ç‚ï¿½Aï¿½ß‚ï¿½

		if(!isHistoryOfStoreAlive())
			return false;

		var result;
		if(ask)
		{
			var prompt = "ï¿½u"+ historyOfStore[0].core.currentPageName + "ï¿½vï¿½Ü‚Å–ß‚ï¿½Ü‚ï¿½ï¿½ï¿½?";
            askYesNo(prompt, "ï¿½mï¿½F", goBackYes);
		}
		else
		{
            goBackYes();
		}
	}

	//--------------------------------------------------------------- ï¿½xï¿½Ç—ï¿½ --

	function createBookMarkSubMenus()
	{
		// ï¿½uï¿½xï¿½ï¿½ï¿½ï¿½ï¿½Ç‚ï¿½vï¿½uï¿½xï¿½ï¿½ï¿½Í‚ï¿½ï¿½Şvï¿½È‰ï¿½ï¿½ÉƒTï¿½uï¿½ï¿½ï¿½jï¿½ï¿½ï¿½[ï¿½ï¿½ï¿½Ú‚ï¿½Ç‰ï¿½
		if(freeSaveDataMode) return; // ï¿½tï¿½ï¿½ï¿½[ï¿½Zï¿½[ï¿½uï¿½ï¿½ï¿½[ï¿½hï¿½Å‚Í‚È‚É‚ï¿½ï¿½ï¿½ï¿½È‚ï¿½
		if(typeof this.storeMenu !== "undefined" && storeMenu.visible)
		{
			for(var i = 0; i<numBookMarks; i++)
			{
				var item;
				storeMenu.add(item = new KAGMenuItem(this, string i, 0, onBookMarkStore,
					false));
				item.bmNum = i;
				item.orgEnabled = false;
			}
		}
		if(typeof this.restoreMenu !== "undefined" && restoreMenu.visible)
		{
			for(var i = 0; i<numBookMarks; i++)
			{
				var item;
				restoreMenu.add(item = new KAGMenuItem(this, string i, 0, onBookMarkRestore,
					false));
				item.bmNum = i;
				item.orgEnabled = false;
			}
		}
	}

	function setBookMarkMenuCaptions()
	{
		// ï¿½uï¿½xï¿½ï¿½ï¿½ï¿½ï¿½Ç‚ï¿½vï¿½uï¿½xï¿½ï¿½ï¿½Í‚ï¿½ï¿½Şvï¿½È‰ï¿½ï¿½ÌƒTï¿½uï¿½ï¿½ï¿½jï¿½ï¿½ï¿½[ï¿½ï¿½
		// ï¿½Lï¿½ï¿½ï¿½vï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½İ’ï¿½

		// ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		if(typeof this.storeMenu !== "undefined")
		{
			var children = storeMenu.children;
			for(var i = children.count - 1; i >= 0; i--)
			{
				if(bookMarkDates[i] != '') // ï¿½ó•¶ï¿½ï¿½ï¿½Ìê‡ï¿½Íxï¿½ï¿½ï¿½È‚ï¿½ï¿½Æ‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
				{
					// ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½İ‚ï¿½ï¿½ï¿½
					var caption;
					if(showBookMarkDate) caption = bookMarkDates[i] + " ";
					caption += bookMarkNames[i];
					var item = children[i];
					item.caption = caption;
					item.enabled = false;
					item.orgEnabled = !bookMarkProtectedStates[i];
				}
				else
				{
					// ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½İ‚ï¿½ï¿½È‚ï¿½
					var item = children[i];
					item.caption = "(ï¿½ï¿½ï¿½İ’ï¿½)";
					item.enabled = false;
					item.orgEnabled = !bookMarkProtectedStates[i];
				}
			}
		}

		// ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½Ç‚ï¿½
		if(typeof this.restoreMenu !== "undefined")
		{
			var children = restoreMenu.children;
			for(var i = children.count - 1; i >= 0; i--)
			{
				if(bookMarkDates[i] != '') // ï¿½ó•¶ï¿½ï¿½ï¿½Ìê‡ï¿½Íxï¿½ï¿½ï¿½È‚ï¿½ï¿½Æ‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
				{
					// ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½İ‚ï¿½ï¿½ï¿½
					var caption;
					if(showBookMarkDate) caption = bookMarkDates[i] + " ";
					caption += bookMarkNames[i];
					var item = restoreMenu.children[i];
					item.caption = caption;
					item.enabled = false;
					item.orgEnabled = true;
				}
				else
				{
					var item = restoreMenu.children[i];
					item.caption = "(ï¿½ï¿½ï¿½İ’ï¿½)";
					item.enabled = false;
					item.orgEnabled = false;
				}
			}
		}
		setMenuAccessibleAll();
	}

	function setBookMarkProtectedState(num, s)
	{
		// n ï¿½Ô‚Ìxï¿½Ì•ÛŒï¿½tï¿½ï¿½ï¿½Oï¿½ï¿½İ’è‚·ï¿½ï¿½
		// s = true ï¿½È‚ï¿½Îxï¿½Éï¿½ï¿½ï¿½ï¿½ï¿½ï¿½İ•ÛŒï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		bookMarkProtectedStates[num] = s;
		setBookMarkMenuCaptions();
	}

	function onBookMarkStore(sender)
	{
		// ï¿½xï¿½ï¿½ï¿½Í‚ï¿½ï¿½Şƒï¿½ï¿½jï¿½ï¿½ï¿½[ï¿½ï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ê‚½
//		if(!sender.parent.accessEnabled) return;
		saveBookMarkWithAsk(sender.bmNum);
	}

	function onBookMarkRestore(sender)
	{
		// ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½Ç‚éƒï¿½jï¿½ï¿½ï¿½[ï¿½ï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ê‚½
//		if(!sender.parent.accessEnabled) return;
		loadBookMarkWithAsk(sender.bmNum);
	}

	function getBookMarkPageName(num)
	{
		// ï¿½xï¿½Ôï¿½ num ï¿½Ìƒuï¿½bï¿½Nï¿½}ï¿½[ï¿½Nï¿½ï¿½ï¿½ğ“¾‚ï¿½
		if(bookMarkDates[num] != '') // ï¿½ó•¶ï¿½ï¿½ï¿½Ìê‡ï¿½Íxï¿½ï¿½ï¿½È‚ï¿½ï¿½Æ‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
			return bookMarkNames[num];
		return "(ï¿½ï¿½ï¿½İ’ï¿½)";
	}

	function getBookMarkDate(num)
	{
		// ï¿½xï¿½Ôï¿½ num ï¿½Ì“ï¿½tï¿½ğ“¾‚ï¿½
		return bookMarkDates[num];
	}

	function getBookMarkStorage(num)
	{
        // ï¿½xï¿½Ôï¿½ num ï¿½ÌƒXï¿½gï¿½ï¿½ï¿½[ï¿½Wï¿½ï¿½ï¿½ğ“¾‚ï¿½
        if(bookMarkDates[num] != '') // ï¿½ó•¶ï¿½ï¿½ï¿½Ìê‡ï¿½Íxï¿½ï¿½ï¿½È‚ï¿½ï¿½Æ‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
            return bookMarkStorages[num];
		return "";
	}

	function getBookMarkPlayTime(num)
	{
        // ï¿½xï¿½Ôï¿½ num ï¿½Ìƒvï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ô‚ğ“¾‚ï¿½
        if(bookMarkDates[num] != '') // ï¿½ó•¶ï¿½ï¿½ï¿½Ìê‡ï¿½Íxï¿½ï¿½ï¿½È‚ï¿½ï¿½Æ‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
            return bookMarkPlayTimes[num];
        return 0;
	}
    
	function getBookMarkInfo(num)
	{
        // ï¿½xï¿½Ôï¿½ num ï¿½ÌŠgï¿½ï¿½ï¿½ï¿½ï¿½ğ“¾‚ï¿½
        return bookMarkInfos[num];
	}
    
	function getBookMarkFileNameAtNum(num)
	{
		if(num >= 999) // 999 ï¿½ÔˆÈ~ï¿½Í“ï¿½ï¿½ï¿½Èƒfï¿½[ï¿½^ï¿½É—pï¿½ï¿½ï¿½ï¿½Ì‚ï¿½
			return saveDataLocation + "/" + dataName + num + ".ksd";
		else
			return saveDataLocation + "/" + dataName + num + (saveThumbnail?".bmp":".kdt");
	}

	function lockSnapshot()
	{
		// ï¿½Xï¿½iï¿½bï¿½vï¿½Vï¿½ï¿½ï¿½bï¿½gï¿½ï¿½ï¿½ï¿½ï¿½bï¿½Nï¿½ï¿½ï¿½ï¿½
		// ï¿½ï¿½ï¿½ß‚ÄƒXï¿½iï¿½bï¿½vï¿½Vï¿½ï¿½ï¿½bï¿½gï¿½ï¿½ï¿½ï¿½ï¿½bï¿½Nï¿½ï¿½ï¿½ê‚½ï¿½ï¿½ï¿½_ï¿½Å‚Ì‰ï¿½Ê‚ï¿½Û‘ï¿½ï¿½ï¿½ï¿½ï¿½
		if(snapshotLockCount == 0)
		{
			if(snapshotLayer === void)
                snapshotLayer = new Layer(this, primaryLayer);
            snapshotLayer.name = "ï¿½Xï¿½iï¿½bï¿½vï¿½Vï¿½ï¿½ï¿½bï¿½gï¿½p";
            snapshotLayer.setImageSize(scWidth, scHeight);
			snapshotLayer.face = dfAlpha;
			snapshotLayer.piledCopy(0, 0, kag.fore.base, 0, 0, scWidth, scHeight);
		}
		snapshotLockCount ++;
	}

	function unlockSnapshot()
	{
		// ï¿½Xï¿½iï¿½bï¿½vï¿½Vï¿½ï¿½ï¿½bï¿½gï¿½Ìƒï¿½ï¿½bï¿½Nï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		if(snapshotLockCount == 0)
			throw new Exception("snapshotLockCount ï¿½ï¿½ï¿½Aï¿½ï¿½ï¿½_ï¿½[ï¿½tï¿½ï¿½ï¿½[ï¿½ï¿½ï¿½Ü‚ï¿½ï¿½ï¿½");
		snapshotLockCount --;
		if(snapshotLockCount == 0)
		{
			if(snapshotLayer !== void)
				invalidate snapshotLayer, snapshotLayer = void;
		}
	}

	function calcThumbnailSize()
	{
		// ï¿½Tï¿½ï¿½ï¿½lï¿½Cï¿½ï¿½ï¿½ÌƒTï¿½Cï¿½Yï¿½ï¿½ï¿½vï¿½Zï¿½ï¿½ï¿½ï¿½
		// ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ 133 ï¿½ï¿½
		var ratio = scHeight / scWidth;
		var w = thumbnailWidth;
		var h = (int)(w * ratio);

		// ï¿½Tï¿½ï¿½ï¿½lï¿½Cï¿½ï¿½ï¿½pï¿½rï¿½bï¿½gï¿½}ï¿½bï¿½vï¿½ÌƒTï¿½Cï¿½Yï¿½ï¿½ï¿½vï¿½Z
		// ï¿½Tï¿½ï¿½ï¿½lï¿½Cï¿½ï¿½ï¿½pï¿½æ‘œï¿½ï¿½ 256 ï¿½F BMP ï¿½Ü‚ï¿½ï¿½ï¿½ 24bit ï¿½tï¿½ï¿½ï¿½Jï¿½ï¿½ï¿½[ BMP
		var size;
		if (thumbnailDepth == 8)
		  size = ((((w - 1) >> 2) + 1) << 2) * h + 1024 + 54;
		else
		  size = (((w * 3 + 3) >> 2) << 2) * h + 54;

		return %[width : w, height : h, size : size];
	}

	function freeSnapshot()
	{
		// ï¿½Xï¿½iï¿½bï¿½vï¿½Vï¿½ï¿½ï¿½bï¿½gï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Iï¿½É”jï¿½ï¿½AsnapshotLockCount ï¿½ï¿½ 0 ï¿½Éİ’è‚·ï¿½ï¿½
		snapshotLockCount = 0;
		if(snapshotLayer !== void)
			invalidate snapshotLayer, snapshotLayer = void;
	}

    /**
     * ï¿½Û‘ï¿½ï¿½pï¿½Ç‰ï¿½ï¿½ï¿½ï¿½Ì“oï¿½^
     */
    function addBookMarkInfo(name, value) {
        if (pcflags.bookMarkInfo === void) {
            pcflags.bookMarkInfo = %[];
        }
        pcflags.bookMarkInfo[name] = value;
    }

	function saveBookMarkToFile(fn, savehist = true)
	{
        // ï¿½tï¿½@ï¿½Cï¿½ï¿½ fn ï¿½Éxï¿½ï¿½Û‘ï¿½ï¿½ï¿½ï¿½ï¿½
        if(readOnlyMode) return false;
        pcflags.storeTime = (new Date()).getTime(); // ï¿½ï¿½tï¿½ï¿½Û‘ï¿½
        pcflags.playTime = playTime + pcflags.storeTime - playStartTime;
        
		// ï¿½Zï¿½[ï¿½uï¿½fï¿½[ï¿½^ï¿½ï¿½ï¿½Ü‚Æ‚ß‚ï¿½
		var data = %[];
		data.id = saveDataID;
		data.core = pcflags;
		data.user = pflags;
		if(savehist) data.history = historyOfStore;

		if(saveThumbnail)
		{
			// ï¿½Tï¿½ï¿½ï¿½lï¿½Cï¿½ï¿½ï¿½ï¿½Û‘ï¿½
			lockSnapshot();
			try
			{
				// ï¿½Tï¿½ï¿½ï¿½lï¿½Cï¿½ï¿½ï¿½ÌƒTï¿½Cï¿½Yï¿½Ü‚Åkï¿½ï¿½
				var size = calcThumbnailSize();
				var tmp = new Layer(this, primaryLayer);
				try
				{
					tmp.setImageSize(size.width, size.height);
					tmp.face = dfAlpha;
					tmp.stretchCopy(0, 0, size.width, size.height, snapshotLayer,
						0, 0, snapshotLayer.imageWidth, snapshotLayer.imageHeight, stLinear);
					/*
					// ï¿½Tï¿½ï¿½ï¿½lï¿½Cï¿½ï¿½ï¿½æ‘œï¿½ï¿½ï¿½Zï¿½sï¿½Aï¿½ï¿½ï¿½É‚ï¿½ï¿½Ä•Û‘ï¿½ï¿½ï¿½ï¿½ï¿½ê‡ï¿½ÍƒRï¿½ï¿½ï¿½ï¿½ï¿½gï¿½Aï¿½Eï¿½gï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
					tmp.doGrayScale();
					tmp.adjustGamma(
									1.3, 0, 255,  // R gamma, floor, ceil
									1.0, 0, 255,  // G gamma, floor, ceil
									0.8, 0, 255); // B gamma, floor, ceil
					*/
					try
					{
						// ï¿½Tï¿½ï¿½ï¿½lï¿½Cï¿½ï¿½ï¿½ï¿½Û‘ï¿½
						tmp.saveLayerImage(fn, "bmp" + thumbnailDepth);

						// ï¿½fï¿½[ï¿½^ï¿½ï¿½Û‘ï¿½
						var mode = saveDataMode;
						mode += "o" + size.size; // ï¿½ï¿½ï¿½[ï¿½hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½İƒIï¿½tï¿½Zï¿½bï¿½gï¿½ï¿½ï¿½wï¿½ï¿½
						(Dictionary.saveStruct incontextof data)(fn, mode);
					}
					catch(e)
					{
						invalidate tmp;
						unlockSnapshot();
						readOnlyMode = true;
						errorInform("savefail");
						return false;
					}
				}
				catch(e)
				{
					invalidate tmp;
					throw e;
				}
				invalidate tmp;
			}
			catch(e)
			{
				unlockSnapshot();
				throw e;
			}
			unlockSnapshot();
		}
		else
		{
			// ï¿½Êï¿½Ìƒtï¿½@ï¿½Cï¿½ï¿½ï¿½É•Û‘ï¿½
			try
			{
				(Dictionary.saveStruct incontextof data)(fn, saveDataMode);
			}
			catch(e)
			{
				readOnlyMode = true;
				errorInform("savefail");
				return false;
			}
		}

		return true;
	}
	

	function saveBookMark(num, savehist = true)
	{
		// ï¿½xï¿½Ôï¿½ num ï¿½Éxï¿½ï¿½Û‘ï¿½ï¿½ï¿½ï¿½ï¿½
		if(readOnlyMode) return false;
		if(bookMarkProtectedStates[num]) return false;

        var ret = saveBookMarkToFile(getBookMarkFileNameAtNum(num), savehist);
		if(ret)
		{
            // ï¿½ï¿½ï¿½jï¿½ï¿½ï¿½[ / bookMarkNames / bookMarkDates ï¿½ï¿½ï¿½Xï¿½V
            getBookMarkInfoFromData(pcflags, num);
		}
		return ret;
	}

	function getBookMarkInfoFromData(dic, num)
	{
        // ï¿½ï¿½ï¿½ï¿½ï¿½zï¿½ï¿½ dic ï¿½ï¿½ï¿½ï¿½xï¿½Ìƒyï¿½[ï¿½Wï¿½ï¿½ï¿½Æ“ï¿½tï¿½ï¿½Ç‚İoï¿½ï¿½ï¿½A
		// bookMarkDates[num] ï¿½ï¿½ bookMarkNames[num] ï¿½Éİ’è‚·ï¿½ï¿½
		if(num < numBookMarks)
		{
            bookMarkNames[num] = dic.currentPageName;
            var date = new Date();
            date.setTime(dic.storeTime);
            if (bookMarkDateSecond) {
                date = "%04d/%02d/%02d %02d:%02d:%02d".sprintf(
                    date.getYear(), date.getMonth() + 1, date.getDate(),
                    date.getHours(), date.getMinutes(), date.getSeconds() );
            } else {
                date = "%04d/%02d/%02d %02d:%02d".sprintf(
                    date.getYear(), date.getMonth() + 1, date.getDate(),
                    date.getHours(), date.getMinutes() );
            }
            bookMarkDates[num] = date;
            bookMarkStorages[num]  = dic.currentStorage;
            bookMarkPlayTimes[num] = dic.playTime;
            bookMarkInfos[num]     = dic.bookMarkInfo;
            setBookMarkMenuCaptions();
			saveSystemVariables();
		}
	}

    function readBookMarkFromFile(fn)
    {
        try {
            if (Storages.isExistentStorage(fn)) {
                var modestr;
                if(saveThumbnail) {
                    // ï¿½wï¿½ï¿½Iï¿½tï¿½Zï¿½bï¿½gï¿½ï¿½ï¿½ï¿½fï¿½[ï¿½^ï¿½ï¿½Ç‚İï¿½ï¿½ï¿½
                    modestr += "o" + calcThumbnailSize().size;
                }
                var data = Scripts.evalStorage(fn, modestr);
                if (data.id == saveDataID) {
                    return data;
                }
            }
        } catch(e) {
        }
        return %[];
    }

    function loadBookMarkFromFile(fn, loaduser = true)
	{
		// ï¿½tï¿½@ï¿½Cï¿½ï¿½ fn ï¿½ï¿½ï¿½ï¿½xï¿½ï¿½Ç‚İï¿½ï¿½ï¿½
		// loaduser ï¿½ï¿½ false ï¿½Ìï¿½ï¿½ï¿½ user ï¿½ï¿½Ç‚İï¿½ï¿½Ü‚È‚ï¿½
		try
		{
			if(!Storages.isExistentStorage(fn)) return false; //ï¿½tï¿½@ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½È‚ï¿½

			var data;

			var modestr;

			if(saveThumbnail)
			{
				// ï¿½wï¿½ï¿½Iï¿½tï¿½Zï¿½bï¿½gï¿½ï¿½ï¿½ï¿½fï¿½[ï¿½^ï¿½ï¿½Ç‚İï¿½ï¿½ï¿½
				modestr += "o" + calcThumbnailSize().size;
			}

			data = Scripts.evalStorage(fn, modestr);

			if(data.id != saveDataID)
			{
				errorInform("loadfail");
				return false;
			}

			pcflags = data.core;
			pcflags = %[] if pcflags === void;
			if(loaduser)
			{
				pflags = data.user;
				pflags = %[] if pflags === void;
			}
			else
			{
				(Dictionary.assignStruct incontextof pflags)(flags);
			}
			historyOfStore = data.history;
			historyOfStore = [] if historyOfStore === void;
		}
		catch(e)
		{
			errorInform("loadexception", e.message);
			return false;
		}
		restoreFlags();
        clearPlayTime(pcflags.playTime);
        return true;
	}

	function loadBookMark(num, loaduser = true)
	{
		// ï¿½xï¿½Ôï¿½ num ï¿½ï¿½ï¿½ï¿½fï¿½[ï¿½^ï¿½ï¿½Ç‚İoï¿½ï¿½
		return loadBookMarkFromFile(getBookMarkFileNameAtNum(num), loaduser);
	}

    function readBookMark(num)
	{
        // ï¿½xï¿½Ôï¿½ num ï¿½ï¿½ï¿½ï¿½fï¿½[ï¿½^ï¿½Ì‚İ‚ï¿½Ç‚İoï¿½ï¿½
        return readBookMarkFromFile(getBookMarkFileNameAtNum(num));
	}
    
	function saveBookMarkWithAsk(num)
	{
		// ï¿½xï¿½Ôï¿½ num ï¿½Éxï¿½ï¿½İ’è‚·ï¿½ï¿½
		// ï¿½ï¿½ï¿½Ì‚Æ‚ï¿½ï¿½Aï¿½İ’è‚·ï¿½é‚©ï¿½Ç‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ë‚ï¿½
		if(readOnlyMode) return false;
		if(bookMarkProtectedStates[num]) return false;
		var prompt = "ï¿½x ";
		if(num < numBookMarks) prompt += (num + 1);
		if(bookMarkDates[num] != "") // bookMarkDates ï¿½ï¿½ï¿½ó•¶ï¿½ï¿½Ìê‡ï¿½Íxï¿½Í‘ï¿½ï¿½İ‚ï¿½ï¿½È‚ï¿½
			prompt += "ï¿½u" + bookMarkNames[num] + "ï¿½v";
		prompt += "ï¿½Éu"+ pcflags.currentPageName + "ï¿½vï¿½ï¿½ï¿½Í‚ï¿½ï¿½İ‚Ü‚ï¿½ï¿½ï¿½?";

        askYesNo(prompt, "ï¿½mï¿½F", saveBookMark, void, num);
        return true;
	}

	function loadBookMarkWithAsk(num)
	{
		// ï¿½xï¿½Ôï¿½ num ï¿½ï¿½ï¿½ï¿½xï¿½ï¿½Ç‚İoï¿½ï¿½
		// ï¿½ï¿½ï¿½Ì‚Æ‚ï¿½ï¿½Aï¿½Ç‚İoï¿½ï¿½ï¿½ï¿½ï¿½Ç‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ë‚ï¿½
		if(num < numBookMarks && bookMarkDates[num] == "") // bookMarkDates ï¿½ï¿½ï¿½ó•¶ï¿½ï¿½Ìê‡ï¿½Íxï¿½Í‘ï¿½ï¿½İ‚ï¿½ï¿½È‚ï¿½
			return false;
		var prompt = "ï¿½x ";
		if(num < numBookMarks) prompt += (num + 1);
		prompt += "ï¿½u"+ bookMarkNames[num] + "ï¿½vï¿½ï¿½ï¿½ï¿½ï¿½Ç‚ï¿½Ü‚ï¿½ï¿½ï¿½?";

        askYesNo(prompt, "ï¿½mï¿½F", loadBookMark, void, num);
        return true;
	}

	function saveBookMarkToFileWithAsk()
	{
		// ï¿½Cï¿½Ó‚Ìƒtï¿½@ï¿½Cï¿½ï¿½ï¿½Éxï¿½ï¿½Û‘ï¿½ï¿½ï¿½ï¿½ï¿½
		// currentPageName ï¿½ï¿½ï¿½tï¿½@ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½Æ‚ï¿½ï¿½Ä“Kï¿½ï¿½ï¿½ï¿½ï¿½ï¿½æ‚¤ï¿½ï¿½
		// ï¿½ÏŒ`ï¿½ï¿½ï¿½ï¿½
		var invalid = "\\/:,;*?\"<>!.";
		var valid = "ï¿½ï¿½ï¿½^ï¿½Fï¿½Cï¿½Gï¿½ï¿½ï¿½Hï¿½hï¿½ï¿½ï¿½ï¿½ï¿½Iï¿½D";

		var initialname = saveDataLocation + "/";
		var through = false;
		var orgname = currentPageName;

		if(lastSaveDataNameGlobal != "")
		{
			try
			{
				initialname = Storages.extractStoragePath(lastSaveDataNameGlobal);
			}
			catch(e)
			{
				initialname = saveDataLocation + "/";
			}
		}

		if(orgname == "")
		{
			// ï¿½xï¿½ÌŒï¿½ï¿½oï¿½ï¿½ï¿½ï¿½ï¿½È‚ï¿½ï¿½Ì‚ï¿½
			if(lastSaveDataName == "")
				orgname = System.title; // System.title ï¿½ï¿½ï¿½ï¿½ï¿½Égï¿½ï¿½
			else
				initialname = lastSaveDataName, through = true;
		}

		if(!through)
		{
			var length = orgname.length;
			for(var i = 0; i < length; i++)
			{
				var ch = orgname[i];
					var ind = invalid.indexOf(ch);
				if(ind != -1)
					initialname += valid[ind];
				else if(#ch >= 32)
					initialname += ch;
			}
		}

		// ï¿½Û‘ï¿½ï¿½ï¿½ï¿½ï¿½tï¿½@ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½ğ“¾‚ï¿½
		var selectdata = %[
			title:"ï¿½xï¿½ï¿½ï¿½Í‚ï¿½ï¿½ï¿½",
			filter: [saveThumbnail ?
					"ï¿½Tï¿½ï¿½ï¿½lï¿½Cï¿½ï¿½ï¿½æ‘œï¿½tï¿½ï¿½ï¿½xï¿½fï¿½[ï¿½^(*.bmp)|*.bmp" :
					"ï¿½xï¿½fï¿½[ï¿½^(*.kdt)|*.kdt"],
			filterIndex : 1,
			name : initialname,
			initialDir : "",
			defaultExt : saveThumbnail?"bmp":"kdt",
			save : true,
		];
		if(Storages.selectFile(selectdata))
		{
			// ï¿½Û‘ï¿½
			saveBookMarkToFile(lastSaveDataName = lastSaveDataNameGlobal = selectdata.name);
			lastSaveDataName = Storages.chopStorageExt(lastSaveDataName);
		}
	}

	function loadBookMarkFromFileWithAsk()
	{
		// ï¿½Cï¿½Ó‚Ìƒtï¿½@ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½xï¿½ï¿½Ç‚İï¿½ï¿½ï¿½
		var initialdir = "";
		if(lastSaveDataNameGlobal == "")
			initialdir = saveDataLocation + "/";

		var selectdata = %[
			title:"ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½Ç‚ï¿½",
			filter: [saveThumbnail ?
					"ï¿½Tï¿½ï¿½ï¿½lï¿½Cï¿½ï¿½ï¿½æ‘œï¿½tï¿½ï¿½ï¿½xï¿½fï¿½[ï¿½^(*.bmp)|*.bmp" :
					"ï¿½xï¿½fï¿½[ï¿½^(*.kdt)|*.kdt"],
			filterIndex : 1,
			name : lastSaveDataNameGlobal,
			initialDir : initialdir,
			defaultExt : saveThumbnail?"bmp":"kdt",
			save : false,
		];
		if(Storages.selectFile(selectdata))
		{
			loadBookMarkFromFile(lastSaveDataName = lastSaveDataNameGlobal = selectdata.name);
			lastSaveDataName = Storages.chopStorageExt(lastSaveDataName);
		}
	}


	function copyBookMark(from, to)
	{
		// ï¿½xï¿½Ôï¿½ from ï¿½ï¿½ï¿½ï¿½xï¿½Ôï¿½ to ï¿½Éxï¿½ï¿½ï¿½Rï¿½sï¿½[ï¿½ï¿½ï¿½ï¿½
		if(readOnlyMode) return false;
		if(bookMarkProtectedStates[to]) return;

		var fn = getBookMarkFileNameAtNum(from);

		if(!Storages.isExistentStorage(fn)) return; //ï¿½tï¿½@ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½È‚ï¿½

		var data = Scripts.evalStorage(fn);

		fn = getBookMarkFileNameAtNum(to);

        (Dictionary.saveStruct incontextof data)(fn, saveDataMode);
        getBookMarkInfoFromData(data.core, to);
	}

	function eraseBookMark(num)
	{
		// ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		// num < numBookMarks ï¿½Ìï¿½ï¿½É‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ì‚µï¿½È‚ï¿½ï¿½æ‚¤ï¿½É‚È‚ï¿½ï¿½ï¿½ï¿½Ì‚Å’ï¿½ï¿½ï¿½
		if(num < numBookMarks)
		{
			if(!bookMarkProtectedStates[num])
			{
				bookMarkDates[num] = "";
				setBookMarkMenuCaptions();
			}
		}
	}

	function tempDisableStore(elm)
	{
		// ï¿½xï¿½ï¿½ï¿½êï¿½Iï¿½É•Û‘ï¿½ï¿½sï¿½Â”\ï¿½É‚ï¿½ï¿½ï¿½
		storeEnabled = true;
		if(elm.store === void)
			storeLabelPassed = false;
		else
			storeLabelPassed = !(+elm.store);
		if(elm.restore == void)
			restoreEnabled = true;
		else
			restoreEnabled = !(+elm.restore);
		setMenuAccessibleAll();
	}

	function setStoreEnabled(enabled)
	{
		// ï¿½xï¿½ï¿½ï¿½jï¿½ï¿½ï¿½[ï¿½Ì—Lï¿½ï¿½/ï¿½ï¿½ï¿½ï¿½Ìİ’ï¿½
		storeEnabled = enabled;
		restoreEnabled = enabled;
		setMenuAccessibleAll();
	}

	function setStartAnchorEnabled(enabled)
	{
		// ï¿½uï¿½Åï¿½ï¿½É–ß‚ï¿½vï¿½Ì—Lï¿½ï¿½/ï¿½ï¿½ï¿½ï¿½Ìİ’ï¿½
		startAnchorEnabled = enabled;
		if(enabled) saveBookMark(999, false); // 999 ï¿½Ô‚É•Û‘ï¿½
		setMenuAccessibleAll();
	}

	function goToStart()
	{
		// ï¿½Åï¿½ï¿½É–ß‚ï¿½
		if(!startAnchorEnabled) return;
		loadBookMark(999, false); // ï¿½xï¿½ï¿½Ç‚İï¿½ï¿½ï¿½
	}

	function goToStartWithAsk()
	{
		// ï¿½Åï¿½ï¿½É–ß‚ï¿½(ï¿½mï¿½Fï¿½ï¿½ï¿½ï¿½)
        askYesNo("ï¿½Åï¿½ï¿½É–ß‚ï¿½Ü‚ï¿½ï¿½Bï¿½ï¿½ë‚µï¿½ï¿½ï¿½Å‚ï¿½ï¿½ï¿½ ?", "ï¿½mï¿½F", goToStart);
	}

	function tempSave(num)
	{
		// tempBookMarks[num] ï¿½ÉŒï¿½ï¿½İ‚Ìï¿½Ô‚ï¿½Û‘ï¿½ï¿½ï¿½ï¿½ï¿½
		tempBookMarks[num] = %[];
		internalStoreFlags(tempBookMarks[num]);
	}

	function tempLoad(num, elm)
	{
		// tempBookMarks[num] ï¿½ï¿½ï¿½ï¿½ï¿½Ô‚ï¿½Ç‚İï¿½ï¿½ï¿½
		internalRestoreFlags(tempBookMarks[num], false, elm);
	}

	function restoreBookMark(num, ask = true)
	{
		// KAG 2.x ï¿½İŠï¿½ï¿½p
		if(ask)
			return loadBookMarkWithAsk(num);
		else
			return loadBookMark(num);
	}

	function storeBookMark(num, ask = true)
	{
		// KAG 2.x ï¿½İŠï¿½ï¿½p
		if(ask)
			return saveBookMarkWithAsk(num);
		else
			return saveBookMark(num);
	}

	//------------------------------------------------- ï¿½ï¿½ï¿½ï¿½/ï¿½ï¿½ï¿½/ï¿½ï¿½ï¿½xï¿½ï¿½ï¿½Lï¿½^ --

    function getRecordLabel(storage, label) {
        if(label != '')	{
            if(label[0] == '*') label = label.substring(1);
        }
        return Storages.chopStorageExt(Storages.extractStorageName(storage)) + '_' + label;
    }

    function getBookMarkFileNameAtLabel(storage, label) {
        var name = saveDataLocation + "/" + "auto_" + getRecordLabel(storage, label) + ".ksd";
		//dm("ï¿½Û‘ï¿½ï¿½tï¿½@ï¿½Cï¿½ï¿½ï¿½ï¿½:" + name);
        return name;
    }

    
	function setRecordLabel(storage, label)
	{
		// ï¿½ï¿½ï¿½İ‚Ìƒï¿½ï¿½xï¿½ï¿½ï¿½ï¿½İ’è‚·ï¿½ï¿½
		if(autoRecordPageShowing)
		{
			if(label != '')
			{
				if(label[0] == '*') label = label.substring(1);
				if(label[1] == '-') return; // ï¿½ï¿½ï¿½[ï¿½Jï¿½ï¿½ï¿½ï¿½ï¿½xï¿½ï¿½
			}
			currentRecordName = 'trail_' + Storages.chopStorageExt(
				Storages.extractStorageName(storage)) + '_' + label;
			autoLabelCurrentRecordName = "auto" + currentRecordName;
		}
	}

	function incRecordLabel(count)
	{
		// ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½xï¿½ï¿½ï¿½ï¿½Ô‚ï¿½Û‘ï¿½
		storeAutoLabel();

        // sflags[currentRecordName]++
		if(autoRecordPageShowing)
		{
			if(currentRecordName != "")
			{
				if(count)
				{
                    if(sflags[currentRecordName] === void)
						sflags[currentRecordName] = 0;
					sflags[currentRecordName]++;
				}
				currentRecordName = "";
				autoLabelCurrentRecordName  ="";
			}
		}
	}

	//------------------------------------------- ï¿½Vï¿½Xï¿½eï¿½ï¿½ï¿½Sï¿½Ì‚ÉŠÖŒWï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ --

	function setTitle(title)
	{
		// ï¿½^ï¿½Cï¿½gï¿½ï¿½ï¿½ï¿½İ’ï¿½
		//if(isMain) System.title = title;
		caption = title;
	}

	function setCursor(elm)
	{
		// ï¿½}ï¿½Eï¿½Xï¿½Jï¿½[ï¿½\ï¿½ï¿½ï¿½Ìİ’ï¿½
		var conv = function(variable, value)
		{
			if(value !== void)
			{
				if(!(typeof value == "String" &&
					(value.indexOf('.cur')!=-1 || value.indexOf('.ani')!=-1) ))
						value = +value;
				this[variable] = value;
			}
		} incontextof this;

		conv('cursorDefault', elm['default']); 
		conv('cursorPointed', elm.pointed);
		conv('cursorWaitingClick', elm.click);
		conv('cursorDraggable', elm.draggable);
		fore.base.setDefaultCursor(cursorDefault);
		back.base.setDefaultCursor(cursorDefault);
	}

	//---------------------------------------------------- ï¿½gï¿½ï¿½ï¿½Kï¿½Ç—ï¿½(TJSï¿½p) --

	function waitTrigger(elm)
	{
		// elm.name ï¿½Åï¿½ï¿½ï¿½ï¿½ê‚½ï¿½gï¿½ï¿½ï¿½Kï¿½ï¿½Ò‚ï¿½
		if((elm.canskip !== void && +elm.canskip) && clickSkipEnabled)
		{
			// ï¿½Xï¿½Lï¿½bï¿½vï¿½Å‚ï¿½ï¿½ï¿½ê‡
			if(skipMode)
			{
				// ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½ì’†
				if(elm.onskip !== void) Scripts.eval(elm.onskip);
				return 0; // ï¿½ï¿½ï¿½ï¿½ï¿½É•Ô‚ï¿½
			}
			conductor.wait(%[
				click : function(arg)
				{
					if(arg !== void) Scripts.eval(arg);
				} incontextof this,
				click_arg : elm.onskip,
				elm.name => function
				{
				} incontextof this
				]);
		}
		else
		{
			conductor.wait(%[
				elm.name => function
				{
				} incontextof this
				]);
		}
		return -2;
	}

	function trigger(name)
	{
		// name ï¿½Åï¿½ï¿½ï¿½ï¿½ï¿½ï¿½gï¿½ï¿½ï¿½Kï¿½ğ”­“ï¿½ï¿½ï¿½ï¿½ï¿½
		conductor.trigger(name);
	}

	//------------------------------------------------------- ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ --

	function showHistory()
	{
		// ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		historyLayer.parent = fore.base; // ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ìeï¿½ï¿½ï¿½Äİ’ï¿½
        historyLayer.absolute = 4000000;
		historyLayer.dispInit();
		historyShowing = true;
		if(typeof this.showHistoryMenuItem != "undefined")
			showHistoryMenuItem.checked = true;
		setMenuAccessibleAll();
	}

	function hideHistory()
	{
		// ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½É‚ï¿½ï¿½ï¿½
		historyLayer.dispUninit();
		historyShowing = false;
		if(typeof this.showHistoryMenuItem != "undefined")
			showHistoryMenuItem.checked = false;
		setMenuAccessibleAll();
		lastHistoryHiddenTick = System.getTickCount();
		conductor.trigger('history'); // 'history' ï¿½ğ‘—‚ï¿½
	}

	function setHistoryOptions(elm)
	{
		// elm ï¿½ï¿½ï¿½çƒï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ÌƒIï¿½vï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½İ’è‚·ï¿½ï¿½
		historyWriteEnabled = +elm.output if elm.output !== void;
		historyEnabled = +elm.enabled if elm.enabled !== void;
		if(elm.enabled !== void && !historyEnabled)
			historyLayer.clearAction();
		historyLayer.setOptions(elm); // ï¿½ï¿½ï¿½Ì‘ï¿½ï¿½ÌƒIï¿½vï¿½Vï¿½ï¿½ï¿½ï¿½
		setMenuAccessibleAll();
	}

	function showHistoryByScenario(elm)
	{
		// ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Vï¿½iï¿½ï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		showHistory();
		conductor.wait(%[ // ï¿½Rï¿½ï¿½ï¿½_ï¿½Nï¿½^ï¿½ï¿½Ò‚ï¿½ï¿½ï¿½
			history : function
			{
				// ï¿½ï¿½é‚±ï¿½Æ‚È‚ï¿½
			} incontextof this
			]);
		return -2; // break
	}

    //------------------------------------------------------- ï¿½Iï¿½ï¿½ï¿½ï¿½ --

    function setSelectOptions(elm)
	{
        selectLayer.setOptions(elm);
	}

    function addSelect(elm) {
		if ((elm.eval === void || elm.eval == "" || Scripts.eval(elm.eval))) {
			if (f.selectInfos == void) {
				f.selectInfos = [];
			}
			if (f.selectDoneFlag) {
				f.selectInfos.clear();
				f.selDoneStorage = void;
				f.selDoneTarget  = void;
				f.selectDoneFlag = false;
			}
			var e = %[];
			(Dictionary.assign incontextof e)(elm,false);
			f.selectInfos.add(e);
		}
	}

    /**
     * ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½Ì•\ï¿½ï¿½
     */
	function showSelect()
	{
		selectLayer.clearButtons();
		for (var i=0;i<f.selectInfos.count;i++) {
			selectLayer.addSelect(f.selectInfos[i]);
		}
		selectLayer.start(fore.base, 1000000);
		selectShowing = true;
        setMenuAccessibleAll();
	}

    function hideSelect() {
        if (_selectLayer !== void) {
            selectLayer.done();
            selectShowing = false;
        }
    }
    
    function afterSelect() {
        if (erAfterPage) {
            // ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½eï¿½Lï¿½Xï¿½gï¿½ï¿½ï¿½ï¿½
            tagHandlers.er(%[all:true]);
        }
        if (afterauto && selectPrevAutoMode == true) {
            if(typeof this.autoModeMenuItem !== "undefined")
                autoModeMenuItem.checked = true;
            autoMode = true;
        } else if (afterskip && selectPrevSkipMode >= SKIP_STOP) {
            if (selectPrevSkipMode == SKIP_STOP) {
                skipMode = SKIP_STOP;
                actualChSpeed = 0;
            } else if (selectPrevSkipMode == SKIP_FAST) {
                if (getKeyState(VK_CONTROL)) {
                    skipMode = SKIP_FAST;
                    actualChSpeed = 0;
                }
            }
        }
        setMenuAccessibleAll();
    }

    //------------------------------------------------------- ï¿½}ï¿½bï¿½vï¿½Iï¿½ï¿½ï¿½ï¿½ --

    /**
     * ï¿½}ï¿½bï¿½vï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
     */
    function initMapSelect()
    {
        mapSelectLayer.init();
	}

    /**
     * ï¿½}ï¿½bï¿½vï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½Iï¿½vï¿½Vï¿½ï¿½ï¿½ï¿½
     */
    function setMapSelectOptions(elm)
	{
        mapSelectLayer.setOptions(elm);
	}

    /**
     * ï¿½{ï¿½^ï¿½ï¿½ï¿½oï¿½^
     */
    function addMapSelectButton(elm) {
		mapSelectLayer.addButton(elm);
    }

    /**
     * ï¿½êŠï¿½oï¿½^
     */
    function addMapSelectPosition(elm) {
        mapSelectLayer.addPosition(elm);
    }

    /**
     * ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½oï¿½^
     */
    function addMapSelect(elm) {
		if ((elm.eval === void || elm.eval == "" || Scripts.eval(elm.eval))) {
			mapSelectLayer.addSelect(elm);
		}
    }
    
    function showMapSelect()
	{
        mapSelectLayer.start(fore.base, 1000000);
        mapSelectShowing = true;
        setMenuAccessibleAll();
	}

    function hideMapSelect()
	{
        if (_mapSelectLayer !== void) {
            mapSelectLayer.done();
            mapSelectShowing = false;
        }
    }

    //------------------------------------------------------- ï¿½Vï¿½iï¿½ï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ --

	/**
	 * ï¿½ï¿½ï¿½ï¿½Ì’Ç‰ï¿½
	 */
    function addBranch(elm) {
		if (f.branchInfos == void) {
			f.branchInfos = [];
		}
		delete f.branchDoneTarget;
		var e = %[];
		(Dictionary.assign incontextof e)(elm,false);
		f.branchInfos.add(e);
		return 0;
    }

	/**
	 * ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½s
	 */
	function doBranch(elm) {
		f.branchDoneTarget  = elm.target  if elm.target  !== void;
		for (var i=0;i<f.branchInfos.count;i++) {
			var elm = f.branchInfos[i];
			if (elm.target !== void && (elm.eval === void || elm.eval == "" || Scripts.eval(elm.eval))) {
				kag.process("", elm.target);
				break;
			}
		}
		delete f.branchInfos;
		return 0;
    }

	/**
	 * ï¿½ï¿½ï¿½ï¿½Iï¿½ï¿½
	 */
	function doneBranch(elm) {
		if (f.branchDoneTarget != "") {
			// ï¿½ï¿½ï¿½ï¿½
			kag.process("", f.branchDoneTarget);
		} else {
			// ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½~
			return kag.tagHandlers.s(elm);
		}
        return 0;
    }
	
    //------------------------------------------------------- ï¿½ï¿½ÊØ‚ï¿½Ö‚ï¿½ï¿½ï¿½ï¿½êƒŒï¿½Cï¿½ï¿½ --

    function hideTransLayer() {
        if (_transLayer !== void) {
            transLayer.stop();
            transShowing = false;
        }
    }
    
    function layerTransBegin(elm)
	{
        hideTransLayer();
        if (elm.time === void) { elm.time = 1000; }
        if (elm.type === void) { elm.type = "wipeltor"; }
        var waitParam  = %[];
		var waitTime = void;
        if((elm.canskip === void || +elm.canskip) && clickSkipEnabled) {
            if(skipMode) {
                return 0; // ï¿½ï¿½ï¿½ï¿½ï¿½É•Ô‚ï¿½
            }
            waitParam.click = function() {hideTransLayer();} incontextof this;
		}
        if (elm.wait !== void) {
            waitTime = +elm.time + +elm.wait;
            waitParam.timeout = function() {} incontextof this;
        } else {
            waitParam.layertrans = function() {} incontextof this;
        }
        transLayer.start(elm);
		flipStart();
		transShowing = true;
        if (waitTime > 0) {
            conductor.waitWithTimeOut(waitParam, waitTime);
        } else {
            conductor.wait(waitParam);
        }
        return -2;
	}

    function layerTransEnd(elm) {
        if (!transShowing) {
            return 0;
        }
        var waitParam  = %[];
        if((elm.canskip === void || +elm.canskip) && clickSkipEnabled) {
            if(skipMode) {
                hideTransLayer();
                return 0; // ï¿½ï¿½ï¿½ï¿½ï¿½É•Ô‚ï¿½
            }
            waitParam.click = function() {hideTransLayer();} incontextof this;
        }
        waitParam.layertrans = function() {hideTransLayer();} incontextof this;
		transLayer.start(elm, true);
		flipStart();
        conductor.wait(waitParam);
        return -2;
    }

	//------------------------------------------------------- ï¿½pï¿½lï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ --

	// ï¿½pï¿½lï¿½ï¿½ï¿½p
	var panelLayer;
	var panelShowing = false;
	var panelModal   = false; // modalï¿½\ï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½hï¿½ï¿½ï¿½Ç‚ï¿½ï¿½ï¿½
	function hidePanel() {
		if (panelLayer !== void) {
			panelLayer.removeMode();
			panelLayer.visible = false;
			invalidate panelLayer;
			panelLayer = void;
			panelModal = panelShowing = false;
        }
	}

	//-------------------------------------------------------------- process --

	function process(file, label, countpage = true, immediate = false)
	{
        // ï¿½wï¿½ï¿½tï¿½@ï¿½Cï¿½ï¿½ï¿½Aï¿½wï¿½èƒ‰ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½sï¿½ï¿½ï¿½Jï¿½nï¿½ï¿½ï¿½ï¿½

        if(!usingExtraConductor) {
            incRecordLabel(countpage);
        }
		setUserSpeed();

		if(file != '')
		{
			// ï¿½tï¿½@ï¿½Cï¿½ï¿½ï¿½ï¿½Ç‚İï¿½ï¿½ï¿½
            conductor.loadScenario(file);
		}

		if(label != '')
		{
			// ï¿½ï¿½ï¿½xï¿½ï¿½ï¿½ÉˆÚ“ï¿½ï¿½ï¿½ï¿½ï¿½
			conductor.goToLabel(label);
		}

		if(isFirstProcess)
		{
			storeFlags(); // ï¿½ï¿½ÔÅï¿½ï¿½Ìï¿½Ô‚ï¿½ï¿½Xï¿½gï¿½A
			isFirstProcess = false;
		}

        if (debugLevel >= tkdlSimple)
            dm("ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Jï¿½nï¿½ï¿½ï¿½Ü‚ï¿½");
		inSleep = false;
		notifyRun();
		if(conductor.status != conductor.mRun) conductor.run(immediate); // ï¿½ï¿½ï¿½sï¿½Jï¿½n
    }

	function processGo()
	{
        // ï¿½Rï¿½ï¿½ï¿½_ï¿½Nï¿½^ï¿½ï¿½ï¿½ï¿½ï¿½İˆÊ’uï¿½ï¿½ï¿½ï¿½ï¿½ï¿½sï¿½Jï¿½nï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
        if (debugLevel >= tkdlSimple)
            dm("ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Jï¿½nï¿½ï¿½ï¿½Ü‚ï¿½");
		inSleep = false;
		notifyRun();
		conductor.run(false); // ï¿½ï¿½ï¿½sï¿½Jï¿½n
	}

	function processCall(file, label)
	{
		// ï¿½wï¿½ï¿½tï¿½@ï¿½Cï¿½ï¿½ï¿½Aï¿½wï¿½èƒ‰ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½Ä‚ï¿½
		// incRecordLabel(); ï¿½ÍŒÄ‚Î‚È‚ï¿½ï¿½Ì‚Å’ï¿½ï¿½ï¿½

		if(file != '')
		{
			// ï¿½tï¿½@ï¿½Cï¿½ï¿½ï¿½ï¿½Ç‚İï¿½ï¿½ï¿½
			conductor.loadScenario(file);
		}

		inSleep = false;
		notifyRun();
		conductor.callLabel(label); // ï¿½ï¿½ï¿½sï¿½Jï¿½n
        if (debugLevel >= tkdlSimple)
            dm("ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Jï¿½nï¿½ï¿½ï¿½Ü‚ï¿½");
		if(conductor.status != conductor.mRun) conductor.run();
	}

	//------------------------------------------------- ï¿½Rï¿½ï¿½ï¿½_ï¿½Nï¿½^ï¿½ÌƒCï¿½xï¿½ï¿½ï¿½g --

	function onConductorScenarioLoad(name)
	{
        prevSkipMode = void;
        // ï¿½Rï¿½ï¿½ï¿½_ï¿½Nï¿½^ï¿½ï¿½ï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Vï¿½iï¿½ï¿½ï¿½Iï¿½tï¿½@ï¿½Cï¿½ï¿½ï¿½ï¿½Ç‚İï¿½ï¿½Ş‘Oï¿½É‚ï¿½Î‚ï¿½ï¿½B
		// name ï¿½Í“Ç‚İï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æ‚ï¿½ï¿½ï¿½ï¿½Vï¿½iï¿½ï¿½ï¿½Iï¿½tï¿½@ï¿½Cï¿½ï¿½ï¿½B
		// ï¿½ß‚ï¿½lï¿½É•ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ô‚ï¿½ï¿½ÆAï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Vï¿½iï¿½ï¿½ï¿½Iï¿½Æ‚ï¿½ï¿½ï¿½
		// ï¿½tï¿½@ï¿½Cï¿½ï¿½ï¿½Ì‘ï¿½ï¿½ï¿½Égï¿½ï¿½ï¿½æ‚¤ï¿½É‚È‚ï¿½Ì‚ÅAï¿½ï¿½ï¿½ï¿½ï¿½Éƒtï¿½Bï¿½ï¿½ï¿½^ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		// ï¿½Æ‚ï¿½ï¿½Å‚ï¿½ï¿½ï¿½B
		// true ï¿½ï¿½Ô‚ï¿½ï¿½Æ’Êï¿½ÌƒVï¿½iï¿½ï¿½ï¿½Iï¿½tï¿½@ï¿½Cï¿½ï¿½ï¿½Ç‚İï¿½ï¿½İ‚Æ‚È‚ï¿½B
		return true;
	}


	function onConductorScenarioLoaded(name)
	{
		// ï¿½Rï¿½ï¿½ï¿½_ï¿½Nï¿½^ï¿½ï¿½ï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Vï¿½iï¿½ï¿½ï¿½Iï¿½tï¿½@ï¿½Cï¿½ï¿½ï¿½ï¿½Ç‚İï¿½ï¿½ï¿½
		if(!usingExtraConductor) incRecordLabel(true);
        return true;
	}


	function onConductorLabel(label, page)
	{
        if (skipMode == SKIP_LABEL) {
            cancelSkip();
        }
        // ï¿½Rï¿½ï¿½ï¿½_ï¿½Nï¿½^ï¿½ï¿½ï¿½ï¿½ï¿½xï¿½ï¿½ï¿½ï¿½Ê‰ß‚ï¿½ï¿½ï¿½
		if(!usingExtraConductor)
		{
            if (label !== "*autoLabelLabel") {
                incRecordLabel(true);
				autoLabelCount = 1;
            }
            setRecordLabel(conductor.curStorage, label);
		}
		setUserSpeed();
		if(!usingExtraConductor)
		{
            if (label !== "*autoLabelLabel") {
				if(!(allskip || getCurrentRead()) && skipMode < SKIP_FAST)
                    cancelSkip(); // ï¿½ï¿½ï¿½Ç‚È‚Ì‚ÅƒXï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½~
                currentStorage = conductor.curStorage;
            }
            currentLabel = label;
		}
		if (autoLabelMode) {
			autoLabelCount++;
			storeAutoLabel();
		}
		if(page !== void && page !== '')
		{
			if(page[0] == '&') page = Scripts.eval((page.substring(1)));
			currentPageName = page;
		}
		if(page !== void)
		{
			pushHistoryOfStore();
			stablePosibility = false;
            if (debugLevel >= tkdlVerbose) {
				dm(conductor.curStorage + " : ï¿½ï¿½ï¿½xï¿½ï¿½/ï¿½yï¿½[ï¿½W : " + label + "/" + currentPageName);
            }
			if(usingExtraConductor) throw new Exception("ï¿½Eï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Tï¿½uï¿½ï¿½ï¿½[ï¿½`ï¿½ï¿½ï¿½ï¿½/extraCondutor"
				"ï¿½Tï¿½uï¿½ï¿½ï¿½[ï¿½`ï¿½ï¿½ï¿½ï¿½ï¿½Å‚Í•Û‘ï¿½ï¿½Â”\ï¿½Èƒï¿½ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½Lï¿½qï¿½Å‚ï¿½ï¿½Ü‚ï¿½ï¿½ï¿½");
			storeFlags(), storeLabelPassed = true, setMenuAccessibleAll();
			if(recordHistoryOfStore == 1) // 1 : ï¿½Û‘ï¿½ï¿½Â”\ï¿½Èƒï¿½ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
				setToRecordHistory();

			// ï¿½fï¿½oï¿½bï¿½Oï¿½pï¿½Éï¿½ï¿½ï¿½ï¿½Û‘ï¿½
			if (autoLabelSaveMode) {
                saveBookMarkToFile(getBookMarkFileNameAtLabel(conductor.curStorage, label));
            }

        }

        if (label.substring(0,12) == "*kaisouBegin") {

            // ï¿½ï¿½zï¿½pï¿½Ì‹Lï¿½^ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½sï¿½ï¿½
            var num = (int)label.substring(12);
            saveBookMark(recollectionBookmark + num, false);

        } else if (label.substring(0,10) == "*kaisouEnd") {

            // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ç‚É‚ï¿½ï¿½ï¿½
            if(!usingExtraConductor) incRecordLabel(true);

            // ï¿½ï¿½zï¿½Iï¿½ï¿½
            if (label == recollectionEndLabel) {
                endRecollection();
            }
            
        }
		return true;
	}

	function onConductorJump(elm)
	{
        // ï¿½Rï¿½ï¿½ï¿½_ï¿½Nï¿½^ï¿½ï¿½ jump ï¿½^ï¿½Oï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æ‚ï¿½
        closeDialog();
        if(!usingExtraConductor) incRecordLabel(elm.countpage === void || +elm.countpage);
		return true;
	}

	function onConductorCall(elm)
	{
		// ï¿½Rï¿½ï¿½ï¿½_ï¿½Nï¿½^ï¿½ï¿½ call ï¿½^ï¿½Oï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æ‚ï¿½
		if(!usingExtraConductor) incRecordLabel(elm.countpage !== void && +elm.countpage);
		return true;
	}

	function onConductorReturn(elm)
	{
		// ï¿½Rï¿½ï¿½ï¿½_ï¿½Nï¿½^ï¿½ï¿½ return ï¿½^ï¿½Oï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æ‚ï¿½
		if(!usingExtraConductor) incRecordLabel(elm.countpage === void || +elm.countpage);
		if(conductor === extraConductor)
		{
			// extraConductor ï¿½Tï¿½uï¿½ï¿½ï¿½[ï¿½`ï¿½ï¿½ï¿½pï¿½ÌƒRï¿½ï¿½ï¿½_ï¿½Nï¿½^ï¿½ï¿½ï¿½ï¿½Ä‚Î‚ï¿½Ä‚ï¿½ï¿½ï¿½
			if(conductor.callStackDepth == 1)
			{
				// ï¿½Â‚Ü‚ï¿½Aï¿½ÅIï¿½ï¿½ return ï¿½ï¿½ï¿½ï¿½ï¿½sï¿½ï¿½ï¿½ê‚½ï¿½ÆŒï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
				dm("extraConductor ï¿½Tï¿½uï¿½ï¿½ï¿½[ï¿½`ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ß‚ï¿½Ü‚ï¿½ ...");
				var run;
				if(elm.storage !== void || elm.target !== void) run = true; else run = false;
				returnExtraConductor(run);
				if(elm.storage !== void) conductor.loadScenario(elm.storage);
				if(elm.target !== void) conductor.goToLabel(elm.target);
				setRecordLabel(currentStorage = conductor.curStorage, currentLabel = conductor.curLabel);
				if(run)
				{
					notifyRun();
					conductor.run();
				}
				isLeavePeriodEvent = false;
				if(elm.storage !== void || elm.target !== void)
				{	// returnï¿½ÅŒï¿½ï¿½ÌˆÊ’uï¿½ÈŠOï¿½É–ß‚éï¿½Íƒsï¿½ï¿½ï¿½Iï¿½hï¿½Cï¿½xï¿½ï¿½ï¿½gï¿½ï¿½ï¿½Nï¿½ï¿½ï¿½Aï¿½ï¿½ï¿½ï¿½B
					holdPeriodEventQueue.clear();
					isWaitPeriodEvent = false;
				}
				if( isWaitPeriodEvent == true )
				{	// [wp]ï¿½Åƒsï¿½ï¿½ï¿½Iï¿½hï¿½Cï¿½xï¿½ï¿½ï¿½gï¿½Ò‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ä‚ï¿½ï¿½éï¿½Ì‚İAï¿½gï¿½ï¿½ï¿½Kï¿½[ï¿½ï¿½ï¿½ï¿½
					fireMoviePeriodFromQueue();
				}
				return false; // return ï¿½Íï¿½ï¿½sï¿½ï¿½ï¿½È‚ï¿½
			}
		}
		return true;
	}
	function purgeMoviePeriod()
	{
		isLeavePeriodEvent = false;
		holdPeriodEventQueue.clear();
		isWaitPeriodEvent = false;
		waitedPeriodEventStorageName = void;
	}
	function fireMoviePeriodFromQueue()
	{
		var retVal = false;
		if( holdPeriodEventQueue.count > 0 )
		{
			if( waitedPeriodEventStorageName == conductor.curStorage && conductor == mainConductor )
			{
				for( var i = 0; i < holdPeriodEventQueue.count; i++ )
				{
					conductor.trigger( holdPeriodEventQueue[i] );
					retVal = true;
				}
			}
			holdPeriodEventQueue.clear();
		}
		return retVal;
	}

	function onConductorAfterReturn()
	{
		// ï¿½Rï¿½ï¿½ï¿½_ï¿½Nï¿½^ï¿½ï¿½ return ï¿½^ï¿½Oï¿½ï¿½ï¿½ï¿½ï¿½sï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		if(!usingExtraConductor)
		{
			setRecordLabel(currentStorage = conductor.curStorage, currentLabel = conductor.curLabel);
		}
		setUserSpeed();
		if(!usingExtraConductor)
		{
            if(!(allskip || getCurrentRead()) && skipMode < SKIP_FAST)
                cancelSkip(); // ï¿½ï¿½ï¿½Ç‚È‚Ì‚ÅƒXï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½~
		}
    }

	function onConductorScript(script, scriptname, lineofs)
	{
		// iscript ï¿½^ï¿½O
		try
		{
			Scripts.exec(script, scriptname, lineofs);
		}
		catch(e)
		{
			throw new Exception(scriptname + " ï¿½ï¿½ ï¿½s " + lineofs + " ï¿½ï¿½ï¿½ï¿½nï¿½Ü‚ï¿½"
				" iscript ï¿½uï¿½ï¿½ï¿½bï¿½Nï¿½ÅƒGï¿½ï¿½ï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ü‚ï¿½ï¿½ï¿½ï¿½B"
				"\n( ï¿½Ú×‚ÍƒRï¿½ï¿½ï¿½\ï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½Qï¿½Æ‚ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ )\n" + e.message);
		}
		return true;
	}

    var unknownHandler;
    
	function onConductorUnknownTag(tagname, elm)
	{
        var ret;
        if (unknownHandler === void || (ret = unknownHandler(tagname,elm)) === void) {
            // ï¿½sï¿½ï¿½ï¿½Èƒ^ï¿½Oï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ê‡
            throw new Exception("ï¿½^ï¿½O/ï¿½}ï¿½Nï¿½ï¿½ \"" + tagname + "\" ï¿½Í‘ï¿½ï¿½İ‚ï¿½ï¿½Ü‚ï¿½ï¿½ï¿½");
        } else {
            return ret; // ï¿½ï¿½ï¿½Ì–ß‚ï¿½lï¿½ÍAï¿½eï¿½^ï¿½Oï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½ï¿½ï¿½Ô‚ï¿½ï¿½ï¿½ï¿½Æ‚ï¿½ï¿½È‚ï¿½
        }
	}

	//----------------------------------------------------------- stable/run --

	function notifyStable()
	{
		// ï¿½Vï¿½Xï¿½eï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½(ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Ò‚ï¿½/ï¿½ï¿½~)ï¿½ï¿½ï¿½ï¿½ï¿½Æ‚ï¿½ï¿½ÉAï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½ï¿½ï¿½Ä‚ï¿½
		if(!inStable)
		{
			inStable = true;
			var handlers = stableHandlers;
			for(var i = handlers.count-1; i>=0; i--)
				handlers[i]();

			// stableHook
			forEachEventHook('onStableStateChanged',
				function(handler, f) { handler(f.stable); } incontextof this,
				%[stable:true]);
        }
	}

	function notifyRun()
	{
		// ï¿½Vï¿½Xï¿½eï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½nï¿½ß‚ï¿½ï¿½Æ‚ï¿½ï¿½ÉAï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½ï¿½ï¿½Ä‚ï¿½
		if(inStable)
		{
			inStable = false;
			var handlers = runHandlers;
			for(var i = handlers.count-1; i>=0; i--)
				handlers[i]();

			// runHook
            forEachEventHook('onStableStateChanged',
				function(handler, f) { handler(f.stable); } incontextof this,
				%[stable:false]);
            
			if(autoMode) hideMouseCursor();
		}
	}

	function defaultStableHandler()
	{
		// ï¿½fï¿½tï¿½Hï¿½ï¿½ï¿½gï¿½ï¿½ stable ï¿½nï¿½ï¿½ï¿½hï¿½ï¿½
		setMenuAccessibleAll();
	}

	function defaultRunHandler()
	{
		// ï¿½fï¿½tï¿½Hï¿½ï¿½ï¿½gï¿½ï¿½ run ï¿½nï¿½ï¿½ï¿½hï¿½ï¿½
		hideHistory();
		hideClickGlyphs();
		showMessageLayerByUser();
		setMenuAccessibleAll();
	}

	//----------------------------------------------------------- ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ --

	var inputTemp;
	function inputString(elm)
	{
		// ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Í‚ï¿½ï¿½ï¿½
		var name = elm.name;
		var initial = Scripts.eval(name);
		var res = System.inputString(elm.title, elm.prompt, initial);
		if(res !== void)
		{
			// name ï¿½ï¿½ res ï¿½ï¿½ï¿½ï¿½ï¿½
			inputTemp = res;
			Scripts.eval(("(" + name + ") = kag.inputTemp"));
		}
	}

	//-------------------------------------------------- extraConductor ï¿½ï¿½ï¿½ï¿½ --

	function callExtraConductor(storage, label, onreturn)
	{
		// extraConductor ï¿½ï¿½ï¿½gï¿½ï¿½ï¿½ÄƒTï¿½uï¿½ï¿½ï¿½[ï¿½`ï¿½ï¿½ï¿½ï¿½ï¿½Ä‚Ñoï¿½ï¿½
		onExtraConductorReturn = onreturn;
		inSleepBeforeExtraConductor = inSleep; // inSleep ï¿½Û‘ï¿½

		storeMessageLayerSelProcessLock(); // ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ storeSelProcessLock ï¿½ï¿½ï¿½Ä‚ï¿½
		lockSelectLayerFocus(true);

		conductor = extraConductor; // ï¿½Rï¿½ï¿½ï¿½_ï¿½Nï¿½^ï¿½ï¿½Ø‚ï¿½Ö‚ï¿½ï¿½ï¿½
		(Dictionary.assign incontextof extraConductor.macros)(mainConductor.macros);
			// ï¿½}ï¿½Nï¿½ï¿½ï¿½ÍƒRï¿½sï¿½[
		usingExtraConductor = true;
		if(storage == '')
		{
			// ï¿½Xï¿½gï¿½ï¿½ï¿½[ï¿½Wï¿½wï¿½è‚ªï¿½È‚ï¿½ï¿½Ì‚ÅŒï¿½ï¿½İ‚ÌƒXï¿½gï¿½ï¿½ï¿½[ï¿½Wï¿½ï¿½Ç‚İï¿½ï¿½Ü‚ï¿½ï¿½ï¿½
			storage = mainConductor.curStorage;
		}

		// ï¿½Ä‚Ñoï¿½ï¿½
		conductor.clearCallStack();
		processCall(storage, label);
	}

	function returnExtraConductor(run)
	{
		// extraConductor ï¿½ÌƒTï¿½uï¿½ï¿½ï¿½[ï¿½`ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ß‚ï¿½
		// run ï¿½ï¿½ true ï¿½Ìê‡ï¿½ï¿½ ï¿½Ò‹@ï¿½ï¿½Ô‚Ì•ï¿½ï¿½Aï¿½Ísï¿½ï¿½È‚ï¿½

		conductor.sleep(); // ï¿½ï¿½~
		conductor.interrupt();
			// interrupt ï¿½ï¿½ ï¿½Rï¿½ï¿½ï¿½_ï¿½Nï¿½^ï¿½ÌƒCï¿½xï¿½ï¿½ï¿½gï¿½ï¿½ï¿½ÅƒRï¿½ï¿½ï¿½_ï¿½Nï¿½^ï¿½Ìï¿½ï¿½sï¿½ï¿½
			// ï¿½ï¿½~ï¿½ï¿½ï¿½ï¿½ï¿½é‚½ï¿½ß‚Ìƒï¿½ï¿½\ï¿½bï¿½h
		conductor = mainConductor; // ï¿½Rï¿½ï¿½ï¿½_ï¿½Nï¿½^ï¿½ï¿½Ø‚ï¿½Ö‚ï¿½
		(Dictionary.assign incontextof mainConductor.macros)(extraConductor.macros);
			// ï¿½}ï¿½Nï¿½ï¿½ï¿½ÍƒRï¿½sï¿½[
		usingExtraConductor = false;
		if(!run)
		{	restoreClickGlyphState(); // ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Ò‚ï¿½ï¿½Lï¿½ï¿½ï¿½Ì•ï¿½ï¿½A
			inSleep = inSleepBeforeExtraConductor; // inSleep ï¿½ï¿½ï¿½A
			notifyStable();
		}

		lockSelectLayerFocus(false);
		restoreMessageLayerSelProcessLock(); // ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ restoreSelProcessLock ï¿½ï¿½ï¿½Ä‚ï¿½

		setMenuAccessibleAll();
		cancelSkip();

		if(onExtraConductorReturn !== void) onExtraConductorReturn();
	}

	// ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½bï¿½Nï¿½Eï¿½Aï¿½ï¿½ï¿½ï¿½ï¿½bï¿½Nï¿½ï¿½ï¿½ï¿½
	function lockSelectLayerFocus(lock) {
		var sel = lock ? "lockFocus" : "unlockFocus";
		selectLayer   [sel]() if (_selectLayer    !== void);
		mapSelectLayer[sel]() if (_mapSelectLayer !== void);
	}

	//------------------------------------------------------- ï¿½Eï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½ï¿½ï¿½ï¿½ --

	function setRightClickOptions(elm)
	{
		// ï¿½Eï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½ÌƒIï¿½vï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½İ’è‚·ï¿½ï¿½
		rightClickEnabled = +elm.enabled if elm.enabled !== void;
		if(elm.call !== void)
		{
			rightClickCall = +elm.call;
			if(rightClickCall) rightClickJump = false;
		}
		if(elm.jump !== void)
		{
			rightClickJump = +elm.jump;
			if(rightClickJump) rightClickCall = false;
		}
		rightClickTarget = elm.target if elm.target !== void;
		rightClickStorage = elm.storage if elm.storage !== void;
		if(elm.name !== void)
		{
			if(typeof this.rightClickMenuItem != "undefined")
			{
				rightClickName = elm.name;
				if(rightClickName == "default")
					rightClickMenuItem.caption = rightClickCurrentMenuName = rightClickDefaultName;
				else
					rightClickMenuItem.caption = rightClickCurrentMenuName = rightClickName;
			}
		}
	}

	function callRightClickSubRoutine()
	{
		isLeavePeriodEvent = true;

		// ï¿½Eï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Tï¿½uï¿½ï¿½ï¿½[ï¿½`ï¿½ï¿½ï¿½ï¿½ï¿½Ä‚ï¿½
		if(typeof this.rightClickMenuItem != "undefined")
		{
			rightClickMenuItem.caption = rightClickCurrentMenuName = rightClickDefaultName;
		}

		callExtraConductor(rightClickStorage, rightClickTarget, restoreFromRightClick);

		lockMessageLayerSelProcess(); // ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½bï¿½N
	}

	function restoreFromRightClick()
	{
		// ï¿½Eï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Tï¿½uï¿½ï¿½ï¿½[ï¿½`ï¿½ï¿½ï¿½ï¿½ï¿½ç”²ï¿½ï¿½ï¿½ï¿½Æ‚ï¿½ï¿½ÉŒÄ‚Î‚ï¿½ï¿½
		if(typeof this.rightClickMenuItem != "undefined")
		{
			if(rightClickName == "default")
				rightClickMenuItem.caption = rightClickCurrentMenuName = rightClickDefaultName;
			else
				rightClickMenuItem.caption = rightClickCurrentMenuName = rightClickName;
		}
	}

	function setConductorToMain()
	{
		// restore ï¿½Ìï¿½ï¿½ÉŒÄ‚Î‚ï¿½Aï¿½Rï¿½ï¿½ï¿½_ï¿½Nï¿½^ï¿½ï¿½ main ï¿½ÉØ‚ï¿½Ö‚ï¿½ï¿½ï¿½
		if(usingExtraConductor)
		{
			extraConductor.sleep();
			extraConductor.interrupt();
			conductor= mainConductor;
			usingExtraConductor = false;
		}
	}

	function jumpToRightClickTarget()
	{
		process(rightClickStorage, rightClickTarget);
	}

	function onPrimaryRightClick()
	{
		// ï¿½vï¿½ï¿½ï¿½Cï¿½}ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Å‰Eï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½ï¿½ï¿½ê‚½ï¿½Æ‚ï¿½ï¿½ÉŒÄ‚Î‚ï¿½ï¿½
		if(!callHook(rightClickHook))
		{
			if(getKeyState(VK_LBUTTON))
			{
//				enterAutoMode();
				return;
			}
			if(!rightClickEnabled) return;
			if(inStable)
			{
				if(rightClickJump)
					jumpToRightClickTarget();
				else if(rightClickCall && conductor == mainConductor)
					callRightClickSubRoutine();
				else
					switchMessageLayerHiddenByUser();
			}
			setMenuAccessibleAll();
		}
	}

	//------------------------------------------------------- ï¿½Oï¿½iï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ --

    function allocateCharacterLayers(num, reorder=true, level=0)
	{
		// ï¿½Oï¿½iï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ num ï¿½Éİ’è‚·ï¿½ï¿½
		if(fore.layers.count > num)
		{
			// ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
			for(var i = num; i<fore.layers.count; i++)
			{
				invalidate fore.layers[i];
				invalidate back.layers[i];
			}
			fore.layers.count = num;
			back.layers.count = num;
		}
		else if(fore.layers.count < num)
		{
            // ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
            if (reorder) {
                for(var i = fore.layers.count; i<num; i++)
                {
                    fore.layers[i] = new CharacterLayer(this, fore.base, "ï¿½\ï¿½Oï¿½iï¿½ï¿½ï¿½Cï¿½ï¿½" + i, i, level);
                    back.layers[i] = new CharacterLayer(this, back.base, "ï¿½ï¿½ï¿½Oï¿½iï¿½ï¿½ï¿½Cï¿½ï¿½" + i, i, level);
                    fore.layers[i].setCompLayer(back.layers[i]);
                    back.layers[i].setCompLayer(fore.layers[i]);
                }
                reorderLayers(true, false);
            } else {
                // ï¿½Yï¿½ï¿½ï¿½ï¿½ï¿½xï¿½ï¿½ï¿½ÅÅ‘ï¿½ï¿½ index ï¿½lï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
                var foreindex = (level + 1) * 100000;
                var backindex = (level + 1) * 100000;
                for (var i=0; i<fore.layers.count;i++) {
                    if (fore.layers[i].level == level && fore.layers[i].absolute > foreindex) {
                        foreindex = fore.layers[i].absolute;
                    }
                    if (back.layers[i].level == level && back.layers[i].absolute > backindex) {
                        backindex = back.layers[i].absolute;
                    }
                }
                foreindex += 100;
                backindex += 100;
                
                for(var i = fore.layers.count; i<num; i++) {
                    fore.layers[i] = new CharacterLayer(this, fore.base, "ï¿½\ï¿½Oï¿½iï¿½ï¿½ï¿½Cï¿½ï¿½" + i, i, level);
                    back.layers[i] = new CharacterLayer(this, back.base, "ï¿½ï¿½ï¿½Oï¿½iï¿½ï¿½ï¿½Cï¿½ï¿½" + i, i, level);
                    fore.layers[i].setCompLayer(back.layers[i]);
                    back.layers[i].setCompLayer(fore.layers[i]);
                    fore.layers[i].absolute = foreindex;
                    back.layers[i].absolute = backindex;
                    foreindex += 100;
                    backindex += 100;
                }
            }
        }
		numCharacterLayers = num;
	}

	//------------------------------------------------- ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ --

	function allocateMessageLayers(num, setdefaultfont = true)
	{
		// ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ num ï¿½Éİ’è‚·ï¿½ï¿½
		if(fore.messages.count > num)
		{
			// ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
			for(var i = num; i<fore.messages.count; i++)
			{
				if(current == fore.messages[i] || current == back.messages[i])
					current = fore.messages[0], currentNum = 0, currentPage = 0;
				invalidate fore.messages[i];
				invalidate back.messages[i];
			}
			fore.messages.count = num;
			back.messages.count = num;
		}
		else if(fore.messages.count < num)
		{
			// ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
			for(var i = fore.messages.count; i<num; i++)
			{
				fore.messages[i] = new MessageLayer(this, fore.base, "ï¿½\ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½" + i, i, true);
				back.messages[i] = new MessageLayer(this, back.base, "ï¿½ï¿½ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½" + i, i, true);
				fore.messages[i].setCompLayer(back.messages[i]);
				back.messages[i].setCompLayer(fore.messages[i]);
				fore.messages[i].clear();
				back.messages[i].clear();
			}
			reorderLayers(false, true);
			if(setdefaultfont) setMessageLayerUserFont();
		}
		numMessageLayers = num;
	}

	function setCurrentMessageLayer(elm)
	{
		// ï¿½ï¿½ï¿½İ‚Ìƒï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½İ’ï¿½
		var page = getMessageLayerPageFromElm(elm);
		var num = getMessageLayerNumberFromElm(elm);
		currentNum = num;
		currentPage = page;
		if(page) current = back.messages[num]; else current = fore.messages[num];
		currentWithBack = +elm.withback if elm.withback !== void;
	}

	function setMessageLayerPosition(elm)
	{
		// ï¿½ï¿½ï¿½İ‚Ìƒï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ÌˆÊ’uï¿½Aï¿½ï¿½ï¿½ï¿½ï¿½ï¿½İ’ï¿½
		var layer = getMessageLayerObjectFromElm(elm);
		elm.setPosition(elm);
	}

	function clearMessageLayers(resetcurrent)
	{
		// ï¿½ï¿½ï¿½×‚Ä‚Ìƒï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ÌƒNï¿½ï¿½ï¿½A
		// ct ï¿½^ï¿½Oï¿½ï¿½ï¿½ï¿½Ä‚Î‚ï¿½ï¿½
		// resetcurrent ï¿½ï¿½ true ï¿½Ìê‡ï¿½ÍŒï¿½ï¿½İ‚Ìƒï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½
		// ï¿½\0ï¿½Éİ’è‚·ï¿½ï¿½

		var messages;
		messages = fore.messages;
		for(var i = messages.count-1; i >= 0; i--) messages[i].clear(true);
		messages = back.messages;
		for(var i = messages.count-1; i >= 0; i--) messages[i].clear(true);
		if(resetcurrent)
		{
			currentNum = 0;
			currentPage = 0;
			current = fore.messages[0];
			currentWithBack = false;
		}
	}

	function lockMessageLayerSelProcess()
	{
		// ï¿½ï¿½ï¿½×‚Ä‚Ìƒï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ ï¿½Iï¿½ï¿½ï¿½ï¿½processï¿½ï¿½ï¿½Ö~ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		var messages;
		messages = fore.messages;
		for(var i = messages.count-1; i >= 0; i--) messages[i].setSelProcessLock(true);
		messages = back.messages;
		for(var i = messages.count-1; i >= 0; i--) messages[i].setSelProcessLock(true);
	}

	function unlockMessageLayerSelProcess()
	{
		// ï¿½ï¿½ï¿½×‚Ä‚Ìƒï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ì‘Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Â‚ï¿½ï¿½ï¿½
		var messages;
		messages = fore.messages;
		for(var i = messages.count-1; i >= 0; i--) messages[i].setSelProcessLock(false);
		messages = back.messages;
		for(var i = messages.count-1; i >= 0; i--) messages[i].setSelProcessLock(false);
	}

	function setMessageLayerUserFont()
	{
		// ï¿½ï¿½ï¿½×‚Ä‚Ìƒï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ defaultAntialiased ï¿½ï¿½
		// userFace ï¿½ï¿½İ’è‚·ï¿½ï¿½
		var messages;
		messages = fore.messages;
		for(var i = messages.count-1; i >= 0; i--)
			messages[i].defaultAntialiased = chDefaultAntialiased,
			messages[i].userFace = chDefaultFace,
			messages[i].resetNameLayerFont();
		messages = back.messages;
		for(var i = messages.count-1; i >= 0; i--)
			messages[i].defaultAntialiased = chDefaultAntialiased,
			messages[i].userFace = chDefaultFace,
			messages[i].resetNameLayerFont();
	}

	function storeMessageLayerSelProcessLock()
	{
		// ï¿½ï¿½ï¿½×‚Ä‚Ìƒï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ storeSelProcessLock ï¿½ï¿½ï¿½Ä‚Ñoï¿½ï¿½
		var messages;
		messages = fore.messages;
		for(var i = messages.count-1; i >= 0; i--) messages[i].storeSelProcessLock();
		messages = back.messages;
		for(var i = messages.count-1; i >= 0; i--) messages[i].storeSelProcessLock();
	}

	function restoreMessageLayerSelProcessLock()
	{
		// ï¿½ï¿½ï¿½×‚Ä‚Ìƒï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ restoreSelProcessLock ï¿½ï¿½ï¿½Ä‚Ñoï¿½ï¿½
		var messages;
		messages = fore.messages;
		for(var i = messages.count-1; i >= 0; i--) messages[i].restoreSelProcessLock();
		messages = back.messages;
		for(var i = messages.count-1; i >= 0; i--) messages[i].restoreSelProcessLock();
	}

	function setMessageLayerHiddenState(b)
	{
		var layers;
		layers = fore.messages;
        for(var i = layers.count-1; i >= 0; i--) layers[i].setHiddenStateByUser(b);
        layers = fore.layers;
		for(var i = layers.count-1; i >= 0; i--) layers[i].setHiddenStateByUser(b);

        selectLayer.setHiddenStateByUser(b);
        //mapSelectLayer.setHiddenStateByUser(b);
        
		// ï¿½vï¿½ï¿½ï¿½Oï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½Ä‚ï¿½
		forEachEventHook('onMessageHiddenStateChanged',
			function(handler, f) { handler(f.hidden); } incontextof this,
			%[hidden:b]);
	}

    // ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½Ô‚ğ“¯Šï¿½
    function syncMessageLayer() {
        var messages = back.messages;
        for(var i = messages.count-1; i >= 0; i--) messages[i].assignComp();
    }
    
	function hideMessageLayerByUser()
	{
        // ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½êï¿½Iï¿½É‰Bï¿½ï¿½
		if(messageLayerHiding) return;
		setMessageLayerHiddenState(true);
		if(typeof this.rightClickMenuItem !== "undefined")
			rightClickMenuItem.checked = true;
		messageLayerHiding = true;
		fore.base.cursor = cursorWaitingClick;
		setMenuAccessibleAll();
	}

	function showMessageLayerByUser()
	{
        // ï¿½êï¿½Iï¿½É‰Bï¿½ï¿½ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½É–ß‚ï¿½
		if(!messageLayerHiding) return;
        setMessageLayerHiddenState(false);
		if(typeof this.rightClickMenuItem !== "undefined")
			rightClickMenuItem.checked = false;
		messageLayerHiding = false;
		conductor.trigger('message'); // 'message' ï¿½ğ‘—‚ï¿½
		if(clickWaiting)
			fore.base.cursor = cursorWaitingClick;
		else
			fore.base.cursor = cursorDefault;
		setMenuAccessibleAll();
	}

	function switchMessageLayerHiddenByUser()
	{
		// ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ì”ï¿½\ï¿½ï¿½/ï¿½\ï¿½ï¿½ï¿½ï¿½Ø‚ï¿½Ö‚ï¿½ï¿½ï¿½
		if(messageLayerHiding) showMessageLayerByUser(); else hideMessageLayerByUser();
	}

	function hideMessageLayerByScenario(elm)
	{
		// ï¿½Vï¿½iï¿½ï¿½ï¿½Iï¿½ï¿½ï¿½çƒï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½êï¿½Iï¿½É‰Bï¿½ï¿½
		hideMessageLayerByUser();
		conductor.wait(%[ // ï¿½Rï¿½ï¿½ï¿½_ï¿½Nï¿½^ï¿½ï¿½Ò‚ï¿½ï¿½ï¿½
			message : function
			{
				// ï¿½ï¿½é‚±ï¿½Æ‚È‚ï¿½
			} incontextof this
			]);
        notifyStable();
		return -2; // break
	}

    function setCurrentMessageLayerVisibleFast(page, visible) {
        var base = page == 0 ? fore : back;
        var msg = base.messages[currentNum];
        msg.visible = visible;
        if (!visible) {
            msg.clear(true);
        }
        forEachEventHook('onCurrentMessageVisibleChanged',
                         function(handler, f) { handler(f.hidden, f.page); } incontextof this,
                         %[hidden:!visible, page:page]);
    }

    /**
     * ï¿½ï¿½ï¿½İ‚Ìƒï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Ì•\ï¿½ï¿½ï¿½ï¿½Ô‚Ì•ÏX
     * @param visible
     * @return ï¿½ï¿½ï¿½ï¿½ï¿½Ì‘Ò‚ï¿½ï¿½ï¿½ï¿½Kï¿½vï¿½Èê‡ï¿½ï¿½ true ï¿½ï¿½Ô‚ï¿½
     */
    function setCurrentMessageLayerVisible(visible) {

		if (fore.messages[currentNum].visible != visible) {
			var fadeTime = messageFadeTime * drawspeed;
            if (!skipMode && fadeTime > 0) {

                // ï¿½ï¿½ï¿½Íï¿½Éï¿½ï¿½ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½ï¿½Bï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½È‚ï¿½ï¿½ï¿½ msgvisible ï¿½ï¿½ï¿½Æ‚ï¿½Å‚ï¿½ï¿½Ü‚ï¿½ï¿½ï¿½
                // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ì‘Ò‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
                back.messages[currentNum].visible = visible;
                if (!visible) {
                    back.messages[currentNum].clear(true);
                }
                
                // ï¿½ï¿½ï¿½ï¿½ï¿½Ò‚ï¿½
                var layer = fore.messages[currentNum];
                layer.setVisibleTime(visible, fadeTime);

                if (visible) {
                    conductor.wait(%[
                    click : function(layer) {
                        updateBeforeCh = 1;
                        layer.fadeDone();
                    } incontextof this,
                    'click_arg' => layer,
                    msgvisible : function() {
                        updateBeforeCh = 1;
                    } incontextof this
                        ]);
                } else {
                    conductor.wait(%[
                    click : function(layer) {
                        updateBeforeCh = 1;
                        layer.fadeDone();
                        layer.clear(true);
                    } incontextof this,
                    'click_arg' => layer,
                    msgvisible : function(layer) {
                        updateBeforeCh = 1;
                        layer.clear(true);
                    } incontextof this,
                    'msgvisible_arg' => layer,
                        ]);
                }
                forEachEventHook('onCurrentMessageVisibleChanged',
                                 function(handler, f) { handler(f.hidden, f.page); } incontextof this,
                                 %[hidden:!visible, page:0]);
                
                return true;
            } else {
                fore.messages[currentNum].visible = visible;
                back.messages[currentNum].visible = visible;
                forEachEventHook('onCurrentMessageVisibleChanged',
                                 function(handler, f) { handler(f.hidden, f.page); } incontextof this,
                                 %[hidden:!visible, page:0]);
                if (!visible) {
                    fore.messages[currentNum].clear(true);
                    back.messages[currentNum].clear(true);
                }
            }
        }
        return false;
    }

	function selectFont()
	{
		// ï¿½tï¿½Hï¿½ï¿½ï¿½gï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		fore.base.font.face = chDefaultFace;
		fore.base.font.height = -20;
		var flags = fsfSameCharSet | fsfNoVertical | fsfTrueTypeOnly | fsfUseFontFace;
		if(showFixedPitchOnlyInFontSelector) flags |= fsfFixedPitch;
		if(fore.base.font.doUserSelect(flags, "ï¿½tï¿½Hï¿½ï¿½ï¿½gï¿½Ì‘Iï¿½ï¿½",
			"ï¿½tï¿½Hï¿½ï¿½ï¿½gï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½", "ABCDEFGHIï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½İ‰Fï¿½Gï¿½ï¿½"))
		{
			chDefaultFace = fore.base.font.face;
			setMessageLayerUserFont();
		}
	}

	function mapPrerenderedFont(storage)
	{
		// ï¿½ï¿½ï¿½ï¿½ï¿½_ï¿½ï¿½ï¿½ï¿½ï¿½Oï¿½Ï‚İƒtï¿½Hï¿½ï¿½ï¿½gï¿½ï¿½ï¿½ï¿½ï¿½İ‚Ì‘ï¿½ï¿½ï¿½ÎÛ‚Ìƒï¿½ï¿½Cï¿½ï¿½ï¿½É‘Iï¿½ï¿½
		// ï¿½ï¿½ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½tï¿½Hï¿½ï¿½ï¿½gï¿½Éƒ}ï¿½bï¿½sï¿½ï¿½ï¿½Oï¿½ï¿½ï¿½ï¿½
		current.decideSizeChange();
		current.lineLayer.font.mapPrerenderedFont(storage);
	}

    //------------------------------------------------- ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ğ³‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ --

    // ï¿½wï¿½è‚µï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½wï¿½è‚µï¿½ï¿½ï¿½ï¿½ï¿½xï¿½ï¿½ï¿½ÉˆÚ“ï¿½ï¿½ï¿½ï¿½ï¿½
    function toLevel(n, newlevel, base) {
        if (base === void) {
            base = fore;
        }
        if (n === void) {
            return;
        }
        n = +n;
        newlevel = +newlevel;
        if (n < base.layers.count) {
            
            var level = base.layers[n].level;
            if (level == newlevel) {
                return;
            }
            var index = base.layers[n].absolute;
            // ï¿½ï¿½ï¿½Æ‚ï¿½ï¿½Æ‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½xï¿½ï¿½ï¿½Ì’ï¿½ï¿½ï¿½
            for (var i = 0; i<base.layers.count; i++) {
                if (i != n && base.layers[i].level == level) {
                    if (base.layers[i].absolute > index) {
                        base.layers[i].absolute -= 100;
                    }
                }
            }
            // ï¿½Vï¿½Kï¿½ï¿½ï¿½xï¿½ï¿½ï¿½Ìˆï¿½Ôï¿½É‚ï¿½ï¿½ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½
            var newindex = (newlevel + 1) * 100000;
            for (var i = 0; i<base.layers.count; i++) {
                if (i != n && base.layers[i].level == newlevel && base.layers[i].absolute > newindex) {
                    newindex = base.layers[i].absolute;
                }
            }
            newindex += 100;
            //dm("ï¿½ï¿½ï¿½xï¿½ï¿½ï¿½İ’ï¿½:" + newlevel + ":" + newindex);
            base.layers[n].absolute = newindex;
            base.layers[n].level = newlevel;
        }
    }
    
    // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½xï¿½ï¿½ï¿½Ìƒï¿½ï¿½Cï¿½ï¿½ï¿½Ì’ï¿½ï¿½ÅÅ‘Oï¿½ï¿½ÉˆÚ“ï¿½
    function toFront(n, base) {
        if (base === void) {
            base = fore;
        }
        if (n !== void && n < base.layers.count) {
            var level = base.layers[n].level;
            var index = base.layers[n].absolute;
            var maxindex = index;
            for(var i = 0; i<base.layers.count; i++) {
                if (i != n && base.layers[i].level == level) {
                    if (base.layers[i].absolute > maxindex) {
                        maxindex = base.layers[i].absolute;
                    }
                    if (base.layers[i].absolute > index) {
                        base.layers[i].absolute -= 100;
                    }
                }
            }
            base.layers[n].absolute = maxindex;
        }
    }

    // ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½ÅŒï¿½ï¿½ï¿½
    function toBack(n, base) {
        if (base === void) {
            base = fore;
        }
        if (n !== void && n < base.layers.count) {
            var level = base.layers[n].level;
            var index = base.layers[n].absolute;
            var minindex = index;
            for(var i = 0; i<base.layers.count; i++) {
                if (i != n && base.layers[i].level == level) {
                    if (base.layers[i].absolute < minindex) {
                        minindex = base.layers[i].absolute;
                    }
                    if (base.layers[i].absolute < index) {
                        base.layers[i].absolute += 100;
                    }
                }
            }
            base.layers[n].absolute = minindex;
        }
    }

    function reorderLayers(ch=true, msg=true)
	{
        // ï¿½Xï¿½eï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½
        fore.stage.absolute = 100;
        back.stage.absolute = 100;

        // ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ğ³‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½É•ï¿½ï¿½Ñ‘Ö‚ï¿½ï¿½ï¿½
        if (ch) {
            var indexes = %[];
            for(var i = 0; i<fore.layers.count; i++)
            {
                var level = fore.layers[i].level;
                var index = indexes[level];
                if (index === void) {
                    index = (level + 1) * 100000;
                }
                fore.layers[i].absolute = index;
                back.layers[i].absolute = index;
                index += 100;
                indexes[level] = index;
            }
        }

        // ï¿½Cï¿½xï¿½ï¿½ï¿½gï¿½ï¿½ï¿½Cï¿½ï¿½
        fore.event.absolute = 6 * 100000 - 100;
        back.event.absolute = 6 * 100000 - 100;

        if (msg) {
            var index = 1000000;
            for(var i = 0; i<fore.messages.count; i++)
            {
                fore.messages[i].absolute = index;
                back.messages[i].absolute = index;
                index += 1000;
            }
        }

		historyLayer.absolute = 4000000;
	}

	//--------------------------------------------- ï¿½ï¿½ï¿½ï¿½->ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Iï¿½uï¿½Wï¿½Fï¿½Nï¿½g --

	function getLayerFromElm(elm, prefix = '')
	{
		// elm ï¿½Éwï¿½è‚³ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½ page ï¿½ï¿½ layer ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Aï¿½Yï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		// ï¿½Iï¿½uï¿½Wï¿½Fï¿½Nï¿½gï¿½ï¿½Ô‚ï¿½
		// prefix ï¿½É‚ÍAï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ì‘Oï¿½É‚Â‚ï¿½ï¿½ï¿½vï¿½ï¿½ï¿½tï¿½Bï¿½Nï¿½Xï¿½ï¿½ï¿½wï¿½è‚·ï¿½ï¿½
		var base;
		if(elm[prefix + 'page'] == 'back') base = back; else base = fore;
		var layer = elm[prefix + 'layer'];
		if(layer == 'base') return base.base; // ï¿½wï¿½i
		if(layer == 'stage') return base.stage; // ï¿½ï¿½ï¿½ï¿½
		if(layer == 'event') return base.event; // ï¿½Cï¿½xï¿½ï¿½ï¿½g
		if(layer[0] == 'm')
		{
			// message? ( ? = ï¿½ï¿½ï¿½l )
			// ï¿½ï¿½ï¿½ï¿½ï¿½Å‚Í‚ï¿½ï¿½Ü‚èŒµï¿½ï¿½ï¿½ÉƒGï¿½ï¿½ï¿½[ï¿½`ï¿½Fï¿½bï¿½Nï¿½Í‚ï¿½ï¿½È‚ï¿½
			if(layer == 'message') return base.messages[currentNum];
			return base.messages[+layer.substr(7)];
		}
		return base.layers[+layer];
	}

	function getLayerPageFromElm(elm, backlay)
	{
		// getLayerFromElm ï¿½Æï¿½ï¿½Ä‚ï¿½ï¿½é‚ªï¿½Apage ï¿½ï¿½ï¿½ï¿½ï¿½Ü‚Å‚Í‚İ‚È‚ï¿½ï¿½B
		// backlay ï¿½ï¿½ true ï¿½Ì‚Æ‚ï¿½ï¿½Í—ï¿½ï¿½Afalse ï¿½Ìï¿½ï¿½Í•\ï¿½Ìƒï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½Ô‚ï¿½ï¿½B
		// elm.layer ï¿½ï¿½ void ï¿½Ìï¿½ï¿½Í”wï¿½iï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½Aï¿½ï¿½
		var base = backlay?back:fore;
		var layer = elm.layer;
		if(layer === void || layer == 'base') return base.base; // ï¿½wï¿½i
		if(layer == 'stage') return base.stage; // ï¿½ï¿½ï¿½ï¿½
		if(layer == 'event') return base.event; // ï¿½Cï¿½xï¿½ï¿½ï¿½g
        if(layer[0] == 'm')
		{
			if(layer == 'message') return base.messages[currentNum];
			return base.messages[+layer.substr(7)];
		}
		return base.layers[+layer];
	}

	function getMessageLayerPageFromElm(elm)
	{
		// elm ï¿½ï¿½ï¿½ï¿½Yï¿½ï¿½ï¿½ï¿½ï¿½ï¿½\/ï¿½ï¿½ï¿½ï¿½Ê‚Ìƒï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½zï¿½ï¿½ï¿½Ô‚ï¿½
		if(elm.page == 'back') return 1; else return 0;
	}

	function getMessageLayerNumberFromElm(elm)
	{
		// elm ï¿½ï¿½ layer ï¿½ï¿½ï¿½ï¿½ï¿½Ìï¿½ï¿½ï¿½ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ôï¿½ï¿½ï¿½Ô‚ï¿½
		var layer = elm.layer;
		if(layer === void || layer == 'message') return currentNum;
		return +layer.substr(7);
	}

	function getMessageLayerObjectFromElm(elm)
	{
		// elm ï¿½ï¿½ layer ï¿½ï¿½ï¿½ï¿½ï¿½Ìï¿½ï¿½ï¿½ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½Ô‚ï¿½
		var page = elm.page;
		var layer = elm.layer;
		if(page === void && layer === void) return current;
		var base;
		if(page == 'back') base = back; else base = fore;
		if(layer === void || layer == 'message') return base.messages[currentNum];
		return base.messages[+layer.substr(7)];
	}

	function getMessageLayerObjectFromPageAndNumber(page, num)
	{
		return (page?back:fore).messages[num];
	}

	//----------------------------------------------------- ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Rï¿½sï¿½[ï¿½Ö˜A --

	function backupLayer(elm, toback)
	{
        // ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ì•\ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ô‚ÌƒRï¿½sï¿½[ï¿½ï¿½ï¿½sï¿½ï¿½
		// toback = true ï¿½Ìê‡ï¿½Í•\ï¿½ï¿½ï¿½ï¿½ï¿½Afalse ï¿½Ìê‡ï¿½Í—ï¿½ï¿½ï¿½ï¿½\
		if(elm.layer !== void)
		{
			// ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½wï¿½è‚ªï¿½ï¿½ï¿½ï¿½
			getLayerPageFromElm(elm, toback).assignComp(); // ï¿½Î‚Ìƒï¿½ï¿½Cï¿½ï¿½ï¿½Ì“ï¿½ï¿½eï¿½ï¿½ï¿½Rï¿½sï¿½[
		}
		else
		{
			// ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½wï¿½è‚ªï¿½ï¿½ï¿½ï¿½ï¿½Ì‚Å‘Sï¿½ï¿½ï¿½Ìƒï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½Rï¿½sï¿½[
			var base = toback ? back:fore;
			base.base.assignComp();
            base.stage.assignComp();
            base.event.assignComp();
            var layers = base.layers, messages = base.messages;
			for(var i = layers.count-1; i >= 0; i--) layers[i].assignComp();
			for(var i = messages.count-1; i >= 0; i--) messages[i].assignComp();

			forEachEventHook('onCopyLayer',
				function(handler, f) { handler(f.toback, true); } incontextof this,
				%[toback:toback]);
		}
	}

	function copyLayer(elm)
	{
		// elm ï¿½É]ï¿½ï¿½ï¿½Ä“ï¿½ï¿½ï¿½Ìƒï¿½ï¿½Cï¿½ï¿½ï¿½Ô‚ÌƒRï¿½sï¿½[ï¿½ï¿½ï¿½sï¿½ï¿½
		var src = getLayerFromElm(elm, 'src');
		var dest = getLayerFromElm(elm, 'dest');
		dest.assign(src);
	}

	//--------------------------------------------------- ï¿½Aï¿½jï¿½ï¿½ï¿½[ï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Ö˜A --

	function onAnimationStopped(name, segment)
	{
		// ï¿½Aï¿½jï¿½ï¿½ï¿½[ï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½~ï¿½ï¿½ï¿½ï¿½
		conductor.trigger('anim:' + name + ':' + segment);
	}

	function waitAnimation(elm)
	{
		// ï¿½Aï¿½jï¿½ï¿½ï¿½[ï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Ì’ï¿½~ï¿½ï¿½ï¿½Ü‚ï¿½
		var layer = getLayerFromElm(elm);
		var seg = +elm.seg;
		if(!layer.canWaitAnimStop(seg)) return 0; // ï¿½Aï¿½jï¿½ï¿½ï¿½[ï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Ì’ï¿½~ï¿½ï¿½Ò‚ï¿½
		conductor.wait(%[
			'anim:' + layer.name + ':' + seg => function
			{
			} incontextof this
			]);
		return -2;
	}

	//--------------------------------------------------- ï¿½gï¿½ï¿½ï¿½ï¿½ï¿½Wï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Ö˜A --

	function onLayerTransitionCompleted(layer, dest, src)
	{
		// ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Åƒgï¿½ï¿½ï¿½ï¿½ï¿½Wï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æ‚ï¿½ï¿½ÉŒÄ‚Î‚ï¿½ï¿½
		conductor.trigger('trans'); // 'trans' ï¿½ğ‘—‚ï¿½
    }

	function waitTransition(elm)
	{
		// ï¿½gï¿½ï¿½ï¿½ï¿½ï¿½Wï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ò‚ï¿½
		if(transCount == 0) return 0; // ï¿½gï¿½ï¿½ï¿½ï¿½ï¿½Wï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ò‚Ä‚È‚ï¿½
		if((elm.canskip === void || +elm.canskip) && clickSkipEnabled)
		{
			// ï¿½Xï¿½Lï¿½bï¿½vï¿½Å‚ï¿½ï¿½ï¿½ê‡
			if(skipMode)
			{
				// ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½ì’†
				stopAllTransitions();
				return 0; // ï¿½gï¿½ï¿½ï¿½ï¿½ï¿½Wï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½~ï¿½ï¿½ï¿½ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½ï¿½É•Ô‚ï¿½
			}
			conductor.wait(%[
				click : function
				{
					updateBeforeCh = 1;
					stopAllTransitions(); // ï¿½ï¿½ï¿½×‚Ä‚Ìƒgï¿½ï¿½ï¿½ï¿½ï¿½Wï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Í’ï¿½~
				} incontextof this,
				trans : function
				{
					updateBeforeCh = 1;
				} incontextof this
				]);
		}
		else
		{
			conductor.wait(%[
				trans : function
				{
					updateBeforeCh = 1;
				} incontextof this
				]);
		}
		return -2;
	}

	function stopAllTransitions()
	{
        // ï¿½ï¿½ï¿½×‚Ä‚Ìƒgï¿½ï¿½ï¿½ï¿½ï¿½Wï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½~ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		var layers, messages;
		fore.base.stopTransition();
        fore.stage.stopTransition();
        fore.event.stopTransition();
        layers = fore.layers, messages = fore.messages;
		for(var i = layers.count-1; i >= 0; i--) layers[i].stopTransition();
		for(var i = messages.count-1; i >= 0; i--) messages[i].stopTransition();
        back.base.stopTransition();
        back.stage.stopTransition();
        back.event.stopTransition();
        layers = back.layers, messages = back.messages;
		for(var i = layers.count-1; i >= 0; i--) layers[i].stopTransition();
		for(var i = messages.count-1; i >= 0; i--) messages[i].stopTransition();
		transCount = 0; // ï¿½ê‰
	}

	function callExchangeInfo()
	{
		// ï¿½ï¿½ï¿½×‚Ä‚Ì”wï¿½iï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½Ì‚ï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½É‘Î‚ï¿½ï¿½ï¿½
		// exchangeInfo ï¿½ï¿½ï¿½Ä‚ï¿½
        fore.stage.exchangeInfo();
        fore.event.exchangeInfo();
        var layers = fore.layers, messages = fore.messages;
		for(var i = layers.count-1; i >= 0; i--) layers[i].exchangeInfo();
		for(var i = messages.count-1; i >= 0; i--) messages[i].exchangeInfo();
    }

	function callAssignTransSrc()
	{
		// ï¿½ï¿½ï¿½×‚Ä‚Ì”wï¿½iï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½Ì‚ï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½É‘Î‚ï¿½ï¿½ï¿½
		// assignTransSrc ï¿½ï¿½ï¿½Ä‚ï¿½
        fore.event.assignTransSrc();
        fore.stage.assignTransSrc();
        var layers = fore.layers, messages = fore.messages;
		for(var i = layers.count-1; i >= 0; i--) layers[i].assignTransSrc();
		for(var i = messages.count-1; i >= 0; i--) messages[i].assignTransSrc();
        forEachEventHook('onCopyLayer',
				function(handler, f) { handler(f.toback); } incontextof this,
				%[toback:false]);
    }

	function exchangeForeBack()
	{
        var tmp = fore;
		fore = back;
		back = tmp;
		current = (currentPage?back:fore).messages[currentNum]; // current ï¿½Íİ’è‚µï¿½ï¿½ï¿½ï¿½
		forEachEventHook('onExchangeForeBack',
				function(handler, f) { handler(); } incontextof this);

        // ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½A
        if (selectShowing) {
            selectLayer.setParent(fore.base, 1000000);
        }
        if (mapSelectShowing) {
            mapSelectLayer.setParent(fore.base, 1000000);
        }

        // ï¿½ï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½ÏX
        fore.base.visible = true;
        back.base.visible = false;
    }

	function swapBaseLayer()
	{
        // ï¿½wï¿½iï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ì‚İ‚ï¿½ï¿½ï¿½ï¿½Ö‚ï¿½ï¿½ï¿½
        var tmp = fore.base;
		fore.base = back.base;
		back.base = tmp;
        current = (currentPage?back:fore).messages[currentNum]; // current ï¿½Íİ’è‚µï¿½ï¿½ï¿½ï¿½

    }

	function swapStageLayer(id)
	{
        // ï¿½Oï¿½iï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ì•\ï¿½Æ—ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ö‚ï¿½ï¿½ï¿½
        var fl = fore[id], bl = back[id];
        var tmp = fl;
        fl = bl;
        bl = tmp;
	}
    
	function swapCharacterLayer(id)
	{
		// ï¿½Oï¿½iï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ì•\ï¿½Æ—ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ö‚ï¿½ï¿½ï¿½
		var fl = fore.layers, bl = back.layers;
		var tmp = fl[id];
		fl[id] = bl[id];
		bl[id] = tmp;
	}

	function swapMessageLayer(id)
	{
		// ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ì•\ï¿½Æ—ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ö‚ï¿½ï¿½ï¿½
		var fl = fore.messages, bl = back.messages;
		var tmp = fl[id];
		fl[id] = bl[id];
		bl[id] = tmp;
		current = (currentPage?back:fore).messages[currentNum]; // current ï¿½Íİ’è‚µï¿½ï¿½ï¿½ï¿½
	}

	//--------------------------------------------------------- ï¿½ï¿½ï¿½ï¿½ï¿½Ú“ï¿½ï¿½Ö˜A --

	function onLayerMoveStop()
	{
		// ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ìï¿½ï¿½ï¿½ï¿½Ú“ï¿½ï¿½ï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		conductor.trigger('move');
	}

	function waitMove(elm)
	{
		// ï¿½ï¿½ï¿½ï¿½ï¿½Ú“ï¿½ï¿½ï¿½Ò‚ï¿½
		if(moveCount == 0) return 0; // ï¿½ï¿½ï¿½ï¿½ï¿½Ú“ï¿½ï¿½ï¿½Ò‚Ä‚È‚ï¿½
		if((elm.canskip === void || +elm.canskip) && clickSkipEnabled)
		{
			// ï¿½Xï¿½Lï¿½bï¿½vï¿½Å‚ï¿½ï¿½ï¿½ê‡
			if(skipMode)
			{
				// ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½ì’†
				stopAllMoves();
				return 0; // ï¿½ï¿½ï¿½ï¿½ï¿½Ú“ï¿½ï¿½ï¿½ï¿½~ï¿½ï¿½ï¿½ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½ï¿½É•Ô‚ï¿½
			}
			conductor.wait(%[
				click : function
				{
					updateBeforeCh = 1;
					stopAllMoves(); // ï¿½ï¿½ï¿½×‚Ä‚Ìƒgï¿½ï¿½ï¿½ï¿½ï¿½Wï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Í’ï¿½~
				} incontextof this,
				move : function
				{
					updateBeforeCh = 1;
				} incontextof this
				]);
		}
		else
		{
			conductor.wait(%[
				move : function
				{
					updateBeforeCh = 1;
				} incontextof this
				]);
		}
		return -2;
	}

	function stopAllMoves()
	{
		// ï¿½ï¿½ï¿½×‚Ä‚Ìï¿½ï¿½ï¿½ï¿½Ú“ï¿½ï¿½ï¿½ï¿½~ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		var layers, messages;
		fore.base.stopMove();
		back.base.stopMove();
        fore.stage.stopMove();
        back.stage.stopMove();
        fore.event.stopMove();
        back.event.stopMove();
        layers = fore.layers, messages = fore.messages;
		for(var i = layers.count-1; i >= 0; i--) layers[i].stopMove();
		for(var i = messages.count-1; i >= 0; i--) messages[i].stopMove();
		layers = back.layers, messages = back.messages;
		for(var i = layers.count-1; i >= 0; i--) layers[i].stopMove();
		for(var i = messages.count-1; i >= 0; i--) messages[i].stopMove();
		moveCount = 0; // ï¿½ê‰
	}

	//--------------------------------------------------------- ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Ö˜A --

    // ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ÎÛ‘Sï¿½ï¿½
    var allActions = %[];
    var actionCount = 0;

    /**
     * ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½sï¿½ï¿½ï¿½ï¿½
     */
    function isInAction(target) {
        return allActions[target] !== void;
    }

	/**
	 * ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Rï¿½sï¿½[ï¿½ï¿½ï¿½ï¿½
	 * @param src ï¿½Rï¿½sï¿½[ï¿½ï¿½
	 * @param dest ï¿½Rï¿½sï¿½[ï¿½ï¿½
	 */
	function copyAction(src, dest, completed) {
		//dm("ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ÌƒRï¿½sï¿½[");
		stopAction(dest);
		var srcAction = allActions[src];
		if (srcAction !== void) {
			var destAction = srcAction.clone();
			destAction.target = dest;
			if (completed !== void) {
				destAction.onActionCompleted = completed;
			}
			allActions[dest] = destAction;
			actionCount++;
		}
	}

	/**
	 * ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½sï¿½ï¿½ï¿½Ê‚ï¿½Ô‚ï¿½
	 * @param target ï¿½^ï¿½[ï¿½Qï¿½bï¿½gï¿½Iï¿½uï¿½Wï¿½Fï¿½Nï¿½g
	 */
	function getActionResult(target) {
		var info = allActions[target];
		return info !== void ? info.getResultValue() : void;
	}
	
    /**
	 * ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½oï¿½^
	 * @param target ï¿½^ï¿½[ï¿½Qï¿½bï¿½gï¿½Iï¿½uï¿½Wï¿½Fï¿½Nï¿½g
     * @param action ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
	 * @param elm ï¿½pï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½^
	 * @param completed ï¿½Iï¿½ï¿½ï¿½nï¿½ï¿½ï¿½hï¿½ï¿½
	 * @param nowait ï¿½Ò‚ï¿½ï¿½È‚ï¿½
     */
	function beginAction(target, action, completed, nowait) {
		//dm("ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Jï¿½n:" + nowait + ":" + action.nowait);
		var info = allActions[target];
		if (info === void) {
			info = new ActionSequense(target);
			allActions[target] = info;
			actionCount++;
		}
		if (completed !== void) {
			// ï¿½Iï¿½ï¿½ï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½ï¿½oï¿½^
			info.onActionCompleted = completed;
		}
        
        // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ìê‡ï¿½Í•]ï¿½ï¿½ï¿½ï¿½ï¿½Ä‚ï¿½ï¿½Ü‚ï¿½
        if (typeof action == "String") {
            action = Scripts.eval(action);
        }
        
        if (typeof action == "Object") {
            if (action instanceof "Dictionary") {
				//dm("ï¿½ï¿½ï¿½ï¿½ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½:" + action);
				//showKeys("ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½", action);
				// ï¿½ï¿½ï¿½ï¿½ï¿½Ìê‡
				if (typeof action.module == "Object") {
					//dm("ï¿½ï¿½ï¿½Wï¿½ï¿½ï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½Úwï¿½ï¿½");
					action.module(info, action);
                } else if (typeof action.module == "String") {
					//dm("ï¿½ï¿½ï¿½Wï¿½ï¿½ï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½wï¿½ï¿½:" + action.module);
					var module = Scripts.eval(action.module);
					if (module !== void) {
						module(info, action);
                    }
                } else if (typeof action.moduleName == "String") {
					// moduleName ï¿½ï¿½ï¿½wï¿½è‚³ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½ê‡ï¿½ÍƒAï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½`ï¿½Æ‚İ‚È‚ï¿½
					//dm("ï¿½ï¿½ï¿½Wï¿½ï¿½ï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½wï¿½ï¿½:" + action.moduleName);
                    var module = Scripts.eval(action.moduleName);
                    if (module !== void) {
                        module(info, action);
                    }
                } else {
                    // ï¿½ï¿½ï¿½ï¿½ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Ì“ï¿½ï¿½ï¿½ï¿½wï¿½ï¿½
                    info.addActions(action);
				}
                if (action.next) {
					info.next();
				}
				if (action.nowait !== void) {
					info.nowait = action.nowait;
				}
			} else if (action instanceof "Array") {
				//dm("ï¿½Vï¿½[ï¿½Pï¿½ï¿½ï¿½Xï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½");
				for (var i=0;i<action.count;i++) {
					info.addActions(action[i]);
					info.next();
				}
			}
        }
		if (nowait !== void) {
			info.nowait = nowait;
		}
		flipStart();
		return info.getResultValue();
	}
    
    /**
     * ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½~
     * @param target ï¿½^ï¿½[ï¿½Qï¿½bï¿½gï¿½Iï¿½uï¿½Wï¿½Fï¿½Nï¿½g
     */
	function stopAction(target) {
		var info = allActions[target];
		if (info !== void) {
			//dm("ï¿½wï¿½ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½~:" + target.name);
			actionCount--;
			info.stopAction();
            if (typeof info.onActionCompleted != "undefined") {
                info.onActionCompleted(info.target);
            }
            invalidate info;
            delete allActions[target];
        }
    }

    /**
     * ï¿½Sï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Ì’ï¿½~
     */
	function stopAllActions(all) {
		//dm("ï¿½Sï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½~:" + all);
		var names = [];
		names.assign(allActions);
		(Dictionary.clear incontextof allActions)();
		for (var i=0;i<names.count;i+=2) {
			var name = names[i];
			var info = names[i+1];
			if (all || !info.nowait) {
				//dm("ï¿½ï¿½~ï¿½ÎÛƒAï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½:" + name + ": " + info.nowait);
				actionCount--;
				info.stopAction();
				if (typeof info.onActionCompleted != "undefined") {
					info.onActionCompleted(info.target);
				}
				invalidate info;
				delete names[name];
			} else {
				allActions[name] = info;
			}
		}
		if (typeof this.stopActionHandler != "undefined") {
			stopActionHandler(all);
		}
	}
    
    /**
     * ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ÔXï¿½V
     * ï¿½Vï¿½Xï¿½eï¿½ï¿½ï¿½Sï¿½Ì‚ï¿½ï¿½ï¿½Ä‚Ñoï¿½ï¿½
     * @param now ï¿½ï¿½ï¿½İï¿½ï¿½ï¿½
     */
    function updateAction(now) {
        var names = [];
        names.assign(allActions);
        (Dictionary.clear incontextof allActions)();
		actionCount = 0;
        for (var i=0;i<names.count;i+=2) {
            var target = names[i];
            var info   = names[i+1];
            if (info.doAction(now, false)) {
				//dm("ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Iï¿½ï¿½:" + info.target);
                if (typeof info.onActionCompleted != "undefined") {
                    info.onActionCompleted(info.target);
                }
                invalidate info;
            } else {
                // ï¿½Ä“oï¿½^
                allActions[target] = info;
				actionCount++;
            }
        }
    }
    
    /**
     * ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Iï¿½ï¿½
     */
	function onActionCompleted(self) {
		// ï¿½Â•ÊƒAï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½~
		conductor.trigger('action_' + (string)self);
		if (actionCount == 0) {
			// ï¿½Sï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½~
			conductor.trigger('action');
			// ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Sï¿½ï¿½ï¿½ï¿½
			if (typeof this.actionCompletedHandler != "undefined") {
				actionCompletedHandler();
			}
		}
    }

	/**
	 * ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Ò‚ï¿½
	 */
	function waitAction(target, canskip=void) {
		if (!isInAction(target)) return 0; // ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ò‚Ä‚È‚ï¿½
		if((canskip === void || +canskip) && clickSkipEnabled)
		{
			// ï¿½Xï¿½Lï¿½bï¿½vï¿½Å‚ï¿½ï¿½ï¿½ê‡
			if(skipMode)
			{
				// ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½ì’†
                stopAction(target);
				return 0; // ï¿½ï¿½ï¿½ï¿½ï¿½Ú“ï¿½ï¿½ï¿½ï¿½~ï¿½ï¿½ï¿½ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½ï¿½É•Ô‚ï¿½
			}
			conductor.wait(%[
				click : function (target)
				{
                    updateBeforeCh = 1;
                    stopAction(target); // ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½~
				} incontextof this,
				'click_arg' => target, // ï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Ö‚Ìˆï¿½
                'action_' + (string)target => function
				{
					updateBeforeCh = 1;
				} incontextof this
				]);
		}
		else
		{
			conductor.wait(%[
				'action_' + (string)target => function
				{
					updateBeforeCh = 1;
				} incontextof this
				]);
		}
		return -2;
	}

	function waitAllAction(canskip)	{
		// ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ò‚ï¿½
		if (actionCount == 0) return 0; // ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ò‚Ä‚È‚ï¿½
		if((canskip === void || +canskip) && clickSkipEnabled)
		{
			// ï¿½Xï¿½Lï¿½bï¿½vï¿½Å‚ï¿½ï¿½ï¿½ê‡
			if(skipMode)
			{
				// ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½ì’†
				stopAllActions(false);
				return 0; // ï¿½ï¿½ï¿½ï¿½ï¿½Ú“ï¿½ï¿½ï¿½ï¿½~ï¿½ï¿½ï¿½ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½ï¿½É•Ô‚ï¿½
			}
			conductor.wait(%[
				click : function
				{
					updateBeforeCh = 1;
					stopAllActions(false); // ï¿½ï¿½ï¿½×‚Ä‚ÌƒAï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Í’ï¿½~
				} incontextof this,
				action : function
				{
					updateBeforeCh = 1;
				} incontextof this
				]);
		}
		else
		{
			conductor.wait(%[
				action : function
				{
					updateBeforeCh = 1;
				} incontextof this
				]);
		}
		return -2;
	}
	
	//------------------------------------------------ ï¿½fï¿½Bï¿½ï¿½ï¿½C/ï¿½Xï¿½Lï¿½bï¿½vï¿½Ö˜A --

	function setDelay(elm)
	{
		// delay ï¿½^ï¿½Oï¿½Ìï¿½ï¿½ï¿½
		var speed = elm.speed;
		if(speed == 'nowait')
		{
			chSpeed = 0;
			chUserMode = false;
		}
		else if(speed == 'user')
		{
			chUserMode = true;
			setUserSpeed();
		}
		else
		{
			chSpeed = +speed;
			chUserMode = false;
		}
		if(!skipMode) actualChSpeed = chSpeed;
	}

	function getCurrentRead()
	{
        // ï¿½ï¿½zï¿½ï¿½ï¿½Íï¿½ÉŠï¿½ï¿½
		if (isRecollection) {
            return true;
        }

        // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½hï¿½Å‚Ísï¿½Pï¿½Ê‚Å”ï¿½ï¿½è‚·ï¿½ï¿½Kï¿½vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ 
        if (autoLabelMode) {
			if (autoLabelCurrentRecordName != "") {
				//dm("ï¿½ï¿½ï¿½xï¿½ï¿½:" + autoLabelCurrentRecordName);
				//dm("ï¿½tï¿½ï¿½ï¿½O:" + sflags[autoLabelCurrentRecordName]);
				//dm("ï¿½Jï¿½Eï¿½ï¿½ï¿½g:" + autoLabelCount);
				return (sflags[autoLabelCurrentRecordName] !== void &&
						sflags[autoLabelCurrentRecordName] > autoLabelCount);
            }
        }

        // ï¿½ï¿½ï¿½İ‚ÌƒVï¿½iï¿½ï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ç‚ï¿½ï¿½Ç‚ï¿½ï¿½ï¿½ï¿½ğ”»’è‚·ï¿½ï¿½
		return autoRecordPageShowing && currentRecordName != "" &&
				+sflags[currentRecordName] || !autoRecordPageShowing;
	}

	function setUserSpeed()
	{
		// ï¿½ï¿½ï¿½[ï¿½Uï¿½Ì‘Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½Xï¿½sï¿½[ï¿½hï¿½ï¿½İ’ï¿½
		// ï¿½ï¿½ï¿½ÌŠÖï¿½ï¿½ï¿½Ç‚ñ‚¾ï¿½ï¿½_ï¿½Å‚ï¿½ï¿½Å‚ï¿½ userChSpeed ï¿½É‚ï¿½
		// ï¿½ï¿½ï¿½ï¿½ï¿½ç‚µï¿½ï¿½ï¿½lï¿½ï¿½ï¿½İ’è‚³ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½Æ‚İ‚È‚ï¿½ï¿½B
		// ï¿½ï¿½ï¿½é‚¢ï¿½ÍAï¿½ï¿½ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½Æ‚ÉAï¿½ï¿½ï¿½Ì‹ï¿½æ‚ªï¿½ï¿½Ç‚ï¿½ï¿½ï¿½ï¿½Ç‚ï¿½ï¿½ï¿½
		// ï¿½\ï¿½ï¿½ï¿½Xï¿½sï¿½[ï¿½hï¿½ï¿½Ï‚ï¿½ï¿½ï¿½Ú“Iï¿½ÅŒÄ‚Î‚ï¿½ï¿½
		if(chUserMode)
		{
			if(getCurrentRead())
				chSpeed = userCh2ndSpeed==-1?userChSpeed:userCh2ndSpeed; // ï¿½ï¿½ï¿½
			else
				chSpeed = userChSpeed; // ï¿½ï¿½ï¿½ï¿½
		}
		if(!skipMode) actualChSpeed = chSpeed;
	}

	function skipToClick()
	{
		// ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Ò‚ï¿½ï¿½Lï¿½ï¿½ï¿½Ü‚ÅƒXï¿½Lï¿½bï¿½v
		skipMode = SKIP_CLICK;
		actualChSpeed = 0;
	}

	function skipToPage()
	{
		// ï¿½ï¿½yï¿½[ï¿½Wï¿½Ò‚ï¿½ï¿½Lï¿½ï¿½ï¿½Ü‚ÅƒXï¿½Lï¿½bï¿½v
		skipMode = SKIP_PAGE;
		actualChSpeed = 0;
	}

	function skipToStop(nodisp=false)
	{
        // ï¿½ï¿½ï¿½×‚ÄƒXï¿½Lï¿½bï¿½vï¿½Ü‚ï¿½ï¿½ÍŠï¿½Ç‚Ìê‡ï¿½Ì‚ï¿½
        if (allskip || getCurrentRead()) {
            // ï¿½ï¿½ï¿½Ì’ï¿½~ï¿½Ü‚ÅƒXï¿½Lï¿½bï¿½v
            onPrimaryClick(); // ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Ì“ï¿½ï¿½ï¿½ï¿½ï¿½Gï¿½~ï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½gï¿½ï¿½ï¿½ï¿½
            skipMode = SKIP_STOP;
            actualChSpeed = 0;
			if (nodisp) {
				skipNoDisp = true;
			}
		}
	}

	function skipToStop2()
	{
		// ï¿½ï¿½ï¿½Ì’ï¿½~ï¿½Ü‚ÅƒXï¿½Lï¿½bï¿½v(ï¿½ï¿½ï¿½ï¿½ï¿½èƒ‚ï¿½[ï¿½h)
		showMessageLayerByUser() if(messageLayerHiding);
		onPrimaryClick();
		skipMode = SKIP_FAST;
		actualChSpeed = 0;
	}

	function skipToLabel(nodisp=false)
    {
        // ï¿½fï¿½oï¿½bï¿½Oï¿½p: ï¿½ï¿½ï¿½Ìƒï¿½ï¿½xï¿½ï¿½ï¿½Ü‚Å‹ï¿½ï¿½ï¿½ï¿½Xï¿½Lï¿½bï¿½v
		onPrimaryClick();
		skipMode = SKIP_LABEL;
		if (nodisp) {
			skipNoDisp = true;
		}
		actualChSpeed = 0;
    }
    
	function cancelSkip()
	{
		// ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Lï¿½ï¿½ï¿½ï¿½ï¿½Zï¿½ï¿½
		if (skipMode == SKIP_FAST) skipKeyRepressed = false;
		skipMode = SKIP_NONE;
		actualChSpeed = chSpeed;
	}

	function enterNoWait()
	{
		// nowait ï¿½^ï¿½Oï¿½Ìï¿½ï¿½ï¿½
		beforeNoWaitActualChSpeed = actualChSpeed;
		beforeNoWaitChUserMode = chUserMode;
		actualChSpeed = 0;
	}

	function leaveNoWait()
	{
		// endnowait ï¿½^ï¿½Oï¿½Ìï¿½ï¿½ï¿½
		actualChSpeed = beforeNoWaitActualChSpeed;
		chUserMode = beforeNoWaitChUserMode;
	}

	function setAutoWait(elm)
	{
		// ï¿½ï¿½ï¿½ï¿½ï¿½Eï¿½Fï¿½Cï¿½gï¿½ï¿½İ’è‚·ï¿½ï¿½
		autoWCEnabled = +elm.enabled if elm.enabled !== void;
		autoWCChars = elm.ch if elm.ch !== void;
		autoWCWaits = [].split(",", elm.time) if elm.time !== void;
	}

	function cancelAutoMode()
	{
        // ï¿½ï¿½ï¿½ï¿½ï¿½Ç‚İ‚ï¿½ï¿½ï¿½ï¿½İƒï¿½ï¿½[ï¿½hï¿½ÌƒLï¿½ï¿½ï¿½ï¿½ï¿½Zï¿½ï¿½
        if (autoMode) {
			if (typeof this.autoModeMenuItem !== "undefined") {
                autoModeMenuItem.checked = false;
            }
			if (clickWaiting) {
				conductor.trigger('click');
			}
			autoMode = false;
		}
	}

	function enterAutoMode()
	{
        // ï¿½ï¿½ï¿½ï¿½ï¿½Ç‚İ‚ï¿½ï¿½ï¿½ï¿½İƒï¿½ï¿½[ï¿½hï¿½É“ï¿½ï¿½
        if(typeof this.autoModeMenuItem !== "undefined")
            autoModeMenuItem.checked = true;
        // ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Ò‚ï¿½ï¿½Ìê‡ï¿½Ì‹ï¿½ï¿½ï¿½
		if (clickWaiting) {
			conductor.trigger('click');
			if (autoModeAddWait !== void && autoModeAddWait - System.getTickCount() > 0) {
				var t = conductor.lastTagName;
				if (t == 'p' || t == 'p2'){
					insertTag("p2");
				}
				else if(t == 'l'){
					insertTag("l");
				}
			}
		}
		autoMode = true;
    }
        
	//--------------------------------------------------------- ï¿½Eï¿½Fï¿½Cï¿½gï¿½Ö˜A --

	function resetWait()
	{
		// ï¿½ï¿½ï¿½ÔŒï¿½ï¿½_ï¿½Ìƒï¿½ï¿½Zï¿½bï¿½g
        timeOrigin = System.getTickCount();
	}

	function waitTime(waittime, canskip, trans=false, action=false)
	{
		// waittime ï¿½ï¿½ï¿½Ò‚ï¿½
		if(waittime == 0) return 0;

		var arg = 0;
		if (trans) { arg |= 0x01; };
		if (action) { arg |= 0x02; };
		
		if(canskip)
		{
			// ï¿½Xï¿½Lï¿½bï¿½vï¿½Å‚ï¿½ï¿½ï¿½ê‡
			if(skipMode)
			{
				// ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½Ìê‡
				if ((arg & 0x01)) {stopAllTransitions();} // ï¿½ï¿½ï¿½×‚Ä‚Ìƒgï¿½ï¿½ï¿½ï¿½ï¿½Wï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Í’ï¿½~
				if ((arg & 0x02)) {stopAllActions(false);} // ï¿½ï¿½ï¿½×‚Ä‚ÌƒAï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Í’ï¿½~
				return 0; // ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½Ìê‡ï¿½Í‚È‚É‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½É•Ô‚ï¿½
			}

            conductor.waitWithTimeOut(%[
				click : function(arg) 
				{
					if (arg) {
						updateBeforeCh = 1;
						if ((arg & 0x01)) {stopAllTransitions();} // ï¿½ï¿½ï¿½×‚Ä‚Ìƒgï¿½ï¿½ï¿½ï¿½ï¿½Wï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Í’ï¿½~
						if ((arg & 0x02)) {stopAllActions(false);} // ï¿½ï¿½ï¿½×‚Ä‚ÌƒAï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Í’ï¿½~
					}
				} incontextof this,
				click_arg : arg,
				timeout : function(arg)
				{
					if (arg) {
						updateBeforeCh = 1;
						if ((arg & 0x01)) {stopAllTransitions();} // ï¿½ï¿½ï¿½×‚Ä‚Ìƒgï¿½ï¿½ï¿½ï¿½ï¿½Wï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Í’ï¿½~
						if ((arg & 0x02)) {stopAllActions(false);} // ï¿½ï¿½ï¿½×‚Ä‚ÌƒAï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Í’ï¿½~
					}
				} incontextof this,
				timeout_arg : arg,
				], waittime);
		}
		else
		{
			// ï¿½Xï¿½Lï¿½bï¿½vï¿½Å‚ï¿½ï¿½È‚ï¿½ï¿½ê‡
			conductor.waitWithTimeOut(%[
				timeout : function(arg)
				{
					if (arg) {
						updateBeforeCh = 1;
						if ((arg & 0x01)) {stopAllTransitions();} // ï¿½ï¿½ï¿½×‚Ä‚Ìƒgï¿½ï¿½ï¿½ï¿½ï¿½Wï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Í’ï¿½~
						if ((arg & 0x02)) {stopAllActions(false);} // ï¿½ï¿½ï¿½×‚Ä‚ÌƒAï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Í’ï¿½~
					}
				} incontextof this,
				timeout_arg : arg
				], waittime);
		}
		return -2; // break
		
	}



    
	function doWait(elm)
	{
		// wait ï¿½^ï¿½Oï¿½Ìï¿½ï¿½ï¿½
		var waittime;
		if(elm.mode == 'until')
		{
			// until ï¿½ï¿½ï¿½[ï¿½h
			waittime = timeOrigin + +elm.time - System.getTickCount();
			if(waittime < 0) { lastWaitTime = 0; return 0; } // ï¿½ï¿½ï¿½Å‚Éï¿½ï¿½Ô‚ï¿½ï¿½oï¿½ß‚ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½
			lastWaitTime = waittime;
			if(waittime < 6) return 0; // ï¿½ï¿½ï¿½Ü‚ï¿½É‘Ò‚ï¿½ï¿½ï¿½ï¿½Ô‚ï¿½ï¿½Zï¿½ï¿½ï¿½Ì‚Å‘Ò‚ï¿½ï¿½È‚ï¿½
		}
		else
		{
			waittime = +elm.time;
        }
		return waitTime(waittime, (elm.canskip === void || +elm.canskip) && clickSkipEnabled,
						elm.trans !== void ? elm.trans : false,
						elm.action !== void ? elm.action : false);
	}

	function doWaitCh(elm)
	{
		// +elm.time ï¿½ÌƒJï¿½Eï¿½ï¿½ï¿½gï¿½ï¿½ï¿½Aï¿½Ò‚ï¿½
		var t = elm.time;
		return waitTime(actualChSpeed * (t === void ? 1 : +t),
			(elm.canskip === void || +elm.canskip) && clickSkipEnabled);
	}

	//------------------------------------------------------------ quakeï¿½Ö˜A --

	function doQuake(elm)
	{
		// elm ï¿½É]ï¿½ï¿½ï¿½ï¿½ quake ï¿½ï¿½ï¿½Jï¿½n
		if(elm.time !== void)
		{
			if(defaultQuakeTimeInChUnit)
			{
				if(elm.timemode == 'ms')
					quakeEndTick = System.getTickCount() + +elm.time;
				else
					quakeEndTick = System.getTickCount() + +elm.time * chSpeed;
			}
			else
			{
				if(elm.timemode == 'delay')
					quakeEndTick = System.getTickCount() + +elm.time * chSpeed;
				else
					quakeEndTick = System.getTickCount() + +elm.time;
			}
		}
		else
		{
			quakeEndTick = -1;
		}

		if(elm.hmax !== void) quakeHorzMax = +elm.hmax; else quakeHorzMax = 10;
		if(elm.vmax !== void) quakeVertMax = +elm.vmax; else quakeVertMax = 10;

		quakeTimer.enabled = true;
		quaking = true;
	}

	function restoreQuake()
	{
		// restore ï¿½ï¿½ï¿½ï¿½Ä‚Î‚ï¿½Aï¿½xï¿½ï¿½Û‘ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æ‚ï¿½ï¿½É—hï¿½ï¿½Ä‚ï¿½ï¿½ï¿½ï¿½ê‡ï¿½Í—hï¿½ç‚·
		if(quaking && quakeEndTick == -1)
			quakeTimer.enabled =true;
	}

    /**
     * ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ê’uï¿½Ì’ï¿½ï¿½ï¿½
     * ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ÌˆÊ’uï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Iï¿½É‚ï¿½ï¿½ç‚·
     */
    function setLayerPos(x, y) {
        super.setLayerPos(x, y);
        if (!quakeMessageLayer) {
            for(var i = 0; i< fore.messages.count; i++) fore.messages[i].setDiff(-x, -y);
            for(var i = 0; i< back.messages.count; i++) back.messages[i].setDiff(-x, -y);
        }
    }

    
	function stopQuake()
	{
		// ï¿½hï¿½ï¿½ï¿½ï¿½~
		setLayerPos(0, 0);
		quakeTimer.enabled = false;
		quaking = false;
		conductor.trigger('quake');
	}

	function onQuakeTimerInterval()
	{
		// quakeTimer ï¿½É‚ï¿½ï¿½Ä‚Î‚ï¿½ï¿½
		if(quakeEndTick != -1 && System.getTickCount() > quakeEndTick) { stopQuake(); return; }
		if(historyShowing || selectShowing || mapSelectShowing || panelShowing || currentDialog !== void)
		{
			// ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½ï¿½ï¿½Í‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½É—hï¿½ï¿½Ä‚ï¿½ï¿½ï¿½ï¿½È‚ï¿½
			setLayerPos(0, 0);
			return;
		}
		var x, y;
		if(quakeHorzMax == quakeVertMax)
		{
			// ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
			x = int(Math.random() * quakeHorzMax - quakeHorzMax);
			y = int(Math.random() * quakeVertMax - quakeVertMax);
		}
		else if(quakeHorzMax < quakeVertMax)
		{
			// ï¿½cï¿½hï¿½ï¿½
			x = int(Math.random() * quakeHorzMax - quakeHorzMax);
			y = int((quakePhase ? Math.random() : -Math.random()) * quakeVertMax);
		}
		else
		{
			// ï¿½ï¿½ï¿½hï¿½ï¿½
			x = int((quakePhase ? Math.random() : -Math.random()) * quakeHorzMax);
			y = int(Math.random() * quakeVertMax - quakeVertMax);
		}
		quakePhase = !quakePhase;
		setLayerPos(x, y);
	}

	function waitQuake(elm)
	{
		// ï¿½hï¿½ê‚ªï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ü‚Å‚Ü‚ï¿½
		if(!quaking || quakeEndTick == -1) return 0; // ï¿½hï¿½ï¿½Ä‚ï¿½ï¿½È‚ï¿½ï¿½ï¿½Î‘Ò‚ï¿½ï¿½È‚ï¿½
		if(elm.canskip !== void && +elm.canskip && clickSkipEnabled)
		{
			// ï¿½Xï¿½Lï¿½bï¿½vï¿½Å‚ï¿½ï¿½ï¿½ê‡
			if(skipMode)
			{
				// ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½Ìê‡
				stopQuake();
				return 0; // ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½Ìê‡ï¿½Í—hï¿½ï¿½ï¿½ï¿½~ï¿½ï¿½ï¿½ï¿½ï¿½Ä•Ô‚ï¿½
			}
			conductor.wait(%[
				click : function
				{
					stopQuake(); // ï¿½hï¿½ï¿½Í’ï¿½~ï¿½ï¿½ï¿½ï¿½
				} incontextof this,

				quake : function
				{
					// ï¿½ï¿½é‚±ï¿½Æ‚È‚ï¿½
				} incontextof this
				]);
		}
		else
		{
			// ï¿½Xï¿½Lï¿½bï¿½vï¿½Å‚ï¿½ï¿½È‚ï¿½ï¿½ê‡
			conductor.wait(%[
				quake : function
				{
					// ï¿½ï¿½é‚±ï¿½Æ‚È‚ï¿½
				} incontextof this
				]);
		}
		return -2;
	}

	//------------------------------------------------------------- ï¿½Nï¿½ï¿½ï¿½bï¿½N --

	function onPrimaryClick()
	{
        // ï¿½vï¿½ï¿½ï¿½Cï¿½}ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Åuï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Ì“ï¿½ï¿½ï¿½vï¿½ï¿½ï¿½È‚É‚ï¿½ï¿½tï¿½Bï¿½ï¿½ï¿½^ï¿½ï¿½ï¿½ï¿½ï¿½Oï¿½ï¿½ï¿½ï¿½È‚ï¿½ï¿½ï¿½ï¿½ï¿½
		// ï¿½Æ‚ï¿½ï¿½Aï¿½vï¿½ï¿½ï¿½Cï¿½}ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ä‚Î‚ï¿½ï¿½B
		clickCount ++;
		if(!callHook(leftClickHook))
		{
			if(messageLayerHiding)
			{
				showMessageLayerByUser(); // ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
			}
            else
            {
				var st = conductor.status;
				var runst = conductor.mRun;
				var stopst = conductor.mStop;

                if(st != stopst && canCancelSkipByClick && skipMode && skipMode < SKIP_FAST)
				{
					// ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½É‚ï¿½ï¿½Xï¿½Lï¿½bï¿½vï¿½Ì‰ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Â”\
					cancelSkip();
                    return;
				}
                
//				else
                {
					// ï¿½ï¿½ï¿½Ìï¿½ï¿½_ï¿½Åƒtï¿½Bï¿½ï¿½ï¿½^ï¿½ï¿½ï¿½ï¿½ï¿½Oï¿½ï¿½ï¿½ï¿½È‚ï¿½ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½Í‘Ò‚ï¿½ï¿½ï¿½Ô‚ÌƒNï¿½ï¿½ï¿½Aï¿½È‚Ì‚ï¿½
					// conductor ï¿½ï¿½ 'click' ï¿½ğ‘—‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½`ï¿½ï¿½ï¿½ï¿½B

					if(!conductor.trigger('click')) // ï¿½Ò‚ï¿½ï¿½ï¿½Ô‚Å‚È‚ï¿½ï¿½ê‡ï¿½Í’Pï¿½É–ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
					{
                        // ï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Â‚ï¿½ï¿½ï¿½È‚ï¿½ï¿½È‚ÇAï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½È‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ê‡
                        if (prevSkipMode !== void) {
                            skipMode = SKIP_CANCEL;
                        } else {
                            if(st == runst && clickSkipEnabled && skipMode == SKIP_NONE)
  						    {
                                // ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½É‚ï¿½ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½Â”\
                                skipToClick();
                            }
                        }
                    } else {
                        if (prevSkipMode !== void) {
                            skipMode = SKIP_CANCEL;
                        }
                    }
				}

                // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ê‚©ï¿½ï¿½ï¿½ï¿½ï¿½Bï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½hï¿½ï¿½ï¿½ï¿½ï¿½ÍƒNï¿½ï¿½ï¿½bï¿½Nï¿½É‚ï¿½ï¿½Lï¿½ï¿½ï¿½ï¿½ï¿½Zï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ÌŒï¿½É‚ï¿½ï¿½ï¿½
                if (st != stopst && autoMode) {
                    cancelAutoMode();
                }
                
            }
		}
	}

	function onPrimaryClickByKey()
	{
		// ï¿½Lï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ê‚½ï¿½Æ‚ï¿½ï¿½vï¿½ï¿½ï¿½Cï¿½}ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½ï¿½ï¿½ï¿½ï¿½Ì‚ï¿½
		// ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½é‚ªï¿½Aï¿½ï¿½ï¿½ï¿½Éˆêï¿½Iï¿½Éƒ}ï¿½Eï¿½Xï¿½Jï¿½[ï¿½\ï¿½ï¿½ï¿½ï¿½ï¿½Bï¿½ï¿½
		onPrimaryClick();
		hideMouseCursor();
	}

	function waitClick(elm)
	{
		// beginskip/endskipï¿½ï¿½ï¿½Í‹ï¿½ï¿½ï¿½ï¿½Å”ï¿½Î‚ï¿½
		if (skipMode >= SKIP_CANCEL) return  0;

		// ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½ï¿½Ò‚ï¿½
		conductor.wait(%[
			click : function
			{
				inSleep = false;
				notifyRun();
			} incontextof this]);
		inSleep = true;
		notifyStable();
		return -2;
	}

	function onMouseDown(x, y)
	{
		lastMouseDownX = x;
		lastMouseDownY = y;
		super.onMouseDown(...);
	}

	function onMouseUp(x, y, btn)
	{
		conductor.trigger("mouseup" + btn);
		super.onMouseUp(...);
	}

	//------------------------------------------------------- ï¿½Lï¿½[ï¿½{ï¿½[ï¿½hï¿½ï¿½ï¿½ï¿½ --

	function processKeys(key, shift)
	{
        if (shift == ssAlt && key == VK_LEFT) {
            onSkipToPrevLabelMenuItemClick();
            return;
        } else if (shift == ssAlt && key == VK_RIGHT) {
            onSkipToNextLabelMenuItemClick();
            return;
        }

        // CONTROL ï¿½É‚ï¿½ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½ï¿½
        if(key == VK_CONTROL) {
            var sg = getKeyState;
            if(sg(VK_CONTROL)){
                if (conductor.status != conductor.mStop && clickSkipEnabled && skipMode < SKIP_FAST) {
                    skipToStop2(); // ï¿½Ü‚ï¿½skipMode 4ï¿½É“ï¿½ï¿½ï¿½Ä‚ï¿½ï¿½È‚ï¿½ï¿½ê‡ï¿½Í‘ï¿½ï¿½ï¿½ï¿½èƒ‚ï¿½[ï¿½hï¿½É“ï¿½ï¿½
                }
            }
        }

        if(checkProceedingKey(key, shift)) return;

		if(key == #'F')
		{
			// ï¿½ï¿½ï¿½Ì‘Iï¿½ï¿½ï¿½ï¿½/ï¿½ï¿½ï¿½Ç‚Ü‚Åiï¿½ï¿½
			skipToNextStopByKey();
			return;
		}

		if(key == #'B')
		{
			// ï¿½Oï¿½É–ß‚ï¿½
			goBackByKey();
			return;
		}

		if(key == #'A')
		{
			// ï¿½ï¿½ï¿½ï¿½ï¿½Iï¿½É“Ç‚İiï¿½ß‚ï¿½
			switchAutoModeByKey();
			return;
		}
 
		if(freeSaveDataMode)
		{
			if(key == #'S')
			{
				// ï¿½xï¿½ï¿½ï¿½Í‚ï¿½ï¿½ï¿½
				if(typeof this.storeMenu != "undefined" && storeMenu.enabled)
					storeMenu.click();
				return;
			}

			if(key == #'L')
			{
				// ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½Ç‚ï¿½
				if(typeof this.restoreMenu != "undefined" && restoreMenu.enabled)
					restoreMenu.click();
				return;
			}
		}

		if(key == #'R' || (shift == ssShift && key == VK_UP))
		{
			// ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½
			showHistoryByKey();
			return;
		}

		if(key == VK_ESCAPE)
		{
			// ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
			if(typeof this.rightClickMenuItem != "undefined" &&
				rightClickMenuItem.enabled)
			{
				rightClickMenuItem.click(); // ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½ï¿½ï¿½Gï¿½~ï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½g
				return;
			}
		}
	}

	function preProcessKeys(key, shift)
	{
		return callHook(keyDownHook, key, shift);
	}

	function internalOnKeyDown(key, shift)
	{
		if(!preProcessKeys(key, shift)) processKeys(key, shift);
	}

	function checkProceedingKey(key, shift)
	{
        // key ï¿½ï¿½ï¿½Ç‚İ‚ï¿½ï¿½ï¿½ï¿½İ‚ÌƒLï¿½[ ( ï¿½Xï¿½yï¿½[ï¿½Xï¿½Lï¿½[ï¿½ï¿½Returnï¿½Lï¿½[ ) ï¿½Ìê‡ï¿½ï¿½
		// ï¿½Lï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Atrue ï¿½ï¿½Ô‚ï¿½ï¿½Bï¿½ï¿½ï¿½ï¿½ï¿½Å‚È‚ï¿½ï¿½ï¿½ï¿½ false ï¿½ï¿½Ô‚ï¿½
		if(key == VK_RETURN || key == VK_SPACE)
		{
			// ï¿½Lï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½Lï¿½ï¿½ï¿½[ï¿½É—ï¿½ï¿½Ü‚ï¿½ï¿½Ä‚ï¿½ê‡ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ì‚ï¿½
			// ï¿½ï¿½ï¿½Û‚É‚ï¿½ï¿½ÌƒLï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½Ì‚ï¿½ï¿½Ç‚ï¿½ï¿½ï¿½ï¿½ï¿½
			// getKeyState ï¿½ï¿½pï¿½ï¿½ï¿½Ä’ï¿½ï¿½×‚ï¿½
			var sg = getKeyState;
			if(sg(VK_RETURN) || sg(VK_SPACE))
			{
				// ï¿½Lï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ä‚ï¿½
				if((shift & ssRepeat) && clickSkipEnabled)
				{
					// ï¿½Lï¿½[ï¿½ï¿½ï¿½sï¿½[ï¿½g
					if(skipMode < SKIP_FAST && skipKeyRepressed)
						skipToStop2(); // ï¿½Ü‚ï¿½skipMode 4ï¿½É“ï¿½ï¿½ï¿½Ä‚ï¿½ï¿½È‚ï¿½ï¿½ê‡ï¿½Í‘ï¿½ï¿½ï¿½ï¿½èƒ‚ï¿½[ï¿½hï¿½É“ï¿½ï¿½
					// skipKeyRepressed ï¿½ï¿½ï¿½`ï¿½Fï¿½bï¿½Nï¿½ï¿½ï¿½ï¿½Ì‚ï¿½
					// ï¿½Aï¿½ï¿½ï¿½ï¿½ï¿½ÄƒLï¿½[ï¿½ï¿½ï¿½sï¿½[ï¿½gï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½Æ‚ï¿½ï¿½ï¿½
					// cancelSkip ï¿½ï¿½ÉƒXï¿½Lï¿½bï¿½vï¿½É“Ë“ï¿½ï¿½Ì‚ï¿½hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
				}
				else
				{
					skipKeyRepressed = true;
					onPrimaryClickByKey();
				}
				return true;
			}
		}

		return false;
	}

	function skipCancelKeyPressing()
	{
		// ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½vï¿½ï¿½Æ‚È‚ï¿½Lï¿½[ï¿½ï¿½ï¿½é‚¢ï¿½Íƒ}ï¿½Eï¿½Xï¿½{ï¿½^ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ä‚ï¿½ï¿½é‚©
		var sg = getKeyState;
		return sg(VK_RETURN) || sg(VK_SPACE) || sg(VK_LBUTTON);
	}

	function skipKeyPressing()
	{
		// VK_RETURN ï¿½ï¿½ï¿½é‚¢ï¿½ï¿½ VK_SPACE ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ä‚ï¿½ï¿½é‚©ï¿½Ç‚ï¿½ï¿½ï¿½
		var sg = getKeyState;
		return sg(VK_RETURN) || sg(VK_SPACE) || sg(VK_CONTROL);
	}

	function releaseCapture() {
		// releaseCaptureï¿½Ìƒï¿½ï¿½Cï¿½ï¿½ï¿½Í‰ï¿½ï¿½Å‚ï¿½ï¿½Ç‚ï¿½
		primaryLayer.releaseCapture();
	}

	function goBackByKey()
	{
		releaseCapture();
		if(typeof this.goBackMenuItem != "undefined" &&
			goBackMenuItem.enabled)
			goBackMenuItem.click(); // ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½ï¿½ï¿½Gï¿½~ï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½g
	}

	function skipToNextStopByKey()
	{
		releaseCapture();
		if(typeof this.skipToNextStopMenuItem != "undefined" &&
			skipToNextStopMenuItem.enabled)
			skipToNextStopMenuItem.click(); // ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½ï¿½ï¿½Gï¿½~ï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½g
	}

	function showHistoryByKey()
	{
		releaseCapture();
		if(typeof this.showHistoryMenuItem != "undefined" &&
			showHistoryMenuItem.enabled)
			showHistoryMenuItem.click(); // ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½ï¿½ï¿½Gï¿½~ï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½g
	}

	function switchAutoModeByKey()
	{
		releaseCapture();
		if(typeof this.autoModeMenuItem != "undefined" &&
			autoModeMenuItem.enabled)
			autoModeMenuItem.click(); // ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½ï¿½ï¿½Gï¿½~ï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½g
	}

	function onKeyDown(key, shift)
	{
        if(focusedLayer === null)
			internalOnKeyDown(key, shift);
		super.onKeyDown(...);
	}

	function onMouseWheel(shift, delta, x, y)
	{
		// ï¿½zï¿½Cï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½]ï¿½ï¿½ï¿½ï¿½
		super.onMouseWheel(...);
        if (currentDialog !== void) {
            return;
        }
        // ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Ìƒzï¿½Cï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
        if (inSleep && current.hasWheel()) {
            current.processWheel(shift, delta, x, y);
            return;
        }
        if(!historyLayer.visible)
		{
			if(delta > 0)
				showHistoryByKey(); // ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½
			else if(System.getTickCount() - lastHistoryHiddenTick > 150) 
					onPrimaryClick(); // ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½ï¿½ï¿½Gï¿½~ï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½g
			// ï¿½ï¿½ tick ï¿½ï¿½ï¿½rï¿½ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½Ì‚ÍAï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Bï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æƒzï¿½Cï¿½[ï¿½ï¿½ï¿½ï¿½
			// ï¿½ï¿½Oï¿½É‰ñ‚·‘ï¿½ï¿½ì‚ªï¿½Aï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ê‡ï¿½Éï¿½ï¿½ï¿½É“Ç‚İiï¿½Ş‚Ì‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½xï¿½hï¿½ï¿½ï¿½dï¿½|ï¿½ï¿½
		}
		else
		{
			// ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½ÉƒCï¿½xï¿½ï¿½ï¿½gï¿½ğ‚‚ê—¬ï¿½ï¿½
			historyLayer.windowMouseWheel(shift, delta, x, y);
		}
	}

	//------------------------------------------------- ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Ò‚ï¿½ï¿½Lï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ --

	function hideClickGlyphs()
	{
		// ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Ò‚ï¿½ï¿½Lï¿½ï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½ï¿½
		lineBreak.visible = false;
		pageBreak.visible = false;
		if(conductor == mainConductor)
		{
			// ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Ò‚ï¿½ï¿½Lï¿½ï¿½ï¿½Ìï¿½Ô‚ï¿½ï¿½Lï¿½^
			lastClickGlyphVisible = false;
		}
	}

	function storeClickGlyphState(which)
	{
		// ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Ò‚ï¿½ï¿½Lï¿½ï¿½ï¿½Ìï¿½ï¿½ï¿½ï¿½êï¿½Iï¿½É‘Ò”ï¿½
		// ï¿½ï¿½ï¿½Ìƒfï¿½[ï¿½^ï¿½Í‰Eï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Tï¿½uï¿½ï¿½ï¿½[ï¿½`ï¿½ï¿½ï¿½ï¿½extraConductorï¿½Tï¿½uï¿½ï¿½ï¿½[ï¿½`ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ß‚ï¿½Æ‚ï¿½ï¿½ÉQï¿½Æ‚ï¿½ï¿½ï¿½
		if(conductor == mainConductor)
		{
			lastClickGlyphVisible = true;
			lastClickGlyphMessagePage = currentPage;
			lastClickGlyphMessageNum = currentNum;
			lastClickGlyphWhich = which;
		}
	}

	function restoreClickGlyphState()
	{
		// lastClickGlyph *** ï¿½Éˆêï¿½Iï¿½É‘Ò”ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Ò‚ï¿½ï¿½Lï¿½ï¿½ï¿½Ìï¿½ï¿½
		// ï¿½ÉŠï¿½Ã‚ï¿½ï¿½ÄƒNï¿½ï¿½ï¿½bï¿½Nï¿½Ò‚ï¿½ï¿½Lï¿½ï¿½ï¿½ï¿½İ’è‚·ï¿½ï¿½
		if(lastClickGlyphVisible)
		{
			var layer = getMessageLayerObjectFromPageAndNumber
				(lastClickGlyphMessagePage, lastClickGlyphMessageNum);
			if(layer !== void)
			{
				switch(lastClickGlyphWhich)
				{
				case 'line':
					layer.showLineBreakGlyph(lineBreak);
					break;
				case 'page':
					layer.showPageBreakGlyph(pageBreak);
					break;
				}
			}
		}
	}

	function canIgnoreL()
	{
		// L ï¿½^ï¿½Oï¿½ğ–³ï¿½ï¿½Å‚ï¿½ï¿½é‚©ï¿½Ç‚ï¿½ï¿½ï¿½
		return chNonStopToPageBreak || (getCurrentRead() && ch2ndNonStopToPageBreak);
	}

    function waitAuto(waittime, tag) {
        if (skipMode) return 0;
        if (waittime <= 0) {
            waittime = 1;
        }
        conductor.waitWithTimeOut(%[
            click : function (tag)
            {
				clickWaiting = false;
				fore.base.cursor = cursorDefault;
				cancelAutoMode();
				hideClickGlyphs();
				if (tag !== void) {
					insertTag(tag);
				}
            } incontextof this,
            click_arg : tag,
            timeout : function
            {
				clickWaiting = false;
				fore.base.cursor = cursorDefault;
                hideClickGlyphs();
            } incontextof this
                ], waittime);
		clickWaiting = true;
		return -2; // break
	}
    
	function showLineBreak(elm)
	{
		// ï¿½ï¿½ï¿½İ‚Ìƒï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ésï¿½Ò‚ï¿½ï¿½Lï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		stablePosibility = true;
		if(canIgnoreL())
		{
			// l ï¿½^ï¿½Oï¿½Ì–ï¿½ï¿½ï¿½
			if(elm.canskip === void || !+elm.canskip)
				return (skipMode==SKIP_STOP || skipMode==SKIP_FAST) ? 0 : -4;
		}

        if(autoMode) {
            current.showLineBreakGlyph(lineBreak);
            storeClickGlyphState("line");
            return waitAuto(elm.voicewait ? calcAutoModeLineWait() : autoModeLineWait, "l");
		}
		if(skipMode == SKIP_CLICK) cancelSkip();
		if(skipMode == SKIP_FAST && !skipKeyPressing()) cancelSkip();
		if(skipMode >= SKIP_FAST) return -4;
		if(skipMode) return skipCancelKeyPressing()?-4:0;
			// ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½(ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½Lï¿½ï¿½ï¿½ï¿½ï¿½Zï¿½ï¿½ï¿½ï¿½ï¿½ï¿½æ‚¤ï¿½ÈƒLï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ÎƒXï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½ï¿½
			// ï¿½Ì‚ï¿½ï¿½ß‚ÌƒCï¿½xï¿½ï¿½ï¿½gï¿½ï¿½ï¿½ï¿½ï¿½Ì‹@ï¿½ï¿½ï¿½^ï¿½ï¿½ï¿½ï¿½)

        current.showLineBreakGlyph(lineBreak);
        storeClickGlyphState("line");
        
		if(!current.nodeVisible)
		{
			dm("ï¿½xï¿½ï¿½ : ï¿½ï¿½\ï¿½ï¿½ï¿½É‚È‚ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½" +
				(currentPage ? "ï¿½ï¿½" : "ï¿½\") + "ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½" + currentNum +
				"ï¿½Åsï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Ò‚ï¿½ï¿½É‚È‚ï¿½Ü‚ï¿½ï¿½ï¿½");
		}

		// conductor ï¿½ï¿½ 'click' ï¿½Ü‚Å‘Ò‚ï¿½ï¿½ï¿½Ô‚ï¿½
		conductor.wait(%[
			click : function
			{
				clickWaiting = false;
				fore.base.cursor = cursorDefault;
				notifyRun();
                hideClickGlyphs();
            } incontextof this
			]);
		clickWaiting = true;
		fore.base.cursor = cursorWaitingClick;
		notifyStable();
		return -2;
	}

	function showPageBreak(elm)
	{
		// ï¿½ï¿½ï¿½İ‚Ìƒï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Éƒyï¿½[ï¿½Wï¿½Ò‚ï¿½ï¿½Lï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		stablePosibility = true;
		if(skipMode == SKIP_CLICK || skipMode == SKIP_PAGE) cancelSkip();
		if(skipMode == SKIP_FAST && !skipKeyPressing()) cancelSkip();
		if(skipMode) return -4; // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½xï¿½ï¿½ï¿½gï¿½ï¿½ï¿½ï¿½ï¿½ï¿½

        current.showPageBreakGlyph(pageBreak);
		storeClickGlyphState("page");
        
        if(autoMode) {
			return waitAuto(calcAutoModePageWait(), "p2");
        }

		if(!current.nodeVisible)
		{
			dm("ï¿½xï¿½ï¿½ : ï¿½ï¿½\ï¿½ï¿½ï¿½É‚È‚ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½" +
				(currentPage ? "ï¿½ï¿½" : "ï¿½\") + "ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½" + currentNum +
				"ï¿½Åƒyï¿½[ï¿½Wï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Ò‚ï¿½ï¿½É‚È‚ï¿½Ü‚ï¿½ï¿½ï¿½");
		}

		// conductor ï¿½ï¿½ 'click' ï¿½Ü‚Å‘Ò‚ï¿½ï¿½ï¿½Ô‚ï¿½
		conductor.wait(%[
			click : function
			{
				clickWaiting = false;
				fore.base.cursor = cursorDefault;
				notifyRun();
                hideClickGlyphs();
			} incontextof this
			]);
		clickWaiting = true;
		fore.base.cursor = cursorWaitingClick;
		notifyStable();
		return -2;
	}

	function showPageBreakAndClear()
	{
		// ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½ÅIï¿½sï¿½Ü‚Å’Bï¿½ï¿½ï¿½Äï¿½ï¿½ï¿½ï¿½ï¿½yï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æ‚ï¿½ï¿½ï¿½
		// ï¿½Ä‚Î‚ï¿½ï¿½Bï¿½ï¿½ï¿½İ‚Ìƒï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Éƒyï¿½[ï¿½Wï¿½Ò‚ï¿½ï¿½Lï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½ï¿½ï¿½A
		// ï¿½ï¿½ï¿½sï¿½ÄŠJï¿½ï¿½ï¿½É‚ï¿½ MessageLayer.clear2 ï¿½ï¿½ï¿½Ä‚ï¿½
		stablePosibility = true;
		if(skipMode == SKIP_CLICK || skipMode == SKIP_PAGE) cancelSkip();
		if(skipMode == SKIP_FAST && !skipKeyPressing()) cancelSkip();
		var lasttagname = conductor.lastTagName;
		if(!autoMode && ((!canIgnoreL() && lasttagname == 'l') || lasttagname == 'p'))
			{ current.clear2(); return -5; }// ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½xï¿½ï¿½ï¿½gï¿½ï¿½ï¿½ï¿½ï¿½ï¿½(ï¿½^ï¿½Oï¿½ÍŒï¿½ï¿½)
		if(skipMode) { current.clear2(); return -5; }// ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½xï¿½ï¿½ï¿½gï¿½ï¿½ï¿½ï¿½ï¿½ï¿½(ï¿½^ï¿½Oï¿½ÍŒï¿½ï¿½)

		if(!current.nodeVisible)
		{
			dm("ï¿½xï¿½ï¿½ : ï¿½ï¿½\ï¿½ï¿½ï¿½É‚È‚ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½" +
				(currentPage ? "ï¿½ï¿½" : "ï¿½\") + "ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½" + currentNum +
				"ï¿½Åï¿½ï¿½ï¿½ï¿½ï¿½yï¿½[ï¿½Wï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Ò‚ï¿½ï¿½É‚È‚ï¿½Ü‚ï¿½ï¿½ï¿½");
		}

		if(autoMode)
		{
            var wait = calcAutoModePageWait();
			conductor.waitWithTimeOut(%[ // ï¿½^ï¿½Cï¿½ï¿½ï¿½Aï¿½Eï¿½gï¿½tï¿½ï¿½ï¿½Eï¿½Fï¿½Cï¿½g
				click : function
				{
					current.clear2(); // clear2 ï¿½ï¿½ï¿½Ä‚ï¿½
                    cancelAutoMode();
				} incontextof this,
				timeout : function
				{
					current.clear2(); // clear2 ï¿½ï¿½ï¿½Ä‚ï¿½
				} incontextof this
				], wait <= 0 ? 1 : wait);
			return -3;
		}
		else
		{
			current.showPageBreakGlyph(pageBreak);
			storeClickGlyphState("page");

			// conductor ï¿½ï¿½ 'click' ï¿½Ü‚Å‘Ò‚ï¿½ï¿½ï¿½Ô‚ï¿½
			conductor.wait(%[
				click : function
				{
					clickWaiting = false;
					fore.base.cursor = cursorDefault;
					current.clear2(); // clear2 ï¿½ï¿½ï¿½Ä‚ï¿½
					notifyRun();
				} incontextof this
				]);
			clickWaiting = true;
			fore.base.cursor = cursorWaitingClick;
			notifyStable();
			return -3;
		}
	}

	//------------------------------------------------------------- BGM ï¿½ï¿½ï¿½ï¿½ --

	function onBGMFadeCompleted()
	{
		// BGM ï¿½Ìƒtï¿½Fï¿½[ï¿½hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		conductor.trigger('bgmfade');
	}

    // BGMï¿½ï¿½~ï¿½ï¿½ï¿½ï¿½
    var bgmStopExp;
    var bgmStopStorage;
    var bgmStopTarget;

    function handleBgmStop() {
        // BGMï¿½ï¿½~ï¿½nï¿½ï¿½ï¿½hï¿½ï¿½

        // ï¿½pï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½^ï¿½ï¿½Ûï¿½ï¿½ï¿½ï¿½Ä”jï¿½ï¿½
        var exp     = bgmStopExp;
        var storage = bgmStopStorage;
        var target  = bgmStopTarget;
        clearBgmStop();
        
        // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½s
        if (exp !== void) {
            Scripts.eval(exp);
        }
        if (storage !== void || target !== void) {
            process(storage, target);
        }
    }
    
    function setBgmStop(elm) {
        // BGMï¿½ï¿½~ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ì“oï¿½^
        bgmStopExp     = elm.exp;
        bgmStopStorage = elm.storage;
        bgmStopTarget  = elm.target;
    }
    
    function clearBgmStop() {
        // BGMï¿½ï¿½~ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ì‰ï¿½ï¿½ï¿½
        bgmStopExp     = void;
        bgmStopStorage = void;
        bgmStopTarget  = void;
    }
    
    // BGM ï¿½ï¿½~ï¿½ï¿½ï¿½gï¿½ï¿½ï¿½nï¿½ï¿½ï¿½hï¿½ï¿½
    var bgmStopHandler;
    
	function onBGMStop()
	{
        // BGM ï¿½ï¿½ï¿½ï¿½~ï¿½ï¿½ï¿½ï¿½
        conductor.trigger('bgmstop');
        if (bgmStopHandler !== void) {
            bgmStopHandler();
        }
        if (bgmStopExp !== void || bgmStopStorage !== void || bgmStopTarget !== void) {
            global.stopBgmTrigger = new AsyncTrigger(handleBgmStop, '');
            global.stopBgmTrigger.cached = true;
            global.stopBgmTrigger.trigger();
        }
    }

    // ------------------------------------------
    
    var bgmLabelInfos = %[];
    var bgmLabelInfo;

    function handleBgmLabel() {
        if (bgmLabelInfo !== void) {
            if (bgmLabelInfo.exp !== void) {
                Scripts.eval(bgmLabelInfo.exp);
            }
            if (bgmLabelInfo.storage !== void || bgmLabelInfo.target !== void) {
                process(bgmLabelInfo.storage, bgmLabelInfo.target);
            }
        }
    }

    // BGM ï¿½ï¿½~ï¿½ï¿½ï¿½gï¿½ï¿½ï¿½nï¿½ï¿½ï¿½hï¿½ï¿½
    var bgmLabelHandler;

    function onBGMLabel(label) {
        // BGM ï¿½Ìƒï¿½ï¿½xï¿½ï¿½ï¿½Ê‰ßï¿½ï¿½ï¿½
        conductor.trigger('bgmlabel_' + label);
        if (bgmLabelHandler !== void) {
            bgmLabelHandler(label);
        }
        var obj = bgmLabelInfos[label];
        if (obj !== void) {
            bgmLabelInfo = obj;
            global.labelBgmTrigger = new AsyncTrigger(handleBgmLabel, '');
            global.labelBgmTrigger.cached = true;
            global.labelBgmTrigger.trigger();
        }
    }

    /**
     * BGM ï¿½ï¿½ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ì“oï¿½^
     */
    function setBgmLabel(elm) {
        if (elm.name !== void) {
            var obj = %[];
            obj.storage = elm.storage;
            obj.target  = elm.target;
            obj.exp     = elm.exp;
            bgmLabelInfos[elm.name] = obj;
        }
    }

    /**
     * BGM ï¿½ï¿½ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ì‰ï¿½ï¿½ï¿½
     */
    function clearBgmLabel() {
        bgmLabelInfos = %[];
        bgmLabelInfo = void;
    }

    // ----------------------------------------------------------------------
    
	function waitBGMFade(elm)
	{
		// BGM ï¿½Ìƒtï¿½Fï¿½[ï¿½hï¿½Iï¿½ï¿½ï¿½ï¿½Ò‚ï¿½
		if(!bgm.inFading) return 0; // ï¿½tï¿½Fï¿½[ï¿½hï¿½ï¿½ï¿½Å‚È‚ï¿½ï¿½ï¿½Î‘Ò‚ï¿½ï¿½È‚ï¿½
		if(elm.canskip !== void && +elm.canskip && clickSkipEnabled)
		{
			// ï¿½Xï¿½Lï¿½bï¿½vï¿½Å‚ï¿½ï¿½ï¿½ê‡
			if(skipMode)
			{
				// ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½Ìê‡
				bgm.stopFade();
				return 0; // ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½Ìê‡ï¿½Íƒtï¿½Fï¿½[ï¿½hï¿½ï¿½ï¿½~ï¿½ï¿½ï¿½ï¿½ï¿½Ä•Ô‚ï¿½
			}
			conductor.wait(%[
				click : function
				{
					bgm.stopFade(); // ï¿½tï¿½Fï¿½[ï¿½fï¿½Bï¿½ï¿½ï¿½Oï¿½Í’ï¿½~ï¿½ï¿½ï¿½ï¿½
				} incontextof this,

				bgmfade : function
				{
					// ï¿½ï¿½é‚±ï¿½Æ‚È‚ï¿½
				} incontextof this
				]);
		}
		else
		{
			// ï¿½Xï¿½Lï¿½bï¿½vï¿½Å‚ï¿½ï¿½È‚ï¿½ï¿½ê‡
			conductor.wait(%[
				bgmfade : function
				{
					// ï¿½ï¿½é‚±ï¿½Æ‚È‚ï¿½
				} incontextof this
				]);
		}
		return -2;
	}

	function waitBGMStop(elm)
	{
		// BGM ï¿½ÌÄï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½Ò‚ï¿½
		if(!bgm.canWaitStop) return 0; // BGM ï¿½Äï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½Ò‚Ä‚È‚ï¿½ï¿½ï¿½Î‚ï¿½ï¿½Ì‚Ü‚Ü–ß‚ï¿½
		if(elm.canskip !== void && +elm.canskip && clickSkipEnabled)
		{
			// ï¿½Xï¿½Lï¿½bï¿½vï¿½Å‚ï¿½ï¿½ï¿½ê‡
			if(skipMode)
			{
				// ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½Ìê‡
				bgm.stop();
				return 0; // ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½Ìê‡ï¿½ÍÄï¿½ï¿½ï¿½ï¿½~ï¿½ï¿½ï¿½ï¿½ï¿½Ä•Ô‚ï¿½
			}
			conductor.wait(%[
				click : function
				{
					bgm.stop(); // ï¿½Äï¿½ï¿½ï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
				} incontextof this,

				bgmstop : function
				{
					// ï¿½ï¿½é‚±ï¿½Æ‚È‚ï¿½
				} incontextof this
				]);
		}
		else
		{
			// ï¿½Xï¿½Lï¿½bï¿½vï¿½Å‚ï¿½ï¿½È‚ï¿½ï¿½ê‡
			conductor.wait(%[
				bgmstop : function
				{
					// ï¿½ï¿½é‚±ï¿½Æ‚È‚ï¿½
				} incontextof this
				]);
		}
		return -2;
	}

	//----------------------------------------------------------- ï¿½ï¿½Ê‰ï¿½ï¿½ï¿½ï¿½ï¿½ --

	function onSESoundBufferFadeCompleted(id)
	{
		// ï¿½ï¿½Ê‰ï¿½ï¿½Ìƒtï¿½Fï¿½[ï¿½hï¿½ï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		conductor.trigger('sefade' + id);
	}

    function onSESoundBufferStop(id) {
		// ï¿½ï¿½Ê‰ï¿½ï¿½ÌÄï¿½ï¿½ï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		conductor.trigger('sestop' + id);
		if (typeof this.seStopHandler != "undefined") {
			seStopHandler(id);
        }
	}

	function waitSEFade(elm)
	{
		var id = +elm.buf;
		var buf = se[id];
		if(!buf.inFading) return 0; // ï¿½tï¿½Fï¿½[ï¿½hï¿½ï¿½ï¿½Å‚È‚ï¿½ï¿½ï¿½Î‚ï¿½ï¿½Ì‚Ü‚Ü–ß‚ï¿½
		if(elm.canskip !== void && +elm.canskip && clickSkipEnabled)
		{
			// ï¿½Xï¿½Lï¿½bï¿½vï¿½Å‚ï¿½ï¿½ï¿½ê‡
			if(skipMode)
			{
				// ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½Ìê‡
				buf.stopFade();
				return 0; // ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½Ìê‡ï¿½Íƒtï¿½Fï¿½[ï¿½hï¿½ï¿½ï¿½~ï¿½ï¿½ï¿½ï¿½ï¿½Ä•Ô‚ï¿½
			}
			conductor.wait(%[
				click : function (id)
				{
					se[id].stopFade(); // ï¿½tï¿½Fï¿½[ï¿½hï¿½ï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
				} incontextof this,

				click_arg : id, // ï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Ö‚Ìˆï¿½

				'sefade'+id =>
				function (id)
				{
					// ï¿½ï¿½é‚±ï¿½Æ‚È‚ï¿½
				} incontextof this,

				'sefade'+id+'_arg' => id // ï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Ö‚Ìˆï¿½
				]);
		}
		else
		{
			// ï¿½Xï¿½Lï¿½bï¿½vï¿½Å‚ï¿½ï¿½È‚ï¿½ï¿½ê‡
			conductor.wait(%[
				'sefade'+id =>
					function (id)
					{
						// ï¿½ï¿½é‚±ï¿½Æ‚È‚ï¿½
					} incontextof this,

				'sefade'+id+'_arg' => id // ï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Ö‚Ìˆï¿½
				]);
		}
		return -2;
	}

	function waitSEStop(elm)
	{
		var id = +elm.buf;
		var buf = se[id];
		if(!buf.canWaitStop()) return 0; // ï¿½Iï¿½ï¿½ï¿½ï¿½Ò‚Ä‚È‚ï¿½ï¿½ï¿½Î‚ï¿½ï¿½Ì‚Ü‚Ü•Ô‚ï¿½
		if(elm.canskip !== void && +elm.canskip && clickSkipEnabled)
		{
			// ï¿½Xï¿½Lï¿½bï¿½vï¿½Å‚ï¿½ï¿½ï¿½ê‡
			if(skipMode)
			{
				// ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½Ìê‡
				buf.stop();
				return 0; // ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½Ìê‡ï¿½ÍÄï¿½ï¿½ï¿½ï¿½~ï¿½ï¿½ï¿½ï¿½ï¿½Ä•Ô‚ï¿½
			}
			conductor.wait(%[
				click : function (id)
				{
					se[id].stop(); // ï¿½Äï¿½ï¿½ï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
				} incontextof this,

				'click_arg' => id, // ï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Ö‚Ìˆï¿½

				'sestop'+id =>
				function (id)
				{
					// ï¿½ï¿½é‚±ï¿½Æ‚È‚ï¿½
				} incontextof this,

				'sestop'+id+'_arg' => id // ï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Ö‚Ìˆï¿½
				]);
		}
		else
		{
			// ï¿½Xï¿½Lï¿½bï¿½vï¿½Å‚ï¿½ï¿½È‚ï¿½ï¿½ê‡
			conductor.wait(%[
				'sestop'+id =>
				function (id)
				{
					// ï¿½ï¿½é‚±ï¿½Æ‚È‚ï¿½
				} incontextof this,

				'sestop'+id+'_arg' => id // ï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Ö‚Ìˆï¿½
				]);
		}
		return -2;
	}

	//--------------------------------------------------------- ï¿½ï¿½ï¿½[ï¿½rï¿½[ï¿½Ö˜A --

	// ï¿½Ûï¿½ï¿½ï¿½ï¿½Ä‚éƒ€ï¿½[ï¿½rï¿½[ï¿½ï¿½ï¿½Cï¿½ï¿½
	var movieLayers = [];

	// ï¿½ï¿½ï¿½[ï¿½rï¿½[ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ìæ“¾
	function getLayerMovie() {
		var movie = new MovieControlLayer(this);
		movieLayers.add(movie);
		flipStart();
		return movie;
	}

	/**
	 * ï¿½ï¿½ï¿½[ï¿½rï¿½[ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½ÌXï¿½V
	 */
	function updateLayerMovies() {
		if (movieLayers.count > 0) {
			for (var i=movieLayers.count-1;i>=0;i--) {
				var movie = movieLayers[i];
				if (movie.layers.count == 0) {
					conductor.trigger("lmstop" + movie);
					invalidate movie;
					movieLayers.erase(i);
				}
			}
			if (movieLayers.count == 0) {
				conductor.trigger("lmstop");
			}
		}
	}

	/**
	 * ï¿½Sï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½rï¿½[ï¿½Ì’ï¿½~
	 */
	function stopAllLayerMovies() {
		for (var i=movieLayers.count-1;i>=0;i--) {
			var movie = movieLayers[i];
			movie.stopMovie();
		}
	}

	/**
	 * ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½rï¿½[ï¿½ï¿½Ò‚ï¿½ï¿½Ä‚İ‚ï¿½
	 */
	function waitLayerMovie(target, canskip) {

		if (target === void ||
			!target instanceof "GraphicLayerEx" ||
			target.movie === void) {
			return 0;
		}

		var movie = target.movie;
		
		if (!movie.isPlayingMovie) return 0;
		if((canskip === void || +canskip) && clickSkipEnabled)
		{
			// ï¿½Xï¿½Lï¿½bï¿½vï¿½Å‚ï¿½ï¿½ï¿½ê‡
			if(skipMode)
			{
				// ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½Ìê‡
				movie.stopMovie();
				return 0; // ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½Ìê‡ï¿½ÍÄï¿½ï¿½ï¿½ï¿½~ï¿½ï¿½ï¿½ï¿½ï¿½Ä•Ô‚ï¿½
			}
			conductor.wait(%[
				click : function (movie)
				{
					movie.stopMovie(); // ï¿½Äï¿½ï¿½ï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
				} incontextof this,
				'click_arg' => movie, // ï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Ö‚Ìˆï¿½
				'lmstop'+movie =>
				function ()
				{
					// ï¿½ï¿½é‚±ï¿½Æ‚È‚ï¿½
				} incontextof this,
				]);
		}
		else
		{
			// ï¿½Xï¿½Lï¿½bï¿½vï¿½Å‚ï¿½ï¿½È‚ï¿½ï¿½ê‡
			conductor.wait(%[
				'lmstop'+movie =>
				function ()
				{
					// ï¿½ï¿½é‚±ï¿½Æ‚È‚ï¿½
				} incontextof this,
				]);
		}
		return -2;
	}

	function waitAllLayerMovies(canskip)	{
		// ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ò‚ï¿½
		if (movieLayers.count == 0) return 0; // ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ò‚Ä‚È‚ï¿½
		if((canskip === void || +canskip) && clickSkipEnabled)
		{
			// ï¿½Xï¿½Lï¿½bï¿½vï¿½Å‚ï¿½ï¿½ï¿½ê‡
			if(skipMode)
			{
				// ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½ì’†
				stopAllLayerMovies(false);
				return 0; // ï¿½ï¿½ï¿½ï¿½ï¿½Ú“ï¿½ï¿½ï¿½ï¿½~ï¿½ï¿½ï¿½ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½ï¿½É•Ô‚ï¿½
			}
			conductor.wait(%[
				click : function
				{
					updateBeforeCh = 1;
					stopAllLayerMovies(false); // ï¿½ï¿½ï¿½×‚Ä‚Ìƒï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½rï¿½[ï¿½ï¿½ï¿½~
				} incontextof this,
				lmstop : function
				{
					updateBeforeCh = 1;
				} incontextof this
				]);
		}
		else
		{
			conductor.wait(%[
				lmstop : function
				{
					updateBeforeCh = 1;
				} incontextof this
				]);
		}
		return -2;
	}
	
	function onMovieStatusChanged(state, id)
	{
		// ï¿½gï¿½ï¿½ï¿½pï¿½Xï¿½^ï¿½uï¿½iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½È‚ï¿½ï¿½j
	}
	function onMoviePlay(id)
	{
		// ï¿½ï¿½ï¿½[ï¿½rï¿½[ï¿½ÌÄï¿½ï¿½ï¿½ï¿½Jï¿½nï¿½ï¿½ï¿½ï¿½
		onMovieStatusChanged("play", id);
	}
	function onMovieStop(id)
	{
		// ï¿½ï¿½ï¿½[ï¿½rï¿½[ï¿½ÌÄï¿½ï¿½ï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		conductor.trigger('moviestop'+id);
		onMovieStatusChanged("stop", id);
	}

	function waitMovieStop(elm)
	{
		var id = +elm.slot;

		// ï¿½ï¿½ï¿½[ï¿½rï¿½[ï¿½ÌÄï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½Ò‚ï¿½
		if(!movies[id].canWaitStop) return 0; // ï¿½ï¿½ï¿½[ï¿½rï¿½[ï¿½Äï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½Ò‚Ä‚È‚ï¿½ï¿½ï¿½Î‚ï¿½ï¿½Ì‚Ü‚Ü–ß‚ï¿½
		if(elm.canskip !== void && +elm.canskip && clickSkipEnabled)
		{
			// ï¿½Xï¿½Lï¿½bï¿½vï¿½Å‚ï¿½ï¿½ï¿½ê‡
			if(skipMode)
			{
				// ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½Ìê‡
				movies[id].stop();
				return 0; // ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½Ìê‡ï¿½ÍÄï¿½ï¿½ï¿½ï¿½~ï¿½ï¿½ï¿½ï¿½ï¿½Ä•Ô‚ï¿½
			}
			conductor.wait(%[
				click : function (id)
				{
					movies[id].stop(); // ï¿½Äï¿½ï¿½ï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
				} incontextof this,

				'click_arg' => id, // ï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Ö‚Ìˆï¿½

				'moviestop'+id =>
				function (id)
				{
					// ï¿½ï¿½é‚±ï¿½Æ‚È‚ï¿½
				} incontextof this,

				'moviestop'+id+'_arg' => id // ï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Ö‚Ìˆï¿½
				]);
		}
		else
		{
			// ï¿½Xï¿½Lï¿½bï¿½vï¿½Å‚ï¿½ï¿½È‚ï¿½ï¿½ê‡
			conductor.wait(%[
				'moviestop'+id =>
				function (id)
				{
					// ï¿½ï¿½é‚±ï¿½Æ‚È‚ï¿½
				} incontextof this,

				'moviestop'+id+'_arg' => id // ï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Ö‚Ìˆï¿½
				]);
		}
		return -2;
	}

	function onMoviePeriod(id,type)
	{
		// ï¿½ï¿½ï¿½[ï¿½rï¿½[ï¿½Ìƒsï¿½ï¿½ï¿½Iï¿½hï¿½Cï¿½xï¿½ï¿½ï¿½gï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		if( isLeavePeriodEvent != false )
		{
			holdPeriodEventQueue.add( 'movieperiod'+id+'_'+type );
		}
		else
		{
			conductor.trigger('movieperiod'+id+'_'+type);
		}
	}

	function waitMoviePeriod(elm)
	{
		isWaitPeriodEvent = true;
		waitedPeriodEventStorageName = conductor.curStorage;
	
		var id = +elm.slot;

		stablePosibility = true;

		if( holdPeriodEventQueue.count > 0 )
		{
			var		triggered = false;
			for( var i = 0; i < holdPeriodEventQueue.count; i++ )
			{
				if( elm.for !== void )
				{
					if( elm.for == 'loop' )
					{
						if( ('movieperiod'+id+'_'+perLoop) == holdPeriodEventQueue[i] )
							triggered = true;
					}
					else if( elm.for == 'period' )
					{
						if( ('movieperiod'+id+'_'+perPeriod) == holdPeriodEventQueue[i] )
							triggered = true;
					}
					else if( elm.for == 'prepare' )
					{
						if( ('movieperiod'+id+'_'+perPrepare) == holdPeriodEventQueue[i] )
							triggered = true;
					}
					else if( elm.for == 'segLoop' )
					{
						if( ('movieperiod'+id+'_'+perSegLoop) == holdPeriodEventQueue[i] )
							triggered = true;
					}
					else
					{
						triggered == true;
					}
				}
				else
				{
					triggered == true;
				}
			}
			holdPeriodEventQueue.clear();
			if( triggered == true )
			{
				isWaitPeriodEvent = false;
				return 0;
			}
		}

		// ï¿½ï¿½ï¿½[ï¿½rï¿½[ï¿½Ìƒsï¿½ï¿½ï¿½Iï¿½hï¿½Cï¿½xï¿½ï¿½ï¿½gï¿½ï¿½Ò‚ï¿½
		if(!movies[id].canWaitStop) return 0; // ï¿½ï¿½ï¿½[ï¿½rï¿½[ï¿½ï¿½ï¿½Äï¿½ï¿½ï¿½ï¿½Å‚È‚ï¿½ï¿½ï¿½Î‚ï¿½ï¿½Ì‚Ü‚Ü–ß‚ï¿½
		if( elm.for !== void )
		{
			if( elm.for == 'loop' )
			{
				conductor.wait(%[
					'movieperiod'+id+'_'+perLoop => function (id) { notifyRun(); isWaitPeriodEvent = false;} incontextof this,
					'movieperiod'+id+'_arg' => id // ï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Ö‚Ìˆï¿½
					]);
			}
			else if( elm.for == 'period' )
			{
				conductor.wait(%[
					'movieperiod'+id+'_'+perPeriod => function (id) { notifyRun(); isWaitPeriodEvent = false;} incontextof this,
					'movieperiod'+id+'_arg' => id // ï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Ö‚Ìˆï¿½
					]);
			}
			else if( elm.for == 'prepare' )
			{
				conductor.wait(%[
					'movieperiod'+id+'_'+perPrepare => function (id) { notifyRun(); isWaitPeriodEvent = false;} incontextof this,
					'movieperiod'+id+'_arg' => id // ï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Ö‚Ìˆï¿½
					]);
			}
			else if( elm.for == 'segLoop' )
			{
				conductor.wait(%[
					'movieperiod'+id+'_'+perSegLoop => function (id) { notifyRun(); isWaitPeriodEvent = false;} incontextof this,
					'movieperiod'+id+'_arg' => id // ï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Ö‚Ìˆï¿½
					]);
			}
			else
			{
				return 0; // ï¿½ï¿½ï¿½ï¿½
			}
		}
		else
		{
			conductor.wait(%[
				'movieperiod'+id+'_'+perLoop => function (id) { notifyRun(); isWaitPeriodEvent = false;} incontextof this,
				'movieperiod'+id+'_'+perPeriod => function (id) { notifyRun(); isWaitPeriodEvent = false;} incontextof this,
				'movieperiod'+id+'_'+perPrepare => function (id) { notifyRun(); isWaitPeriodEvent = false;} incontextof this,
				'movieperiod'+id+'_'+perSegLoop => function (id) { notifyRun(); isWaitPeriodEvent = false;} incontextof this,
				'movieperiod'+id+'_arg' => id // ï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Ö‚Ìˆï¿½
				]);
		}
		notifyStable();
		return -2;
	}

    // ------------------------------------------------------ ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Sï¿½ï¿½ï¿½ï¿½

	/**
	 * ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ì‘Sï¿½ï¿½ï¿½ï¿½
	 */
	function clearLayers(base) {
		
		base.base.freeImage();
		base.stage.freeImage();
		base.stage.visible = false;
		base.event.freeImage();
        base.event.visible = false;
        for(var i = base.layers.count-1; i >= 0; i--) {
			base.layers[i].freeImage();
            base.layers[i].visible = false;
        }
        for(var i = base.messages.count-1; i >= 0; i--) {
            base.messages[i].clear(true);
            base.messages[i].visible = false;
        }
        // ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		hideSelect();
		hideMapSelect();
		hideTransLayer();
		hidePanel();
		setMenuAccessibleAll();
	}
	
    // ------------------------------------------------------ ï¿½ï¿½sï¿½ï¿½ï¿½ê§ï¿½äƒ‚ï¿½[ï¿½h

    var lineMode;    // ï¿½ï¿½sï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½h
    var crAfterName; // ï¿½ï¿½ï¿½Oï¿½ÌŒï¿½É‰ï¿½sï¿½ï¿½ï¿½ï¿½ï¿½ï¿½é‚©
    var erAfterPage; // ï¿½ï¿½yï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½É‰ï¿½Êï¿½ï¿½ï¿½ï¿½ï¿½ï¿½é‚©
    var noCrOnce;    // ï¿½ï¿½sï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Pï¿½ï¿½È‚ï¿½ï¿½É‚ï¿½ï¿½ï¿½
    var noErOnce;    // ï¿½ï¿½Êï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Pï¿½ï¿½È‚ï¿½ï¿½É‚ï¿½ï¿½ï¿½
    var autoIndent;  // ï¿½uï¿½wï¿½Åï¿½ï¿½ï¿½ï¿½Iï¿½ÉƒCï¿½ï¿½ï¿½fï¿½ï¿½ï¿½gï¿½ï¿½ï¿½ï¿½
    var afterPage;   // ï¿½ï¿½yï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½
    var emptyLine;     // ï¿½Ü‚ï¿½ï¿½sï¿½ï¿½ï¿½ï¿½
    var prevEmptyLine; // ï¿½Oï¿½Ì‹ï¿½sï¿½ï¿½ï¿½

    var nameMode;    // ï¿½ï¿½ï¿½Oï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½h
    var afterName;   // ï¿½ï¿½ï¿½Oï¿½ï¿½ï¿½ï¿½ï¿½Ì’ï¿½ï¿½ï¿½
    var nameStr;     // ï¿½ï¿½ï¿½İ‚Ì–ï¿½ï¿½O
    var nameDisp;    // ï¿½ï¿½ï¿½İ‚Ì•\ï¿½ï¿½ï¿½ï¿½
    
    /**
     * @param lineMode
     * 0: ï¿½Êï¿½
     * 1:ï¿½sï¿½Pï¿½Ê‚ï¿½ [p]
     * 2:ï¿½sï¿½Pï¿½Ê‚ï¿½ [l] ï¿½è“®ï¿½ï¿½ [p]
     * 3:ï¿½sï¿½Pï¿½Ê‚ï¿½ [l] ï¿½ï¿½sï¿½ï¿½ [p]
     * 4:ï¿½ï¿½sï¿½Í–ï¿½ï¿½ï¿½ï¿½Bï¿½ï¿½sï¿½ï¿½ [p]
     * 5:ï¿½ï¿½sï¿½ï¿½ [r] ï¿½Bï¿½ï¿½sï¿½ï¿½ [p]
     */
    function setLineMode(lineMode) {
        if (lineMode === void) {
            //dm("ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½h:ï¿½È‚ï¿½");
            mainConductor.ignoreCR = global.ignoreCR;
            this.lineMode = 0;
        } else if (lineMode == "page") {
            //dm("ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½h:page");
            mainConductor.ignoreCR  = false;
            afterPage = true;
            emptyLine = true;
            prevEmptyLine = true;
            this.lineMode = 1;
        } else if (lineMode == "line") {
            //dm("ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½h:line");
            mainConductor.ignoreCR  = false;
            afterPage = true;
            emptyLine = true;
            prevEmptyLine = true;
            this.lineMode = 2;
        } else if (lineMode == "vn") {
            //dm("ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½h:vn");
            mainConductor.ignoreCR  = false;
            afterPage = true;
            emptyLine = true;
            prevEmptyLine = true;
            this.lineMode = 3;
        } else if (lineMode == "tex") {
            //dm("ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½h:tex");
            mainConductor.ignoreCR  = false;
            afterPage = true;
            emptyLine = true;
            prevEmptyLine = true;
            this.lineMode = 4;
        } else if (lineMode == "free") {
            //dm("ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½h:free");
            mainConductor.ignoreCR  = false;
            afterPage = true;
            emptyLine = true;
            prevEmptyLine = true;
            this.lineMode = 5;
        }
    }

    /**
     * @param erAfterPage ï¿½yï¿½[ï¿½Wï¿½Ò‚ï¿½ï¿½ï¿½ï¿½ï¿½É‰ï¿½Êï¿½ï¿½ï¿½
     */
    function setErAfterPage(erAfterPage) {
        this.erAfterPage = erAfterPage;
    }

    /**
     * @param crAfterName ï¿½ï¿½ï¿½Oï¿½ÌŒï¿½É‰ï¿½sï¿½ï¿½ï¿½ï¿½ï¿½ï¿½é‚©ï¿½Ç‚ï¿½ï¿½ï¿½
     */
    function setCrAfterName(crAfterName) {
        this.crAfterName = crAfterName;
        afterName = false;
    }

    /**
     * @param autoIndent ï¿½ï¿½ï¿½Oï¿½ï¿½ï¿½ï¿½Ìuï¿½wï¿½Åï¿½ï¿½ï¿½ï¿½Iï¿½ÉƒCï¿½ï¿½ï¿½fï¿½ï¿½ï¿½gï¿½ï¿½ï¿½ï¿½
     */
    function setAutoIndent(autoIndent) {
        this.autoIndent = autoIndent;
    }

    /**
     * ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½hï¿½ÌŠï¿½Çï¿½ï¿½ï¿½
     */
	function storeAutoLabel() {
		if (autoLabelMode) {
			if (autoLabelCurrentRecordName != "") {
				if (sflags[autoLabelCurrentRecordName] === void ||
					sflags[autoLabelCurrentRecordName] < autoLabelCount) {
					sflags[autoLabelCurrentRecordName] = autoLabelCount;
				}
            }
        }
    }

    /**
     * ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½Oï¿½İ’ï¿½
     */
    function setAutoLabel() {
		if (autoLabelMode) {
			// ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Rï¿½ï¿½ï¿½_ï¿½Nï¿½^ï¿½É‚ï¿½è‚±ï¿½Ü‚ï¿½ï¿½ï¿½
            insertTag("autolabel");
        }
    }

	/**
	 * ï¿½ï¿½ï¿½ÇƒXï¿½Lï¿½bï¿½vï¿½ï¿½~ï¿½mï¿½F
	 */
	function checkAutoSkip() {
		if (autoLabelMode && autoLabelType == 1) {
			if(!(allskip || getCurrentRead()) && skipMode < SKIP_FAST) {
				cancelSkip(); // ï¿½ï¿½ï¿½Ç‚È‚Ì‚ÅƒXï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½~
			}
		}
	}

	/**
	 * ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½s
	 */
	function doAutoLabel() {
		if (autoLabelMode) {
			// ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½pï¿½ï¿½ï¿½ï¿½^ï¿½O
			// ï¿½Êï¿½ï¿½ KAG ï¿½ï¿½ï¿½ï¿½ï¿½Ô‚ï¿½ï¿½Æ‚Í‚È‚ï¿½ï¿½B
			// ï¿½ï¿½yï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½É‚ï¿½ï¿½ï¿½Äsï¿½ï¿½ï¿½É‹[ï¿½ï¿½ï¿½Iï¿½É‘}ï¿½ï¿½ï¿½ï¿½
			switch (autoLabelType) {
			case 0:
				// ï¿½ÔÚƒï¿½ï¿½xï¿½ï¿½ï¿½ï¿½Å•Û‘ï¿½
				conductor.callLabel("");
				conductor.loadScenario("autolabel.ks");
				conductor.goToLabel("*autoLabelLabel");
				break;
			case 1:
				// ï¿½sï¿½wï¿½èƒ‚ï¿½[ï¿½hï¿½Å•Û‘ï¿½ï¿½ï¿½ï¿½ï¿½
				pushHistoryOfStore();
				storeFlags(true);
				storeLabelPassed = true;
				checkAutoSkip();
				setMenuAccessibleAll();
				break;
			}
		}
	}

	/**
	 * ï¿½wï¿½è‚µï¿½ï¿½ï¿½^ï¿½Oï¿½ï¿½ï¿½ï¿½ï¿½sï¿½Lï¿½ï¿½ï¿½[ï¿½É’Ç‰ï¿½ï¿½ï¿½ï¿½ï¿½
	 */
	function addTag(name, elm) {
		var e = %[];
		if (elm !== void) {
			(Dictionary.assign incontextof e)(elm, false);
		}
		e.tagname = name if name !== void;
		conductor.pendings.add(e);
    }

    /**
	 * ï¿½wï¿½è‚µï¿½ï¿½ï¿½^ï¿½Oï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ÉŠï¿½ï¿½èï¿½İï¿½ï¿½sï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
     */
    function insertTag(name, elm) {
        var e = %[];
        if (elm !== void) {
            (Dictionary.assign incontextof e)(elm, false);
        }
        e.tagname = name if name !== void;
        conductor.pendings.insert(0, e);
    }

    // ï¿½pï¿½[ï¿½Xï¿½ï¿½ï¿½ï¿½ï¿½p
	var voiceMap;
	var voiceDefault;

	/**
	 * ï¿½^ï¿½Oï¿½Ì’Ç‰ï¿½ï¿½iï¿½pï¿½[ï¿½Xï¿½ï¿½ï¿½ï¿½ï¿½pï¿½j
	 */
	function addParseTag(cd, name, elm) {
        var e = %[];
        if (elm !== void) {
            (Dictionary.assign incontextof e)(elm, false);
        }
        e.tagname = name if name !== void;
		cd.pendings.add(e);
    }
	
	/**
	 * ï¿½pï¿½[ï¿½Xï¿½Rï¿½}ï¿½ï¿½ï¿½hï¿½Ìƒpï¿½[ï¿½X
	 */
	function parseParse(cd, elm) {
		voiceMap = %[];
		voiceDefault = +elm.voice;
		addParseTag(cd, "parse");
    }

	var reNumber = new RegExp("^[0-9][0-9]*$");

	/**
	 * ï¿½{ï¿½Cï¿½Xï¿½Ôï¿½ï¿½wï¿½ï¿½Ìƒpï¿½[ï¿½X
	 */
	function parseVoice(cd, elm) {
		var info = voiceMap[elm.name];
		if (info == void) {
			info = %[];
			voiceMap[elm.name] = info;
		}					
		if (elm.ignore) {
			info.strVoice = "ignore";
		} else {
			if (reNumber.test(elm.voice)) {
				// ï¿½ï¿½ï¿½lï¿½wï¿½ï¿½Ìê‡
				if (elm.once || elm.replace) {
					info.strVoice = elm.voice;
				} else {
					info.voice = +elm.voice;
				}
			} else {
				info.strVoice = elm.voice;
			}
		}
		info.incVoice = elm.incvoice || elm.replace;
	}

	function emptyCheck(cd) {
		// ï¿½sï¿½ï¿½ï¿½Å‚Ìï¿½ï¿½ï¿½
		// ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½hï¿½ï¿½ï¿½ï¿½
		var erflag;
		// ï¿½eï¿½Lï¿½Xï¿½gï¿½Nï¿½ï¿½ï¿½Aï¿½ï¿½ï¿½ï¿½
		switch (lineMode) {
		case 1:
			erflag = true;
			break;
		case 2:
		case 3:
		case 5:
			if (afterPage) {
				erflag = true;
			} else {
				if (!afterName && !skipNoDisp) {
					addParseTag(cd, "r");
				}
			}
			break;
		case 4:
			if (afterPage) {
				erflag = true;
			}
			break;
		}
		if (erflag && !erAfterPage && !skipNoDisp) {
			addParseTag(cd, "er");
		}
	}
	
	/**
	 * ï¿½eï¿½Lï¿½Xï¿½gï¿½Ìƒpï¿½[ï¿½Xï¿½ï¿½ï¿½ï¿½
	 */
    function parseCh(cd, elm, voiceMode) {

        // ï¿½ï¿½ï¿½Oï¿½\ï¿½ï¿½ï¿½ï¿½pï¿½ï¿½ï¿½ï¿½
        //ï¿½yï¿½Lï¿½ï¿½ï¿½ï¿½ï¿½Nï¿½^ï¿½ï¿½/ï¿½\ï¿½ï¿½ï¿½ï¿½ï¿½zï¿½ï¿½ï¿½ï¿½ï¿½oï¿½ï¿½ï¿½Ä–ï¿½ï¿½Oï¿½\ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½sï¿½ï¿½ï¿½ï¿½
		if (nameMode > 0) {
            // ï¿½ï¿½É–ï¿½ï¿½Oï¿½\ï¿½ï¿½ï¿½ï¿½ï¿½Wï¿½bï¿½Nï¿½É“ï¿½ï¿½ï¿½Ä‚ï¿½
            // ï¿½ï¿½ï¿½ï¿½ï¿½Å‚ï¿½ emptyLine ï¿½Ìï¿½Ô‚Í‚ï¿½ï¿½è‚¦ï¿½È‚ï¿½
			if (elm.text == "ï¿½z") {
				nameMode = 0;
				//dm("ï¿½ï¿½ï¿½Oï¿½ï¿½ï¿½ï¿½:" + nameStr + ":" + nameDisp);
				if (voiceMode) {
					var info = voiceMap[nameStr];
					if (info == void) {
						info = %[];
						voiceMap[nameStr] = info;
					}					
					var voice;
					if (info.strVoice !== void) {
						voice = info.strVoice;
						info.strVoice = void;
					} else {
						if (info.voice === void) {
							info.voice = voiceDefault;
						}
						voice = info.voice;
						info.incVoice = true;
					}
					if (info.incVoice) {
						if (info.voice >= 0) {
							info.voice++;
						}
						info.incVoice = void;
					}
					//dm("ï¿½{ï¿½Cï¿½Xï¿½Wï¿½J:" + nameStr + ":" + voice);
					if (voice !== void) {
						addParseTag(cd, "dispname", %[ name:nameStr, disp:nameDisp, voice:voice]);
					} else {
						addParseTag(cd, "dispname", %[ name:nameStr, disp:nameDisp]);
                    }
                } else {
					//dm("ï¿½ï¿½ï¿½Oï¿½Wï¿½J:" + nameStr + " / " + nameDisp);
					addParseTag(cd, "dispname", %[ name:nameStr, disp:nameDisp]);
                }
                afterName = true;
                return;
            } else {
				if (nameMode == 1) {
					if (elm.text == "/") {
						nameMode = 2;
                        return 0;
                    } else {
                        nameStr += elm.text;
                    }
                } else {
                    nameDisp += elm.text;
                }
            }
            return;
        } else if (emptyLine) {
			emptyCheck(cd);
			if (elm.text == "ï¿½y") {
				nameMode = 1;
				nameStr  = "";
				nameDisp = "";
				afterPage = false;
				return;
            } else {
				nameMode = 0;
                // ï¿½ï¿½ï¿½Oï¿½wï¿½è‚ªï¿½È‚ï¿½ï¿½ê‡ï¿½Íƒpï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½^ï¿½È‚ï¿½ï¿½Å–ï¿½ï¿½Oï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ä‚Ñoï¿½ï¿½
                if (!afterName && (lineMode < 3 || prevEmptyLine)) {
					addParseTag(cd, "dispname");
					afterName = true;
                }
            }
        }
        
        // ï¿½ï¿½ï¿½ï¿½ï¿½oï¿½^
		if (!skipNoDisp) {
			addParseTag(cd, "ch", elm);
		}
        emptyLine = false;
		afterPage = false;

        // ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½fï¿½ï¿½ï¿½gï¿½ï¿½ï¿½ï¿½
		if (!skipNoDisp && autoIndent && afterName && (elm.text == "ï¿½u" || elm.text == "ï¿½w")) {
			addParseTag(cd, "indent");
        }
        afterName = false;

        return;
    };

	/**
	 * ï¿½ï¿½sï¿½Ìƒpï¿½[ï¿½Xï¿½ï¿½ï¿½ï¿½
	 */
	function parseR(cd, elm)
	{
		if (!elm.eol) {
			if (!skipNoDisp) {
				addParseTag(cd, "r", elm);
			}
			return;
		}

		// ï¿½ï¿½sï¿½ï¿½Ê‚ï¿½ï¿½ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
        if (noCrOnce) {
            noCrOnce = false;
            return 0;
        }

		switch (lineMode) {
        case 1:
            //dm("page:ï¿½ï¿½s");
            nameMode = 0;
            if (emptyLine) {
                prevEmptyLine = emptyLine;
                return 0; // ï¿½ï¿½sï¿½Í–ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
            } else {
				// ï¿½ï¿½ï¿½Oï¿½Ì’ï¿½ï¿½ï¿½Ì‰ï¿½sï¿½Í–ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
                if (!(crAfterName && afterName)) {
					prevEmptyLine = emptyLine;
                    emptyLine = true;
					if (!skipNoDisp) {
						addParseTag(cd, "p", elm);
					} else {
						checkAutoSkip();
						addParseTag(cd, "afterpage", elm);
					}
                    return 0;
                }
            }
            break;
        case 2:
            //dm("line:ï¿½ï¿½s");
            nameMode = 0;
            if (emptyLine) {
                prevEmptyLine = emptyLine;
                return 0; // ï¿½ï¿½sï¿½Í–ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
            } else {

                // ï¿½ï¿½ï¿½Oï¿½Ì’ï¿½ï¿½ï¿½Ì‰ï¿½sï¿½Í–ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
                if (!(crAfterName && afterName)) {
                    prevEmptyLine = emptyLine;
                    emptyLine = true;
                    // ï¿½{ï¿½Cï¿½Xï¿½Ò‚ï¿½ï¿½ï¿½ï¿½ï¿½ [l] + ï¿½sï¿½Iï¿½ï¿½ï¿½ãˆï¿½ï¿½ï¿½Ä‚Ñoï¿½ï¿½
                    elm.voicewait = true;
					if (!skipNoDisp) {
						addParseTag(cd, "l", elm) ;
						addParseTag(cd, "afterline");
					}
                    return 0;
                }
            }
            break;
        case 3:
            //dm("vn:ï¿½ï¿½s");
            nameMode = 0;
            if (emptyLine) {
                if (!prevEmptyLine) {
                    // ï¿½Åï¿½ï¿½Ì‹ï¿½sï¿½Å‰ï¿½yï¿½[ï¿½W
                    prevEmptyLine = emptyLine;
					parseP(cd, elm);
					return 0;
                } else {
                    // ï¿½ï¿½ï¿½ï¿½ï¿½Å‚È‚ï¿½ï¿½ï¿½sï¿½Í–ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
                    prevEmptyLine = emptyLine;
                    return 0;
                }
            } else {
                // ï¿½ï¿½ï¿½Oï¿½Ì’ï¿½ï¿½ï¿½Ì‰ï¿½sï¿½Í–ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
                if (!(crAfterName && afterName)) {
                    prevEmptyLine = emptyLine;
                    emptyLine = true;
                    elm.voicewait = true;
					if (!skipNoDisp) {
						addParseTag(cd, "l", elm);
						addParseTag(cd, "afterline");
					}
                    return 0;
                }
            }
            break;

        case 4:
        case 5:
            //dm("tex/free:ï¿½ï¿½s");
            nameMode = 0;
            if (emptyLine) {
                if (!prevEmptyLine) {
                    // ï¿½Åï¿½ï¿½Ì‹ï¿½sï¿½Å‰ï¿½yï¿½[ï¿½W
                    prevEmptyLine = emptyLine;
					parseP(cd, elm);
                    return 0;
                } else {
                    // ï¿½ï¿½ï¿½ï¿½ï¿½Å‚È‚ï¿½ï¿½ï¿½sï¿½Í–ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
                    prevEmptyLine = emptyLine;
                    return 0;
                }
            } else {
                // ï¿½ï¿½ï¿½Oï¿½Ì’ï¿½ï¿½ï¿½Ì‰ï¿½sï¿½Í–ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
                if (!(crAfterName && afterName)) {
					prevEmptyLine = emptyLine;
					emptyLine = true;
					return 0;
                }
            }
        }
        return 0;
	}

	/**
	 * p ï¿½^ï¿½Oï¿½Ì“Wï¿½J
	 */
    function parseP(cd, elm) {
		if (!skipNoDisp) {
			addParseTag(cd, "p", elm);
		} else {
			checkAutoSkip();
			addParseTag(cd, "afterpage", elm);
		}
		afterPage = true;
		emptyLine = true;
    }

	function parseRuby(cd, elm) {
		if (emptyLine) {
			emptyCheck(cd);
			// ï¿½ï¿½ï¿½Oï¿½wï¿½è‚ªï¿½È‚ï¿½ï¿½ê‡ï¿½Íƒpï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½^ï¿½È‚ï¿½ï¿½Å–ï¿½ï¿½Oï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ä‚Ñoï¿½ï¿½
			nameMode = 0;
			if (!afterName && (lineMode < 3 || prevEmptyLine)) {
				addParseTag(cd, "dispname");
				afterName = true;
			}
		}
		emptyLine = false;
		afterPage = false;
		afterName = false;
		if (!skipNoDisp) {
			addParseTag(cd, "ruby",elm);
		}
	}
	
	var extractTags = %[
	parse:parseParse incontextof this,
	ch:parseCh incontextof this,
	r:parseR incontextof this,
	voice:parseVoice incontextof this,
	p:parseP incontextof this,
	ruby:parseRuby incontextof this
		];
	
    /*
     * ï¿½^ï¿½Oï¿½Wï¿½Jï¿½ï¿½ï¿½ï¿½
     * lineMode ï¿½É‰ï¿½ï¿½ï¿½ï¿½Ä“ï¿½ï¿½ï¿½Èƒ^ï¿½Oï¿½Wï¿½Jï¿½ï¿½ï¿½sï¿½ï¿½
     */
	function checkTagExtract(cd, elm, voiceMode) {
		// ï¿½ï¿½ï¿½ï¿½ï¿½Û‘ï¿½ï¿½pï¿½Ìƒï¿½ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½Jï¿½Eï¿½ï¿½ï¿½g
		if (autoLabelMode && elm.tagname == "r" && elm.eol) {
			autoLabelCount++;
			storeAutoLabel();
		}
		// ï¿½Wï¿½Jï¿½ï¿½ï¿½ï¿½
		if (lineMode != 0) {
			var func = extractTags[elm.tagname];
			if (func !== void) {
				func(cd, elm, voiceMode);
				return true;
			}
        }
        return false;
    }

	//------------------------------------------------------- ï¿½^ï¿½Oï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Q --
    
	function getHandlers()
	{
		return %[ // ï¿½ï¿½ï¿½ï¿½ï¿½zï¿½ï¿½Iï¿½uï¿½Wï¿½Fï¿½Nï¿½g

		/*
			ï¿½^ï¿½Oï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Qï¿½ÍAï¿½ï¿½ï¿½Oï¿½Æ‚ï¿½ï¿½ï¿½É‘Î‰ï¿½ï¿½ï¿½ï¿½ï¿½Öï¿½ï¿½Ìƒyï¿½Aï¿½ï¿½ñ‹“‚ï¿½ï¿½ï¿½ï¿½ï¿½Ì‚ÅA
			ï¿½Öï¿½ï¿½ï¿½ : function(elm)
			{
				// ï¿½Öï¿½ï¿½Ì’ï¿½ï¿½g
			} incontextof this,
			ï¿½Ìï¿½ï¿½ï¿½ï¿½ï¿½pï¿½ï¿½ï¿½ï¿½Bï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Aï¿½Öï¿½ï¿½ï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½Ìê‡ï¿½ÍAï¿½uï¿½Öï¿½ï¿½ï¿½ : ï¿½vï¿½Å‚Í‚È‚ï¿½
			ï¿½u"ï¿½Öï¿½ï¿½ï¿½" => ï¿½vï¿½ï¿½pï¿½ï¿½ï¿½ï¿½B
			incontextof this ï¿½ÍAï¿½Öï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ÌƒNï¿½ï¿½ï¿½Xï¿½ï¿½
			ï¿½Iï¿½uï¿½Wï¿½Fï¿½Nï¿½gï¿½ÌƒRï¿½ï¿½ï¿½eï¿½Lï¿½Xï¿½gï¿½ï¿½Å“ï¿½ï¿½ï¿½ï¿½æ‚¤ï¿½É‚ï¿½ï¿½é‚½ï¿½ß‚É•Kï¿½vï¿½B
		*/

	//--------------------------------------- ï¿½^ï¿½Oï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Q(ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½) --
    parse : function(elm)
    {
        // ï¿½ï¿½ï¿½ï¿½pï¿½[ï¿½Xï¿½ï¿½ï¿½ï¿½
        conductor.parseAll();
        return 0;
	} incontextof this,

    voice : function(elm)
    {
        // ï¿½ï¿½ï¿½ï¿½
        return 0;
	} incontextof this,

    ch : function(elm)
    {
		if (skipNoDisp) { return 0;	}

		if (lineMode) {
			// ï¿½\ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
            if (setCurrentMessageLayerVisible(true)) {
                return -3;
            }
        }

        // ï¿½ï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½
		var acs = actualChSpeed;
		if(updateBeforeCh)
		{
			if(acs) { updateBeforeCh--; return -5; } else { updateBeforeCh--; }
		}
		var text = elm.text;
		if(currentWithBack) current.comp.processCh(text);
		if(current.processCh(text))
		{
			return showPageBreakAndClear();
		}
		if(historyWriteEnabled) historyLayer.store(text);
		if(autoWCEnabled)
		{
			// ï¿½ï¿½ï¿½ï¿½ï¿½Eï¿½Fï¿½Cï¿½g
			var ind;
			if((ind = autoWCChars.indexOf(text)) != -1)
			{
				return int(acs * autoWCWaits[ind]);
			}
		}
		return acs;
	} incontextof this,

    dispname : function(elm)
    {
		if (skipNoDisp) { return 0;	}

		// ï¿½\ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		if (setCurrentMessageLayerVisible(true)) {
			return -3;
		}

		if (elm !== void) {
            var name = elm.disp !== void ? elm.disp : elm.name;
            if (name !== void) {
                return tagHandlers.ch(%["text" => "ï¿½y" + elm.name + "ï¿½z"]);
            }
        }
        return 0;
	} incontextof this,

	graph : function(elm)
	{
		if (skipNoDisp) { return 0;	}

		// ï¿½Oï¿½ï¿½ï¿½tï¿½Bï¿½bï¿½Nï¿½ğ•¶ï¿½ï¿½Æ‚ï¿½ï¿½Ä•\ï¿½ï¿½
		var acs = actualChSpeed;
		if(updateBeforeCh)
		{
			if(acs) { updateBeforeCh--; return -5; } else { updateBeforeCh--; }
		}
		if(currentWithBack) current.comp.processGraph(elm);
		if(current.processGraph(elm))
		{
			return showPageBreakAndClear();
		}
		if(historyWriteEnabled && elm.alt !== void) historyLayer.store(elm.alt);
		return acs;
	} incontextof this,

	hch : function(elm)
	{
		if (skipNoDisp) { return 0;	}

		// ï¿½cï¿½ï¿½ï¿½ï¿½
		var acs = actualChSpeed;
		if(updateBeforeCh)
		{
			if(acs) { updateBeforeCh--; return -5; } else { updateBeforeCh--; }
		}
		var text = elm.text;
		var expand = elm.expand !== void && +elm.expand;
		if(currentWithBack) current.comp.putHorizonCh(text, expand);
		if(current.putHorizonCh(text, expand))
		{
			return showPageBreakAndClear();
		}
		if(historyWriteEnabled) historyLayer.store(text);
		return acs;
	} incontextof this,

    linemode : function(elm) {
        setLineMode(elm.mode);
        return 0;
    } incontextof this,

    craftername : function(elm) {
        setCrAfterName(elm.mode);
        return 0;
    } incontextof this,

    erafterpage : function(elm) {
        setErAfterPage(elm.mode);
        return 0;
    } incontextof this,

    nor : function(elm) {
        noCrOnce = true;
        return 0;
    } incontextof this,

    noer : function(elm) {
        noErOnce = true;
        return 0;
    } incontextof this,
                  
    autoindent : function(elm) {
        setAutoIndent(elm.mode);
        return 0;
    } incontextof this,
                  
	r : function(elm)
    {
		if (skipNoDisp) { return 0;	}

		// ï¿½ï¿½s
        if(historyWriteEnabled) historyLayer.reline();
        if(currentWithBack) current.comp.processReturn();
        if(current.processReturn())
        {
            var ret = showPageBreakAndClear();
            // ï¿½ï¿½sï¿½ï¿½pendingï¿½ï¿½ï¿½È‚ï¿½
            if(ret == -5)
                ret = -4;
            else if(ret == -3)
                ret = -2;
            return ret;
        }
        return actualChSpeed;
    } incontextof this,

	ruby : function(elm)
	{
		// ï¿½ï¿½ï¿½Ì•ï¿½ï¿½ï¿½ï¿½É‘Î‚ï¿½ï¿½éƒ‹ï¿½rï¿½İ’ï¿½
		if(currentWithBack) current.comp.setRuby(elm.text);
		current.setRuby(elm.text);
		return 0;
	} incontextof this,

	font : function(elm)
	{
		// ï¿½tï¿½Hï¿½ï¿½ï¿½gï¿½İ’ï¿½
		if(currentWithBack) current.comp.setFont(elm);
		current.setFont(elm);
		return 0;
	} incontextof this,

	deffont : function(elm)
	{
		// ï¿½fï¿½tï¿½Hï¿½ï¿½ï¿½gï¿½Ìƒtï¿½Hï¿½ï¿½ï¿½gï¿½İ’ï¿½
		if(currentWithBack) current.comp.setDefaultFont(elm);
		current.setDefaultFont(elm);
		return 0;
	} incontextof this,

	resetfont : function(elm)
	{
		// ï¿½tï¿½Hï¿½ï¿½ï¿½gï¿½Ìƒï¿½ï¿½Zï¿½bï¿½g
		if(currentWithBack) current.comp.resetFont();
		current.resetFont();
		return 0;
	} incontextof this,

	style : function(elm)
	{
		// ï¿½Xï¿½^ï¿½Cï¿½ï¿½ï¿½İ’ï¿½
		if(currentWithBack) current.comp.setStyle(elm);
		current.setStyle(elm);
		return 0;
	} incontextof this,

	defstyle : function(elm)
	{
		// ï¿½fï¿½tï¿½Hï¿½ï¿½ï¿½gï¿½ÌƒXï¿½^ï¿½Cï¿½ï¿½ï¿½İ’ï¿½
		if(currentWithBack) current.comp.setDefaultStyle(elm);
		current.setDefaultStyle(elm);
		return 0;
	} incontextof this,

	resetstyle : function(elm)
	{
		// ï¿½Xï¿½^ï¿½Cï¿½ï¿½ï¿½Ìƒï¿½ï¿½Zï¿½bï¿½g
		if(currentWithBack) current.comp.resetStyle();
		current.resetStyle();
		return 0;
	} incontextof this,

	link : function(elm)
	{
		// ï¿½nï¿½Cï¿½pï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½Nï¿½ÌŠJï¿½n
		if(currentWithBack) current.comp.beginHyperLink(elm);
		current.beginHyperLink(elm);
		return 0;
	} incontextof this,

	endlink : function(elm)
	{
		// ï¿½nï¿½Cï¿½pï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½Nï¿½ÌIï¿½ï¿½
		if(currentWithBack) current.comp.endHyperLink(elm);
		current.endHyperLink(elm);
		return 0;
	} incontextof this,

	button : function(elm)
	{
		// ï¿½Oï¿½ï¿½ï¿½tï¿½Bï¿½Jï¿½ï¿½ï¿½{ï¿½^ï¿½ï¿½
		if(currentWithBack) current.comp.addButton(elm);
		current.addButton(elm);
		return 0;
	} incontextof this,

	edit : function(elm)
	{
		// ï¿½Pï¿½ï¿½sï¿½ÒW
		if(currentWithBack) current.comp.addEdit(elm);
		current.addEdit(elm);
		return 0;
	} incontextof this,

	checkbox : function(elm)
	{
		// ï¿½`ï¿½Fï¿½bï¿½Nï¿½{ï¿½bï¿½Nï¿½X
		if(currentWithBack) current.comp.addCheckBox(elm);
		current.addCheckBox(elm);
		return 0;
	} incontextof this,

	slider : function(elm)
	{
		// ï¿½Xï¿½ï¿½ï¿½Cï¿½_
		if(currentWithBack) current.comp.addSlider(elm);
		current.addSlider(elm);
		return 0;
	} incontextof this,
                  
	commit : function(elm)
	{
		// ï¿½tï¿½Hï¿½[ï¿½ï¿½ï¿½vï¿½fï¿½ÌƒRï¿½~ï¿½bï¿½g
		current.commit();
		return 0;
	} incontextof this,

    sysbutton : function(elm)
    {
        // ï¿½Vï¿½Xï¿½eï¿½ï¿½ï¿½{ï¿½^ï¿½ï¿½ï¿½Ì’Ç‰ï¿½
        if (currentWithBack) current.comp.addSystemButton(elm);
        current.addSystemButton(elm);
        return 0;
    } incontextof this,

    csysbutton : function(elm)
    {
        // ï¿½Vï¿½Xï¿½eï¿½ï¿½ï¿½{ï¿½^ï¿½ï¿½ï¿½Ìï¿½ï¿½ï¿½
        if (currentWithBack) current.comp.clearSystemButtons();
        current.clearSystemButtons(elm);
        return 0;
    } incontextof this,

    timeout : function(elm)
    {
        // ï¿½^ï¿½Cï¿½ï¿½ï¿½Aï¿½Eï¿½gï¿½ï¿½ï¿½ï¿½ï¿½Ì“oï¿½^(ï¿½Jï¿½ï¿½ï¿½ï¿½ï¿½gï¿½Ì‚ï¿½)
        current.addTimeout(elm);
        return 0;
    } incontextof this,

    ctimeout : function(elm)
    {
        // ï¿½^ï¿½Cï¿½ï¿½ï¿½Aï¿½Eï¿½gï¿½ï¿½ï¿½ï¿½ï¿½Ì‰ï¿½ï¿½ï¿½ï¿½iï¿½Jï¿½ï¿½ï¿½ï¿½ï¿½gï¿½Ì‚İj
        current.clearTimeout();
        return 0;
    } incontextof this,

    wheel : function(elm)
    {
        // ï¿½zï¿½Cï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ì“oï¿½^(ï¿½Jï¿½ï¿½ï¿½ï¿½ï¿½gï¿½Ì‚ï¿½)
        current.addWheel(elm);
        return 0;
    } incontextof this,

    cwheel : function(elm)
    {
        // ï¿½zï¿½Cï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ì‰ï¿½ï¿½ï¿½ï¿½iï¿½Jï¿½ï¿½ï¿½ï¿½ï¿½gï¿½Ì‚İj
        current.clearWheel();
        return 0;
    } incontextof this,
                  
    click : function(elm)
    {
        // ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½ï¿½ï¿½ï¿½ï¿½Ì“oï¿½^(ï¿½Jï¿½ï¿½ï¿½ï¿½ï¿½gï¿½Ì‚ï¿½)
        current.addClick(elm);
        return 0;
    } incontextof this,

    afterline : function(elm)
    {
        // ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½hï¿½Åsï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ÉŒÄ‚Ñoï¿½ï¿½ï¿½ï¿½éˆï¿½ï¿½
        return 0;
    } incontextof this,

	l : function(elm)
	{
		// ï¿½sï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Ò‚ï¿½
		return showLineBreak(elm);
	} incontextof this,

    afterpage : function(elm) {
        // ï¿½yï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½nï¿½ï¿½ï¿½hï¿½ï¿½
        return 0;
    } incontextof this,

	p : function(elm)
	{
        // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½hï¿½ï¿½ p ï¿½^ï¿½Oï¿½É‚ï¿½ï¿½ï¿½ï¿½Ä—Lï¿½ï¿½

		if (!(erAfterPage && noErOnce)) {
			// ï¿½ï¿½yï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ìê‡ï¿½Íï¿½ï¿½ï¿½ï¿½Zï¿½[ï¿½uï¿½ï¿½ï¿½È‚ï¿½
			// ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½È‚Ç‚Ì‘Oï¿½ï¿½ï¿½ï¿½ï¿½Ì•ï¿½ï¿½ï¿½ï¿½ÅˆÓ–ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
			setAutoLabel();
		}

        if (lineMode == 2 || lineMode == 3) {
            afterPage = true;
            if (emptyLine) {
                return 0;
            }
            emptyLine = true;
        } else if (lineMode == 4 || lineMode == 5) {
            afterPage = true;
            emptyLine = true;
        }

        // ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½fï¿½ï¿½ï¿½gï¿½ï¿½ï¿½ï¿½
        if (autoIndent) {
            tagHandlers.endindent();
        }

        // ï¿½yï¿½[ï¿½Wï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Ò‚ï¿½
		if (!skipNoDisp) {
			if(historyWriteEnabled) historyLayer.reline();
		}
		var ret = showPageBreak(elm);

		// ï¿½yï¿½[ï¿½Wï¿½Iï¿½ï¿½ï¿½ï¿½ÉŒÄ‚Î‚ï¿½ï¿½^ï¿½O
		insertTag("afterpage");
        
		// ï¿½yï¿½[ï¿½Wï¿½Ò‚ï¿½ï¿½ï¿½Éï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
        if (erAfterPage) {
			if (!noErOnce) {
				insertTag("er", %[all:true]);
            }
            noErOnce = false;
        }

        return ret;

	} incontextof this,

	p2 : function(elm)
	{
		return showPageBreak(elm);
	} incontextof this,
				  
	current : function(elm)
	{
		// ï¿½ï¿½ï¿½ï¿½ÎÛ‚Ìƒï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ìwï¿½ï¿½
		setCurrentMessageLayer(elm);
		return 0;
	} incontextof this,

	position : function(elm)
	{
		// ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ÌˆÊ’uï¿½Aï¿½ï¿½ï¿½ï¿½ï¿½ï¿½İ’ï¿½
		getMessageLayerObjectFromElm(elm).setPosition(elm);
		return 0;
	} incontextof this,

	uiload : function(elm)
	{
		// ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½UIï¿½pï¿½[ï¿½cï¿½ï¿½ï¿½êŠ‡ï¿½Å“Ç‚İï¿½ï¿½ï¿½
        if (elm.storage !== void) {
            global.uiload(getMessageLayerObjectFromElm(elm), elm);
        } else {
            error("uiload:ï¿½tï¿½@ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½wï¿½è‚³ï¿½ï¿½Ä‚ï¿½ï¿½Ü‚ï¿½ï¿½ï¿½");
        }
		return 0;
	} incontextof this,

	sysuiload : function(elm)
	{
		// ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½UIï¿½pï¿½[ï¿½cï¿½ï¿½ï¿½êŠ‡ï¿½Å“Ç‚İï¿½ï¿½ï¿½
        if (elm.storage !== void) {
            global.uiloadSystem(getMessageLayerObjectFromElm(elm), elm);
        } else {
            error("uiload:ï¿½tï¿½@ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½wï¿½è‚³ï¿½ï¿½Ä‚ï¿½ï¿½Ü‚ï¿½ï¿½ï¿½");
        }
		return 0;
	} incontextof this,

	ct : function(elm)
	{
		// ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ìƒï¿½ï¿½Zï¿½bï¿½g(ï¿½ï¿½ï¿½×‚Ä‚Ìƒï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ÌƒNï¿½ï¿½ï¿½Aï¿½ï¿½
		// current ï¿½Ìƒï¿½ï¿½Zï¿½bï¿½g)
		if(historyWriteEnabled) historyLayer.repage();
		clearMessageLayers(true);
		return 0;
	} incontextof this,

	cm : function(elm)
	{
		// ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ìƒï¿½ï¿½Zï¿½bï¿½gï¿½ï¿½ï¿½sï¿½ï¿½ï¿½ï¿½ï¿½Act ï¿½Ì‚æ‚¤ï¿½ï¿½
		// current ï¿½Ìƒï¿½ï¿½Zï¿½bï¿½gï¿½Ísï¿½ï¿½È‚ï¿½ï¿½ï¿½ï¿½ï¿½
		if(historyWriteEnabled) historyLayer.repage();
		clearMessageLayers(false);
		return 0;
	} incontextof this,

	er : function(elm)
	{
		if (!skipNoDisp) {
			// ï¿½ï¿½ï¿½İ‚Ìƒï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ÌƒNï¿½ï¿½ï¿½A
			if(historyWriteEnabled) historyLayer.repage();
			if(currentWithBack) current.comp.clear(elm.all);
			current.clear(elm.all);
		}
		return 0;
	} incontextof this,

	indent : function(elm)
	{
		if (!skipNoDisp) {
			// ï¿½Cï¿½ï¿½ï¿½fï¿½ï¿½ï¿½gï¿½Ìİ’ï¿½
			if(currentWithBack) current.comp.setIndent();
			current.setIndent();
			if(historyWriteEnabled) historyLayer.beginIndent();
		}
		return 0;
	} incontextof this,

	endindent : function(elm)
	{
		if (!skipNoDisp) {
		// ï¿½Cï¿½ï¿½ï¿½fï¿½ï¿½ï¿½gï¿½Ì‰ï¿½ï¿½ï¿½
			if(currentWithBack) current.comp.resetIndent();
			current.resetIndent();
			if(historyWriteEnabled) historyLayer.endIndent();
		}
		return 0;
	} incontextof this,

	delay : function(elm)
	{
		// ï¿½ï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½ï¿½ï¿½xï¿½Ìwï¿½ï¿½
		setDelay(elm);
		return 0;
	} incontextof this,

	nowait : function(elm)
	{
		// ï¿½êï¿½Iï¿½Éƒmï¿½[ï¿½Eï¿½Fï¿½Cï¿½gï¿½Åï¿½ï¿½s
		enterNoWait();
		return 0;
	} incontextof this,

	endnowait : function(elm)
	{
		// nowait ï¿½Ì‰ï¿½ï¿½ï¿½
		leaveNoWait();
		return 0;
	} incontextof this,

	locate : function(elm)
	{
		// ï¿½ï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½Ê’uï¿½ï¿½ï¿½wï¿½ï¿½
		if(currentWithBack) current.comp.locate(elm.x, elm.y);
		current.locate(elm.x, elm.y);
		return 0;
	} incontextof this,

	glyph : function(elm)
	{
		// ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Ò‚ï¿½ï¿½Lï¿½ï¿½ï¿½ï¿½ï¿½wï¿½ï¿½
		current.setGlyph(elm);
		return 0;
	} incontextof this,

	locklink : function(elm)
	{
		// ï¿½ï¿½ï¿½ï¿½ï¿½Nï¿½Ìƒï¿½ï¿½bï¿½N
		lockMessageLayerSelProcess();
		return 0;
	} incontextof this,

	unlocklink : function(elm)
	{
		// ï¿½ï¿½ï¿½ï¿½ï¿½Nï¿½ÌƒAï¿½ï¿½ï¿½ï¿½ï¿½bï¿½N
		unlockMessageLayerSelProcess();
		return 0;
	} incontextof this,

	//----------------------------------------- ï¿½^ï¿½Oï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Q(ï¿½Vï¿½Xï¿½eï¿½ï¿½ï¿½ï¿½ï¿½ï¿½) --

	loadplugin : function(elm)
	{
		// ï¿½vï¿½ï¿½ï¿½Oï¿½Cï¿½ï¿½ï¿½Ì“Ç‚İï¿½ï¿½ï¿½
		Plugins.link(elm.module);
        if (debugLevel >= tkdlSimple)
            dm("ï¿½vï¿½ï¿½ï¿½Oï¿½Cï¿½ï¿½ï¿½ï¿½Ç‚İï¿½ï¿½İ‚Ü‚ï¿½ï¿½ï¿½ : " + elm.module);
		return 0;
	} incontextof this,

	title : function(elm)
	{
		// ï¿½^ï¿½Cï¿½gï¿½ï¿½ï¿½Ìİ’ï¿½
		setTitle(elm.name);
		return 0;
	} incontextof this,

	s : function(elm)
	{
        // ï¿½ï¿½ï¿½sï¿½ï¿½~
		stablePosibility = true;
		cancelSkip();
		if(!usingExtraConductor) incRecordLabel(true);
		inSleep = true;
		if(recordHistoryOfStore == 2) // 2 : ï¿½Iï¿½ï¿½ï¿½ï¿½ ( @s ï¿½^ï¿½O ) ï¿½ï¿½ï¿½ï¿½
			setToRecordHistory();
		notifyStable();

        // ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½^ï¿½Cï¿½ï¿½ï¿½Aï¿½Eï¿½gï¿½Ä‚Ñoï¿½ï¿½ï¿½Jï¿½n
        current.startTimeout();

        return -1;
	} incontextof this,

	clickskip : function(elm)
	{
        // ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Xï¿½Lï¿½bï¿½vï¿½Ìİ’ï¿½
		clickSkipEnabled = +elm.enabled;
		return 0;
	} incontextof this,

	nextskip : function(elm)
	{
		// ï¿½ï¿½ï¿½Ì‘Iï¿½ï¿½ï¿½ï¿½(/ï¿½ï¿½ï¿½ï¿½)ï¿½Ü‚Åiï¿½Ş‚Ìİ’ï¿½
		nextSkipEnabled = +elm.enabled;
		return 0;
	} incontextof this,

	cancelskip : function(elm)
	{
		// ï¿½Xï¿½Lï¿½bï¿½vï¿½Ì‰ï¿½ï¿½ï¿½
		cancelSkip();
        setMenuAccessibleAll();
		return 0;
	} incontextof this,

	cancelautomode : function(elm)
	{
		// ï¿½uï¿½ï¿½ï¿½ï¿½ï¿½Iï¿½É“Ç‚İiï¿½Şvï¿½Ì‰ï¿½ï¿½ï¿½
		cancelAutoMode();
        setMenuAccessibleAll();
		return 0;
	} incontextof this,

	resetwait : function(elm)
	{
		// ï¿½ï¿½ï¿½ÔŒï¿½ï¿½_ï¿½Ìİ’ï¿½
		resetWait();
		return 0;
	} incontextof this,

	wait : function(elm)
	{
		// ï¿½Eï¿½Fï¿½Cï¿½g
		return doWait(elm);
	} incontextof this,

	wc : function(elm)
	{
		// ï¿½wï¿½è•¶ï¿½ï¿½ï¿½ï¿½ï¿½ÌƒEï¿½Fï¿½Cï¿½g
		return doWaitCh(elm);
	} incontextof this,

	waitclick : function(elm)
	{
		// ï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½ï¿½Ò‚ï¿½
		return waitClick(elm);
	} incontextof this,

	rclick : function(elm)
	{
		// ï¿½Eï¿½Nï¿½ï¿½ï¿½bï¿½Nï¿½Ì“ï¿½ï¿½ï¿½İ’ï¿½
		setRightClickOptions(elm);
		return 0;
	} incontextof this,

	history : function(elm)
	{
		// ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ìİ’ï¿½
		setHistoryOptions(elm);
		return 0;
	} incontextof this,

	clearhistory : function(elm)
	{
        // ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ìï¿½ï¿½ï¿½
        historyLayer.clear();
        historyOfStore.clear();
		nextRecordHistory = false;
        return 0;
	} incontextof this,
                  
	showhistory : function(elm)
	{
		// ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ì•\ï¿½ï¿½
		return showHistoryByScenario(elm);
	} incontextof this,

	hr : function(elm)
	{
		// ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½É‰ï¿½sï¿½ï¿½ï¿½oï¿½ï¿½
		if(historyWriteEnabled)
		{
			if(elm.repage !== void && +elm.repage)
				historyLayer.repage();
			else
				historyLayer.reline();
		}
		return 0;
	} incontextof this,

	hact : function(elm)
	{
		// ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½ÉƒAï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½İ’ï¿½
		if(historyWriteEnabled)
			historyLayer.setNewAction(elm.exp);
		return 0;
	} incontextof this,

	endhact : function(elm)
	{
		// ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½ÌƒAï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Nï¿½ï¿½ï¿½A
		if(historyWriteEnabled)
			historyLayer.clearAction();
		return 0;
	} incontextof this,

	hidemessage : function(elm)
	{
		// ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½êï¿½Iï¿½É‰Bï¿½ï¿½
		return hideMessageLayerByScenario(elm);
	} incontextof this,

	quake : function(elm)
	{
		// ï¿½hï¿½ï¿½
		doQuake(elm);
		return 0;
	} incontextof this,

	stopquake : function(elm)
	{
		// ï¿½hï¿½ï¿½Ì’ï¿½~
		stopQuake();
		return 0;
	} incontextof this,

	wq : function(elm)
	{
		// ï¿½hï¿½ï¿½Ì’ï¿½~ï¿½ï¿½Ò‚ï¿½
		return waitQuake(elm);
	} incontextof this,

	autowc : function(elm)
	{
		// ï¿½ï¿½ï¿½ï¿½ï¿½Eï¿½Fï¿½Cï¿½g
		setAutoWait(elm);
		return 0;
	} incontextof this,

	cursor : function(elm)
	{
		// ï¿½}ï¿½Eï¿½Xï¿½Jï¿½[ï¿½\ï¿½ï¿½ï¿½Ì•ÏX
		setCursor(elm);
		return 0;
	} incontextof this,

	close : function(elm)
	{
		// ï¿½Eï¿½Bï¿½ï¿½ï¿½hï¿½Eï¿½ï¿½Â‚ï¿½ï¿½ï¿½
		closeByScript(elm);
		return -2;
	} incontextof this,

	copybookmark : function(elm)
	{
		// ï¿½xï¿½ï¿½ï¿½Rï¿½sï¿½[
		copyBookMark(+elm.from, +elm.to);
		return 0;
	} incontextof this,

	erasebookmark : function(elm)
	{
		// ï¿½xï¿½ï¿½ï¿½íœ
		eraseBookMark(+elm.place);
		return 0;
	} incontextof this,

	disablestore : function(elm)
	{
		// ï¿½xï¿½ï¿½ï¿½êï¿½Iï¿½Égï¿½pï¿½sï¿½Â‚ï¿½
		tempDisableStore(elm);
		return 0;
	} incontextof this,

	store : function(elm)
	{
		// ï¿½xï¿½Ìgï¿½pï¿½sï¿½ÂEï¿½gï¿½pï¿½Â‚ï¿½İ’è‚·ï¿½ï¿½
		setStoreEnabled(+elm.enabled);
		return 0;
	} incontextof this,

	load : function(elm)
	{
		// ï¿½xï¿½Ì“Ç‚İï¿½ï¿½ï¿½
		if(elm.ask !== void && +elm.ask)
			loadBookMarkWithAsk(+elm.place);
		else
			loadBookMark(+elm.place);
		return -4;
	} incontextof this,

	save : function(elm)
	{
		// ï¿½xï¿½Ì“Ç‚İï¿½ï¿½ï¿½
		if(elm.ask !== void && +elm.ask)
			saveBookMarkWithAsk(+elm.place);
		else
			saveBookMark(+elm.place);
		return -4;
	} incontextof this,

	startanchor : function(elm)
	{
		// ï¿½uï¿½Åï¿½ï¿½É–ß‚ï¿½vï¿½Ìgï¿½pï¿½sï¿½ÂEï¿½gï¿½pï¿½Â‚ï¿½İ’è‚·ï¿½ï¿½
		setStartAnchorEnabled(elm.enabled === void || +elm.enabled);
		return 0;
	} incontextof this,

	gotostart : function(elm)
	{
		// ï¿½uï¿½Åï¿½ï¿½É–ß‚ï¿½v
		if(elm.ask !== void && +elm.ask)
			goToStartWithAsk();
		else
			goToStart();
		return -4;
	} incontextof this,

	goback : function(elm)
	{
		// ï¿½Ê‰ß‹Lï¿½^ï¿½ï¿½ß‚ï¿½
		if(elm.ask !== void && +elm.ask)
			goBackHistory(true);
		else
			goBackHistory(false);
		return -4;
	} incontextof this,

	record : function(elm)
	{
		// ï¿½Ê‰ß‹Lï¿½^ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		setToRecordHistory();
		return 0;
	} incontextof this,

	tempsave : function(elm)
	{
		// ï¿½ï¿½Ô‚Ìƒï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ö‚Ì•Û‘ï¿½
		tempSave(+elm.place);
		return 0;
	} incontextof this,

	tempload : function(elm)
	{
		// ï¿½ï¿½Ô‚Ìƒï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ö‚Ì•Û‘ï¿½
		tempLoad(+elm.place, elm);
			//elm.se === void || +elm.se, elm.bgm === void || +elm.bgm,
			//elm.backlay !== void && +elm.backlay);
		return 0;
	} incontextof this,

	mappfont : function(elm)
	{
		// ï¿½ï¿½ï¿½ï¿½ï¿½_ï¿½ï¿½ï¿½ï¿½ï¿½Oï¿½Ï‚İƒtï¿½Hï¿½ï¿½ï¿½gï¿½ï¿½ï¿½ï¿½ï¿½İ‚Ìƒtï¿½Hï¿½ï¿½ï¿½gï¿½Éƒ}ï¿½bï¿½sï¿½ï¿½ï¿½O
		mapPrerenderedFont(elm.storage);
		return 0;
	} incontextof this,

	locksnapshot : function(elm)
	{
		// ï¿½ï¿½Ê‚ÌƒXï¿½iï¿½bï¿½vï¿½Vï¿½ï¿½ï¿½bï¿½gï¿½ï¿½ï¿½ï¿½ï¿½bï¿½Nï¿½ï¿½ï¿½ï¿½
		lockSnapshot();
		return 0;
	} incontextof this,

	unlocksnapshot : function(elm)
	{
		// ï¿½ï¿½Ê‚ÌƒXï¿½iï¿½bï¿½vï¿½Vï¿½ï¿½ï¿½bï¿½gï¿½Ìƒï¿½ï¿½bï¿½Nï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		unlockSnapshot();
		return 0;
	} incontextof this,

	//------------------------------------------- ï¿½^ï¿½Oï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Q(ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½) --

	image : function(elm)
	{
		// ï¿½æ‘œï¿½Ç‚İï¿½ï¿½ï¿½
		updateBeforeCh = 1;
		var start = System.getTickCount();
		getLayerFromElm(elm).loadImages(elm);
        if (debugLevel >= tkdlVerbose)
            dm(elm.storage + " ï¿½Ì“Ç‚İï¿½ï¿½İ‚ï¿½ " + (System.getTickCount() - start) + "ms ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ü‚ï¿½ï¿½ï¿½");
		return 0;
	} incontextof this,

	img : function(elm)
	{
		// ï¿½æ‘œï¿½Ç‚İï¿½ï¿½ï¿½(imageï¿½Æ‚ï¿½ï¿½È‚ï¿½)
		updateBeforeCh = 1;
		var start = System.getTickCount();
		getLayerFromElm(elm).loadImages(elm);
        if (debugLevel >= tkdlVerbose)
            dm(elm.storage + " ï¿½Ì“Ç‚İï¿½ï¿½İ‚ï¿½ " + (System.getTickCount() - start) + "ms ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ü‚ï¿½ï¿½ï¿½");
		return 0;
	} incontextof this,

	pimage : function(elm)
	{
		// ï¿½ï¿½ï¿½ï¿½ï¿½Ç‰ï¿½ï¿½æ‘œï¿½Ç‚İï¿½ï¿½ï¿½
		getLayerFromElm(elm).loadPartialImage(elm);
		return 0;
	} incontextof this,

	ptext : function(elm)
	{
		// ï¿½wï¿½i/ï¿½Oï¿½iï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ö‚Ì•ï¿½ï¿½ï¿½ï¿½`ï¿½ï¿½
		getLayerFromElm(elm).drawReconstructibleText(elm);
		return 0;
	} incontextof this,

    clearlayers : function(elm) {
        updateBeforeCh = 1;

		var base;
		if (elm !== void && elm.page == "back") {
            base   = back;
        } else {
            base   = fore;
        }
		
		clearLayers(base);
		
		// ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Sï¿½ï¿½ï¿½ï¿½
		if (typeof this.clearLayersHandler != "undefined") {
			clearLayersHandler(base);
		}
		return 0;
    } incontextof this,

    syncmsg : function(elm) {
        //dm("ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½Vï¿½ï¿½ï¿½Nï¿½ï¿½");
        // ï¿½ï¿½ï¿½bï¿½Zï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½ç— ï¿½ÉƒRï¿½sï¿½[
        var messages = fore.messages;
        for(var i = messages.count-1; i >= 0; i--) messages[i].assignComp();
        return 0;
    } incontextof this,
                  
	freeimage : function(elm)
	{
		// ï¿½æ‘œï¿½ÌƒNï¿½ï¿½ï¿½A
		updateBeforeCh = 1;
		getLayerFromElm(elm).freeImage(elm);
		return 0;
	} incontextof this,

	animstart : function(elm)
	{
		// ï¿½Aï¿½jï¿½ï¿½ï¿½[ï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ÌŠJï¿½n
		updateBeforeCh = 1;
		getLayerFromElm(elm).startAnim(elm);
		return 0;
	} incontextof this,

	animstop : function(elm)
	{
		// ï¿½Aï¿½jï¿½ï¿½ï¿½[ï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Ì’ï¿½~
		updateBeforeCh = 1;
		getLayerFromElm(elm).stopAnim(+elm.seg);
		return 0;
	} incontextof this,

	wa : function(elm)
	{
		// ï¿½Aï¿½jï¿½ï¿½ï¿½[ï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Ì’ï¿½~ï¿½Ò‚ï¿½
		return waitAnimation(elm);
	} incontextof this,

	mapimage : function(elm)
	{
		// ï¿½Nï¿½ï¿½ï¿½bï¿½Jï¿½uï¿½ï¿½ï¿½}ï¿½bï¿½vï¿½Ì—Ìˆï¿½æ‘œï¿½ï¿½Ç‚İï¿½ï¿½ï¿½
		getLayerFromElm(elm).loadProvinceImage(elm.storage);
		return 0;
	} incontextof this,

	mapaction : function(elm)
	{
		// ï¿½Nï¿½ï¿½ï¿½bï¿½Jï¿½uï¿½ï¿½ï¿½}ï¿½bï¿½vï¿½Ì—Ìˆï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½`ï¿½ï¿½Ç‚İï¿½ï¿½ï¿½
		getLayerFromElm(elm).loadProvinceActions(elm.storage);
		return 0;
	} incontextof this,

	mapdisable : function(elm)
	{
		// ï¿½Nï¿½ï¿½ï¿½bï¿½Jï¿½uï¿½ï¿½ï¿½}ï¿½bï¿½vï¿½ğ–³Œï¿½É‚ï¿½ï¿½ï¿½
		getLayerFromElm(elm).clearProvinceActions();
		return 0;
	} incontextof this,

	backlay : function(elm)
	{
		// ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ğ— ‰ï¿½Ê‚ÉƒRï¿½sï¿½[
		updateBeforeCh = 1;
		backupLayer(elm, true);
		return 0;
	} incontextof this,

	forelay : function(elm)
	{
		// ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½Ê‚ÉƒRï¿½sï¿½[
		updateBeforeCh = 1;
		backupLayer(elm, false);
		return 0;
	} incontextof this,

	copylay : function(elm)
	{
		// ï¿½ï¿½ï¿½ï¿½Ìƒï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½mï¿½ÌƒRï¿½sï¿½[
		updateBeforeCh = 1;
		copyLayer(elm);
		return 0;
	} incontextof this,

	layopt : function(elm)
	{
		// ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ÌƒIï¿½vï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½İ’ï¿½
		updateBeforeCh = 1;
        getLayerFromElm(elm).setOptions(elm);
		return 0;
	} incontextof this,

    laylevel : function(elm)
    {
        updateBeforeCh = 1;
        var base = (elm.page == 'back') ? back : fore;
		toLevel(elm.layer, elm.level, base);
		if (elm.front) {
			toFront(elm.layer, base);
		}
        return 0;
	} incontextof this,

    layfront : function(elm)
    {
        updateBeforeCh = 1;
        var base = (elm.page == 'back') ? back : fore;
        toFront(elm.layer, base);
        return 0;
	} incontextof this,

    layback : function(elm)
    {
        updateBeforeCh = 1;
        var base = (elm.page == 'back') ? back : fore;
        toBack(elm.layer, base);
        return 0;
	} incontextof this,
                  
	trans : function(elm)
	{
		// ï¿½gï¿½ï¿½ï¿½ï¿½ï¿½Wï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ÌŠJï¿½n
		var layer = getLayerPageFromElm(elm, false);
		if (layer == fore.base)  {
			if (selectShowing) {
				selectLayer.setParent(back.base, 1000000);
			}
			if (mapSelectShowing) {
				mapSelectLayer.setParent(back.base, 1000000);
			}
		}
		layer.beginTransition(elm);
		return 0;
	} incontextof this,

	wt : function(elm)
	{
        // ï¿½gï¿½ï¿½ï¿½ï¿½ï¿½Wï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ò‚ï¿½
		return waitTransition(elm);
	} incontextof this,

	stoptrans : function(elm)
	{
		// ï¿½gï¿½ï¿½ï¿½ï¿½ï¿½Wï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½~ï¿½ï¿½ï¿½ï¿½
		stopAllTransitions();
		return 0;
	} incontextof this,

	move : function(elm)
	{
		// ï¿½ï¿½ï¿½ï¿½ï¿½Ú“ï¿½ï¿½ÌŠJï¿½n
		getLayerFromElm(elm).beginMove(elm);
		return 0;
	} incontextof this,

	wm : function(elm)
	{
		//  ï¿½ï¿½ï¿½ï¿½ï¿½Ú“ï¿½ï¿½ï¿½Ò‚ï¿½
		return waitMove(elm);
	} incontextof this,

	stopmove : function(elm)
	{
		// ï¿½ï¿½ï¿½ï¿½ï¿½Ú“ï¿½ï¿½ï¿½ï¿½~ï¿½ï¿½ï¿½ï¿½
		stopAllMoves();
		return 0;
	} incontextof this,

	laycount : function(elm)
	{
		updateBeforeCh = 1;
		allocateCharacterLayers(+elm.layers) if elm.layers !== void;
		allocateMessageLayers(+elm.messages) if elm.messages !== void;
		return 0;
	} incontextof this,

    // ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Jï¿½n
    action : function(elm)
    {
		var target;
		if (elm.layer !== void) {
			target = getLayerFromElm(elm);
		} else if (typeof elm.target == "Object") {
			target = elm.target;
		} else if (typeof elm.target == "String") {
			target = Scripts.eval(elm.target);
		}
		if (typeof target == "Object") {
			var action;
			if (elm.action !== void) {
				// ï¿½ï¿½ï¿½ÚƒAï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½ï¿½ï¿½wï¿½è‚³ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½ê‡
				action = elm.action;
			} else {
				action = %[];
				// ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½ï¿½ï¿½pï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½^ï¿½ï¿½ï¿½ç¶ï¿½ï¿½
				(Dictionary.assign incontextof action)(elm);
				delete action.tagname;
				delete action.layer;
				delete action.page;
				delete action.target;
			}
			if (target instanceof "GraphicLayerEx") {
				target.beginAction(action, elm.hide, elm.nowait);
			} else {
				beginAction(target, action, onActionCompleted, elm.nowait);
			}
		} else {
			error("ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ÍƒIï¿½uï¿½Wï¿½Fï¿½Nï¿½gï¿½Éwï¿½è‚·ï¿½ï¿½Kï¿½vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ü‚ï¿½");
		}
		return 0;
    } incontextof this,

    // ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½~
	stopaction : function(elm)
	{
		updateBeforeCh = 1;
        var target;
		if (elm.layer !== void) {
			target = getLayerFromElm(elm);
		} else if (typeof elm.target == "Object") {
			target = elm.target;
		} else if (typeof elm.target == "String") {
			target = Scripts.eval(elm.target);
		}
		if (target !== void) {
			if (typeof target == "Object") {
				stopAction(target);
			} else {
				dm("ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ÍƒIï¿½uï¿½Wï¿½Fï¿½Nï¿½gï¿½Éwï¿½è‚·ï¿½ï¿½Kï¿½vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ü‚ï¿½");
			}
		} else {
			stopAllActions(true);
		}
        return 0;
	} incontextof this,

	wact : function(elm)
	{
        var target;
		if (elm.layer !== void) {
			target = getLayerFromElm(elm);
		} else if (typeof elm.target == "Object") {
			target = elm.target;
		} else if (typeof elm.target == "String") {
			target = Scripts.eval(elm.target);
		}
		if (target !== void) {
			if (typeof target == "Object") {
				return waitAction(target, elm.canskip);
			} else {
				dm("ï¿½Aï¿½Nï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½Ò‚ï¿½ï¿½ÍƒIï¿½uï¿½Wï¿½Fï¿½Nï¿½gï¿½Éwï¿½è‚·ï¿½ï¿½Kï¿½vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ü‚ï¿½");
			}
		} else {
			return waitAllAction(elm.canskip);
		}
		return 0;
	} incontextof this,
                  
	//------------------------------ ï¿½^ï¿½Oï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Q(ï¿½ï¿½Ê‰ï¿½ï¿½EBGMï¿½Eï¿½rï¿½fï¿½Iï¿½ï¿½ï¿½ï¿½) --

	playbgm : function(elm)
	{
        // BGM ï¿½Ì‰ï¿½ï¿½t
		bgm.play(elm);
        clearBgmStop();
        clearBgmLabel();
        return 0;
	} incontextof this,

	stopbgm : function(elm)
	{
		// BGM ï¿½Ì’ï¿½~
		bgm.stop();
		return 0;
	} incontextof this,

	pausebgm : function(elm)
	{
		// BGM ï¿½Ìˆêï¿½ï¿½~
		bgm.pause();
		return 0;
	} incontextof this,

	resumebgm : function(elm)
	{
		// BGM ï¿½ÌÄŠJ
		bgm.resume();
		return 0;
	} incontextof this,

	fadeinbgm : function(elm)
	{
		// BGM ï¿½Ìƒtï¿½Fï¿½[ï¿½hï¿½Cï¿½ï¿½
		bgm.fadeIn(elm);
		return 0;
	} incontextof this,

	fadeoutbgm : function(elm)
	{
		// BGM ï¿½Ìƒtï¿½Fï¿½[ï¿½hï¿½Aï¿½Eï¿½g
		bgm.fadeOut(elm);
		return 0;
	} incontextof this,

	fadepausebgm : function(elm)
	{
		// BGM ï¿½Ìƒtï¿½Fï¿½[ï¿½hï¿½|ï¿½[ï¿½Y
		bgm.fadePause(elm);
		return 0;
	} incontextof this,
                  
	fadebgm : function(elm)
	{
		// BGM ï¿½Ìwï¿½è‰¹ï¿½Ê‚Ü‚Å‚Ìƒtï¿½Fï¿½[ï¿½h
		bgm.fade(elm);
		return 0;
	} incontextof this,

	xchgbgm : function(elm)
	{
		// BGM ï¿½Ì“ï¿½ï¿½Ö‚ï¿½/ï¿½Nï¿½ï¿½ï¿½Xï¿½tï¿½Fï¿½[ï¿½h
		bgm.exchange(elm);
        clearBgmStop();
        clearBgmLabel();
		return 0;
	} incontextof this,

	bgmopt : function(elm)
	{
		// BGM ï¿½ÌƒIï¿½vï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½İ’ï¿½
		bgm.setOptions(elm);
		return 0;
	} incontextof this,

    setbgmstop : function(elm)
	{
		// BGM ï¿½ÌIï¿½ï¿½ï¿½ï¿½ï¿½Rï¿½[ï¿½ï¿½ï¿½oï¿½bï¿½Nï¿½Ì“oï¿½^
        setBgmStop(elm);
        return 0;
	} incontextof this,

    clearbgmstop : function(elm)
	{
		// BGM ï¿½ÌIï¿½ï¿½ï¿½ï¿½ï¿½Rï¿½[ï¿½ï¿½ï¿½oï¿½bï¿½Nï¿½Ìíœ
        clearBgmStop();
        return 0;
	} incontextof this,

    setbgmlabel : function(elm) {
        // BGM ï¿½Ìƒï¿½ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½Rï¿½[ï¿½ï¿½ï¿½oï¿½bï¿½Nï¿½Ì“oï¿½^
        setBgmLabel(elm);
        return 0;
    } incontextof this,

    clearbgmlabel : function(elm)
	{
        // BGM ï¿½Ìƒï¿½ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½Rï¿½[ï¿½ï¿½ï¿½oï¿½bï¿½Nï¿½Ìíœ
        clearBgmLabel();
        return 0;
	} incontextof this,
                  
	wb : function(elm)
	{
		// BGM ï¿½Ìƒtï¿½Fï¿½[ï¿½hï¿½Iï¿½ï¿½ï¿½Ò‚ï¿½
		return waitBGMFade(elm);
	} incontextof this,

	wl : function(elm)
	{
		// BGM ï¿½ÌÄï¿½ï¿½Iï¿½ï¿½ï¿½Ò‚ï¿½
		return waitBGMStop(elm);
	} incontextof this,

	playse : function(elm)
	{
        // ï¿½ï¿½Ê‰ï¿½ï¿½ÌÄï¿½
		se[+elm.buf].play(elm);
		return 0;
	} incontextof this,

	stopse : function(elm)
	{
		// ï¿½ï¿½Ê‰ï¿½ï¿½Ì’ï¿½~
		se[+elm.buf].stop();
		return 0;
	} incontextof this,

	fadeinse : function(elm)
	{
		// ï¿½ï¿½Ê‰ï¿½ï¿½Ìƒtï¿½Fï¿½[ï¿½hï¿½Cï¿½ï¿½ï¿½Äï¿½
		se[+elm.buf].fadeIn(elm);
		return 0;
	} incontextof this,

	fadeoutse : function(elm)
	{
		// ï¿½ï¿½Ê‰ï¿½ï¿½Ìƒtï¿½Fï¿½[ï¿½hï¿½Aï¿½Eï¿½g
		se[+elm.buf].fadeOut(elm);
		return 0;
	} incontextof this,

	fadese : function(elm)
	{
		// ï¿½ï¿½Ê‰ï¿½ï¿½Ìƒtï¿½Fï¿½[ï¿½h
		se[+elm.buf].fade(elm);
		return 0;
	} incontextof this,

	seopt : function(elm)
	{
		// ï¿½ï¿½Ê‰ï¿½ï¿½Ìƒtï¿½Fï¿½[ï¿½h
		se[+elm.buf].setOptions(elm);
		return 0;
	} incontextof this,

	wf : function(elm)
	{
		// ï¿½ï¿½Ê‰ï¿½ï¿½Ìƒtï¿½Fï¿½[ï¿½hï¿½Iï¿½ï¿½ï¿½Ò‚ï¿½
		return waitSEFade(elm);
	} incontextof this,

	ws : function(elm)
	{
		// ï¿½ï¿½Ê‰ï¿½ï¿½ÌÄï¿½ï¿½Iï¿½ï¿½ï¿½Ò‚ï¿½
		return waitSEStop(elm);
	} incontextof this,

	video : function(elm)
	{
		// ï¿½ï¿½ï¿½[ï¿½rï¿½[ï¿½ÌƒIï¿½vï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ï¿½İ’è‚·ï¿½ï¿½
		movies[+elm.slot].setOptions(elm);
		return 0;
	} incontextof this,

	playvideo : function(elm)
	{
		// ï¿½ï¿½ï¿½[ï¿½rï¿½[ï¿½ï¿½ï¿½Äï¿½ï¿½ï¿½ï¿½ï¿½
		movies[+elm.slot].play(elm.storage);
		return 0;
	} incontextof this,

	stopvideo : function(elm)
	{
		// ï¿½ï¿½ï¿½[ï¿½rï¿½[ï¿½ï¿½ï¿½~ï¿½ï¿½ï¿½ï¿½
		movies[+elm.slot].stop();
		return 0;
	} incontextof this,

	openvideo : function(elm)
	{
		// ï¿½ï¿½ï¿½[ï¿½rï¿½[ï¿½Äï¿½ï¿½Ìï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		movies[+elm.slot].open(elm.storage);
		return 0;
	} incontextof this,

	wv : function(elm)
	{
		if (elm.layer) {
			// ï¿½Sï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½rï¿½[ï¿½ÌÄï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½Ò‚ï¿½
			return waitAllLayerMovies(elm.canskip);
		} else {
			// ï¿½ï¿½ï¿½[ï¿½rï¿½[ï¿½ÌÄï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½Ò‚ï¿½
			return waitMovieStop(elm);
		}
	} incontextof this,

// Start: Add: T.Imoto
	wp : function(elm)
	{
		// ï¿½ï¿½ï¿½[ï¿½rï¿½[ï¿½Ìƒsï¿½ï¿½ï¿½Iï¿½hï¿½Cï¿½xï¿½ï¿½ï¿½gï¿½ï¿½Ò‚ï¿½
		return waitMoviePeriod(elm);
	} incontextof this,

	pausevideo : function(elm)
	{
		movies[+elm.slot].pause();
		return 0;
	} incontextof this,

	resumevideo : function(elm)
	{
		movies[+elm.slot].resume();
		return 0;
	} incontextof this,

	preparevideo : function(elm)
	{
		movies[+elm.slot].prepare();
		return 0;
	} incontextof this,

	rewindvideo : function(elm)
	{
		movies[+elm.slot].rewind();
		return 0;
	} incontextof this,

	videolayer : function(elm)
	{
		movies[+elm.slot].storeLayer( elm.layer, elm.page, elm.channel );
		movies[+elm.slot].setVideoLayer(getLayerFromElm(elm),elm);
		return 0;
	} incontextof this,

	clearvideolayer : function(elm)
	{
		movies[+elm.slot].cancelLayer( elm.channel );
		movies[+elm.slot].setVideoLayer(null,elm);
		return 0;
	} incontextof this,

	videosegloop : function(elm)
	{
		movies[+elm.slot].setSegment(elm);
		return 0;
	} incontextof this,

	cancelvideosegloop : function(elm)
	{
		movies[+elm.slot].cancelSegmentLoop();
		return 0;
	} incontextof this,

	videoevent : function(elm)
	{
		movies[+elm.slot].setPeriod(elm);
		return 0;
	} incontextof this,

	cancelvideoevent : function(elm)
	{
		movies[+elm.slot].cancelPeriodEvent();
		return 0;
	} incontextof this,
// End: Add: T.Imoto

	//--------------------------------------- ï¿½^ï¿½Oï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Q(ï¿½Ïï¿½ï¿½ETJS ï¿½ï¿½ï¿½ï¿½) --

	eval : function(elm)
	{
		// ï¿½ï¿½ï¿½Ì•]ï¿½ï¿½
		Scripts.eval(elm.exp);
		return 0;
	} incontextof this,

	trace : function(elm)
	{
		// ï¿½ï¿½ï¿½Ìƒgï¿½ï¿½ï¿½[ï¿½Xï¿½\ï¿½ï¿½
		var exp = elm.exp;
		var result = Scripts.eval(exp);
        
        if (result instanceof "Dictionary") {
            dm("ï¿½ï¿½[trace] expression=\"" + exp + "\"");
            var names = [];
            names.assign(result);
            for (var i=0; i<names.count; i+= 2) {
                var name = names[i];
                var value = names[i+1];
                dm("ï¿½ï¿½[trace] name=\"" + name + "\" type of value=" + typeof value + 
                   " value=" + value);
            }
        } else if (result instanceof "Array") {
            dm("ï¿½ï¿½[trace] expression=\"" + exp +  "\"");
            for (var i=0; i<result.count; i++) {
                var value = result[i];
                dm("ï¿½ï¿½[trace] idx=\"" + i + "\" type of value=" + typeof value + 
                   " value=" + value);
            }
        } else {
            dm("ï¿½ï¿½[trace] expression=\"" + exp + "\" type of result=" + typeof result + 
               " result=" + result);
        }
		return 0;
	} incontextof this,

	input : function(elm)
	{
		// ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ì“ï¿½ï¿½
		inputString(elm);
		return 0;
	} incontextof this,

	clearsysvar : function(elm)
	{
		// ï¿½Vï¿½Xï¿½eï¿½ï¿½ï¿½Ïï¿½ï¿½ÌƒNï¿½ï¿½ï¿½A
		clearSystemVariables();
		return 0;
	} incontextof this,

	clearvar : function(elm)
	{
		// ï¿½Qï¿½[ï¿½ï¿½ï¿½Ïï¿½ï¿½ÌƒNï¿½ï¿½ï¿½A
		clearVariables();
		return 0;
	} incontextof this,

	clearplaytime : function(elm)
	{
        // ï¿½vï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½Ô‚ÌƒNï¿½ï¿½ï¿½A
		clearPlayTime();
		return 0;
	} incontextof this,

	waittrig : function(elm)
	{
		// ï¿½gï¿½ï¿½ï¿½Kï¿½ï¿½Ò‚ï¿½
		return waitTrigger(elm);
	} incontextof this,

	//----------------------------------------- ï¿½^ï¿½Oï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Q(ï¿½Iï¿½ï¿½ï¿½ï¿½) --

    seladd : function(elm)
    {
        addSelect(elm);
        return 0;
	} incontextof this,

    select : function(elm)
    {
		if (selectLayer.msgoff && setCurrentMessageLayerVisible(false)) {
            // ï¿½ï¿½ï¿½ï¿½ï¿½Ò‚ï¿½
            return -3;
        }

		f.selectDoneFlag = true;

		if (skipNoDisp && skipMode < SKIP_FORCE) {
			cancelSkip();
		}
		
		if (recordHistoryOfStore == 3) { // 2 : ï¿½Iï¿½ï¿½ï¿½ï¿½ ( @s ï¿½^ï¿½O ) ï¿½ï¿½ï¿½ï¿½
//			if (autoLabelMode && autoLabelType == 1) {
//				// ï¿½ï¿½Ô•Û‘ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½iï¿½sï¿½wï¿½èƒ‚ï¿½[ï¿½hï¿½Û‘ï¿½ï¿½ï¿½ï¿½gï¿½ï¿½)
//				pushHistoryOfStore();
//				storeFlags(true);
//				storeLabelPassed = true;
//			}
			// ï¿½Lï¿½^ï¿½wï¿½ï¿½
			setToRecordHistory();
		}

        selectPrevAutoMode = autoMode;
        selectPrevSkipMode = skipMode;
        if (skipMode < SKIP_FORCE) {
            cancelSkip();
        }
        cancelAutoMode();
        
        stablePosibility = true;
        notifyStable();
        
        f.selDoneStorage = elm.storage if elm.storage !== void;
        f.selDoneTarget  = elm.target  if elm.target  !== void;

		// ï¿½yï¿½[ï¿½Wï¿½ãˆï¿½ï¿½
		tagHandlers.afterpage(%[]);
		
        showSelect();

        conductor.sleep();
        conductor.interrupt();
        setMenuAccessibleAll();
        return -1;
	} incontextof this,

	selopt : function(elm)
	{
		setSelectOptions(elm);
		return 0;
	} incontextof this,

	seldone : function(elm)
	{
        if (f.selDoneStorage != "" || f.selDoneTarget != "") {
            process(f.selDoneStorage, f.selDoneTarget);
        } else {
            return tagHandlers.s(elm);
        }
		return 0;
	} incontextof this,

	doneselect : function(elm)
	{
		hideSelect();
		afterSelect();
		setMenuAccessibleAll();
		return 0;
	} incontextof this,

	//----------------------------------------- ï¿½^ï¿½Oï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Q(ï¿½Iï¿½ï¿½ï¿½ï¿½) --

    mselinit : function(elm)
    {
        initMapSelect();
        return 0;
	} incontextof this,

    mselbutton : function(elm)
    {
        addMapSelectButton(elm);
        return 0;
	} incontextof this,

    mselpos : function(elm)
    {
        addMapSelectPosition(elm);
        return 0;
	} incontextof this,

    mseladd : function(elm)
    {
        addMapSelect(elm);
        return 0;
	} incontextof this,

    mselect : function(elm)
    {
        if (mapSelectLayer.msgoff && setCurrentMessageLayerVisible(false)) {
            // ï¿½ï¿½ï¿½ï¿½ï¿½Ò‚ï¿½
            return -3;
        }

		if (skipNoDisp && skipMode < SKIP_FORCE) {
			cancelSkip();
		}
		
		if (recordHistoryOfStore == 3) { // 3 : ï¿½Iï¿½ï¿½ï¿½ï¿½ ( @s ï¿½^ï¿½O ) ï¿½ï¿½ï¿½ï¿½
			if (autoLabelMode && autoLabelType == 1) {
				// ï¿½ï¿½Ô•Û‘ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½iï¿½sï¿½wï¿½èƒ‚ï¿½[ï¿½hï¿½Û‘ï¿½ï¿½ï¿½ï¿½gï¿½ï¿½)
				pushHistoryOfStore();
				storeFlags(true);
				storeLabelPassed = true;
			}
			// ï¿½Lï¿½^ï¿½wï¿½ï¿½
			setToRecordHistory();
		}

		selectPrevAutoMode = autoMode;
        selectPrevSkipMode = skipMode;
        if (skipMode < SKIP_FORCE) {
            cancelSkip();
        }
        cancelAutoMode();

        stablePosibility = true;
        notifyStable();

        showMapSelect();

        conductor.sleep();
        conductor.interrupt();
		setMenuAccessibleAll();
        return -1;
	} incontextof this,

	mselopt : function(elm)
	{
        setMapSelectOptions(elm);
		return 0;
	} incontextof this,

	donemapselect : function(elm)
	{
        hideMapSelect();
        afterSelect();
        setMenuAccessibleAll();
		return 0;
	} incontextof this,

	//----------------------------------------- ï¿½^ï¿½Oï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Q(ï¿½Vï¿½iï¿½ï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½) --

    bradd : function(elm)
    {
		return addBranch(elm);
	} incontextof this,

    branch : function(elm)
    {
		return doBranch(elm);
	} incontextof this,

    brdone : function(elm)
    {
		return doneBranch(elm);
	} incontextof this,

	//----------------------------------------- ï¿½^ï¿½Oï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Q(ï¿½ï¿½ï¿½ê•ªï¿½òˆ—ï¿½) --

	next : function(elm)
	{
		if ((elm.storage !== void || elm.target !== void) && (elm.eval === void || elm.eval == "" || Scripts.eval(elm.eval))) {
			kag.process(elm.storage, elm.target);
		}
		return 0;
	} incontextof this,
				  
	//----------------------------------------- ï¿½^ï¿½Oï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Q(ï¿½ï¿½ï¿½ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½ï¿½) --

    beginskip : function(elm)
	{
        // ï¿½ï¿½ï¿½İ‚ÌƒXï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½[ï¿½hï¿½ï¿½ï¿½Lï¿½^
        if (prevSkipMode !== void) {
            throw new Exception("beginskipï¿½Í“ï¿½ï¿½qï¿½Å‚ï¿½ï¿½Ü‚ï¿½ï¿½ï¿½!!!");
        } else {
            prevSkipMode = skipMode;
            if (skipMode) {
                // ï¿½ï¿½ÉƒXï¿½Lï¿½bï¿½vï¿½ï¿½ï¿½Ä‚ï¿½ï¿½ê‡ï¿½Í’ï¿½~ï¿½Å‚ï¿½ï¿½È‚ï¿½ï¿½Xï¿½Lï¿½bï¿½vï¿½ï¿½Ô‚É‚ï¿½ï¿½ï¿½
                skipMode = SKIP_CANCEL;
            }
        }
        return 0;
	} incontextof this,

    endskip : function(elm)
	{
        if (prevSkipMode == 0) {
            cancelSkip();
        } else {
            skipMode = prevSkipMode;
        }
        prevSkipMode = void;
        return 0;
	} incontextof this,

	//----------------------------------------------- ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ --

    autolabel : function(elm)
	{
		doAutoLabel();
		return 0;
	} incontextof this,

	//----------------------------------------------- ï¿½ï¿½zï¿½ï¿½ï¿½[ï¿½h --

    recollection : function(elm)
	{
        startRecollection(elm);
        return 0;
	} incontextof this,

    stoprecollection : function(elm)
    {
        stopRecollection(elm);
        return 0;
    } incontextof this,
                  
    endrecollection : function(elm)
	{
        return endRecollection();
	} incontextof this,

	//----------------------------------------------- ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½gï¿½ï¿½ï¿½ï¿½ï¿½Wï¿½Vï¿½ï¿½ï¿½ï¿½ --

	ltbegin : function(elm)
	{
		return layerTransBegin(elm);
	} incontextof this,

	ltend : function(elm)
	{
		return layerTransEnd(elm);
	} incontextof this,


	//----------------------------------------- ï¿½^ï¿½Oï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Q(ï¿½Iï¿½ï¿½ï¿½ï¿½) --

    panel : function(elm)
    {
		hidePanel();
		if (elm.class !== void) {
			var clobj = Scripts.eval(elm.class);
			panelLayer = new clobj(this, elm.name !== void ? elm.name : "panel", elm);
			dm("ï¿½pï¿½lï¿½ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½\ï¿½ï¿½");
			panelLayer.absolute = (elm.absolute !== void) ? +elm.absolute : 8000000;
			panelLayer.visible = true;
			panelLayer.setMode();
			panelLayer.focus();
			panelShowing = true;
			panelModal   = panelLayer.modal;

			if (elm.nostop) {
				return 0;
			}

			stablePosibility = true;
			notifyStable();
			conductor.sleep();
			conductor.interrupt();
			setMenuAccessibleAll();
			return -1;
		} else {
			return 0;
		}
	} incontextof this,

	donepanel : function(elm)
	{
		hidePanel();
		setMenuAccessibleAll();
		return 0;
	} incontextof this,
				  
	//----------------------------------------------- ï¿½^ï¿½Oï¿½nï¿½ï¿½ï¿½hï¿½ï¿½ï¿½Qï¿½ÌIï¿½ï¿½ï¿½ --

		interrupt : function(elm) { return -2; } incontextof this ];
	}

	//------------------------------------------------------ ï¿½ï¿½ï¿½ï¿½Ïï¿½ï¿½ï¿½ï¿½ï¿½ --
    // ï¿½Vï¿½Xï¿½eï¿½ï¿½ï¿½ï¿½Ê—pï¿½ÉŠÈˆÕQï¿½Æ‚Å‚ï¿½ï¿½éƒï¿½\ï¿½bï¿½hï¿½Eï¿½vï¿½ï¿½ï¿½pï¿½eï¿½Bï¿½ï¿½Ç‰ï¿½

    /**
     * BGM ï¿½Lï¿½ï¿½lï¿½Ìİ’ï¿½
     * true / false
     */
    property bgmenable {
        getter() {
            if (scflags.bgm !== void && scflags.bgm.enable !== void) {
                return scflags.bgm.enable;
            }
            return true;
        }
        setter(v) {
            if (scflags.bgm === void) {
                scflags.bgm = %[];
            }
            scflags.bgm.enable = v;
            bgm.restoreSystemState(scflags);
        }
    }
    
    /**
     * BGM ï¿½{ï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½ï¿½ï¿½lï¿½Ìİ’ï¿½
     * 100ï¿½iï¿½Kï¿½wï¿½ï¿½
     */
    property bgmvolume {
        getter() {
            //dm("bgmVolume ï¿½æ“¾");
            if (scflags.bgm !== void && scflags.bgm.globalVolume !== void) {
                return scflags.bgm.globalVolume / 1000;
            }
            return 100;
        }
        setter(v) {
            if (scflags.bgm === void) {
                scflags.bgm = %[];
            }
            scflags.bgm.globalVolume = v * 1000;
            bgm.restoreSystemState(scflags);
        }
    }

    /**
     * BGM ï¿½Lï¿½ï¿½lï¿½Ìİ’ï¿½
     * true / false
     */
    property seenable {
        getter() {
            if (scflags.se !== void && scflags.se[0] !== void && scflags.se[0].enable !== void) {
                return scflags.se[0].enable;
            }
            return true;
        }
        setter(v) {
            if (scflags.se === void) {
                scflags.se = %[];
            }
            for(var i = 0; i<numSEBuffers+1; i++) {
                if (scflags.se[i] === void) {
                    scflags.se[i] = %[];
                }
                scflags.se[i].enable = v;
                se[i].restoreSystemState(scflags);
            }
        }
    }
    
    /**
     * SE ï¿½{ï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½ï¿½ï¿½lï¿½Ìİ’ï¿½
     * 100ï¿½iï¿½Kï¿½İ’ï¿½
     */
    property sevolume {
        getter() {
            if (scflags.se !== void && scflags.se[0] !== void) {
                return scflags.se[0].globalVolume / 1000;
            }
            return 100;
        }
        setter(v) {
            if (scflags.se === void) {
                scflags.se = %[];
            }
            for(var i = 0; i<numSEBuffers+1; i++) {
                if (scflags.se[i] === void) {
                    scflags.se[i] = %[];
                }
                scflags.se[i].globalVolume = v * 1000;
                se[i].restoreSystemState(scflags);
            }
        }
    }

    /**
     * ï¿½{ï¿½Cï¿½Xï¿½Lï¿½ï¿½lï¿½Ìİ’ï¿½
     * true / false
     */
    property voiceenable {
        getter() {
            if (scflags.voice !== void && scflags.voice.enable !== void) {
                return scflags.voice.enable;
            }
            return true;
        }
        setter(v) {
            if (scflags.voice === void) {
                scflags.voice = %[];
            }
            scflags.voice.enable = v;
        }
    }
    
    /**
     * ï¿½{ï¿½Cï¿½Xï¿½Ì‘ï¿½\ï¿½{ï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½ï¿½
     * 100ï¿½iï¿½Kï¿½İ’ï¿½
     */
    property voicevolume {
        getter() {
            if (scflags.voice !== void && scflags.voice.globalVolume !== void) {
                return scflags.voice.globalVolume / 1000;
            }
            return 100;
        }
        setter(v) {
            if (scflags.voice === void) {
                scflags.voice = %[];
            }
            scflags.voice.globalVolume = v * 1000;
        }
    }

    /**
     * ï¿½wï¿½è‚³ï¿½ê‚½ï¿½ï¿½ï¿½Oï¿½ÌƒLï¿½ï¿½ï¿½ï¿½ï¿½Ìƒ{ï¿½Cï¿½Xï¿½ï¿½ï¿½Lï¿½ï¿½Ç‚ï¿½ï¿½ï¿½
     */
    function getVoiceOn(name) {
        //dm("ï¿½{ï¿½Cï¿½Xï¿½Lï¿½ï¿½mï¿½F:" + name);
        if (name === void) {
            name = "etc";
        }
        if (scflags.voiceon !== void) {
            if (scflags.voiceon[name] !== void) {
                return scflags.voiceon[name];
            }
        }
        return true;
    }

    /**
     * ï¿½wï¿½è‚³ï¿½ê‚½ï¿½ï¿½ï¿½Oï¿½ÌƒLï¿½ï¿½ï¿½ï¿½ï¿½Ìƒ{ï¿½Cï¿½Xï¿½ï¿½Lï¿½ï¿½É‚ï¿½ï¿½ï¿½
     */
    function setVoiceOn(name, on=true) {
        if (name === void) {
            name = "etc";
        }
        if (scflags.voiceon === void) {
            scflags.voiceon = %[];
        }
        scflags.voiceon[name] = on;
    }

    /**
     * ï¿½wï¿½è‚³ï¿½ê‚½ï¿½ï¿½ï¿½Oï¿½ÌƒLï¿½ï¿½ï¿½ï¿½ï¿½Ìƒ{ï¿½Cï¿½Xï¿½ï¿½Lï¿½ï¿½É‚ï¿½ï¿½ï¿½
     */
    function getVoiceVolume(name) {
        if (name === void) {
            name = "etc";
        }
        if (scflags.voice !== void && 
            scflags.voice[name] !== void) {
            return scflags.voice[name] / 1000;
        }
        return voicevolume;
    }
    
    /**
     * ï¿½wï¿½è‚³ï¿½ê‚½ï¿½ï¿½ï¿½Oï¿½ÌƒLï¿½ï¿½ï¿½ï¿½ï¿½Ìƒ{ï¿½Cï¿½Xï¿½ï¿½Lï¿½ï¿½É‚ï¿½ï¿½ï¿½
     */
    function setVoiceVolume(name, vol) {
        if (name === void) {
            name = "etc";
        }
        if (scflags.voice === void) {
            scflags.voice = %[];
        }
        scflags.voice[name] = vol * 1000;
    }

    /**
     * ï¿½eï¿½Lï¿½Xï¿½gï¿½ï¿½ï¿½xï¿½ï¿½ï¿½ï¿½
     * 0ï¿½`10 ï¿½Åwï¿½ï¿½ (10ï¿½ï¿½ï¿½Å‘ï¿½)
     */
    property textspeed {
        getter() {
            return 10 - (userChSpeed / (chSpeeds.slow / 10));
        }
        setter(v) {
            userChSpeed = (10 - v) * (chSpeeds.slow / 10);
            if (userChSpeed <= chSpeeds.fast) {
                if (typeof this.chFastMenuItem != "undefined") {
                    this.chFastMenuItem.checked = true;
                }
            } else if (userChSpeed <= chSpeeds.normal) {
                if (typeof this.chNormalMenuItem != "undefined") {
                    this.chNormalMenuItem.checked = true;
                }
            } else {
				if (typeof this.chSlowMenuItem != "undefined") {
                    this.chSlowMenuItem.checked = true;
                }
            }
        }
    }

    /**
     * ï¿½ï¿½ï¿½ï¿½ï¿½Äï¿½ï¿½ï¿½ï¿½Ò‚ï¿½ï¿½ï¿½ï¿½Ôï¿½ï¿½ï¿½
     * 0ï¿½`10ï¿½Åwï¿½ï¿½ (10ï¿½ï¿½ï¿½Å‘ï¿½ï¿½j
     */
    property autospeed {
        getter() {
            return 10 - (autoModePageWait / (autoModePageWaits.slow / 10));
        }
        setter(v) {
            autoModePageWait = (int)((10 - v) * (autoModePageWaits.slow / 10));
            autoModeLineWait = (int)((10 - v) * (autoModeLineWaits.slow / 10));
            if (autoModePageWait <= autoModePageWaits.fast) {
                if (typeof this.autoModeFastMenuItem != "undefined") {
                    this.autoModeFastMenuItem.checked = true;
                }
            } else if (autoModePageWait <= autoModePageWaits.faster) {
                if (typeof this.autoModeFasterMenuItem != "undefined") {
                    this.autoModeFasterMenuItem.checked = true;
                }
            } else if (autoModePageWait <= autoModePageWaits.medium) {
                if (typeof this.autoModeMediumMenuItem != "undefined") {
                    this.autoModeMediumMenuItem.checked = true;
                }
            } else if (autoModePageWait <= autoModePageWaits.slower) {
                if (typeof this.autoModeSlowerMenuItem != "undefined") {
                    this.autoModeSlowerMenuItem.checked = true;
                }
            } else {
                if (typeof this.autoModeSlowMenuItem != "undefined") {
                    this.autoModeSlowMenuItem.checked = true;
                }
            } 
        }
    }

	function updateEffectButton() {
		if (noeffect) {
			if (typeof this.noeffectMenuItem != "undefined") {
				this.noeffectMenuItem.checked = true;
			}
		} else {
			if (typeof this.effectMenuItem != "undefined") {
				this.effectMenuItem.checked = true;
			}
		}
	}
	
    /**
     * ï¿½`ï¿½æ‘¬ï¿½x (ï¿½gï¿½ï¿½ï¿½ï¿½ï¿½Wï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½ÌÄï¿½ï¿½{ï¿½ï¿½ï¿½ï¿½ï¿½wï¿½è‚·ï¿½ï¿½j
     */
    property drawspeed {
        getter() {
            if (scflags.drawspeed === void) {
                return 1.0;
            }
            return scflags.drawspeed;
        }
        setter(v) {
			scflags.drawspeed = v;
			updateEffectButton();
        }
    }
    
    /**
     * ï¿½Gï¿½tï¿½Fï¿½Nï¿½gï¿½Ì—Lï¿½ï¿½Eï¿½ï¿½ï¿½ï¿½iï¿½gï¿½ï¿½ï¿½ï¿½ï¿½Wï¿½Vï¿½ï¿½ï¿½ï¿½ï¿½â³ï¿½Æ˜Aï¿½ï¿½ï¿½j
     */
    property noeffect {
        getter() {
            if (scflags.drawspeed === void) {
                return false;
            }
            return scflags.drawspeed == 0;
        }
        setter(v) {
            if (v) {
                scflags.drawspeed = 0;
			} else {
				delete scflags.drawspeed;
			}
			updateEffectButton();
        }
    }

    /**
     * ï¿½{ï¿½Cï¿½Xï¿½ÌÄï¿½ï¿½{ï¿½ï¿½
     */
    property voicespeed {
        getter() {
            if (scflags.voicespeed === void) {
                return 1.0;
            }
            return scflags.voicespeed;
        }
        setter(v) {
            scflags.voicespeed = v;
        }
    }
    
	function onVoiceSpeedMenuItemClick(sender)
	{
		sender.checked = true;
        voicespeed = sender.speed;
        if (typeof updateVoice !== "undefined") {
            updateVoice();
        }
    }

    // ----------------------------------------------------------
    // ï¿½Gï¿½ï¿½ï¿½[ï¿½ï¿½ï¿½Oï¿½ï¿½ï¿½ï¿½
    // ----------------------------------------------------------

    // ï¿½fï¿½oï¿½bï¿½Oï¿½ï¿½ï¿½xï¿½ï¿½ï¿½ï¿½ï¿½ï¿½l
    var _debugLevel = tkdlNone;
    
    /**
     * ï¿½fï¿½oï¿½bï¿½Oï¿½ï¿½ï¿½xï¿½ï¿½
     */
    property debugLevel {
        setter(v) {
            _debugLevel = v;
            if (mainConductor !== void) {
                mainConductor.debugLevel = v;
                extraConductor.debugLevel = v;
            }
        }
        getter() {
            return _debugLevel;
        }
    }

	function onDebugLevelNoneMenuItemClick(sender)
	{
        debugLevel = tkdlNone;
        if(typeof this.debugLevelNoneMenuItem != "undefined")
            debugLevelNoneMenuItem.checked = true;
        saveSystemVariables();
	}

	function onDebugLevelSimpleMenuItemClick(sender)
	{
        debugLevel = tkdlSimple;
        if(typeof this.debugLevelSimpleMenuItem != "undefined")
            debugLevelSimpleMenuItem.checked = true;
        saveSystemVariables();
	}

    function onDebugLevelVerboseMenuItemClick(sender)
	{
        debugLevel = tkdlVerbose;
        if(typeof this.debugLevelVerboseMenuItem != "undefined")
            debugLevelVerboseMenuItem.checked = true;
        saveSystemVariables();
	}
    
	var logMode = false;
	var cmdLog = [];
	var imageLog = [];
	var soundLog = [];
	var voiceLog = [];

    function error(msg) {
        if (debugLevel >= tkdlSimple) dm(msg);
    }
    
    function errorLine(target, msg) {
		msg = "%s:%s: %s".sprintf(conductor.curStorage, conductor.curLine, msg);
		if (debugLevel >= tkdlSimple) dm(msg);
		if (logMode) {
			target.add(msg);
		}
    }

    /**
	 * ï¿½ï¿½ï¿½mï¿½Ì–ï¿½ï¿½ï¿½
     */
	function errorCmd(msg) {
		errorLine(cmdLog, msg);
    }

	
    /**
     * ï¿½æ‘œï¿½tï¿½@ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½hï¿½Å‚ï¿½ï¿½È‚ï¿½ï¿½ê‡
     */
    function errorImage(msg) {
        errorLine(imageLog, msg);
    }

    /**
     * ï¿½{ï¿½Cï¿½Xï¿½tï¿½@ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½hï¿½Å‚ï¿½ï¿½È‚ï¿½ï¿½ê‡
     */
    function errorSound(msg) {
        errorLine(soundLog, msg);
    }

    /**
     * ï¿½{ï¿½Cï¿½Xï¿½tï¿½@ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½hï¿½Å‚ï¿½ï¿½È‚ï¿½ï¿½ê‡
     */
    function errorVoice(msg) {
        errorLine(voiceLog, msg);
    }

    /**
     * ï¿½ï¿½ï¿½Oï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
     */
    function initLog() {
		cmdLog.clear();
		imageLog.clear();
        soundLog.clear();
        voiceLog.clear();
    }

    /**
     * ï¿½ï¿½ï¿½Oï¿½ï¿½ï¿½oï¿½Í‚ï¿½ï¿½ï¿½
     */
    function outputLog() {
        if (logMode) {
			cmdLog.save(Debug.logLocation + "/cmderror.log");
			imageLog.save(Debug.logLocation + "/imageerror.log");
            soundLog.save(Debug.logLocation + "/sounderror.log");
            voiceLog.save(Debug.logLocation + "/voiceerror.log");
            initLog();
        }
    }

    /**
     * ï¿½_ï¿½Cï¿½Aï¿½ï¿½ï¿½Oï¿½ï¿½\ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
     */
	var _errorInformMessageMap = %[
	savefail: "ï¿½tï¿½@ï¿½Cï¿½ï¿½ï¿½É•Û‘ï¿½ï¿½Å‚ï¿½ï¿½Ü‚ï¿½ï¿½ï¿½ (ï¿½tï¿½@ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½Jï¿½ï¿½ï¿½È‚ï¿½ï¿½ï¿½ï¿½Aï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½İ‹Ö~ï¿½Å‚ï¿½)",
	loadfail:  "ï¿½ï¿½ï¿½ÌƒVï¿½Xï¿½eï¿½ï¿½ï¿½Ìƒfï¿½[ï¿½^ï¿½ï¿½Ç‚İï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æ‚ï¿½ï¿½Ü‚ï¿½ï¿½ï¿½",
	loadexception: %[ exp:function(mes) { return @"ï¿½xï¿½ï¿½Ç‚İï¿½ï¿½ß‚È‚ï¿½ï¿½ï¿½ï¿½Aï¿½xï¿½ï¿½ï¿½ï¿½ï¿½Ä‚ï¿½ï¿½é‚©ï¿½Aï¿½ï¿½ï¿½é‚¢ï¿½Í‘ï¿½ï¿½ÌŒ`ï¿½ï¿½ï¿½Ìxï¿½fï¿½[ï¿½^ï¿½Å‚ï¿½(${mes})"; } ],
	savemydoc: %[ message:"ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½İŒï¿½ï¿½ï¿½ï¿½ï¿½ï¿½È‚ï¿½ï¿½tï¿½@ï¿½Cï¿½ï¿½ï¿½Û‘ï¿½ï¿½Å‚ï¿½ï¿½Ü‚ï¿½ï¿½ï¿½BMyDocumentï¿½È‰ï¿½ï¿½Éƒfï¿½[ï¿½^ï¿½ï¿½Û‘ï¿½ï¿½ï¿½ï¿½Ü‚ï¿½", caption:"Information" ],
	readonly:  %[ message:"ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½İŒï¿½ï¿½ï¿½ï¿½ï¿½ï¿½È‚ï¿½ï¿½tï¿½@ï¿½Cï¿½ï¿½ï¿½Û‘ï¿½ï¿½Å‚ï¿½ï¿½Ü‚ï¿½ï¿½ï¿½BReadOnlyMode ï¿½Å“ï¿½ï¿½ì‚µï¿½Ü‚ï¿½",          caption:"Warning" ],
		];
	function errorInform(tag, *) {
		if (tag == "" || _errorInformMessageMap[tag] == "") return;
		var msg = _errorInformMessageMap[tag];
		var cap = "Error";
		if (typeof msg == "Object") with (msg) {
			cap = .caption if (typeof .caption != "undefined");
			msg = .exp(*)  if (typeof .exp     != "undefined");
			msg = .message if (typeof .message != "undefined");
		}
		System.inform(msg, cap);
	}

    // -------------------------------------------------------------
    
    /**
     * ï¿½fï¿½oï¿½bï¿½Oï¿½ï¿½ï¿½\ï¿½ï¿½ï¿½ï¿½ï¿½eï¿½ÌXï¿½V
     */
	function updateDebugInfo() {
        if (_debugwin !== void && debugwin.visible) {
			var title = "%06d:%s %s".sprintf(conductor.runLine, conductor.curStorage, conductor.runLabel);
			debugwin.fillRect(0, 0, debugwin.width, debugwin.height, 0xa0000000);
			debugwin.drawText(10, 10, title , 0xffffff);
			debugwin.drawText(10, 30, conductor.runLineStr, 0xffffff);
        }
		if (skipNoDispWin !== void) {
			skipNoDispWin.visible = true;
			var title = "ï¿½ï¿½ï¿½Ì‘Iï¿½ï¿½ï¿½ï¿½ï¿½Ü‚ÅƒXï¿½Lï¿½bï¿½vï¿½ï¿½:%s".sprintf(currentPageName);
			skipNoDispWin.fillRect(0, 0, skipNoDispWin.width, skipNoDispWin.height, 0xa0000000);
			skipNoDispWin.drawText(10, 10, title , 0xffffff);
		}
    }

    /**
     * ï¿½fï¿½oï¿½bï¿½Oï¿½ï¿½ï¿½ï¿½ ON/OFF
     */
    function onDebugWinMenuItemClick(sender)
	{
        debugwin.visible = !debugwin.visible;
        if(typeof this.debugWinMenuItem != "undefined")
            debugWinMenuItem.checked = debugwin.visible;
        if (debugwin.visible) {
            updateDebugInfo();
        }
        saveSystemVariables();
	}

    // -------------------------------------------------------------

    // ï¿½Oï¿½ï¿½ï¿½ï¿½ï¿½ï¿½@ï¿½\
    var debugControl;

    // ï¿½fï¿½oï¿½bï¿½Oï¿½ï¿½ï¿½ï¿½Â”\ï¿½ï¿½ï¿½Ç‚ï¿½ï¿½ï¿½ï¿½Ì”ï¿½ï¿½ï¿½
    function canDebugControl() {
        if (debugControl === void) {
            if (typeof global.wmrStart != "undefined") {
                wmrStart(this);
                debugControl = true;
            } else {
                debugControl = false;
            }
        }
		//dm("ï¿½fï¿½oï¿½bï¿½Oï¿½ï¿½ï¿½ä”»ï¿½ï¿½:" + debugControl);
        return debugControl;
    }

    // ï¿½Oï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
    function onCopyData(msg) {
        if (debugControl) {
			// ï¿½^ï¿½uï¿½ï¿½Ø‚ï¿½
			var args = msg.split("\t");
			if (autoLabelSaveMode) {
                if (args[0] == "jump") {
                    try {
                        loadBookMarkFromFile(getBookMarkFileNameAtLabel(args[1], args[2]));
                        if (args[3] == "next") {
                            skipToLabel();
                        }
                    } catch (e) {
                        System.inform("ï¿½Yï¿½ï¿½ï¿½tï¿½@ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½xï¿½ï¿½ï¿½Íƒï¿½ï¿½[ï¿½hï¿½Å‚ï¿½ï¿½Ü‚ï¿½ï¿½ï¿½Å‚ï¿½ï¿½ï¿½ " + args[1] + ":" + args[2]);
                    }
                }
            }
        }
    }
    
    // -------------------------------------------------------------
    
    // ï¿½Sï¿½ÓÜƒï¿½ï¿½[ï¿½h ï¿½iï¿½ê•”ï¿½Vï¿½Xï¿½eï¿½ï¿½ï¿½ï¿½ï¿½tï¿½ï¿½ï¿½Oï¿½Æ‚ï¿½ï¿½Ä‚Ì‚İ—ï¿½ï¿½pï¿½j
    var allseen = false;

    // -------------------------------------------------------------

	/**
	 * ï¿½Vï¿½Xï¿½eï¿½ï¿½ï¿½Ìƒï¿½ï¿½Zï¿½bï¿½gï¿½iï¿½sï¿½ï¿½ï¿½Sï¿½j
	 */
	function resetAll() {
		forEachEventHook('onResetAll',
						 function(handler) { handler(); } incontextof this);

		clearLayers(kag.fore);

		stablePosibility = true;
		cancelSkip();
		inSleep = true;
		notifyStable();

		conductor.sleep();
		conductor.interrupt();

		setMenuAccessibleAll();
	}

	// -------------------------------------------------------------
}


// TJS ï¿½Xï¿½Nï¿½ï¿½ï¿½vï¿½gï¿½Í‚ï¿½ï¿½ï¿½ï¿½ÅIï¿½ï¿½ï¿½
"
END_OF_TJS_SCRIPT
# "; /*

# assign ï¿½ÅƒRï¿½sï¿½[ï¿½ï¿½ï¿½×‚ï¿½ï¿½Ïï¿½ï¿½ÌÄï¿½ï¿½ï¿½ï¿½ï¿½ï¿½sï¿½ï¿½ perl ï¿½Xï¿½Nï¿½ï¿½ï¿½vï¿½g

open FH, "MainWindow.tjs" or die;
undef($/);
$content = <FH>;

$list_store = '';
$list_restore = '';
while($content =~ /\/\*C\*\/var\s+(\w+)/gs)
{
	$list_store .= "\t\tf.$1 = $1;\n";
	$list_restore .= "\t\t$1 = f.$1 if f.$1 !== void;\n";
}

$content =~
s/\t\t\/\/ \[start_store_vars\]\n.*?\t\t\/\/ \[end_store_vars\]/\t\t\/\/ \[start_store_vars\]\n$list_store\t\t\/\/ \[end_store_vars\]/s;
$content =~
s/\t\t\/\/ \[start_restore_vars\]\n.*?\t\t\/\/ \[end_restore_vars\]/\t\t\/\/ \[start_restore_vars\]\n$list_restore\t\t\/\/ \[end_restore_vars\]/s;

open FH, ">MainWindow.tjs" or die;
print FH $content;


# */

