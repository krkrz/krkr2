<html>
<head>
<meta HTTP-EQUIV="CONTENT-TYPE" CONTENT="TEXT/HTML; CHARSET=SHIFT_JIS">
<title>吉里吉里2/KAG3 機能仕様書 / 動画再生機能</title>
<link rel="stylesheet" href="styles-site.css" type="text/css" />
</head>
<body>
<a name="top"></a>
<div id="top_link"><a href="./index.html">Topへ</a></div>
<div id="container">
<div id="title-banner">
<h1>動画再生機能</h1>
</div>

<div class="content">
<p>吉里吉里2/KAG3がサポートする動画再生機能ついて記載。</p>
<h3>目次</h3>
<p><a href="#spec">諸元</a><br />
<a href="#mode">モード</a><br />
<a href="#trickplay">特殊再生機能</a><br />
<a href="#preparevideo">動画再生準備について ( preparevideo )</a><br />
<a href="#layermode">レイヤーモードでのレイヤー指定について</a><br />
<a href="#end_of_video">動画終端での振る舞い</a><br />
<a href="#layer_alpha">レイヤーモードで動画が表示されない現象について</a><br />
<a href="#mixer_mode">ミキシング再生</a><br />
<a href="#seek_to_keyframe">キーフレームとシーク</a><br />

</p>
<br />

<div class="title_bar"><a name="spec">諸元</a></div>
<br />
<table frame="box" rules="all">
	<tbody>
		<tr>
			<td rowspan="3">モード</td>
			<td>オーバーレイモード</td>
			<td>ビデオオーバーレイを使用して動画を表示するモード</td>
		</tr>
		<tr>
			<td>レイヤーモード</td>
			<td>吉里吉里内のレイヤーで動画を再生するモード</td>
		</tr>
		<tr>
			<td>ミキサーモード</td>
			<td>VMR9 + Direct3D を使用して動画を表示するモード</td>
		</tr>

		<tr>
			<td rowspan="4">特殊再生機能</td>
			<td>セグメントループ</td>
			<td>指定されたフレーム間をループする機能</td>
		</tr>
		<tr>
			<td>ピリオドイベント</td>
			<td>指定されたフレームでイベントを発生させる機能</td>
		</tr>
		<tr>
			<td>再生速度指定</td>
			<td>動画の再生速度を指定する機能</td>
		</tr>
		<tr>
			<td>マルチオーディオ</td>
			<td>多重化された音声のうち、1つを選択して再生する機能</td>
		</tr>

		<tr>
			<td>音声バランス<br />(パニング)</td>
			<td>-100000 〜 0<br /> 〜 100000</td>
			<td>-100000 が 完全に左、0 が中央、100000 が完全に右。<br />
			ステレオのソースを再生する場合は、パンは、<br />
			左右どちらかのチャンネルを減衰させることで実現される。</td>
		</tr>
		<tr>
			<td>音声ボリューム</td>
			<td>0 〜 100000</td>
			<td>0 が完全ミュート、100000 が 100% の音量</td>
		</tr>
		<tr>
			<td>音声ストリーム</td>
			<td>コンテンツに依存</td>
			<td>再生する音声ストリームを選択</td>
		</tr>
		<tr>
			<td>再生速度</td>
			<td>＞0</td>
			<td>設定可能値はDirectShowのフィルタ依存。<br />
			音声ありの場合、2.0≧速度＞0。<br />
			1.0が等倍速。</td>
		</tr>

		<tr>
			<td rowspan="7">取得可能値</td>
			<td>フレームレート</td>
			<td>1秒辺りのフレーム数</td>
		</tr>
		<tr>
			<td>現在のフレーム</td>
			<td>現在表示しているフレーム。<br />
			表示しているフレーム番号と完全に一致する保証はない。</td>
		</tr>
		<tr>
			<td>現在の再生時間</td>
			<td>動画の最初からの動画内での経過時間。</td>
		</tr>
		<tr>
			<td>画像サイズ</td>
			<td>幅と高さ</td>
		</tr>
		<tr>
			<td>音声ストリーム数</td>
			<td>多重化されている音声ストリームの数</td>
		</tr>
		<tr>
			<td>全フレーム数</td>
			<td>動画が保持しているフレームの数</td>
		</tr>
		<tr>
			<td>合計時間</td>
			<td>動画の合計時間</td>
		</tr>

		<tr>
			<td rowspan="4">イベント</td>
			<td>コールバックコマンド</td>
			<td>SWF 再生中に Get URL アクションが実行されたときに発生</td>
		</tr>
		<tr>
			<td>フレーム更新</td>
			<td>ビデオフレームが更新された後に発生</td>
		</tr>
		<tr>
			<td>Periodイベント</td>
			<td>通常ループ終端、セグメントループ終端、<br />
			設定したピリオドイベント、再生準備完了時に発生。</td>
		</tr>
		<tr>
			<td>ステータス変更</td>
			<td>再生状態が変更された時に発生</td>
		</tr>

	</tbody>
</table>

<br />
<br />


<div class="title_bar"><a name="mode">モード</a></div>
<br />
<table frame="box" rules="all">
	<thead><tr><td>種類</td><td>説明</td></tr></thead>
	<tbody>
		<tr>
			<td>オーバーレイモード</td>
			<td>ビデオオーバーレイを使用して動画を表示するモードです。<br />
			吉里吉里内の他のどのレイヤーよりも手前に表示されます。<br />
			ほとんどの場合、ムービーの再生は最も軽くなります。<br />
			単純に動画を再生して停止するだけであれば、オーバーレイモードを使用するのが良いです。<br />
			しかし、Windows Vista と Windows XP で吉里吉里の描画モードがDirectDrawの時に一部の環境において、オーバーレイモード時に拡大すると綺麗に拡大されない(ジャギーが発生する)という現象が報告されています。<br />
			このため Windows Vista ではオーバーレイモードは避けた方が良いです。</td>
		</tr>
		<tr>
			<td>レイヤーモード</td>
			<td>吉里吉里内の指定のレイヤーで動画を再生するモードです。<br />
			環境依存性が低く、指定フレーム間でのループ(セグメントループ)や指定フレームでの処理(ピリオドイベント)などの機能が使用可能です。<br />
			ただ、他のモードよりもCPU負荷が高くなるという難点があります。<br />
			また、拡大縮小も出来ません。</td>
		</tr>
		<tr>
			<td>ミキサーモード</td>
			<td>オーバーレイモードの代替として追加された、VMR9 + Direct3D を使用して動画を表示するモードです。<br />
			ビデオカードにビデオ再生支援機能があり、コーデックが対応していれば、ビデオカードのビデオ再生支援機能を使用して再生可能です。<br />
			Windows Vista での拡大時のジャギー問題も回避されます。<br />
			また、指定レイヤーとのミキシングや拡大縮小も可能です。<br />
			使用するには DirectX 9 以降が必要です。</td>
		</tr>
	</tbody>
</table>

<br />
<br />

<div class="title_bar"><a name="trickplay">特殊再生機能</a></div>
<br />
<table frame="box" rules="all">
	<thead><tr><td>種類</td><td>説明</td></tr></thead>
	<tbody>
		<tr>
			<td>セグメントループ</td>
			<td>指定されたフレーム間をループする機能です。<br />
			この機能を使用するためには、動画ファイル自体にループで戻る先のフレームにキーフレームを設定しておく必要があります。<br />
			キーフレームがない場合、期待したようにループされません。</td>
		</tr>
		<tr>
			<td>ピリオドイベント</td>
			<td>指定されたフレームでイベントを発生させ、何らかの処理ができる機能です。<br />
			イベント発生時に、離れたフレームにシークすることで、間のフレームを飛ばして、あたかも動画がつながっているように見せることが可能です。<br />
			また、動画にあわせて字幕を出したい時なども、字幕の開始フレームにピリオドイベントを設定し、イベントを待って文字を表示することで実現可能です。<br />
			他に、この機能を使えば、動画自体には音を入れず、指定フレームでSEを使って音を鳴らすことも可能です。</td>
		</tr>
		<tr>
			<td>再生速度コントロール</td>
			<td>動画の再生速度が指定可能です。<br />
			1.0 を指定すると通常の再生速度、0.5 では半分の再生速度、2では2倍の再生速度になります。<br />
			設定可能な値は DirectShowのフィルタ (Codec) に依存します。</td>
		</tr>
		<tr>
			<td>マルチオーディオ</td>
			<td>MPEG I では、複数のオーディオストリームを多重化可能なため、それを利用する機能です。<br />
			この機能では、任意のオーディオストリームを再生することが可能です。<br />
			たとえば、BGMのみ、BGM+声などのストリームを準備しておき、ユーザーがどのモードで再生するか指定可能にすることなどが出来ます。<br />
			ただ、オーディオストリームの切り替えには2秒程度のタイムラグがあるため、あまりインタラクティブな用途には向いていません。<br />
			上記のユーザーによる選択やシーンによって動画音声が変わるような用途に使えます。</td>
		</tr>

	</tbody>
</table>

<br />
<br />

<div class="title_bar"><a name="preparevideo">動画再生準備について ( preparevideo )</a></div>
<p>preparevideo は、動画の1フレーム目を指定されたレイヤーに描画します。<br />
これは、意図しない画像(メモリ上のごみや前回の画像など)が画面上に表示されるのを防ぐ目的で利用されます。<br />
つまり、再生対象としたレイヤーを非表示にして、動画を openvideo で開いた後、preparevideo をコールし、wp で準備完了を待ち、準備できた後に再生対象レイヤーを表示状態にするような処理を記述することで、表示した時に動画の1フレーム目を表示することが出来ます。<br />
なお、この機能はレイヤーモードの時のみ意味を持ちます。<br />
</p>

<br />
<br />

<div class="title_bar"><a name="layermode">レイヤーモードでのレイヤー指定について</a></div>
<p>レイヤーモードで動画を再生する場合、videolayer を使用して、描画対象レイヤーを指定します。<br />
videolayer では、slotとchannel, page, layer が指定できます。 <br />
slot は、se の buf に相当するもので、異なるビデオを同時に再生する時に、どのビデオに対する操作かを特定するためにあります。<br />
複数の動画を同時に再生することはほとんどないと思いますので、通常は記述を省略し、0 が指定されるようにしておけば問題ありません。<br />
channel は、出力するレイヤーを指定するためにあります。<br />
1つの動画に付き2つまで出力するレイヤーを指定できるので、そのどちらに対する指定かを特定するために利用します。<br />
2つ指定可能になっているのは、トランジションを利用するためです。<br />
動画再生中にトランジションを実行すると、表と裏のレイヤーが入れ替わるため、片方にしか出力していないと、動画が非表示になってしまいます。<br />
これを避けるため、動画再生中にトランジションを行う場合は、チャンネルの1と2に表と裏のレイヤーを設定しておきます。トランジションを行わないのであれば、表面だけ指定しておけば問題ありません。<br />
</p>

<br />
<br />

<div class="title_bar"><a name="end_of_video">動画終端での振る舞い</a></div>
<p>ループを指定せずに動画を再生すると、最後まで再生したら動画は停止します。<br />
動画の最後のフレームを表示したままゲームを進行したい場合、この動作は好ましくありません。<br />
これを回避する最も簡単な方法はレイヤーモードを使用することです。<br />
レイヤーモードでは、レイヤーに対して動画が描画されるため、最後のフレームの画像がそのままレイヤーに残ります。<br />
そのため、特に意識することなく、最後のフレームを表示したままゲームを進行出来ます。<br />
オーバーレイやミキサーの場合は、停止すると表示が消えてしまうため、最終フレームに達する前に一時停止しなければなりません。<br />
これは、ピリオドイベントで実現できますが、本当に最終フレームにしてしまうと、停止してしまう可能性があるため、動画の末尾に数フレームダミーフレームを入れておき、少し通り越しても大丈夫なようにしておいた方が良いです。<br />
</p>

<br />
<br />

<div class="title_bar"><a name="layer_alpha">レイヤーモードで動画が表示されない現象について</a></div>
<p>動画の再生対象としたレイヤーの表示タイプがアルファなどになっていると、動画が表示されないという事態が発生します。<br />
これは、動画がアルファチャンネルを持っていない場合、アルファチャンネルの位置に不定データが書き込まれるためです。<br />
レイヤー表示タイプがアルファになっている場合、この不定データがアルファ値として扱われるため、完全に透明になってしまったりします。<br />
これを回避するためには、再生対象レイヤーの表示タイプをopaqueにしてやります。<br />
そうすると動画が表示されるようになります。<br />
ただ、KAGではopaqueにし辛いので、代わりに freeimage を呼んでも同様の効果が得られるようです。<br />
</p>

<br />
<br />

<div class="title_bar"><a name="mixer_mode">ミキシング再生</a></div>
<p>ミキサーモードはその名の通り、他のレイヤーと動画をミキシングして再生することを実現できます。<br />
ミキサーモードでミキシングに関係して指定できるのは、背景色、ブレンド率、ミキシング対象レイヤーです。<br />
ミキシング対象レイヤーは、設定した瞬間の画像と動画がミキシングされます。<br />
そのため、ミキシング対象レイヤーが更新されても、再度設定しない限り内容は更新されません。<br />
ただ、毎フレームの更新時に設定をコールすると、かなりCPU負荷が高くなります。<br />
CPU負荷を抑えるために、設定する場合は、更新された時のみに限定した方が良いです。<br />
背景色は、ブレンド率を1.0未満にした場合にブレンドされる色です。<br />
背景色を黒などに設定し、ブレンド率を変化させることで、フェードイン/アウトが実現できます。<br />
当然、ミキシング対象レイヤーとのフェードイン/アウト可能です。<br />
ミキシング対象レイヤーとのブレンド率やレイヤー位置はレイヤーの情報が使われます。<br />
つまり、表示位置はレイヤーの位置にブレンド率はレイヤーの不透明度に依存します。<br />
ただ、レイヤーとのブレンドは毎回指定する必要があるという仕様から、レイヤーとフェードイン/アウトをするとCPU負荷が高くなってしまいます。<br />
</p>

<br />
<br />

<div class="title_bar"><a name="seek_to_keyframe">キーフレームとシーク</a></div>
<p>吉里吉里ではシークを高速に行うため、シーク可能位置をキーフレームに限定しています。<br />
キーフレーム以外のフレームを指定した場合、指定フレームに最も近いキーフレームへシーク処理が行われます。<br />
ただし、この動作は Codec 依存のため、しばしば意図しない動作が行われます。<br />
そのため、シークを行うフレームへは必ずキーフレームを設定するようにした方が良いです。<br />
</p>

<br />
<br />



<br />
</div>
</div>

</body>
</html>

