// Movie.tjs - ���[�r�[�Đ�
// Copyright (C)2001-2009, W.Dee and contributors  ��ρE�z�z�͎��R�ł�

class Movie extends VideoOverlay
{
	var owner;
	var lastStatus = "unload"; // ���O�̃X�e�[�^�X
	var opened = false;
	var id = 0; // ���[�r�[�I�u�W�F�N�gID
	var layerNumber = [];
	var layerPage = [];
	var storageName;

	function Movie(owner,id=0)
	{
		super.VideoOverlay(...);

		this.owner = owner;
		this.id = id;

		this.layerNumber[0] = void;
		this.layerNumber[1] = void;
		this.layerPage[0] = void;
		this.layerPage[1] = void;
	}

	function store()
	{
		var dic = %[];
		dic.mode = mode;
		if( mode == vomLayer )
		{
			dic.visible = visible;
			dic.loop = loop;
			dic.frame = frame;

			if( numberOfAudioStream > 0 ) {
				dic.audioBalance = audioBalance;
				dic.audioVolume = audioVolume;
				dic.enabledAudioStream = enabledAudioStream;
			}

			// dic.playRate // �ێ����Ȃ���ǂ��H
			dic.segmentLoopStartFrame = segmentLoopStartFrame;
			dic.segmentLoopEndFrame = segmentLoopEndFrame;
			dic.periodEventFrame = periodEventFrame;

			dic.layerNumber = [];
			dic.layerNumber[0] = layerNumber[0];
			dic.layerNumber[1] = layerNumber[1];
			dic.layerPage = [];
			dic.layerPage[0] = layerPage[0];
			dic.layerPage[1] = layerPage[1];

			dic.lastStatus = lastStatus;
			dic.storageName = storageName;
		}
		return dic;
	}
	function restore(dic)
	{
		if( dic.mode == vomLayer )
		{
			mode = vomLayer;
			loop = dic.loop;
			layerNumber[0] = dic.layerNumber[0];
			layerNumber[1] = dic.layerNumber[1];
			layerPage[0] = dic.layerPage[0];
			layerPage[1] = dic.layerPage[1];
			if( dic.layerNumber[0] !== void && dic.layerPage[0] !== void )
			{
				var elm = %[];
				elm.layer = dic.layerNumber[0];
				elm.page = dic.layerPage[0];
				layer1 = owner.getLayerFromElm(elm);
			}
			if( dic.layerNumber[1] !== void && dic.layerPage[1] !== void )
			{
				var elm = %[];
				elm.layer = dic.layerNumber[1];
				elm.page = dic.layerPage[1];
				layer2 = owner.getLayerFromElm(elm);
			}
			if( dic.lastStatus != "unload" )
			{
				this.open( dic.storageName );
				periodEventFrame = dic.periodEventFrame;	// ���̐ݒ�͕K���t���[�����O�ɍs������
				if( dic.frame >= 0 )
					frame = dic.frame;

				if( numberOfAudioStream > 0 ) {
					audioBalance = dic.audioBalance;
					audioVolume = dic.audioVolume;
					if( dic.enabledAudioStream >= 0 )
					{
						super.selectAudioStream( dic.enabledAudioStream );
					}
				}
				super.setSegmentLoop( dic.segmentLoopStartFrame, dic.segmentLoopEndFrame );
				if( dic.lastStatus == "pause" || dic.lastStatus == "play" )
				{
					play();
				}
			}
		}
	}

	function finalize()
	{
		if(lastStatus == "play") stop();
		super.finalize(...);
	}

	function onStatusChanged(status)
	{
		var oldls = lastStatus;
		lastStatus = status;

		// �X�e�[�^�X�̕ύX��������
		if(oldls == "play" && status == "stop")
		{
			owner.onMovieStop(id); // ��~�ʒm
			super.close();
		} else if(oldls == "stop" && status == "play") {
			owner.onMoviePlay(id); // �J�n�ʒm
		}
	}

	function onPeriod(type)
	{
		// period �C�x���g����������
		owner.onMoviePeriod(id,type);
	}

	function onCallbackCommand(cmd, arg)
	{
		// �R�[���o�b�N�R�}���h
		if(cmd == "Go")
		{
			var spos = arg.indexOf('/');
			if(spos == -1)
			{
				// �X�g���[�W�w�肪�Ȃ�
				owner.process('', '*' + arg);
			}
			else
			{
				// �X�g���[�W�w�肪����
				var label = arg.substring(spos + 1);
				if(label != '') label = '*' + label;
				owner.process(arg.substring(0, spos), label);
			}
		}
		else if(cmd == "Eval")
		{
			Scripts.eval(arg);
		}
	}

	property canWaitStop
	{
		getter
		{
			// �҂Ă邩�ǂ���
			return lastStatus == "play";
		}
	}
	
	property storage
	{
		getter
		{
			return this.storageName;
		}
	}

	function open(storage)
	{
		// open �I�[�o�[���C�h
		this.storageName = storage;
		opened = false;
		var errmes, looped;
		do {
			try {
				super.open(storage);
				opened = true;
			} catch(e) {
				if(e.message.indexOf(".dll") != -1) throw e;
				errmes = e.message;
			}
			looped = false;
			if (!opened && mode == vomMixer) {
				try {
					mode = vomOverlay;
					Debug.notice(storage + ": VideoMixer����Overlay�փt�H�[���o�b�N���܂�: " + errmes);
					looped = true;
				} catch(e) {
					errmes = e.message;
				}
			}
		} while (looped);
		if (!opened) {
			dm("���[�r�[ " + storage + " ���Đ��ł��܂��� : " + errmes);
		}
	}

	function play(storage)
	{
		// play �I�[�o�[���C�h
		try
		{
			if (!opened) {
				open(storage != "" ? storage : this.storageName);
				if (!opened) return;
			}
			super.play();
			opened = false;
		}
		catch(e)
		{
			if(e.message.indexOf(".dll") != -1) throw e;
			dm("���[�r�[ " + storage + " ���Đ��ł��܂��� : " +
				e.message);
			return;
		}
	}
	function resume()
	{
		try
		{
			super.play();
		}
		catch(e)
		{
			if(e.message.indexOf(".dll") != -1) throw e;
			dm("���[�r�[���Đ��ł��܂��� : " + e.message);
			return;
		}
	}

	function stop()
	{
		// stop �I�[�o�[���C�h
		super.stop(...);
		super.close();
	}

	function setOptions(elm)
	{
		// elm ����I�v�V������ݒ�
		visible = +elm.visible if elm.visible !== void;
		var l = left, t = top, w = width, h = height;
		var set = false;
		(set = true, l = +elm.left) if elm.left !== void;
		(set = true, t = +elm.top) if elm.top !== void;
		(set = true, w = +elm.width) if elm.width !== void;
		(set = true, h = +elm.height) if elm.height !== void;
		if(set) setBounds(l, t, w, h);
		
		//
		position = +elm.position if elm.position !== void;
		loop = +elm.loop if elm.loop !== void;
		frame = +elm.frame if elm.frame !== void;
		if( elm.mode !== void )
		{
            if( elm.mode == "layer" ) {
				mode = vomLayer;
            } else if (elm.mode == "mixer") {
                try {
                    mode = vomMixer;
                } catch (e) {
                    try {
                        mode = vomOverlay;
                    } catch (e) {
                        mode = vomLayer;
                    }
                }
            } else {
				mode = vomOverlay;
            }
			dm("video mode:" + ((mode == vomOverlay) ? "overlay" : (mode == vomMixer) ? "mixer" : (mode == vomLayer) ? "layer" : "unknown"));
		}
		playRate = +elm.playrate if elm.playrate !== void;
		audioVolume = +elm.volume * 1000 if elm.volume !== void;
		audioBalance = +elm.pan * 1000 if elm.pan !== void;
		if( elm.audiostreamnum !== void )
		{
			selectAudioStream( +elm.audiostreamnum );
		}
	}

	function setVideoLayer(layer,elm)
	{
		if( elm.channel !== void )
		{
			if( elm.channel == 1 )
				layer1 = layer;
			else
				layer2 = layer;
		}
	}
	function setSegment(elm)
	{
		var startFrame = 0;
		startFrame = +elm.start if elm.start !== void;
		if( elm.end !== void )
			super.setSegmentLoop( startFrame, +elm.end );
	}
	function setPeriod(elm)
	{
		if( elm.frame !== void )
			super.setPeriodEvent( +elm.frame );
	}
	function storeLayer( layer, page, channel )
	{
		if( channel !== void )
		{
			if( channel == 1 )
			{
				layerNumber[0] = layer;
				layerPage[0] = page;
			}
			else
			{
				layerNumber[1] = layer;
				layerPage[1] = page;
			}
		}
	}
	function cancelLayer( channel )
	{
		if( channel !== void )
		{
			if( channel == 1 )
			{
				layerNumber[0] = void;
				layerPage[0] = void;
			}
			else
			{
				layerNumber[1] = void;
				layerPage[1] = void;
			}
		}
	}
}


