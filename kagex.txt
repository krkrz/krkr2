Title: 吉里吉里/KAGEX に関するドキュメント
Author: 合資会社ワムソフト 渡邊剛

●吉里吉里/KAGEX 概要

吉里吉里/KAG に対して主にレイヤ機能面で大きく拡張を行ったシステムです。

KAG の基本機能はそのまま維持されています。KAG の詳細については

 http://devdoc.kikyou.info/tvp/docs/kag3doc/contents/

を参照してください。

●フォルダ構成

krkr.exe		吉里吉里実行ファイル本体
plugin/			プラグイン
savedata/		セーブデータ

data/			データ領域
	system/		システムファイル
	bgimage/	背景ファイル用
	bgm/		BGMファイル用
	fgimage/	前景ファイル用
	image/		その他画像
	others/		その他データ
	rule/		画面更新用ルール画像
	scenario/	シナリオファイル
	sound/		サウンドデータ
	video/		動画データ
	startup.tjs	吉里吉里起動ファイル
	envinit.tjs	システム定義ファイル（KAG拡張用）

※データ領域自体は実際にはどんな構成でもかまいません

●拡張内容解説

◇レイヤ拡張

◆特殊レイヤの追加

次の２枚の全画面レイヤが拡張されています。

stage	背景レイヤの上、前景レイヤの下にさしこまれるレイヤ
event	前景レイヤの上、メッセージレイヤの下にさしこまれるレイヤ
		
※正確には、前景レイヤにレベル概念が拡張されているので、
  event レイヤの上にも表示可能です。

本来の KAG での「背景」は base レイヤを使うのですが、この base レイヤ
に対しては、吉里吉里の実装上の制限から、移動が伴う指定を行うことが
できません。このため、背景の回転用途のために別途専用レイヤを
導入しました。

また「イベント画面」の表示の便宜のため、前景レイヤの上に表示できる
専用レイヤを準備しました。

次のようなレイヤ構造になります

-- -- -- --  messages (KAGメッセージレイヤ）
-- -- -- --  layers (KAG前景レイヤ:level5〜8)
-----------  event
-- -- -- --  layers (KAG前景レイヤ:level0〜4)
-----------  stage
-----------  base（KAG背景レイヤ）

◆前景レイヤへのレベルの導入

KAG 本来の前景レイヤは番号順の表示順をもっています。
KAGEX では、「レベル」という概念を持ち、レベル単位で表示順が決定されます。

・レベルが小さいレイヤ群ほど下に表示されます
・同じレベルの中で「最前列」「最後列」の表示制御が可能です

◆layopt (拡張)

stage / event および 前景レイヤに対して、従来の layopt に加えて
以下の属性を追加で利用できるようになります。

属性
	rotate  角度
	zoomx   横方向拡大率
	zoomy   縦方向拡大率
	zoom    拡大率
	afx     回転・拡大原点X座標 center/left/right 
			または数値でレイヤの左上隅からの座標
	afy     回転・拡大原点Y座標 center/top/bottom
			または数値でレイヤの左上隅からの座標
	type    合成モード
			※http://devdoc.kikyou.info/tvp/docs/kr2doc/contents/index.html
	reset   アクションと属性指定をすべて初期化する
			※opacity と type は画像ロード時のものに初期化されます

◆laylevel (新規)

前景レイヤの表示レベルを指定します。

属性
	layer (前景レイヤのみ)
	page (省略時は fore)  
	level  表示レベル
	    表示レベル：layfront/layback でのグルーピング対象です。
	    表示レベルが大きいほど上に表示されます。

◆layfront (新規)

前景レイヤを同じ表示レベルの最前列に移動させます

属性
	layer (前景レイヤのみ)
	page (省略時は fore)  

◆layback (新規)

前景レイヤを同じ表示レベルのレイヤの最後列に移動させます

属性
	layer (前景レイヤのみ)
	page (省略時は fore)  

◆clearlayers (新規)

全レイヤの内容を消去して表示停止します。

属性
	page 表か裏

◆action (新規)

stage / event および 前景レイヤに対して、
レイヤに対する自動アクション駆動を指定します

属性
	layer レイヤの指定（前景/stage/event のみ)
	page 表裏の指定
	module アクションの種類を指定
	
※その他アクション毎に属性パラメータがあります。
　アクションの種別については action.txt を参照してください。

◆stopaction (新規)

指定されたレイヤのアクションを停止します。
指定を省略した場合は全レイヤのアクションを停止します。

属性
	layer レイヤの指定（前景/stage/event のみ)
	page 表裏の指定

◆wact (新規)

指定されたレイヤのアクションの終了を待ちます。
指定を省略した場合は全レイヤのアクションの終了を待ちます。

属性
	layer レイヤの指定（前景/stage/event のみ)
	page 表裏の指定
	canskip 値 true(デフォルト) または false
			true を指定するとクリックで待ちをスキップできます

◆button (拡張)

画像ボタンのファイルを個別指定できるよう拡張してあります。

属性
	normal	通常時画像
	over    マウスオーバー時画像	省略時は normalと同じ
	on		押し下げ時画像			省略時は over と同じ
	focus	フォーカス時画像		省略時は focus と同じ

◆slider (新規)

メッセージレイヤにスライドバーを配置します。

属性
	exp			commit 時の代入先
	bgcolor		背景の色
	opacity		背景の透明度
	value		連動変数名。指定されると、
				(1)指定された変数を初期値として参照
				(2)変更時に指定された変数に値を代入
	position	初期値
	onchange	変更値を代入する変数名

	base		背景画像名。
				指定した場合は width と height は背景画像のサイズになる
	width		背景幅
	height		背景高さ
	tab			タブ画像（一括) normal / on / over の順で横に並んだ画像を指定
	normal		タブ画像通常（分離）
	over		タブ画像マウスオーバー（分離）
	on			タブ画像プッシュダウン時（分離）

◆sysbutton (新規)

メッセージレイヤにシステムボタンを配置します。

属性
	normal		通常時画像
	over    	マウスオーバー時画像	省略時は normalと同じ
	on			押し下げ時画像			省略時は over と同じ
	focus		フォーカス時画像		省略時は focus と同じ

	graphic		ボタン画像
	graphickey 	ボタン画像キー
	x			表示位置
	y			表示位置
	hint		ヒント
	exp			クリック時実行スクリプト
	clickse		クリック時SE
	clicksebuf	クリック時SEバッファ
	onenter		カーソルenter時 実行スクリプト
	enterse		カーソルenter時 SE
	entersebuf	カーソルenter時 SEバッファ
	onleave		カーソルleave時 実行スクリプト
	leavese		カーソルleave時 SE
	leavesebuf	カーソルleave時 SEバッファ
	recthit		
	enabled		有効にする
	disabled	無効にする

◆csysbutton (新規)

システムボタンを消去します

◆timeout (新規)

カレントのメッセージレイヤにタイムアウト処理を追加します。

属性
	time	タイムアウトまでの時間
	storage	タイムアウト時に実行されるシナリオ
	target	タイムアウト時に実行されるラベル

◇サウンドトラック拡張

◆サウンド制御全般

音量制御の方法

　直接指定
    KAG の [bgmopt] [seopt] タグを使うことでボリュームを直接制御できます
  
  フェード指定
    KAG の [fadebgm] [fadese] タグを使うことで演奏中にボリュームをフェード
　　制御できます。
 
  ループの制御
    吉里吉里ループチューナを使ってください
　　http://devdoc.kikyou.info/tvp/docs/kr2doc/contents/LoopTuner.html

    これを使うと、たとえば
      bgm01.ogg に対して bgm01.ogg.sli というループ情報が格納された
　　　ファイルが生成されます。吉里吉里はこれを参照してループの制御を
　　　行っています。

  任意位置からの開始（拡張機能）
　　(1) ループチューナで開始したい位置にラベルをうつ
    (2) playbgm / playse / fadeinbgm / fadeinse の start ラベルで指定

◆playbgm/playse/fadeinbgm/fadeinse (拡張)

任意位置から生成できるように拡張しました

属性
	start  開始位置の指定。ループチューナで指定したラベル名を指定する

◆fadepausebgm (新命令)

BGMのフェードアウトしながらの一時停止

属性
	time	時間(ms単位)
			フェードアウトを行っている時間を ms 単位で指定します。
			3000 と指定すれば 3 秒間の間、フェードアウトを行っています。

◇表示系拡張

◆linemode (拡張)

KAG の改行に対するルールを切り替えます。
これを用いることで、メッセージ窓スタイルの作品の場合に
[l]や[cm]などを明示的に記述しなくてもよくなります。

属性
	mode	line または page
			未指定の場合は通常の KAG の動作に戻ります。

line の場合
	改行：[l] を実行する
	[p]：待ちのあとページの自動消去

page の場合
	改行：[p] のあとページの自動消去

さらに、ラインモードが有効な場合、行頭にある

【名前/表示名】

という記述に対して、
名前表示コマンド namedisp(名前,表示名) が自動的に呼び出されます。
デフォルトでは namedisp は表示テキストをそのまま表示するだけです。
「ワールド拡張」を行った場合の処理については kag3plugin/world/world.txt を参照してください。

